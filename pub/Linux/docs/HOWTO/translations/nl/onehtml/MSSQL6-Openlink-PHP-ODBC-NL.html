<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<HEAD>
 <META NAME="GENERATOR" CONTENT="SGML-Tools 1.0.9">
 <TITLE>Verbinden met MS SQL 6.x+ via Openlink/PHP/ODBC mini-HOWTO</TITLE>


</HEAD>
<BODY>
<H1>Verbinden met MS SQL 6.x+ via Openlink/PHP/ODBC mini-HOWTO</H1>

<H2>Zili Zhang, <CODE>silen@silen.net</CODE><BR>
Vertaald door: Ellen Bokhorst, <CODE>bokkie@nl.linux.org</CODE></H2>3.0, 15-07-1999
<P><HR>
<EM>Hoe een verbinding te maken met een MS SQL 6.x+ databaseserver via
ODBC functies van PHP3 (3.0.1x of hoger) gecompileerd met Openlink drivers
onder Linux.</EM>
<HR>
<H2><A NAME="s1">1. Introductie</A></H2>

<P>In dit document wordt beschreven hoe een verbinding te maken met een 
MS SQL 6.x+ databaseserver via ODBC functies van PHP3 (3.0.1x of hoger) 
gecompileerd met Openlink drivers onder Linux.
<P>In de Unix wereld hebben de mensen vaak liever niets te maken met
M$ gerelateerde software. In de echte wereld kan je werkgever echter
van je verlangen data in een MS SQL database onder NT op te slaan en
webtoepassingen onder Linux uit te voeren. Wat te doen?
Ontslag nemen of de tijd nemen om dit document te lezen?
Als je voor het laatste kiest, beloof ik je een gedetailleerde leidraad,
zodat je die baan nog een tijdje aan kunt houden. Het is een Hoe-te-doen
leidraad, geen Waarom-zo leidraad.
Dus vraag me niet waarom het abc moet zijn en niet cba. Dat weet ik ook
niet.
<P>PHP wordt onder webprogrammeurs steeds populairder, hoofdzakelijk
omdat het zo kan worden geconfigureerd dat het met diverse databases
zoals Oracle, MySQL, Solid enzovoort een verbinding tot stand kan
brengen. Maar bij een MS SQL server, gaat het om een ander probleem.
Alhoewel je PHP's Sybase-ct ondersteuningsfeatures kunt gebruiken om
een directe verbinding met MSSQL te maken, geven veel mensen
(ik in ieder geval) de voorkeur aan een verbinding via ODBC.
<P>Openlink ODBC middleware aanpassend, kun je gebruik maken van die ODBC_xxxx
functies om alle databases te benaderen waar Openlink een driver voor heeft.
Je moet hiervoor de Openlink Linux client en Server middleware installeren
en PHP opnieuw compileren dat het ODBC functies ondersteunt. 
<H2>1.1 Copyright</H2>

<P>Copyright (c) 1999 door Zili Zhang
<P>Kopieer en distribueer dit document gerust (of geef het weg) in elk
gewenst formaat.
Je wordt verzocht correcties en/of opmerkingen naar de
huidige beheerder door te sturen. Je mag er een afgeleide werk van maken
en het distribueren op voorwaarde dat je:
<P>
<UL>
<LI>Het afgeleide werk (in de meest geschikte vorm, zoals sgml) opstuurt 
naar de LDP (Het Linux Documentatie Project) of vergelijkbaar
zodat het op Internet kan worden geplaatst. Laat de LDP weten waar
het beschikbaar is als het niet de LDP is waar je je document naar
opstuurt.</LI>
<LI>Licentieer het afgeleide werk met dezelfde licentie of gebruik GPL.
Voeg een copyrightmelding in en op z'n minst een verwijzing naar de
gebruikte licentie.</LI>
<LI>Geef krediet aan vorige auteurs en mensen die een belangrijke bijdrage
leverden.</LI>
</UL>
<P>Als je een afgeleid werk overweegt anders dan een vertaling, dan wordt
je verzocht je plannen te bespreken met de huidige beheerder.
<H2>1.2 Disclaimer</H2>

<P>Dit document wordt je in goed vertrouwen aangeboden aangezien het alleen
uit een veilige configuratie en procedures bestaat.
Er wordt geen verantwoordelijkheid
door de auteur geaccepteerd voor enig verlies of schade op welke wijze
dan ook veroorzaakt door een persoon of uitrusting, als een direct of
indirect gevolg van het opvolgen van deze instructies.
<P>Dit document werd afgeleid van het gewone tekstbestand te vinden op
<A HREF="http://www.silen.net/openlink-php-odbc.txt">http://www.silen.net/openlink-php-odbc.txt</A>.
<H2><A NAME="s2">2. Openlink</A></H2>

<P>Deze stap is een beetje gecompliceerd. Er zijn zowel op de Linux client
als de NT server een aantal werkzaamheden te verrichten.
<H2>2.1 Op de client</H2>

<P>
<UL>
<LI>Download <CODE>install.sh</CODE> en <CODE>likoxglc.taz</CODE> (voor een libc6 systeem)
of <CODE>likoxxxx.taz</CODE> (voor een libc5 systeem) vanaf
<A HREF="ftp://www.openlinksw.com/">ftp://www.openlinksw.com/</A>. </LI>
<LI><CODE>mkdir /usr/local/openlink</CODE></LI>
<LI>Kopieer <CODE>install.sh</CODE> en <CODE>likoxglc.taz</CODE> 
naar <CODE>/usr/local/openlink</CODE></LI>
<LI><CODE>cd /usr/local/openlink</CODE></LI>
<LI><CODE>sh install.sh</CODE>, het install script zal je vragen om de eigenaar
en groep van het programma. Bestanden worden ge&euml;xtraheerd naar de
<CODE>odbcsdk</CODE> directory onder <CODE>/usr/local/openlink</CODE>
en <CODE>.odbc.ini</CODE> gekopieerd naar de homedirectory van de eigenaar.</LI>
</UL>
<H2>2.2 Op de server</H2>

<P>
<UL>
<LI>Download <CODE>ntadm65x.zip</CODE> vanuit
<A HREF="ftp://www.openlinksw.com/">ftp://www.openlinksw.com/</A>, 
naar je NT-server.</LI>
<LI><CODE>unzip ntadm65x.zip</CODE></LI>
<LI><CODE>cd disk1</CODE> - directory waar je het package decomprimeert.</LI>
<LI>voer <CODE>setup</CODE> uit en volg de instructies om de Openlink
middleware te installeren.</LI>
<LI>denk eraan de Openlink request broker vanuit het opstartmenu of
het service controlpanel op te starten.</LI>
</UL>
<H2>2.3 Configuratie voor test</H2>

<P>
<UL>
<LI>bewaar het <CODE>.odbc.ini</CODE> bestand in je homedirectory.</LI>
<LI>kopieer <CODE>udbc.ini</CODE> vanuit de bin directory van de Openlink 
middleware installatiedirectory naar de
directory <CODE>/etc</CODE> op de client.</LI>
<LI>pas <CODE>/etc/udbc.ini</CODE> aan. 
Wijzig in de sectie [dsn_sql6], de Host, Database, UserName
en Password velden overeenkomstig je serverinstellingen.
Hier is een deel van mijn <CODE>/etc/udbc.ini</CODE>:
<BLOCKQUOTE><CODE>
<PRE>
  [dsn_sql6]
  Host            = 10.0.0.1
  ServerType      = sql6
  ;ServerOptions  =
  Database        = pubs
  ;FetchBufferSize = 30
  UserName        = sa
  Password        = xxxxxxx
</PRE>
</CODE></BLOCKQUOTE>
</LI>
<LI>voeg aan je omgeving 
<CODE>LD_LIBRARY_PATH='/usr/local/openlink/odbcsdk/lib'</CODE> toe en
exporteer deze variabele. Typ onder de csh-shell:
<CODE>setenv LD_LIBRARY_PATH /usr/local/openlink/odbcsdk/lib</CODE></LI>
</UL>
<H2>2.4 Test met <CODE>odbctest</CODE></H2>

<P>
<UL>
<LI><CODE>cd /usr/local/openlink/odbcsdk/examples</CODE></LI>
<LI><CODE>./odbctest</CODE></LI>
<LI>typ: <CODE>dsn=dsn_sql6</CODE></LI>
<LI>wanneer 'sql&gt;' verschijnt. 
Je kunt nu wat sql opdrachten uitvoeren om de verbinding te testen.</LI>
</UL>
<H2><A NAME="s3">3. PHP</A></H2>

<P>Nu hebben we Openlink en kunnen we verder met de compilatie van PHP.
Voor deze versie is PHP 3.0.10 of hoger nodig om het werkend te krijgen.
<UL>
<LI>Download <CODE>php-3.0.11.tar.gz</CODE> vanaf 
<A HREF="http://www.php.net/">http://www.php.net</A>. </LI>
<LI> Voer de volgende stappen uit:
<BLOCKQUOTE><CODE>
<PRE>
gzip -dc php-3.0.11.tar.gz|tar -xof -

cd php-3.0.11

./configure --with-openlink (--with-mysql --with-gd=/usr/local/gd1.3 --enable-track-vars)

    NOOT: Mijn configuratie is ingesteld PHP in CGI modus te draaien,
          met bovendien ondersteuning voor mysql. Jouw configuratie kan
          er anders uitzien.

make --silent

    NOTE: Maak je geen zorgen bij eventuele waarschuwingsmeldingen.

make install
</PRE>
</CODE></BLOCKQUOTE>

Het uitvoerbare bestand php zal in <CODE>/usr/local/bin</CODE> worden
ge&iuml;nstalleerd. Kopieer voor de uitvoering van php de library bestanden
<CODE>/usr/local/openlink/odbcsdk/lib</CODE> naar <CODE>/usr/lib</CODE> zodat
het makkelijker is voor php om de openlink library's te vinden (ik weet
dat er betere methoden zijn).</LI>
</UL>
<H2><A NAME="s4">4. Voorbeeld</A></H2>

<P>Raadpleeg alsjeblieft de PHP handleiding voor ODBC functies. Hier is mijn
voorbeeldcode odbc.php3:  (odbc_num_rows() zal niets retourneren, dus
je moet herhaaldelijk odbc_fetch_row() aanroepen om aan het aantal te komen.)
<P>
<BLOCKQUOTE><CODE>
<PRE>
&lt;?
/* een aantal omgevingsvariabelen, plaats een commentaarteken voor een
 * van deze regels om te testen of het dan nog werkt
 */
putenv("LD_LIBRARY_PATH=/usr/local/openlink/odbcsdk/lib");
putenv("UDBCINI=/etc/udbc.ini");
putenv("ODBCINI=/root/.odbc.ini");
putenv("DebugFile=/tmp/udbc.out");      // debug trace output

$dsn="DSN=dsn_main";    // noot 'DSN=' is vereist
$user="sa";
$password="xxxxxxx";

$sql="SELECT * FROM titles";

/* directly execute mode                        */
if ($conn_id=odbc_connect("$dsn",$user,$password)){
        echo "connected to DSN: $dsn&lt;br>&lt;br>";
        if($result_id=odbc_do($conn_id, $sql)) {
                echo "executing '$sql'&lt;br>&lt;br>";
                        $num_fields=odbc_num_fields($result_id);
                        if($num_fields>0){
                                echo "Number of fields:
$num_fields&lt;br>";
                                for($i=1;$i&lt;=$num_fields;$i++){

$field_name[$i-1]=odbc_field_name($result_id,$i);
                                }
                                $num_rows=0;
                                while(odbc_fetch_row($result_id)){
                                        for($i=1;$i&lt;=$num_fields;$i++){

$result[$num_rows][$field_name[$i-1]]=odbc_result($result_id,$i);
                                        }
                                        $num_rows++;
                                }
                                echo "Number of rows: $num_rows&lt;br>";
                        }else{
                                echo "not a field returned. &lt;br>&lt;br>";
                        }
                echo "Results:&lt;br>";
                for($i=0;$i&lt;sizeof($result);$i++){
                        while(list($key,$value)=each($result[$i])){
                                echo "$i:$key=$value&lt;br>";
                        }
                }
                echo "freeing result&lt;br>&lt;br>";
                odbc_free_result($result_id);
        }else{
                echo "can not execute '$sql'&lt;BR>&lt;BR>";
        }
        echo "closing connection $conn_id";
        odbc_close($conn_id);
}else{
        echo "can not connect to DSN: $dsn&lt;br>&lt;br>";
}
?&gt;
</PRE>
</CODE></BLOCKQUOTE>
<H2><A NAME="s5">5. FAQ</A></H2>

<P>
<P>
<UL>
<LI><EM>Werkt deze exacte procedure ook voor MSSQL 7.0?</EM>
Ja, Openlink zal hun software naar 7.0 upgraden, maar ik weet niet wanneer.</LI>
<LI><EM>Ik volgde dit document stap-voor-stap op om de openlink drivers
te installeren, maar ik eindigde bij de stap
&quot;installeer ntadm65x.zip&quot;. Ndat ik ntadm65x installeerde,
probeerde ik de OpenLink Request Broker te starten en kreeg de foutmelding:</EM>

<BLOCKQUOTE><CODE>
<PRE>
 unable to open the service control manager &lt;5&gt;
 press RETURN to exit oplrqb
</PRE>
</CODE></BLOCKQUOTE>

<EM>Kun je me alsjeblieft vertellen hoe ik dat probleem kan corrigeren?</EM>
Dit zou een probleem met NT zelf kunnen zijn. Probeer het op te lossen
door de computer opnieuw op te starten en start de openlink service
dan vanuit de Control Panel/service manager.</LI>
</UL>
</BODY>
</HTML>
