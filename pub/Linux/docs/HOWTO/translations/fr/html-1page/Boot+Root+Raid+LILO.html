<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<HEAD>
 <META NAME="GENERATOR" CONTENT="LinuxDoc-Tools 0.9.21">
 <TITLE>Petit guide Boot + Root + Raid + Lilo</TITLE>
</HEAD>
<BODY>
<H1>Petit guide Boot + Root + Raid + Lilo</H1>

<H2>Version fran&ccedil;aise du petit guide <EM>Raid logiciel mini-HOWTO</EM></H2>
<H2>Michael Robinton, 
<A HREF="mailto:michael@bizsystems.com">Michael@BizSystems.com</A></H2>v1.04, 20 juillet 2000
<HR>
<EM>Ce document permet la mise en place d'un syst&egrave;me de fichiers raid en utilisant raidtools 0.90 pour obtenir un raid amor&ccedil;able mont&eacute; sur la racine en utilisant un lilo standard.
La conversion d'un disque conventionnel vers un raid1 ou un raid5 sans perdre les donn&eacute;es pr&eacute;sentes sur le disque est aussi trait&eacute;e.</EM>
<HR>
<H2><A NAME="s1">1. Introduction</A></H2>


<H2><A NAME="ss1.1">1.1 Remerciements</A>
</H2>

<P>Les sources d'information ci-dessous ont &eacute;t&eacute; &eacute;crites par 
 
Harald Nordg&aring;rd-Hansen <CODE>&lt;</CODE>
<A HREF="mailto:hnh@bukharin.hiof.no">hnh@bukharin.hiof.no</A><CODE>></CODE> et on &eacute;t&eacute; post&eacute;es &agrave; la liste de discussion
sur le raid dans un fichier lilo.conf comment&eacute; par Martin Bene <CODE>&lt;</CODE>
<A HREF="mailto:mb@sime.com">mb@sime.com</A><CODE>></CODE>. Merci de leur contribution. 
J'ai essay&eacute; de mettre ces informations et le b&eacute;n&eacute;fique travail de plusieurs autres 
personnes qui ont contribu&eacute; &agrave; la liste de discussion sur le raid et le projet raid sous linux 
sous forme de recettes de cuisine, en incluant diff&eacute;rents exemples de syst&egrave;mes mis en place
afin de rendre le raid amor&ccedil;able facile &agrave; utiliser et &agrave; comprendre. 
Une section traite de la conversion d'un disque seul standard en un disque raid. 
&Agrave; mon humble avis, la cl&eacute; permettant la conversion est la compr&eacute;hension du raid amor&ccedil;able. </P>

<H2><A NAME="ss1.2">1.2 Bugs</A>
</H2>

<P>Oui, je suis s&ucirc;r qu'il y en a. Si vous &ecirc;tes assez bons pour les signaler, je 
corrigerai le document. ;-)</P>

<H2><A NAME="ss1.3">1.3 Notice sur le copyright </A>
</H2>

<P>Ce document a &eacute;t&eacute; &eacute;crit par Michael Robinton
<A HREF="mailto:michael@bizsystems.com">Michael@BizSystems.com</A>,
et est diffus&eacute; sous une licence copyleft GNU.</P>

<P>Permission d'utiliser, de copier, de distribuer ce document pour tout
usage, pourvu que le nom de l'auteur, de l'&eacute;diteur et ce paragraphe
apparaissent dans toutes les copies et documents de soutien&nbsp;; et
qu'une version non modifi&eacute;e de ce document soit librement disponible.
Ce document est distribu&eacute; dans le but de fournir une aide, mais SANS
AUCUNE GARANTIE, ni expresse, ni implicite. Malgr&eacute; tous les efforts de
v&eacute;rification de l'information diffus&eacute;e dans ce document, les auteur,
&eacute;diteurs, responsables de maintenance et traducteurs
n'assument aucune responsabilit&eacute; concernant toutes les erreurs et
tous les dommages, directs ou indirects, d&eacute;coulant de l'utilisation de
l'information fournie dans ce document.</P>

<P>Permission to use, copy, distribute this document for any purpose is
hereby granted, provided that the author's / editor's name and this
notice appear in all copies and/or supporting documents; and that an
unmodified version of this document is made freely available. This
document is distributed in the hope that it will be useful, but
WITHOUT ANY WARRANTY, either expressed or implied. While every effort
has been taken to ensure the accuracy of the information documented
herein, the author / editor / maintainer assumes NO RESPONSIBILITY
for any errors, or for any damages, direct or consequential, as a
result of the use of the information documented herein.</P>

<H2><A NAME="s2">2. Ce dont vous avez besoin AVANT TOUTE CHOSE</A></H2>

<P>Les programmes dont vous allez avoir besoin et la documentation qui r&eacute;pondra &agrave; la 
majeure partie des probl&egrave;mes de configuration et d'utilisation d'un raid sont list&eacute;s 
ci-dessous. Ayez l'obligeance de les lire attentivement.</P>

<H2><A NAME="ss2.1">2.1 Logiciels requis</A>
</H2>

<P>Il est pr&eacute;f&eacute;rable d'utiliser les versions les plus r&eacute;centes de ces programmes.
<UL>
<LI>un noyau supportant le raid, initrd
<BLOCKQUOTE>
 J'ai utilis&eacute; 
<A HREF="ftp://ftp.kernel.org/pub/linux/kernel/v2.2/">linux-2.2.14</A>
 
en provenance de www.kernel.org
</BLOCKQUOTE>

</LI>
<LI>
<A HREF="ftp://ftp.kernel.org/pub/linux/daemons/raid/alpha/">ftp://ftp.kernel.org/pub/linux/daemons/raid/alpha/</A>
les outils et le correctifs les plus r&eacute;cents compatibles avec les raid
1, 4 et 5 modernes

<BLOCKQUOTE>
 J'ai utilis&eacute; 
<A HREF="http://people.redhat.com/mingo/raid-patches/raid-2.2.14-B1">http://people.redhat.com/mingo/raid-patches/</A></BLOCKQUOTE>
</LI>
</UL>
</P>


<H2><A NAME="ss2.2">2.2 O&ugrave; se procurer une version &agrave; jour de ce document&nbsp;?</A>
</H2>

<P>Cliquez ici pour voir la 
<A HREF="ftp://ftp.bizsystems.net/pub/raid/Boot+Root+Raid+LILO.html">derni&egrave;re version de l'auteur</A> de
ce document. Corrections et suggestions sont les bienvenues!</P>
<P>Boot Root Raid + LILO HOWTO</P>
<P>Disponible au format LaTeX (donc DVI et PostScript), texte brut,  et HTML.
<BLOCKQUOTE>
 
<A HREF="http://www.linuxdoc.org/HOWTO/Boot+Root+Raid+LILO.html"> http://www.linuxdoc.org/HOWTO/Boot+Root+Raid+LILO.html</A></BLOCKQUOTE>

Disponible en SGML et HTML.
<BLOCKQUOTE>
 
<A HREF="ftp://ftp.bizsystems.net/pub/raid/">ftp.bizsystems.net/pub/raid/</A></BLOCKQUOTE>
</P>

<H2><A NAME="ss2.3">2.3 Documentation -- Lectures recommand&eacute;es</A>
</H2>

<P><B>Si vous pr&eacute;voyez d'utiliser un raid 1 ou 5 par-dessus un raid 0 veuillez lire&nbsp;:</B>
<BLOCKQUOTE>
<B>/usr/src/linux/Documentation/initrd.txt</B>
</BLOCKQUOTE>
</P>

<P>ainsi que la documentation, et les pages de manuel fournies 
avec le package raidtools. </P>

<P>et... 
<A HREF="http://metalab.unc.edu/mdw/HOWTO/Software-RAID-HOWTO.html">Software-RAID-HOWTO.html</A></P>

<H2><A NAME="ss2.4">2.4 Ressources sur le RAID</A>
</H2>

<P>Adresses de listes de diffusion&nbsp;:
<UL>
<LI>Celle-ci para&icirc;t tranquille&nbsp;: 
<A HREF="mailto:majordomo@nuclecu.unam.mx">majordomo@nuclecu.unam.mx</A><I> envoyer un message</I>
<B>s'inscrire sur raiddev</B><P>envoyer un message sur&nbsp;: 
<A HREF="mailto:raiddev@nuclecu.unam.mx">raiddev@nuclecu.unam.mx</A></P>
<P>&nbsp;</P>
</LI>
<LI>D&eacute;veloppement Raid&nbsp;: 
<A HREF="mailto:majordomo@vger.rutgers.edu">majordomo@vger.rutgers.edu</A><I> envoyer un message </I>
<B>s'inscrire sur linux-raid</B><P>envoyez un courrier &agrave;&nbsp;: 
<A HREF="mailto:linux-raid@vger.rutgers.edu">linux-raid@vger.rutgers.edu</A>
<I>(il semble que ce soit la liste la plus active)</I></P>
</LI>
</UL>
</P>


<H2><A NAME="s3">3. Raid amor&ccedil;able</A></H2>

<P>Je ne vais pas traiter les bases de l'installation d'un raid 0, 1 ou 5 sous
Linux, ceci a d&eacute;j&agrave; &eacute;t&eacute; trait&eacute; ailleurs. Le probl&egrave;me trait&eacute; ici est la
mise en place sur une racine amor&ccedil;able avec un LILO <B>standard</B>. La
documentation fournie avec les sources LILO (pas les pages de manuel) et avec 
les outils raidtools-0.90, couvrent respectivement les d&eacute;tails du boot et des param&egrave;tres g&eacute;n&eacute;raux 
 
de boot sur un raid.</P>

<P>Deux sc&eacute;narios sont envisag&eacute;s ici. La mise en place d'un raid amor&ccedil;able
et la conversion d'un syst&egrave;me de fichier non RAID en raid amor&ccedil;able sans perte
de donn&eacute;es</P>

<H2><A NAME="ss3.1">3.1 D&eacute;marrage d'un RAID&nbsp;1 avec un LILO standard</A>
</H2>

<P>Pour rendre les informations de d&eacute;marrage redondantes et faciles &agrave; maintenir,
pr&eacute;parez un petit raid 1 et montez-le sous le r&eacute;pertoire <B>/boot</B> de votre
disque syst&egrave;me. LILO ne conna&icirc;t pas les p&eacute;riph&eacute;riques 0x9?? et ne peut pas trouver
 
les informations au d&eacute;marrage car le sous-syst&egrave;me raid n'est pas encore actif.
L'astuce est que l'on peut donner &agrave; LILO les informations sur la g&eacute;om&eacute;trie des disques,
et, gr&acirc;ce &agrave; cela, LILO peut d&eacute;terminer la position des informations dont il a besoin
pour charger le noyau, m&ecirc;me si celles-ci sont sur la partition raid 1.
Cela vient du fait que la partition raid 1 a pour seule diff&eacute;rence avec une partition standard
le super-bloc raid situ&eacute; en fin de partition.
 
Le raid amor&ccedil;able doit se situer sur les 1024 premiers mega-octets du disque. En th&eacute;orie,
le d&eacute;but d'une partition raid peut se situer n'importe o&ugrave; dans les 1024 Mo, mais,
en pratique, je n'ai pas pu le v&eacute;rifier dans la mesure o&ugrave; cela fonctionnait
seulement lorsque le raid commen&ccedil;ait sur le premier bloc du disque.
Ceci &eacute;tant probablement d&ucirc; &agrave; une erreur de ma part, mais il n'&eacute;tait pas opportun
d'aller plus loin sur le moment. J'ai ensuite simplement configur&eacute; mon syst&egrave;me
avec le raid amor&ccedil;able comme premi&egrave;re partition. Je dispose  d'un raid &agrave; la racine
avec le raid 1 amor&ccedil;able mont&eacute; sous <B>/boot</B> avec des syst&egrave;mes configur&eacute;s 
comme suit&nbsp;: RAID&nbsp;1, RAID&nbsp;5, RAID&nbsp;10 &amp; RAID&nbsp;1-10 ( 1 miroir + 1 raid0). 
Les disques n'ayant pas la m&ecirc;me g&eacute;om&eacute;trie, la configuration de lilo n'est pas &eacute;vidente.
Le dernier se voit attribuer une paire de fichiers lilo tr&egrave;s sp&eacute;cifique car tous 
les disques ont des g&eacute;om&eacute;tries diff&eacute;rentes, cependant, les principes sont identiques 
pour le processus de lancement initial.
Les montages des racines RAID&nbsp;S 10 et RAID&nbsp;S 1-10 exigent l'utilisation
d'<I>initrd</I> pour monter la racine apr&egrave;s le chargement du noyau.
Voyez les annexes pour le d&eacute;tail des fichiers de configuration pour tous ces 
exemples de syst&egrave;mes.</P>

<P>Un ficher de configuration de LILO peut ressembler &agrave; ce qui suit&nbsp;:</P>
<P>
<PRE>
//# lilo.conf - suppose un disque inf&eacute;rieur &agrave; 1024 Mo
        boot = /dev/hda
        delay = 40               # pas n&eacute;cessaire, mais bien utile
        vga = normal             # pas obligatoire
        image = /bzImage
        root = /dev/hda1
        read-only
        label = Linux
</PRE>
</P>

<P>Un fichier de configuration de LILO pour un raid peut ressembler &agrave; ce qui suit&nbsp;:</P>
<P>
<PRE>
# lilo.conf.hda - disque ma&icirc;tre sur le contr&ocirc;leur primaire 
        disk=/dev/md0
        bios=0x80
        sectors=63
        heads=16
        cylinders=39770
        partition=/dev/md1
        start=63
        boot=/dev/hda
        map=/boot/map
        install=/boot/boot.b
        image=/boot/bzImage
        root=/dev/md0
        read-only
        label=LinuxRaid

# ---------------------

# lilo.conf.hdc - disque ma&icirc;tre sur le contr&ocirc;leur secondaire 
        disk=/dev/md0
        bios=0x80                # voir la note plus bas
        sectors=63
        heads=16
        cylinders=39770
        partition=/dev/md1
        start=63
        boot=/dev/hdc            # ceci est l'autre disque
        map=/boot/map
        install=/boot/boot.b
        image=/boot/bzImage
        root=/dev/md0
        read-only
        label=LinuxRaid
</PRE>
</P>
<P># BIOS=line -- si votre BIOS est assez bien pens&eacute; (la plupart ne le sont pas) pour
d&eacute;tecter que le premier disque est absent ou n'a pas d&eacute;marr&eacute; et d&eacute;marre sur le second disque,
ensuite, <B>bios=81</B> est l'entr&eacute;e appropri&eacute;e ici. Ceci est plus courant avec
les BIOS SCSI qu'avec les BIOS IDE. J'envisage simplement de replacer le disque
de mani&egrave;re &agrave; ce qu'il remplace le d&eacute;funt lecteur C: au cas o&ugrave; il viendrait &agrave; tomber en
panne au d&eacute;marrage.</P>

<P>Vous pouvez obtenir les information sur le disque gr&acirc;ce &agrave; fdisk avec la commande&nbsp;:</P>
<P>
<PRE>
fdisk -ul (petit L)
fdisk -ul /dev/hda

Disk /dev/hda: 16 heads, 63 sectors, 39770 cylinders
Units = sectors of 1 * 512 bytes

   Device Boot    Start       End    Blocks   Id  System
/dev/hda1            63     33263     16600+  fd  Linux raid autodetect
/dev/hda2         33264    443519    205128   82  Linux swap
/dev/hda3        443520  40088159  19822320   fd  Linux raid autodetect

* notez l'indication du D&Eacute;BUT de chaque partition
</PRE>
</P>

<H2><A NAME="ss3.2">3.2 Explications d&eacute;taill&eacute;es de lilo.conf pour le d&eacute;marrage sur un raid</A>
</H2>

<P>Le fichier lilo.conf pour raid ci-dessous, est comment&eacute; en d&eacute;tails pour chaque entr&eacute;e.</P>
<P>
<PRE>
# lilo.conf.hda - disque ma&icirc;tre sur le contr&ocirc;leur primaire
#       La localisation du point de montage /boot qui va &ecirc;tre 
#       d&eacute;crit ci-dessous comme contenant le noyau, la carte, et c&aelig;tera.
#       notez que CE N'EST PAS la partition actuelle contenant l'image et
#       les informations de d&eacute;marrage, mais le disque qui contient ce r&eacute;pertoire
#       Dans cet exemple, /dev/md1 est mont&eacute; sous /dev/md0/boot
     disk=/dev/md0

#       Indique &agrave; LILO quel p&eacute;riph&eacute;rique du BIOS utiliser pour amorcer le syst&egrave;me, par ex. le disque C:
     bios=0x80

#       indique &agrave; LILO la g&eacute;om&eacute;trie du disque
#       c'est habituellement, mais pas toujours la g&eacute;om&eacute;trie
#       logique. V&eacute;rifiez le syst&egrave;me de fichier /proc ou regardez
#       le message du noyau lors de la d&eacute;tection du disque
#       
     sectors=63
     heads=16
     cylinders=39770

#       Il existe une entr&eacute;e permettant de duper LILO afin
#       qu'il reconnaisse l'ensemble raid 0x9?? et qu'il trouve
#       le D&Eacute;BUT du secteur d'amor&ccedil;age. Pour voir ce &agrave; quoi
#       cette entr&eacute;e sert r&eacute;ellement, lisez la documentation
#       incluse avec les sources de LILO.
#       Ce param&egrave;tre doit &ecirc;tre diff&eacute;rent de l'entr&eacute;e disk= 
#       ci-dessus. Il peut correspondre &agrave; un autre p&eacute;riph&eacute;rique mdx,
#       utilis&eacute; ou non et il ne doit pas forc&eacute;ment &ecirc;tre celui qui contient
#       le r&eacute;pertoire /boot
#       
     partition=/dev/md1

#       Le premier secteur de la partition contenant les informations de d&eacute;marrage
#       Le disque sur lequel LILO va &eacute;crire les informations de d&eacute;marrage
     boot=/dev/hda

#       Logiquement l&agrave; o&ugrave; LILO va mettre les informations de d&eacute;marrage
     map=/boot/map
     install=/boot/boot.b

#       Logiquement l&agrave; ou LILO va trouver l'image du noyau
     image=/boot/bzImage

#       Apr&egrave;s cela, indications standard
#       la racine peut &ecirc;tre un raid 1/4/5
     root=/dev/md0
     read-only
     label=LinuxRaid
</PRE>
</P>

<H2><A NAME="s4">4. Passage d'un syst&egrave;me non RAID &agrave; un raid 1/4/5</A></H2>

<P>Le passage &agrave; partir d'un syst&egrave;me non raid est une op&eacute;ration relativement
facile se composant des quelques &eacute;tapes ci-dessous. La description est
destin&eacute;e aux syst&egrave;mes avec une partition de boot, une partition racine et
une partition d'&eacute;change</P>
<P>
<PRE>
ancien disque dans le syst&egrave;me existant&nbsp;:

    /dev/hda1     boot, peut &ecirc;tre dos+loadlin ou lilo
    /dev/hda2     root
    /dev/hda3     swap
</PRE>

Nous allons ajouter un disque suppl&eacute;mentaire et convertir tout le syst&egrave;me en raid&nbsp;1.
Vous pouvez ais&eacute;ment ajouter plusieurs disques et faire un raid 5 en utilisant le
m&ecirc;me protocole.</P>

<H2><A NAME="ss4.1">4.1 &Eacute;tape 1 - Pr&eacute;paration d'un nouveau noyau</A>
</H2>

<P>T&eacute;l&eacute;chargez un noyau propre, raidtools-0.90 (ou une version plus r&eacute;cente), et
le correctif du noyau 0.90 pour le raid. </P>
<P>Compilez et installez raidtools, et lisez la documentation.</P>
<P>Compilez et installez le noyau
de mani&egrave;re &agrave; ce qu'il supporte tous les types (0/1/4/5 ?) de raid que vous allez utiliser.
Assurez-vous de bien sp&eacute;cifier l'auto-d&eacute;marrage des p&eacute;riph&eacute;riques raid lors de la configuration du noyau.
V&eacute;rifiez si le noyau d&eacute;marre bien et examinez /proc/mdstat pour voir si
les types de raid que vous allez utiliser sont bien pris en charge par le nouveau noyau</P>

<H2><A NAME="ss4.2">4.2 &Eacute;tape 2 - Mise en place de raidtab pour le nouveau raid</A>
</H2>

<P>Le nouveau disque va &ecirc;tre ajout&eacute; sur un contr&ocirc;leur IDE en p&eacute;riph&eacute;rique ma&icirc;tre,
il devient ainsi /dev/hdc</P>
<P>
<PRE>
    /dev/hdc1     16&nbsp;Mo -- largement suffisant pour plusieurs images de noyau
    /dev/hdc2     presque tout le disque
    /dev/hdc3     un peu plus d'espace pour la partition d'&eacute;change, si vous en avez
                  besoin, sinon, ajoutez le &agrave; hdc2
</PRE>
</P>
<P>changez le type de partition pour /dev/hdc1 et /dev/hdc2 en &#34;fd&#34; pour
auto-d&eacute;marrer le raid.</P>
<P>En utilisant le param&egrave;tre <B>failed-disk</B>, cr&eacute;ez un raidtab pour
la configuration raid d&eacute;sir&eacute;e. Le disque endommag&eacute; doit &ecirc;tre la derni&egrave;re
entr&eacute;e dans la table.</P>
<P>
<PRE>
# exemple de raidtab
# md0 est le noeud racine
raiddev                 /dev/md0
raid-level              1
nr-raid-disks           2
chunk-size              32
# disques de secours pour la reconstruction &agrave; chaud
nr-spare-disks          0
persistent-superblock   1
device                  /dev/hdc2
raid-disk               0
# ceci est notre vieux disque, marqu&eacute; comme non op&eacute;rationnel pour l'instant
device                  /dev/hda2
failed-disk             1

# md1 est le r&eacute;pertoire /boot
raiddev                 /dev/md1
raid-level              1
nr-raid-disks           2
chunk-size              32
# disques de secours pour la reconstruction &agrave; chaud
nr-spare-disks          0
persistent-superblock   1
device                  /dev/hdc1
raid-disk               0
# le disque hda1 est marqu&eacute; comme d&eacute;faillant
device                  /dev/hda1
failed-disk               1
</PRE>
</P>

<H2><A NAME="ss4.3">4.3 &Eacute;tape 3 - Cr&eacute;er, formater et param&eacute;trer un raid</A>
</H2>

<P>Cr&eacute;er le noeud md avec les commandes&nbsp;:
<PRE>
    mkraid /dev/md0
    mkraid /dev/md1
</PRE>
</P>
<P>Les p&eacute;riph&eacute;riques raid doivent &ecirc;tre cr&eacute;&eacute;s et lanc&eacute;s. L'examen de /proc/mdstat
montre les particularit&eacute;s du raid dans le noyau et les p&eacute;riph&eacute;riques raid
lanc&eacute;s.</P>
<P>Formatez les partitions d'amor&ccedil;age et la racine avec&nbsp;:
<PRE>
    mke2fs /dev/md0
    mke2fs /dev/md1
</PRE>

Montez la nouvelle partition racine &agrave; un endroit quelconque, puis cr&eacute;ez le r&eacute;pertoire /boot, et
montez la partition d'amor&ccedil;age.</P>
<P>
<PRE>
    mount /dev/md0 /mnt
    mkdir /mnt/boot
    mount /dev/md1 /mnt/boot
</PRE>
</P>

<H2><A NAME="ss4.4">4.4 &Eacute;tape 4 - Copie du syst&egrave;me d'exploitation courant sur le nouveau p&eacute;riph&eacute;rique raid</A>
</H2>


<P>Quelques temps apr&egrave;s...</P>
<P>
<PRE>
    cd /
    # pr&eacute;parez un script pour faire ce qui suit
    cp -a /bin /mnt
    cp -a /dev /mnt
    cp -a /etc /mnt
    cp -a (tous les r&eacute;pertoires sauf /mnt, /proc, et les montages NFS) /mnt
</PRE>
</P>
<P>Cette op&eacute;ration peut s'av&eacute;rer ardue si vous avez mont&eacute; ou li&eacute; d'autres disques 
sous votre racine. L'exemple ci-dessous prend en compte un syst&egrave;me tr&egrave;s simple.
Vous serez peut-&ecirc;tre amen&eacute; &agrave; modifier la proc&eacute;dure quelque part.</P>

<H2><A NAME="ss4.5">4.5 &Eacute;tape 5 - Testez votre nouveau RAID</A>
</H2>

<P>Cr&eacute;ez une disquette de d&eacute;marrage et un rdev sur le noyau.</P>
<P>
<PRE>
    dd if=kernal.image of=/dev/fd0 bs=2k
    rdev /dev/fd0 /dev/md0
    rdev -r /dev/fd0 0
    rdev -R /dev/fd0 1
</PRE>
</P>
<P>Modifiez le fichier fstab sur la partition raid pour affecter les nouveaux points de montage
comme suit&nbsp;:</P>
<P>
<PRE>
  /dev/md0        /       ext2    defaults        1 1
  /dev/md1        /boot   ext2    defaults        1 1
</PRE>
</P>
<P>D&eacute;montez les partitions raid et amorcez &agrave; partir du nouveau syst&egrave;me de fichiers pour v&eacute;rifier son fonctionnement</P>
<P>
<PRE>
    umount /mnt/boot
    umount /mnt
    raidstop /dev/md0
    raidstop /dev/md1
    shutdown -r now
</PRE>
</P>
<P>Votre syst&egrave;me raid devrait maintenant &ecirc;tre op&eacute;rationnel en mode d&eacute;grad&eacute; avec une disquette
de d&eacute;marrage. V&eacute;rifiez bien que vous avez tout transf&eacute;r&eacute; sur le nouveau raid
car, si vous ratez votre coup ici, sans sauvegarde, VOUS &Ecirc;TES MORT !</P>


<P>Si quelque chose ne fonctionne pas, red&eacute;marrez votre ancien syst&egrave;me, revenez en arri&egrave;re
et recommencez jusqu'&agrave; ce que cette &eacute;tape soit r&eacute;ussie, pour voir ce qui coince.</P>

<H2><A NAME="ss4.6">4.6 &Eacute;tape 6 - Int&eacute;gration de l'ancien disque dans le raid</A>
</H2>


<P>L'&eacute;tape pr&eacute;c&eacute;dente &eacute;tant r&eacute;ussie, votre raid est maintenant op&eacute;rationnel,
mais, il n'est  pas redondant. On doit maintenant re-partitionner le ou les vieux disques
pour les ajouter au raid. Rappelez-vous que si les g&eacute;om&eacute;tries ne sont pas les m&ecirc;mes, 
la taille de la partition sur l'ancien disque doit &ecirc;tre au moins &eacute;gale &agrave; la taille du raid
sinon ils ne peuvent pas &ecirc;tre ajout&eacute;s.</P>


<P>Re-partitionnez l'ancien disque. Exemple&nbsp;:</P>
<P>
<PRE>
    /dev/hda1     same or larger than /dev/hdc1
    /dev/hda2     same or larger than /dev/hdc2
    /dev/hda3     une petite place pour un swap ou je ne sais quoi...
</PRE>
</P>
<P>Changez le param&egrave;tre <B>failed-disk</B> dans le fichier raidtab en <B>raid-disk</B> et
ins&eacute;rez &agrave; chaud les nouvelles partitions (vieux disque) au raid.</P>
<P>
<PRE>
    raidhotadd /dev/md1 /dev/hda1
    raidhotadd /dev/md0 /dev/hda2
</PRE>
</P>
<P>L'examen de /proc/mdstat devrait nous indiquer un (ou plusieurs) p&eacute;riph&eacute;riques raid
en reconstruisant les donn&eacute;es pour les nouvelles partitions. Apr&egrave;s une minute ou deux... 
ou plus, le raid devrait &ecirc;tre totalement synchronis&eacute; (cela peut prendre pas mal de
temps pour une grande partition).</P>

<P>En utilisant la proc&eacute;dure des premi&egrave;res sections de ce document, pr&eacute;parez
un raid amor&ccedil;able sur la nouvelle paire de disques. Conservez le d&eacute;marrage par disquettes
tout pendant la mise au point et le test de cette derni&egrave;re &eacute;tape.</P>

<H2><A NAME="s5">5. Annexe A - Exemple de fichier raidtab</A></H2>

<P>Exemple de RAID&nbsp;1 d&eacute;crit dans la premi&egrave;re section de ce document</P>
<P>
<PRE>
 df
Filesystem           1k-blocks      Used Available Use% Mounted on
/dev/md0              19510780   1763188  16756484  10% /
/dev/md1                 15860       984     14051   7% /boot

# --------------------------

 fdisk -ul /dev/hda

Disk /dev/hda: 16 heads, 63 sectors, 39770 cylinders
Units = sectors of 1 * 512 bytes

   Device Boot    Start       End    Blocks   Id  System
/dev/hda1            63     33263     16600+  fd  Linux raid autodetect
/dev/hda2         33264    443519    205128   83  Linux native
/dev/hda3        443520  40088159  19822320   fd  Linux raid autodetect

# --------------------------

 fdisk -ul /dev/hdc

Disk /dev/hdc: 16 heads, 63 sectors, 39770 cylinders
Units = sectors of 1 * 512 bytes

   Device Boot    Start       End    Blocks   Id  System
/dev/hdc1            63     33263     16600+  fd  Linux raid autodetect
/dev/hdc2         33264    443519    205128   82  Linux swap
/dev/hdc3        443520  40088159  19822320   fd  Linux raid autodetect

# --------------------------

# md0 est le premier ensemble de disques, d'environ 20&nbsp;Go
raiddev                 /dev/md0
raid-level              1
nr-raid-disks           2
chunk-size              32
# Disque disponible pour la reconstruction &agrave; chaud
nr-spare-disks          0
persistent-superblock   1
device                  /dev/hda3
raid-disk               0
device                  /dev/hdc3
raid-disk               1

# md1 est l'ensemble de disques d'amor&ccedil;age (/boot), d'une taille d'environ 16&nbsp;Mo
raiddev                 /dev/md1
raid-level              1
nr-raid-disks           2
chunk-size              32
Disque pour la reconstruction &agrave; chaud
nr-spare-disks          0
persistent-superblock   1
device                  /dev/hda1
raid-disk               0
device                  /dev/hdc1
raid-disk               1

# --------------------------

# SECTION GLOBAL 
# p&eacute;riph&eacute;rique contenant /boot
disk=/dev/md0
# geometry
  bios=0x80
  sectors=63
  heads=16
  cylinders=39770
# dummy
  partition=/dev/md1
# d&eacute;but du disque ci-dessus
  start=63

boot=/dev/hda
map=/boot/map
install=/boot/boot.b

image=/boot/bzImage
root=/dev/md0
label=LinuxRaid
read-only

# -------------------------

# SECTION GLOBAL 
# p&eacute;riph&eacute;rique contenant /boot
disk=/dev/md0
# geometry
  bios=0x80
  sectors=63
  heads=16
  cylinders=39770
# dummy
  partition=/dev/md1
# d&eacute;but du disque ci-dessus
  start=63

boot=/dev/hdc
map=/boot/map
install=/boot/boot.b

image=/boot/bzImage
root=/dev/md0
label=LinuxRaid
read-only
</PRE>
</P>

<H2><A NAME="s6">6. Annexe B - Mise en oeuvre RAID&nbsp;5 SCSI de r&eacute;f&eacute;rence</A></H2>

<P>4 disques SCSI RAID&nbsp;5
<PRE>
 df
Filesystem           1k-blocks      Used Available Use% Mounted on
/dev/md0              11753770   2146076   9000678  19% /
/dev/md1                 15739       885     14042   6% /boot

# --------------------------

 fdisk -ul /dev/sda

Disk /dev/sda: 64 heads, 32 sectors, 4095 cylinders
Units = sectors of 1 * 512 bytes

   Device Boot    Start       End    Blocks   Id  System
/dev/sda1            32     32767     16368   fd  Linux raid autodetect
/dev/sda2         32768    292863    130048    5  Extended
/dev/sda3        292864   8386559   4046848   fd  Linux raid autodetect
/dev/sda5         32800    260095    113648   82  Linux swap
/dev/sda6        260128    292863     16368   83  Linux native - test

# ------------------------

 fdisk -ul /dev/sdb

Disk /dev/sdb: 64 heads, 32 sectors, 4095 cylinders
Units = sectors of 1 * 512 bytes

   Device Boot    Start       End    Blocks   Id  System
/dev/sdb1            32     32767     16368   fd  Linux raid autodetect
/dev/sdb2         32768    292863    130048    5  Extended
/dev/sdb3        292864   8386559   4046848   fd  Linux raid autodetect
/dev/sdb5         32800    260095    113648   82  Linux swap
/dev/sdb6        260128    292863     16368   83  Linux native - test

# ------------------------

# fdisk -ul /dev/sdc

Disk /dev/sdc: 64 heads, 32 sectors, 4095 cylinders
Units = sectors of 1 * 512 bytes

   Device Boot    Start       End    Blocks   Id  System
/dev/sdc2            32    292863    146416    5  Extended
/dev/sdc3        292864   8386559   4046848   fd  Linux raid autodetect
/dev/sdc5            64    260095    130016   83  Linux native - development
/dev/sdc6        260128    292863     16368   83  Linux native - test

# ------------------------

 fdisk -ul /dev/sdd

Disk /dev/sdd: 64 heads, 32 sectors, 4095 cylinders
Units = sectors of 1 * 512 bytes

   Device Boot    Start       End    Blocks   Id  System
/dev/sdd2            32    292863    146416    5  Extended
/dev/sdd3        292864   8386559   4046848   fd  Linux raid autodetect
/dev/sdd5            64    260095    130016   83  Linux native - development
/dev/sdd6        260128    292863     16368   83  Linux native - test

# --------------------------

# raidtab
#
raiddev /dev/md0
        raid-level      5
        nr-raid-disks   4
        persistent-superblock 1
        chunk-size      32

# Disque d&eacute;di&eacute; &agrave; la reconstruction &agrave; chaud
        nr-spare-disks  0
        device          /dev/sda3
        raid-disk       0
        device          /dev/sdb3
        raid-disk       1
        device          /dev/sdc3
        raid-disk       2
        device          /dev/sdd3
        raid-disk       3

# partition de d&eacute;marrage
#
raiddev /dev/md1
        raid-level      1
        nr-raid-disks   2
        persistent-superblock 1
        chunk-size      32

# Disque d&eacute;di&eacute; &agrave; la reconstruction &agrave; chaud
        nr-spare-disks  0
        device          /dev/sda1
        raid-disk       0
        device          /dev/sdb1
        raid-disk       1

# --------------------------

# cat lilo.conf.sda
# SECTION GLOBALE
# P&eacute;riph&eacute;rique contenant /boot
disk=/dev/md0
# geometry
  bios=0x80
  sectors=32
  heads=64
  cylinders=4095
# dummy
  partition=/dev/md1
# d&eacute;but du disque ci-dessus
  start=32

boot=/dev/sda
map=/boot/map
install=/boot/boot.b

image=/boot/bzImage
root=/dev/md0
label=LinuxRaid
read-only

# ------------------------
# cat lilo.conf.sdb
# SECTION GLOBALE
# P&eacute;riph&eacute;rique contenant /boot
disk=/dev/md0
# geometry
  bios=0x80
  sectors=32
  heads=64
  cylinders=4095 
# dummy
  partition=/dev/md1
# d&eacute;but du disque ci-dessus
  start=32

boot=/dev/sdb
map=/boot/map
install=/boot/boot.b

image=/boot/bzImage
root=/dev/md0
label=LinuxRaid
read-only
</PRE>
</P>

<H2><A NAME="s7">7. Annexe C - RAID&nbsp;10 IDE avec initrd</A></H2>


<P>RAID&nbsp;1 sur une paire de RAID&nbsp;0 d&eacute;coup&eacute;s en bandes... les disques du RAID&nbsp;0 ne sont pas 
de la m&ecirc;me taille, mais suffisamment proches.</P>
<P>
<PRE>
/dev/md0 est la partition /boot et est auto-d&eacute;marr&eacute;e par le noyau 
/dev/md1 et /dev/md3 sont les deux ensembles raid 0 auto-d&eacute;marr&eacute; par le noyau
/dev/md2 est la partition racine et est d&eacute;marr&eacute;e par initrd

df
Filesystem           1k-blocks      Used Available Use% Mounted on
/dev/md2                118531     76485     35925  68% /
/dev/md0                  1917      1361       457  75% /boot

# ----------------------------

 fdisk -ul /dev/hda

Disk /dev/hda: 4 heads, 46 sectors, 903 cylinders
Units = sectors of 1 * 512 bytes

   Device Boot    Start       End    Blocks   Id  System
/dev/hda1            46      4231      2093   fd  Linux raid autodetect
/dev/hda2          4232    166151     80960   fd  Linux raid autodetect

# ----------------------------

 fdisk -ul /dev/hdb

Disk /dev/hdb: 5 heads, 17 sectors, 981 cylinders
Units = sectors of 1 * 512 bytes

   Device Boot    Start       End    Blocks   Id  System
/dev/hdb1            17     83384     41684   fd  Linux raid autodetect

# ----------------------------

 fdisk -ul /dev/hdc

Disk /dev/hdc: 7 heads, 17 sectors, 1024 cylinders
Units = sectors of 1 * 512 bytes

   Device Boot    Start       End    Blocks   Id  System
/dev/hdc1            17     84013     41998+  fd  Linux raid autodetect
/dev/hdc2         84014    121855     18921   82  Linux swap

# ----------------------------

 fdisk -ul /dev/hdd

Disk /dev/hdd: 4 heads, 46 sectors, 903 cylinders
Units = sectors of 1 * 512 bytes

   Device Boot    Start       End    Blocks   Id  System
/dev/hdd1            46      4231      2093   fd  Linux raid autodetect
/dev/hdd2          4232    166151     80960   fd  Linux raid autodetect

# ----------------------------
                                                         
# raidtab
#
raiddev /dev/md0
        raid-level      1
        nr-raid-disks   2
        persistent-superblock   1
        chunk-size      8
        device          /dev/hda1
        raid-disk       0
        device          /dev/hdd1
        raid-disk       1

raiddev /dev/md1
        raid-level      0
        nr-raid-disks   2
        persistent-superblock   1
        chunk-size      8
        device          /dev/hdd2
        raid-disk       0
        device          /dev/hdb1
        raid-disk       1

raiddev /dev/md2
        raid-level      1
        nr-raid-disks   2
        persistent-superblock   1
        chunk-size      8
        device          /dev/md1
        raid-disk       0
        device          /dev/md3
        raid-disk       1

raiddev /dev/md3
        raid-level      0
        nr-raid-disks   2
        persistent-superblock   1
        chunk-size      8
        device          /dev/hda2
        raid-disk       0
        device          /dev/hdc1
        raid-disk       1

# ----------------------------

contenu de linuxrc

#cat linuxrc
#!/bin/sh
# ver 1.02 2-22-00
#
############# d&eacute;but de 'linuxrc' ###############
#
# montage du syst&egrave;me de fichiers proc
/bin/mount /proc

# d&eacute;part d'un raid 1 fait de raid 0
/bin/raidstart /dev/md2

# indique par la console ce qui se passe
/bin/cat /proc/mdstat

# Tout va bien, laissons le noyau monter /dev/md2
# Indique au noyau de consid&eacute;rer /dev/md2 comme la partition /root
# La valeur 0x900 est le num&eacute;ro de p&eacute;riph&eacute;rique calcul&eacute; avec&nbsp;:
# 256 * num&eacute;ro majeur de p&eacute;riph&eacute;rique + num&eacute;ro mineur de p&eacute;riph&eacute;rique
echo "/dev/md2 mont&eacute; comme racine"
echo 0x902>/proc/sys/kernel/real-root-dev

//# umount /proc to deallocate initrd device ram space
# D&eacute;monte /proc pour d&eacute;sallouer le disque virtuel (ramdisk) utilis&eacute; par initrd
/bin/umount /proc
exit

# ----------------------------

//contenus de initrd

./bin/ash
./bin/echo
./bin/raidstart
./bin/mount
./bin/umount
./bin/cat
./bin/sh
./dev/tty1
./dev/md0
./dev/md1
./dev/md2
./dev/md3
./dev/md4
./dev/console
./dev/hda
./dev/hda1
./dev/hda2
./dev/hda3
./dev/hdb
./dev/hdb1
./dev/hdb2
./dev/hdb3
./dev/hdc
./dev/hdc1
./dev/hdc2
./dev/hdc3
./dev/hdd
./dev/hdd1
./dev/hdd2
./dev/hdd3
./dev/initrd
./dev/ram0
./dev/ram1
./dev/ram2
./dev/ram3
./dev/ram4
./dev/ram5
./dev/ram6
./dev/ram7
./etc/raidtab
./etc/fstab
./lib/ld-2.1.2.so
./lib/ld-linux.so.1
./lib/ld-linux.so.1.9.9
./lib/ld-linux.so.2
./lib/ld.so
./lib/libc-2.1.2.so
./lib/libc.so.6
./linuxrc
./proc
</PRE>
</P>
<H2><A NAME="s8">8. Annexe D. - RAID&nbsp;1-10 ide avec initrd</A></H2>

<P>Ceci est un syst&egrave;me fait d'un assortiment de petites choses. Le raid mont&eacute;
sur la racine est compos&eacute; d'un RAID&nbsp;1 bas&eacute; sur un ensemble RAID&nbsp;0 contenant
des disques de toutes tailles et une partition plus large. 
Un examen du fichier lilo.conf vous donnera un meilleur aper&ccedil;u
sur la mani&egrave;re de raisonner sur les diff&eacute;rents param&egrave;tres.</P>
<P>
<PRE>
/dev/md0 est la partition /boot et est amorc&eacute;e par le noyau
/dev/md1 est une moiti&eacute; du miroir md2, amorc&eacute;e automatiquement par le noyau
/dev/hda3 est l'autre moiti&eacute; du miroir md2
/dev/md2 est le RAID&nbsp;1 /dev/md1 + /dev/hda3, d&eacute;marr&eacute; par initrd

df
Filesystem           1k-blocks      Used Available Use% Mounted on
/dev/md2                138381     74421     56815  57% /
/dev/md0                  2011      1360       549  71% /boot

# ----------------------------

 fdisk -ul /dev/hda

Disk /dev/hda: 8 heads, 46 sectors, 903 cylinders
Units = sectors of 1 * 512 bytes

   Device Boot    Start       End    Blocks   Id  System
/dev/hda1            46      4415      2185   fd  Linux raid autodetect
/dev/hda2          4416     43423     19504   82  Linux swap
/dev/hda3         43424    332303    144440   83  Linux native

# ----------------------------

 fdisk -ul /dev/hdc

Disk /dev/hdc: 8 heads, 39 sectors, 762 cylinders
Units = sectors of 1 * 512 bytes

   Device Boot    Start       End    Blocks   Id  System
/dev/hdc1            39      4367      2164+  fd  Linux raid autodetect
/dev/hdc2          4368     70199     32916   82  Linux swap
/dev/hdc3         70200    237743     83772   fd  Linux raid autodetect

# ----------------------------

 fdisk -ul /dev/hdd

Disk /dev/hdd: 4 heads, 39 sectors, 762 cylinders
Units = sectors of 1 * 512 bytes

   Device Boot    Start       End    Blocks   Id  System
/dev/hdd1            39    118871     59416+  fd  Linux raid autodetect

# ----------------------------

# raidtab
#
raiddev /dev/md0
        raid-level      1
        nr-raid-disks   2
        persistent-superblock   1
        chunk-size      8
        device          /dev/hdc1
        raid-disk       1
        device          /dev/hda1
        raid-disk       0

raiddev /dev/md1
        raid-level      0
        nr-raid-disks   2
        persistent-superblock   1
        chunk-size      8
        device          /dev/hdc3
        raid-disk       0
        device          /dev/hdd1
        raid-disk       1

raiddev /dev/md2
        raid-level      1
        nr-raid-disks   2
        persistent-superblock   1
        chunk-size      8
        device          /dev/md1
        raid-disk       1
        device          /dev/hda3
        raid-disk       0

# ----------------------------

 cat linuxrc
#!/bin/sh
# ver 1.02 2-22-00
#
############# d&eacute;but de 'linuxrc' ###############
#
# montage du syst&egrave;me de fichiers proc
/bin/mount /proc

# autostart /boot partition and raid0
# auto-d&eacute;marrage de la partition /boot et du RAID&nbsp;0
/bin/raidstart /dev/md2

# Renvoit sur la console ce qui se passe
/bin/cat /proc/mdstat

# Tout va bien, laissons le noyau monter /dev/md2
# On indique au noyau de monter /dev/md2 sur la racine
# La valeur 0x900 est le num&eacute;ro de p&eacute;riph&eacute;rique calcul&eacute; par&nbsp;:
#  256 * num&eacute;ro majeur de p&eacute;riph&eacute;rique + num&eacute;ro mineur de p&eacute;riph&eacute;rique
echo "/dev/md2 mont&eacute; comme racine"
echo 0x902 > /proc/sys/kernel/real-root-dev

# d&eacute;montage de /proc pour d&eacute;sallouer le ramdisk utilis&eacute; par initrd
/bin/umount /proc
exit

# ----------------------------

contenu de initrd.gz

./bin
./bin/ash
./bin/echo
./bin/raidstart
./bin/mount
./bin/umount
./bin/cat
./bin/sh
./dev/tty1
./dev/md0
./dev/md1
./dev/md2
./dev/md3
./dev/console
./dev/hda
./dev/hda1
./dev/hda2
./dev/hda3
./dev/hdc
./dev/hdc1
./dev/hdc2
./dev/hdc3
./dev/hdd
./dev/hdd1
./dev/hdd2
./dev/hdd3
./dev/initrd
./dev/ram0
./dev/ram1
./dev/ram2
./dev/ram3
./dev/ram4
./dev/ram5
./dev/ram6
./dev/ram7
./etc/raidtab
./etc/fstab
./lib/ld-2.1.2.so
./lib/ld-linux.so.1
./lib/ld-linux.so.1.9.9
./lib/ld-linux.so.2
./lib/ld.so
./lib/libc-2.1.2.so
./lib/libc.so.6
./linuxrc
./proc

# ----------------------------

 cat lilo.conf.hda
# SECTION GLOBALE 
# p&eacute;riph&eacute;rique contenant le r&eacute;pertoire /boot
disk=/dev/md2
# geom&eacute;trie
  bios=0x80
  cylinders=903
  heads=8
  sectors=46
# g&eacute;om&eacute;trie pour le 2e disque
# le bios doit &ecirc;tre le m&ecirc;me car il doit &ecirc;tre transf&eacute;r&eacute; sur hda
#  cylinders=762
#  heads=8
#  sectors=39

# dummy
  partition=/dev/md0
# d&eacute;but du p&eacute;riph&eacute;rique « disque » ci-dessus
  start=46
# second p&eacute;riph&eacute;rique
#  start=39

# il appara&icirc;t quelques probl&egrave;mes avec le noyau 2.2.14
# pour l'attribution de la bonne IRQ
  append = "ide1=0x170,0x376,12 ether=10,0x300,eth0 ether=5,0x320,eth1"

boot=/dev/hda
map=/boot/map
install=/boot/boot.b

initrd=/boot/initrd.gz

image=/boot/zImage
root=/dev/md2
label=LinuxRaid
read-only

# ----------------------------

 cat lilo.conf.hdc
# SECTION GLOBALE
# p&eacute;riph&eacute;rique contenant le r&eacute;pertoire /boot
disk=/dev/md2
# geometry
  bios=0x80
#  cylinders=903
#  heads=8
#  sectors=46
# g&eacute;om&eacute;trie du deuxi&egrave;me disque
# le bios doit &ecirc;tre le m&ecirc;me car il doit &ecirc;tre transf&eacute;r&eacute; sur hda
  cylinders=762
  heads=8
  sectors=39

# dummy
  partition=/dev/md0
# d&eacute;but du p&eacute;riph&eacute;rique "disk" ci-dessus
#  start=46
# deuxi&egrave;me p&eacute;riph&eacute;rique
  start=39

# il peut y avoir quelques probl&egrave;mes avec le noyau 2.2.14 pour l'attribution de la bonne IRQ
  append = "ide1=0x170,0x376,12 ether=10,0x300,eth0 ether=5,0x320,eth1"

boot=/dev/hdc
map=/boot/map
install=/boot/boot.b

initrd=/boot/initrd.gz

image=/boot/zImage
root=/dev/md2
label=LinuxRaid
read-only
</PRE>
</P>

<H2><A NAME="s9">9. Traduction</A></H2>


<P>Cette traduction a &eacute;t&eacute; r&eacute;alis&eacute;e par Julien Savary &lt;c POINT legranblon CHEZ tiscali POINT fr&gt; et
relue par Jean-Paul Aubry &lt;rigolom CHEZ yahoo POINT com POINT au&gt;.</P>
<P>La publication de ce document a &eacute;t&eacute; pr&eacute;par&eacute;e par Jean-Philippe Gu&eacute;rard
&lt;fevrier CHEZ tigreraye POINT org&gt;.</P>

</BODY>
</HTML>
