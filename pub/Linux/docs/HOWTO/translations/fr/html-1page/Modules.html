<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<HEAD>
 <META NAME="GENERATOR" CONTENT="LinuxDoc-Tools 0.9.21">
 <TITLE> Mini-howto Modules</TITLE>
</HEAD>
<BODY>
<H1> Mini-howto Modules</H1>

<H2><CODE>rhw@bigfoot.com</CODE></H2> date ?
<HR>
<EM>Vendredi 14 janvier 1998.
traduit par Frédéric Gacquer <CODE>gacquer@neuronnexion.fr</CODE></EM>
<HR>
<H2><A NAME="s1">1. But de ce document</A></H2>

<P>Les documents existants sur linux et les modules n'ont pas réussi à me 
fournir une explication
satisfaisante comme par exmple la façon d'installer linux avec succès avec les 
modules configurés et opérationnels. La procédure expliquée dans ce 
document a été utilisée avec succès plusieurs fois, aussi bien sur
mon propre système que sur Internet pour donner des indications à
quelqu'un essayant de faire fontionner un élément qui requiert un
driver fourni seulement sous forme de module.</P>
<P>Mon prope système a été installé à partir d'une distribution 
linux Redhat 4.1, et ce fut lors de cette installation que j'ai 
développé cette procédure. Je l'ai installée depuis avec succès
sur plusieurs systèmes avec la distribution slackware, et sur un
système avec une distribution Debian. La procédure qui permet de 
configurer correctement les modules sous linux pour ces trois distributions
est dans ce document.</P>

<H2><A NAME="s2">2. AVERTISSEMENT</A></H2>

<P>J'ai récemment utilisé la même procédure avec la RedHat 4.2,
mais avec des résultats contradictoires sur des systèmes 
apparement identiques. Je n'ai PAS encore déterminé quel est
le problème, et ne peut donc PAS garantir aujourd'hui
que cela va ou non fonctionner sur votre système.</P>

<H2><A NAME="s3">3. Prérequis</A></H2>

<P>Avant d'appliquer les étapes de ce document, le
lecteur DOIT avoir installé linux pour que l'on  
puisse se connecter en tant que root, car la majorité 
des étapes impliquées ne peuvent être entreprises que par le 
dit utilisateur.</P>

<P>Le noyau existant peut être compilé soit pour utiliser les
modules soit pour ne pas les utiliser. Il peut même afficher 
des messages d'erreurs pendant le démarrage du système 
signalent les modules configurés qui ne sont pas disponible pour 
l'instant, pourvu que la condition ci-dessus soit remplie.</P>

<P>L'emplacement du source du noyau en cours est supposée se
trouver à la racine <CODE>/usr/src/linux</CODE> qui est supposé
être le répertoire courant, au travers de ce document, de 
n'importe quelle commande qui en est issue.</P>

<H2><A NAME="s4">4. Accélérer la compilation</A></H2>

<P>Si votre machine a 16 méga ou plus de RAM, on peut accélérer
utilement les choses  en permettant de
compiler plusieurs modules en parallèle. Cela augmentera 
la charge cpu de la machine pendant la recompilation du noyau
mais réduira le temps pendant lequel la compilation 
s'effectuera.</P>
<P>Avant d'utiliser cette méthode, vous devez vérifier
la quantité de RAM présente dans votre machine, car si vous l'avez
estimée trop grande, la compilation va en fait être moins rapide.
L'expérience a montrée que la valeur optimum dépend de la quantité 
de RAM dans votre système selon la formule suivante, au moins pour
les systèmes qui ont jusqu'à 32 Mo de RAM, même si elle est applicable
aux systèmes avec une plus grande quantité de RAM:</P>
<P>
<BLOCKQUOTE><CODE>
<PRE>
N= [RAM en Mo] / 8 + 1
</PRE>
</CODE></BLOCKQUOTE>
</P>

<P>Pour ceux qui n'aime pas les maths, les valeurs pour
les quantités courante de RAM sont :</P>
<P>La valeur à utiliser avec 
<UL>
<LI> 16 Mo 3 </LI>
<LI> 24 Mo 4 </LI>
<LI> 32 Mo 5 </LI>
<LI> 40 Mo 6</LI>
<LI> 48 Mo 7 </LI>
<LI> 56 Mo 8 </LI>
<LI> 64 Mo 9 </LI>
<LI> 80 Mo 11 </LI>
<LI> 96 Mo 13 </LI>
<LI> 112 Mo 15 </LI>
<LI> 128 Mo 17</LI>
</UL>
</P>
<P>Quand vous avez choisi la valeur correcte, éditer le fichier 
<CODE>/usr/src/linux/Makefile</CODE> et trouver la ligne :</P>
<P>
<BLOCKQUOTE><CODE>
<PRE>
MAKE=make
</PRE>
</CODE></BLOCKQUOTE>
</P>
<P>La remplacer par:</P>
<P>
<BLOCKQUOTE><CODE>
<PRE>
MAKE=make -j N
</PRE>
</CODE></BLOCKQUOTE>
</P>
<P>où N est le nombre calculé précédemment.</P>

<H2><A NAME="s5">5. Recompiler le noyau avec les modules</A></H2>

<P>Le noyau peut être reconfiguré pour utiliser les modules pour tout
sauf le système de fichier monté root (dans la plupart des cas, c'est
le système de fichier ext2).</P>
<P>Cependant, il y a certains éléments qui semble difficle à installer
proprement en tant que modules, aussi je propose de 
compiler dans le noyau:</P>
<P>
<UL>
<LI> Les pilotes des cartes ethernet</LI>
<LI> Les pilotes des CDROMs SCSI.</LI>
</UL>
</P>

<P>D'autre part, il y a certaines combinaisons de pilotes qui ne 
fonctionne QUE comme module, particulièrement la combinaison d'un 
ou plusieurs des groupes suivants :</P>
<P>
<UL>
<LI> L'imprimante parallèle</LI>
<LI> Un pilote de port parallèle, comme le lecteur Zip de IOMEGA ou le
lecteur Jazz, ou le CDROM de chez BackPack, et</LI>
<LI> Le démon PLIP</LI>
</UL>
</P>

<P>Vous aurez à décider de ce qui sera compilé dans le noyau, ou 
comme module, en prenant en compte les points cités ci-dessus.
Les vrais choix seront fait durant la compilation, au moment de la séquence 
d'instructions suivante :</P>
<P>
<BLOCKQUOTE><CODE>
<PRE>
   cd /usr/src/linux
   make menuconfig
   make dep clean modules modules_install zImage
</PRE>
</CODE></BLOCKQUOTE>
</P>

<P>Après cela, les dépendances de modules doivent être référencées. C'est
accompli par les commandes suivantes:</P>
<P>
<BLOCKQUOTE><CODE>
<PRE>
   depmod -a
</PRE>
</CODE></BLOCKQUOTE>
</P>

<P>Maintenant le nouveau noyau a besoin d'être inséré dans la séquence 
d'initialisation du boot. Je vais supposer que le lecteur utilise LILO
dans ce but, puisque c'est le seul gestionnaire de boot que j'ai 
utilisé.</P>

<P>Je recommande que le nouveau noyau ne soit pas inséré comme étant le
noyau linux par défaut car s'il plante, il sera
extrêmement difficile de récupérer le setup linux sans refaire une 
complète réinstallation, ce qui n'est pas recommandé. Pour cette raison,
j'ai les entrées suivantes dans mon fichier <CODE>/etc/lilo.conf</CODE> :</P>

<P>
<BLOCKQUOTE><CODE>
<PRE>
   image=/usr/src/linux/arch/i386/boot/zImage
      label=new
      alias=n
      read-only
      vga=ask
      optional
</PRE>
</CODE></BLOCKQUOTE>
</P>

<P>Cette entrée indique qu'il y a une OPTION de boot 
(ignorée si l'image en question n'existe pas) qui charge le fichier
<CODE>/boot/newlinux</CODE> s'il est sélectionné, et permet de sélectionner le mode
vidéo dans lequel il sera exécuté.</P>

<P>Supposant l'existence de l'entrée ci-dessus dans <CODE>/etc/lilo.conf</CODE> le noyau
modifié est sauvegardé au bon endroit à la fin de la compilation, et il 
peut être installé via les commandes suivantes:</P>
<P>
<BLOCKQUOTE><CODE>
<PRE>
   lilo
</PRE>
</CODE></BLOCKQUOTE>
</P>

<P>Ayant fait cela, le lecteur a besoin de suivre les étapes suivantes
qui dépendent de la distribution choisie :</P>
<P>
<UL>
<LI> Configurer Debian ou la Redhat pour les modules</LI>
<LI> Configurer la Slackware pour les modules</LI>
<LI> Configurer les autres distributions pour les modules</LI>
</UL>
</P>

<H2><A NAME="ss5.1">5.1 Configurer Debian ou la Redhat pour les modules</A>
</H2>

<P>Avant la prise en compte des opérations décrites ici, celles listées
dans "Recompiler le noyau" pour les modules sont supposées réalisées. </P>

<P>La distribution Debian et la Redhat ont des procédures de boot identiques,
et ont aussi des procédures identiques pour configurer les modules inclus.</P>

<P>1. vous étant connecté root, utiliser votre éditeur de texte favori pour
créer un nouveau fichier appelé <CODE>/etc/rc.d/init.d/modules.init</CODE> avec le 
contenu suivant :</P>

<P>
<BLOCKQUOTE><CODE>
<PRE>
   # Initialisation des modules
   #
   # Démarrer démon d'auto-chargement des modules
   /sbin/kerneld

   # Monter toutes les partitions courantes auto-montables non montées
   /sbin/mount -a
</PRE>
</CODE></BLOCKQUOTE>
</P>

<P>2. Ayant créé le fichier ci-dessus, exécuter les étapes suivantes alors 
que vous êtes connecté root:</P>

<P>
<BLOCKQUOTE><CODE>
<PRE>
   cd /etc/rc.d
   chmod 755 init.d/*
   cd rc3.d
   ln -s ../init.d/modules.init 05modules.init
</PRE>
</CODE></BLOCKQUOTE>
</P>

<P>Le système peut être relancé, les modules sont alors implémentés.</P>


<H2><A NAME="ss5.2">5.2 Configurer la Slackware pour les modules</A>
</H2>

<P>Avant la prise en compte des opérations décrites ici, celles listées
dans "Recompiler le noyau" pour les modules sont supposées réalisées. </P>
<P>1- Le fichier <CODE>/etc/rc.d/rc.M</CODE> doit être éditer comme suit :</P>
<P>
<UL>
<LI> Aux alentours de la ligne 18, il y a une section du style :
         
<BLOCKQUOTE><CODE>
<PRE>
   # Screen blanks after 15 minutes idle time.
   /bin/setterm -blank 15
         
</PRE>
</CODE></BLOCKQUOTE>

<P>Juste après, insérer le paragraphe suivant, avec les traditionnelles
lignes blanches au dessus et en dessous:</P>
<P>
<BLOCKQUOTE><CODE>
<PRE>
   # Charger le chargeur automatique de module noyau
   /sbin/kerneld
         
</PRE>
</CODE></BLOCKQUOTE>
</P>

</LI>
<LI> A peut près 12 lignes plus loin il y a ce qui suit :

<BLOCKQUOTE><CODE>
<PRE>
   # if there is no /etc/HOSTNAME, fall back on this default:
   Immediately prior to this, insert the following paragraph, again
   with the usual blank lines either side of it:
            
   # Mount remaining unmounted auto-mount drives.
   /sbin/mount -a
         
</PRE>
</CODE></BLOCKQUOTE>
</LI>
</UL>
</P>

<P>Quand ces changements ont été fait, sauver le fichier.
Aucun changement supplémentaire n'est requis pour la Slackware.</P>


<H2><A NAME="ss5.3">5.3 Configurer les autres distributions pour les modules</A>
</H2>

<P>Avant la prise en compte des opérations décrites ici, celles listées
dans "Recompiler le noyau" pour les modules sont supposées réalisées. </P>
<P>La procédure précise pour les autres distributions n'a pas été 
déterminée, mais il s'agit probablement d'une de celle citées plus haut. Pour 
déterminer laquelle, afficher le contenu du répertoire <CODE>/etc/rc.d</CODE>,
comme suit:</P>

<P>
<BLOCKQUOTE><CODE>
<PRE>
   cd /etc/rc.d
   ls -l *.d rc.*
</PRE>
</CODE></BLOCKQUOTE>
</P>

<P>A partir du résultat, vous pouvez choisir une des trois options 
suivantes:</P>
<P>
<UL>
<LI> Si cette liste inclu un répertoire nommé <CODE>init.d</CODE> et quelques 
répertoires dont les noms correspondent à <CODE>rc?.d</CODE> (où le point
d'interrogation remplace un caractère unique), et n'inclu
PAS un fichier nommé <CODE>rc.M</CODE>, cette distribution peut être
configurée pour les modules en suivant la procédure 
pour les distributions Debian et redhat.
</LI>
<LI> Si cette liste n'inclu pas un répertoires appelé <CODE>init.d</CODE> mais
inclu un fichier appelé <CODE>rc.M</CODE> alors la distribution peut être 
configurée pour les modules en suivant la procédure 
pour la distribution slackware.
</LI>
<LI> Si à cette liste ne correspond aucun des critères ci-dessus, 
la distribution à un script de boot qui n'est pas présenté dans cet 
Howto. Dans ce cas, vous êtes invités à contacter l'auteur de ce 
document pour conseils.</LI>
</UL>
</P>


<H2><A NAME="s6">6. Copyright et Loi</A></H2>

<P>Ce document est couvert par les termes de la Licence Générale Publique
GNU (GPL), dont tous les termes et limitations s'appliquent.</P>

<P>L'auteur peut être contacté par email à 
<CODE>
<A HREF="mailto://rhw@bigfoot.com">rhw@bigfoot.com</A></CODE></P>


</BODY>
</HTML>
