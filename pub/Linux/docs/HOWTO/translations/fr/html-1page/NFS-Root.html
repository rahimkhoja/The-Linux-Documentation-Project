<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML>
<HEAD>
 <META NAME="GENERATOR" CONTENT="LinuxDoc-Tools 0.9.21">
 <TITLE>NFS-Root Mini-HowTo</TITLE>
</HEAD>
<BODY>
<H1>NFS-Root Mini-HowTo</H1>

<H2>par Andreas Kostyrka, <CODE>andreas@ag.or.at</CODE></H2>Version 8, 8 Août 1997
<HR>
<EM>(Adaptation française par Eric Dumas <CODE>dumas@Linux.EU.Org</CODE>).
        Ce mini HowTo présente comment configurer une station <B>Linux</B> "sans" disque, qui monte sa racine
via NFS. La dernière version de ce mini HowTo peut toujours être
trouvée et récupérée sur le site <CODE>ftp://sunsite.unc.edu/pub/Linux/docs/HOWTO/mini/NFS-Root</CODE>,
ou sur n'importe quel miroir près de chez vous.</EM>
<HR>
<H2><A NAME="s1">1. Copyright</A></H2>


<P>&copy; 1996 Andreas Kostyrka (<CODE>e9207884@student.tuwien.ac.at</CODE> ou
<CODE>andreas@ag.or.at</CODE>)</P>
<P>Sauf indication contraire, les documents HowTo <B>Linux</B> sont 
copyrightés
par leurs auteurs respectifs. Les documents HowTo <B>Linux</B> peuvent être
reproduits et diffusés d'une manière complète ou partielle, sur n'importe
quel support, qu'il soit physique ou électronique, du moment où ce
copyright se trouve sur toutes les copies. Les diffusions commerciales 
sont autorisées et même encouragées. Toutefois, l'auteur aimerait
bien être averti de ce genre de distributions.</P>
<P>Toute traduction, travail dérivé, ou travaux plus généraux incluant
n'importe quel document HowTo <B>Linux</B> doit être protégé par 
ce copyright. De cette manière, vous ne pouvez pas créer un document
dérivant d'un HowTo et imposer des restrictions supplémentaires sur sa
distribution. Des exceptions à ces règles peuvent être  accordées
sous certaines conditions. Contactez dans ce cas le coordinateur
des HowTo <B>Linux</B> à l'adresse qui vous sera donnée à la fin de cette
section.</P>
<P>En résumé, nous souhaitons promouvoir la diffusion de ces informations
à travers le maximum de moyens de communications. Toutefois, nous 
souhaitons absolument conserver un copyright sur ces documents, et
nous voulons être consultés pour toute redistribution des HowTos.</P>
<P>Si vous avez des questions, contactez alors <EM>Andreas Kostyrka</EM>
<CODE>andreas@ag.or.at</CODE>, l'auteur de ce mini-HOWTO, ou <EM>Greg
Hankins</EM>, le coordinateur des HowTo pour <B>Linux</B>, 
<CODE>gregh@sunsite.unc.edu</CODE> par courrier électronique.</P>

<H2><A NAME="ss1.1">1.1 Contributeurs</A>
</H2>


<P>
<UL>
<LI> <EM>Avery Pennarun</EM> (<CODE>apenwarr@foxnet.net</CODE>) :
comment amorcer la machine sans LILO ;</LI>
<LI>Ofer Maor (<CODE>ofer@hadar.co.il</CODE>) : a écrit un mini-HowTo bien
meilleur pour configurer les stations de travail ne possédant pas de disque ;</LI>
<LI> Christian Leutloff (<CODE>leutoff@sundancer.tng.oche.de</CODE>) : informations
sur netboot.</LI>
</UL>
</P>

<H2><A NAME="s2">2. Présentation générale</A></H2>


<P>En général, on peut rencontrer les problèmes suivants concernant 
une station de travail :
<UL>
<LI>elle doit récupérer sa propre adresse IP, et si besoin,
également le reste de la configuration Éthernet ;
</LI>
<LI>elle doit connaître le serveur NFS et le chemin de montage
de sa partition racine.</LI>
</UL>
</P>
<P>L'implémentation actuelle de <EM>NFSROOT</EM> dans le
noyau <B>Linux</B> (à partir de la version 1.3.7x) autorise
les "solutions" suivantes :
<UL>
<LI>l'adresse IP peut être trouvée par RARP, ou la configuration 
Éthernet complète peut être passée au noyau via des paramètres 
à LILO ou LOADLIN ;
</LI>
<LI>le chemin NFS pour monter la partition peut être passé au noyau
via des paramètres. Si cela n'est pas fait, alors le noyau suppose que
le serveur RARP est également le serveur NFS, et utilise le 
chemin par défaut (le chemin par défaut est codé en dur dans le 
noyau : <CODE>/tftpboot/</CODE><EM>adresse-IP de la machine</EM>.).
</LI>
<LI>la configuration du client peut être trouvée par BOOTP.</LI>
</UL>
</P>
<P>Avant de commencer à configurer un environnement sans disque, vous
devez décider si vous allez amorcer la machine en utilisant LILO ou 
LOADLIN. L'avantage de les utiliser est la souplesse. L'inconvénient est
la rapidité. Amorcer un noyau <B>Linux</B> sans LILO est plus rapide. </P>

<H2><A NAME="s3">3. Configurer le serveur</A></H2>



<H2><A NAME="ss3.1">3.1 Compiler les noyaux</A>
</H2>


<P>Inclure le support RARP dans le noyau du serveur est sûrement une très 
bonne idée. Vous devez absolument l'inclure si vous allez amorcer sans 
donner des paramètres au noyau. D'un autre côté, cela ne vous aidera
pas vraiment si le client n'est pas sur le même sous réseau que le serveur.</P>
<P>Le noyau de la station de travail doit posséder les éléments
suivant au minimum :
<UL>
<LI>système de fichiers NFS inclu (ce n'est pas la peine de compiler 
le système de fichiers ext2 : un module suffira) ;
</LI>
<LI> "Root on NFS" doit être activé ;
</LI>
<LI>le gestionnaire Éthernet pour la carte réseau de la station doit être
inclue dans le noyau ;</LI>
<LI>en fonction de vos besoin, il est possible que vous ayez à inclure 
les protocoles RARP ou BOOTBP pour Nfs-Root (voir les questions posées lors
de la configuration du noyau après avoir activé NFS).</LI>
</UL>
</P>
<P>Si la station de travail sera amorcée sans aucun paramètre passé au
noyau, vous devez également fixer le périphérique de la <EM>racine</EM> à 
<CODE>0:255</CODE>. Pour faire cela, il suffit de créer un fichier 
de périphérique avec : </P>
<P><CODE>mknod /dev/nfsroot b 0 255</CODE>.</P>
<P>Après avoir crée un tel fichier de périphérique, vous pouvez
fixer le périphérique racine pour l'image du noyau avec :</P>
<P><CODE>rdev</CODE><EM>image-noyau</EM> <CODE>/dev/nfsroot</CODE>.</P>

<H2><A NAME="ss3.2">3.2 Création du système de fichiers racine</A>
</H2>



<H3>Copier le système de fichiers</H3>


<P>Attention : bien ces instructions peuvent très bien fonctionner chez vous,
elles ne sont peut être pas très bien adaptées dans un environnement
de production. Consultez le mini-HowTo NFS-Root-Client de Ofer Maor 
(<CODE>ofer@hadar.co.il</CODE>) pour une meilleur solution.</P>
<P>Après avoir décidé où placer la racine de l'arborescence, 
il suffit de la créer avec par exemple :</P>
<P><CODE>mkdir -p </CODE><EM>répertoire</EM></P>
<P>et </P>
<P><CODE>tar cClf / - | tar xpCf </CODE><EM>répertoire</EM> <CODE>-</CODE>.</P>
<P>Si votre noyau s'amorce sans LILO, alors la racine 
doit être <CODE>/tftpboot/</CODE><EM>adresse-IP</EM>. Si cela
ne vous plait pas, il suffit de le changer dans le fichier Makefile
dans les sources du noyau. Recherchez et modifiez la ligne 
<CODE>NFS_ROOT = -DNFS_ROOT</CODE>. Si vous modifiez cela, vous devrez 
alors recompiler le noyau.</P>

<H3>Changer la racine du système de fichiers</H3>


<P>Maintenant, supprimez les fichiers inutiles et vérifiez les 
scripts situés dans <CODE>/etc/rc.d</CODE>. Certains points sont 
vitaux : 
<UL>
<LI>il est important que le périphérique <CODE>eth0</CODE> soit configuré. 
La station de travaille
est lancée avec une interface <CODE>eth0</CODE> au moins configurée
partiellement. Donner comme adresse IP à la station l'adresse
du serveur n'est pas vraiment une chose vraiment intelligente 
à faire (comme cela est arrivé une fois à l'auteur lors de ses
essais...).
</LI>
<LI> un autre point important concerne le fichier <CODE>/etc/fstab</CODE> de la 
station de travail. Il doit être configuré pour 
des systèmes de fichiers nfs.
</LI>
<LI> ATTENTION : ne mélangez pas la racine du système de fichiers situé
sur le serveur la racine du système de fichiers de la station 
de travail (j'ai déjà patché un fichier <CODE>rc.inet1</CODE> sur le
serveur et je me demandais pourquoi la station de travail ne fonctionnait
toujours pas.).</LI>
</UL>
</P>

<H3>Exporter le système de fichiers</H3>


<P>Exporter le répertoire racine de la station de travail. Consultez
la page de manuel <CODE>exports(5)</CODE>. Vous devriez également
relancer les démons <CODE>nfsd</CODE> et <CODE>mountd</CODE> après 
ces modifications. Avec la RedHat, vous pouvez effectuer très simplement
cette opération en lançant <CODE>/etc/rc.d/init.d/nfs stop</CODE>
puis <CODE>/etc/rc.d/init.d/nfs start</CODE>.</P>

<H3>Configuration RARP</H3>


<P>Configurer le serveur RARP quelque part sur le réseau. Si vous 
amorcez sans un paramètre <EM>nfsroot</EM>, le serveur 
RARP doit également être un serveur NFS. En principe,
ce sera le cas. Pour cela, vous devrez utiliser un noyau possédant
le support RARP.</P>
<P>Pour réaliser cette opération, lancez (et insérez-le quelque part 
dans un fichier <CODE>/etc/rc.d</CODE> du serveur !) :</P>
<P><CODE>/sbin/rarp -s </CODE><EM>adresse-ip adresse-matériel</EM></P>
<P>où 
<UL>
<LI> <EM>adresse-ip</EM> : est l'adresse IP de la station de travail ;</LI>
<LI> <EM>adresse-matériel</EM> : est l'adresse Éthernet de la carte
réseau de la station de travail.</LI>
</UL>

Par exemple : <CODE>/sbin/rarp -s 131.131.90.200 00:00:c0:47:10:12</CODE></P>
<P>Vous pouvez également utiliser un nom symbolique à la place de l'adresse
IP, du moment où le serveur est capable de trouver l'adresse IP 
(fichier <CODE>/etc/hosts</CODE> ou résolution par le DNS).</P>

<H3>Configuration de BOOTP</H3>


<P>Pour configurer BOOTP, vous devrez éditer le fichier <CODE>/etc/bootptab</CODE>.
Consultez les pages de manuel <EM>bootpd(8)</EM> et <EM>bootptab(5)</EM>.</P>

<H3>Trouver les adresses matérielles</H3>


<P>Je ne connais pas l'adresse de la carte ! Comment la trouver ?</P>
<P>
<UL>
<LI> amorcez avec la disquette de boot, et regardez la ligne où
votre carte réseau est identifiée. Elle contient normalement 
six octets en hexadécimal, qui devraient normalement correspondre
à l'adresse de la carte.</LI>
<LI> amorcez la station avec un système d'exploitation qui 
utilise TCP/IP. Ensuite, lancez un <CODE>ping</CODE> depuis le serveur
sur la station. Regardez enfin le cache ARP en exécutant 
<CODE>/sbin/arp -a</CODE>.</LI>
</UL>
</P>

<H2><A NAME="s4">4. Amorcer la station de travail</A></H2>



<H2><A NAME="ss4.1">4.1 Utiliser une ROM bootable</A>
</H2>


<P>Comme je ne l'ai pas utilisé par moi-même, je ne peut donc
vous donner que les conseils suivants (merci à Christian Leutloff,
<CODE>leutloff@sundancer.tng.oche.de</CODE>).
<UL>
<LI>utiliser des bootroms "normale" ;</LI>
<LI>utiliser le paquetage <CODE>netboot</CODE> écrit par Gero Kuhlmann,
et qui est disponibles pour Linux, avec des informations supplémentaires.
netboot est récupérable sur les miroirs Linux, ou dans le paquetage 
de la Debian (<CODE>netboot-0.4</CODE>).</LI>
<LI>lire attentivement la documentation fournie avec votre bootrom ;</LI>
<LI>vous devrez probablement à activer le démon <CODE>tftpd</CODE> sur votre
serveur, mais cela dépend un peu de la manière dont votre bootrom charge
le noyau ;</LI>
<LI> toute information concernant les vendeurs de bootrom pour Linux sont
les bienvenues,
étant donné que tout le monde n'a pas forcément accès à un grossiste en prom
(tout spécialement en Europe, puisque c'est là où je suis) </LI>
</UL>
</P>

<H2><A NAME="ss4.2">4.2 Utiliser simplement une disquette</A>
</H2>


<P>Si vous avez exporté la racine du système de fichier avec un nom correcte
et que votre serveur NFS est également le serveur RARP (ce qui implique
que les deux machines soient sur le même sous-réseau), alors il suffit 
tout simplement d'amorcer la machine en utilisant un noyau qui aura été
copié sur la disquette (par exemple avec <CODE>cat</CODE>). Vous devez
fixer le périphérique racine dans le noyau à 0:255. Cela suppose au préalable
que le répertoire racine sur le serveur soit <CODE>/tftpboot/IP-Address</CODE> (cette
valeur peut être modifée en recompilant le noyay).</P>

<H2><A NAME="ss4.3">4.3 Utiliser un <EM>bootloader</EM> et RARP</A>
</H2>


<P>Donnez au noyau tous les paramètres nécessaire lorsque vous souhaitez  
amorcer la machine, et ajoutez :</P>
<P><CODE>nfsroot=</CODE><EM>adresse-ip-serveur</EM><CODE>:</CODE><EM>/chemin d'accès</EM></P>
<P>où <EM>adresse-ip-serveur</EM> est l'adresse IP du serveur NFS et 
<EM>/chemin d'accès</EM> est le chemin d'accès au répertoire racine.</P>
<P>Quelques astuces :
<UL>
<LI> lorsque vous utilisez LILO, pensez à utiliser la caractéristique
"lock". Tapez une seule fois correctement tous les paramètres et
ajoutez "lock". La prochaine fois que vous amorcerez la machine,
LILO lancera un timeout directement et amorcera la machine sans plus 
attendre.
</LI>
<LI> lorsque vous générez une disquette d'amorçage spécifique à une 
station, vous pouvez également utiliser l'option  <CODE>append=</CODE>
dans le fichier <CODE>lilo.conf</CODE>.</LI>
</UL>
</P>

<H2><A NAME="ss4.4">4.4 Utiliser un <EM>bootloader</EM> sans RARP</A>
</H2>


<P>En plus de <CODE>nfsroot</CODE>, il est nécessaire de donner en argument
au noyau :</P>
<P><CODE>nfsaddrs=</CODE><EM>wst-IP</EM><CODE>:</CODE><EM>srv-IP</EM><CODE>:</CODE>
<EM>gw-IP</EM><CODE>:</CODE><EM>netm-IP</EM><CODE>:</CODE><EM>nommachine</EM></P>
<P>Le noyau va alors configurer <CODE>eth0</CODE> avec les paramètres 
donnés :
<UL>
<LI>wst-IP : adresse IP de la machine ;</LI>
<LI>srv-IP : adresse IP du serveur NFS ;</LI>
<LI>gw-IP  : adresse IP de la passerelle ; </LI>
<LI>netm-IP : masque réseau ;</LI>
<LI>nommachine : nom de la machine.</LI>
</UL>
</P>

<H2><A NAME="s5">5. Problèmes connus</A></H2>



<H2><A NAME="ss5.1">5.1 /sbin/init ne se lance pas</A>
</H2>


<P>Un problème fréquent avec <CODE>/sbin/init</CODE> est que certaines distributions
récentes sont fournies avec une version du programme <CODE>init</CODE> 
dynamiquement lié. Donc, vous devez fournir une configuration
correcte concernant le répertoire <CODE>/lib</CODE> au client. Une solution
assez simple consiste à remplacer /sbin/init (pour le client) 
par un programme statiquement lié "Hello World". De cette manière,
vous pouvez déterminer si c'est bien la cause du problème, ou bien
un problème plus grave.</P>

<H2><A NAME="ss5.2">5.2 Problèmes avec le répertoire /dev</A>
</H2>


<P>Lors de l'amorçage de la machine, si vous obtenez tout un tas de messages
d'erreurs concernant les ttys, vous devriez alors lancer un 
<CODE>MAKEDEV</CODE> sur le client dans le répertoire <CODE>/dev</CODE>.
Certaines rumeurs font part que cela ne fonctionne pas avec certains
serveurs qui utilisent des numéros de périphériques codés sur 64 bits.
Contactez-moi si vous avez ce genre de problème. Une solution possible
consiste à créer un petit disque mapé en méoire (ram disc) contenant 
le répertoire <CODE>/dev</CODE> et de réinstaller les i-noeuds des périphériques
à chaque fois.</P>

<H2><A NAME="s6">6. Pour plus de renseignements...</A></H2>


<P>
<UL>
<LI>il existe un client <CODE>BOOTP</CODE> : 
<EM>ftp://sunsite.unc.edu/system/Network/admin/bootpc.v045.tgz</EM>.

Avec <CODE>initrd</CODE> (inclus dans Linux 2.0), cela devrait fonctionner
assez simplement pour les stations sans disque. Ce démon est en fait
un choix judicieux surtout si vous avez besoin d'une configuration
particulière.
</LI>
<LI>Pour les amorçages basés sur bootpd, cela n'est pas vraiment nécessaire
puisque Linux 2.0 contient également l'option d'utiliser BOOTP au lieu de
RARP. Pour être plus précis, vous pouvez inclure les deux options
dans le noyau lors de sa configuration, et la réponse la plus rapide
sera celle choisie.
</LI>
<LI>dans le répertoire <CODE>Documentation</CODE> des sources du noyau, vous pourrez y trouver
un fichier documentant les systèmes NFS-Root ;
</LI>
<LI>il existe un patch quelque part qui permet de swapper <EM>via</EM> NFS.
On me l'a envoyé (durant une période très surchargée), mais j'ai comme qui 
dirait perdu le mail...</LI>
</UL>
</P>
<P>Vous le trouverez probablement sur le site <CODE>http://www.linuxhq.com/</CODE>&lt;
dans la partie "patches non-officiels".</P>
<P>Ma clef PGP publique peut être consultée en effectuant un finger
à l'adresse <CODE>andreas@ag.or.at</CODE>. Il s'agit de :
<PRE>
F1 F7 43 D5 07 C4 6C 87  BF 6B 33 A2 2C EE 5A F9
</PRE>
</P>

</BODY>
</HTML>
