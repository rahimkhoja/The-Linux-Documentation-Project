<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML>
<HEAD>
 <META http-equiv="Content-Type" content="text/html; charset=koi8-r">
 <META NAME="GENERATOR" CONTENT="lfparser_2.50">
 <META NAME="LFCATEGORY" CONTENT="SoftwareDevelopment">
 <link rel="icon" href="../../common/images/lf-16.png" type="image/png">
 <TITLE>lf371, SoftwareDevelopment: Оптимизация C/C++ приложений с помощью GProf</TITLE>
<style type="text/css">
<!--
 td.top {font-family: Arial,Geneva,Verdana,Helvetica,sans-serif; font-size:12 }
 pre { font-family:monospace,Courier }
 pre.code { font-family:monospace,Courier;background-color:#aedbe8; }
 p.cl { color:#EE9500 }
 table.left { margin-right:0.3cm }
 a.nodec { text-decoration:none }
 p.trans { font-size:8pt; text-align:right }
 p.clbox { width:50%; alignment:center; background-color:#FFD700; 
           border-style:none; border-width:medium; border-color:#FFD700; 
           padding:0.5cm;  text-align:center }
 p.code { width:80%; alignment:center; background-color:#aedbe8; 
          border-style:none; border-width:medium; border-color:#aedbe8; 
          padding:0.1cm;  text-align:left }
 p.foot { background-color:#AAAAAA; color:#FFFFFF; border-style:none; 
          border-width:medium; border-color:#AAAAAA; padding:0.5cm ; 
          margin-top:0.1cm; margin-right:1cm; margin-left:1cm; 
          text-align:center }
 div.tbbutton {
   background: #ddd;
   border-right: 1px solid #aaa;
   border-bottom: 1px solid #aaa;
   margin: 2px 5px 2px 5px;
   text-align: center;
   width: 20em;
   line-height: 1.2em;
   padding: 2px;
   font-size: 12px;
   white-space: nowrap;
   color: #555;
 }
 div.bbutton {
   background: #ddd;
   border-right: 1px solid #aaa;
   border-bottom: 1px solid #aaa;
   float: left;
   margin: 2px 5px 2px 5px;
   text-align: center;
   line-height: 1.2em;
   padding: 2px;
   font-size: 12px;
   white-space: nowrap;
   color: #555;
 }
-->
</style>
 
</HEAD>
<BODY bgcolor="#ffffff" text="#000000">
 <!-- this is generated html code. NEVER use this file for your
 translation work. Instead get the file with the same article number
 and .meta.shtml in its name. Translate this meta file and then
 use lfparser program to generate the final article -->
 <!-- lfparser can be obtained from http://main.linuxfocus.org/~guido/dev/lfparser.html -->

<!-- this is used by a number of tools:
 =LF=AUTHOR: Arnout Engelen
 =LF=CAT___: SoftwareDevelopment
 =LF=TITLE_: Оптимизация C/C++ приложений с помощью GProf
 =LF=NUMBER: 371
 =LF=ANAME_: article371.shtml
 =LF=PARSER: 2.50
 -->

<!-- 2pdaIgnoreStart -->

<!-- start navegation bar, current, style=2 -->
 <!-- top navegation bar -->
 <TABLE summary="topbar_1" cellspacing="0" cellpadding="0" border="0" align="center" width="90%">
   <TR bgcolor="#2e2292">
     <TD class="top"><TABLE summary="topbar_1_logo" cellspacing="0" cellpadding="0" border="0" width=
       "100%">
         <TR><TD width="319"><a href="../../index.shtml"><IMG src="../../common/images/logolftop_319x45.gif"
           alt="[LinuxFocus-icon]" width="319" height="45" align="left" 
           border="0"></a></TD>

           <TD class="top">
             <TABLE summary="topbar_1_links" width="100%">
               <TR align="right">
                 <TD class="top">
                 
                 <A class="nodec" href="../../index.shtml"><FONT color=
                 "#DDDDDD" size="2">&lt;--</FONT></A> &nbsp;| 
                 <A class="nodec" href="../map.html"><FONT color=
                 "#DDDDDD" size="2">Карта</FONT></A> &nbsp;| 
                 <A class="nodec" href="../indice.html"><FONT color=
                 "#DDDDDD" size="2">Индекс</FONT></A> &nbsp;| 
                 <A class="nodec" href="../Search/index.shtml"><FONT color=
                 "#DDDDDD" size="2">Поиск</FONT></A> </TD>
                 
               </TR>

               <TR align="right">
                 <TD class="top">
                   <HR width="100%" noshade size="1">
                 </TD>
               </TR>
             </TABLE>
           </TD>
         </TR>
       </TABLE>
     </TD>
   </TR>
 </TABLE>
 <!-- end top navegation bar -->
 <!-- blue bar -->
 <TABLE summary="topbar_2" cellspacing="0" cellpadding="0" border="0" align="center"
 width="90%">
   <TR bgcolor="#00ffff">
     <TD><IMG src="../../common/images/transpix.gif" width="1" height=
     "2" alt=""></TD>
   </TR>
 </TABLE>
 <!-- end blue bar -->
 <!-- bottom navegation bar -->
 <TABLE summary="topbar_3" cellspacing="0" cellpadding="0" border="0" align="center"
 width="94%">
   <TR bgcolor="#000000">
     <TD>
       <TABLE summary="topbar_3_links" cellspacing="0" cellpadding="1" border="0" width=
       "100%">
         <TR align="center">
           <TD WIDTH="20%"><A class="nodec" href="../News/index.shtml"><FONT color=
           "#FFFFFF">Новости</FONT></A> </TD>
           <TD WIDTH="5%"><FONT color="#FFFFFF">|</FONT> </TD>
           <TD WIDTH="20%"><A class="nodec" href="../Archives/"><FONT color=
           "#FFFFFF">Архивы</FONT></A> </TD>
           <TD WIDTH="5%"><FONT color="#FFFFFF">|</FONT> </TD>
           <TD WIDTH="20%"><A class="nodec" href="../Links/index.shtml"><FONT color=
           "#FFFFFF">Ссылки</FONT></A> </TD>
           <TD WIDTH="5%"><FONT color="#FFFFFF">|</FONT> </TD>
           <TD WIDTH="20%"><A class="nodec" href="../aboutus.html"><FONT color=
           "#FFFFFF">Про LF</FONT></A> </TD>
         </TR>
       </TABLE>
     </TD>
   </TR>
 </TABLE>
 <!-- end bottom navegation bar -->
<!-- stop navegation bar -->

<!-- SSI_INFO -->

<!-- tr_staticssi include virtual -->
<!-- tr_staticssi exec cmd -->
<!-- addedByLfdynahead ver 1.5 --><TABLE ALIGN="right" border=0><TR><TD ALIGN="right"><FONT SIZE="-1" FACE="Arial,Helvetica">эта страница доступна на следующих языках: <A href="../../English/March2005/article371.shtml">English</a> &nbsp;<A href="../../ChineseGB/March2005/article371.shtml">ChineseGB</a> &nbsp;<A href="../../Deutsch/March2005/article371.shtml">Deutsch</a> &nbsp;<A href="../../Francais/March2005/article371.shtml">Francais</a> &nbsp;<A href="../../Russian/March2005/article371.shtml">Russian</a> &nbsp;</FONT></TD></TR></TABLE><br>
 


<!-- SSI_INFO STOP -->
<!-- 2pdaIgnoreStop -->

<!-- SHORT_BIO_ABOUT_THE_AUTHOR_AND_INDEX_START -->
<TABLE ALIGN="LEFT" BORDER="0" WIDTH="195" summary="about the author" class="left">
<TR>
<TD>

<IMG SRC="../../common/images2/ArnoutEngelen.png" ALT="Arnout Engelen" width="164" height="200">
<BR>автор  Arnout Engelen <br> <small>&lt;arnouten(Q)bzzt.net&gt;</small>
<BR><BR>
<I>Об авторе:</I><BR>
<!-- aboutauthor_start -->
<P>
Arnout Engelen учится в Университете Неймегена (Нидерланды) и работает в компании
TUNIX специализирующейся на безопасности в интернет. В свободное время он занимается
бегом и играет на саксофоне.
</P>
<!-- aboutauthor_stop -->
<!-- TRANSLATED_TO ru -->
<BR><BR><I>Перевод на Русский:</I><BR>
Pukhlyakov Kirill <small>&lt;kirill(at)linuxfocus.org&gt;</small>
<br>
<!--
 =LF=TRANSTO=ru: Pukhlyakov Kirill
-->
<!-- TRANSLATED_TO_STOP -->
<!-- INDEX_START -->
<BR><i>Содержание</i>:
<UL>
  <LI><A HREF="#371lfindex0">Кратко о профилировании</A></LI>
  <LI><A HREF="#371lfindex1">Использование Pathalizer</A></LI>
  <LI><A HREF="#371lfindex2">Синхронизация приложения</A></LI>
  <LI><A HREF="#371lfindex3">Профилирование</A></LI>
  <LI><A HREF="#371lfindex4">Оптимизация</A></LI>
  <LI><A HREF="#371lfindex5">Результат</A></LI>
  <LI><A HREF="#371lfindex6">Вторая попытка</A></LI>
  <LI><A HREF="#371lfindex7">Другие C/C++ профайлеры</A></LI>
  <LI><A HREF="#371lfindex8">Профилирование других языков</A></LI>
  <LI><A HREF="#371lfindex9">Вывод</A></LI>
  <LI><A HREF="#371lfindex10">Ссылки</A></LI>
  <LI><A HREF="http://cgi.linuxfocus.org/cgi-bin/lftalkback?anum=371">Страница отзывов</A></LI>
</UL>

</TD></TR></TABLE>
<!-- INDEX_STOP -->
<!-- SHORT_BIO_ABOUT_THE_AUTHOR_AND_INDEX_STOP -->
<!-- HEAD_OF_THE_ARTICLE_START -->
<br>&nbsp;
<table border="0"><tr><td>
<H2>Оптимизация C/C++ приложений с помощью GProf</H2>
 <IMG SRC="../../common/images2/article371/profilingpicture.png" ALT="Profiling with GProf" HSPACE=10 width="400" height="63">
<!-- ABSTRACT OF THE ARTICLE -->
<P><i>Резюме</i>:
<P>
<!-- articleabstract_start -->

Если вы решили оптимизировать приложение сначала подумайте есть ли смысл проводить
часы оптимизируя код, который выполняется в течение 0.04 секунды.
<p>
GProf предоставляет простой путь профилирования ваших C/C++ приложений и определения
интересных участков кода. В процессе изучения будет показано как использовался GProf
для уменьшения времени выполнения реального приложения с 3-х минут до 5-ти секунд,
с помощью идентификации и оптимизации 2-х структур данных.
<p>
История приложения берет свое начало в 1982 году, когда оно было представлено на
SIGPLAN Symposium on Compiler Construction. В настоящее время это стандартный инструмент
практически для всех разновидностей UNIX.

<!-- articleabstract_stop -->

<br><!-- HR divider --><center><font color="#8282e0"><b>_________________ _________________ _________________</b></font></center><br>
</td></tr></table>
<!-- HEAD_OF_THE_ARTICLE_STOP -->
<!-- BODY_OF_THE_ARTICLE_START -->


<A NAME="371lfindex0">&nbsp;</A>
<H2>Кратко о профилировании</H2>


Концепция профилирования достаточно проста: фиксирование момента входа программы в функцию и
выхода из нее, что позволяет проанализировать какой участок кода выполняется дольше всего.
Может создаться впечатление, что сбор подобной информации достаточно трудоемкий процесс -
но это не так! Всего навсего необходимо использовать ключ -pg компилятора gcc ( для сбора
этих данных ) и затем запустить 'gprof' для анализа получившегося файла.

<A NAME="371lfindex1">&nbsp;</A>
<H2>Использование Pathalizer</H2>


В качестве примера возьмем реальное приложение, входящее в
<a href="http://pathalizer.bzzt.net">pathalizer</a>: приложение <code>event2dot</code>
преобразует pathalizer 'events' файл в графический 'dot' файл.
<p>
Кратко о работе приложения - данные читаются из файла и сохраняются отдельными
частями и затем все собиратся в один большой график, который можно распечатать.

<A NAME="371lfindex2">&nbsp;</A>
<H3>Синхронизация приложения</H3>

Сначала приложение, которое мы хотим оптимизировать запускаем без профилирования и
фиксируем время выполнения. Используемые примеры и файлы с данными ( 55000 строк )
предоставляются.
<p>
На моем компьютере <code>event2dot</code> работает около 3-х минут, обрабатывая эти
данные.
<pre class="code">
real    3m36.316s
user    0m55.590s
sys     0m1.070s
</pre>

<A NAME="371lfindex3">&nbsp;</A>
<H3>Профилирование</H3>

Профилирование включается опцией '-pg' во время компиляции. Перекомпилируем приложение:
<pre class="code">
g++ -pg dotgen.cpp readfile.cpp main.cpp graph.cpp config.cpp -o event2dot
</pre>
<p>
Опять запустим <code>event2dot</code>. Во время исполнения требуемая информация
будет помещена в файл 'gmon.out'. Можно посмотреть полученные данные следующей
командой 'gprof <code>event2dot</code> | less'.
<p>
gprof показывает, что следующие функции представляют для нас интерес:
<pre class="code">
 % cumulative  self              self     total
 time seconds  seconds  calls s/call s/call name
43.32   46.03  46.03 339952989  0.00  0.00 CompareNodes(Node *,Node *)
25.06   72.66  26.63    55000   0.00  0.00 getNode(char *,NodeListNode *&amp;)
16.80   90.51  17.85 339433374  0.00  0.00 CompareEdges(Edge *,AnnotatedEdge *)
12.70  104.01  13.50    51987   0.00  0.00 addAnnotatedEdge(AnnotatedGraph *,Edge *)
 1.98  106.11   2.10    51987   0.00  0.00 addEdge(Graph *,Node *,Node *)
 0.07  106.18   0.07        1   0.07  0.07 FindTreshold(AnnotatedEdge *,int)
 0.06  106.24   0.06        1   0.06 28.79 getGraphFromFile(char *,NodeListNode *&amp;,Config *)
 0.02  106.26   0.02        1   0.02 77.40 summarize(GraphListNode *,Config *)
 0.00  106.26   0.00    55000   0.00  0.00 FixName(char *)
</pre>

Наиболее интересная для нас колонка - первая: она отображает количество времени, которое
приложение выполняло ту или иную функцию в процентном соотношении.

<A NAME="371lfindex4">&nbsp;</A>
<H3>Оптимизация</H3>


Анализируя полученные данные мы видим, что практически половина времени уходит на выполнение
функции <code>CompareNodes</code>. Эта функция вызывается только функцией <code>CompareEdges</code>,
которая в свою очередь вызывается только <code>addAnnotatedEdge</code> - обе кстати тоже
присутствуют в списке. Подумаем об оптимизации.

<p>
В функции <code>addAnnotatedEdge</code> просматривается связанный список ( linked list ).
Несмотря на простоту использования, это не лучший способ хранения данных. Меняем g-&gt;edges
на бинарное дерево ( binary tree ), что обеспечит более быстрый поиск.

<A NAME="371lfindex5">&nbsp;</A>
<H3>Результат</H3>

Как видно время исполнения уменьшилось:
<pre class="code">
real    2m19.314s
user    0m36.370s
sys     0m0.940s
</pre>

<A NAME="371lfindex6">&nbsp;</A>
<H3>Вторая попытка</H3>

Запускаем опять gprof и смотрим:
<pre class="code">
%   cumulative self           self    total
 time   seconds seconds calls  s/call  s/call name
87.01     25.25  25.25  55000    0.00    0.00 getNode(char *,NodeListNode *&amp;)
10.65     28.34   3.09  51987    0.00    0.00 addEdge(Graph *,Node *,Node *)
</pre>

Видно, что функции, которые занимали более половины времени выполнения приложения, теперь
выполняются гораздо быстрее! Попробуем еще - заменим использование
NodeList на NodeHashTable.
<p>
Это хорошее улучшение кода:
<pre class="code">
real    0m3.269s
user    0m0.830s
sys     0m0.090s
</pre>

<A NAME="371lfindex7">&nbsp;</A>
<H2>Другие C/C++ профайлеры</H2>


<img src="../../common/images2/article371/shot.png" align="right" width="565" height="337">
Кроме рассмотренного нами существует еще несколько профайлеров использующих данные gprof,
например <a href="http://kprof.sf.net">KProf</a> ( скриншот ) и
<a href="http://mvertes.free.fr/">cgprof</a>. Несмотря на то, что графические приложения
выглядят более привлекательно, я считаю более удобным gprof, работающий из командной строки.
<br clear="all">

<A NAME="371lfindex8">&nbsp;</A>
<H2>Профилирование других языков</H2>


Мы рассмотрели профилирование C/C++ приложений с помощью gprof, также подобные вещи можно
делать и для других языков программирования : для Perl используйте модуль Devel::DProf.
Запустите ваше приложение следубщим образом :<code>perl -d:DProf mycode.pl</code> и
смотрите результаты с помощью <code>dprofpp</code>. Если вы скомпилируете свое Java приложение
с помощью gcj вы сможете использовать gprof, но заметим что в настоящее время поддерживается
только однопотоковый Java код.

<A NAME="371lfindex9">&nbsp;</A>
<H2>Вывод</H2>


Используя профилирование несложно найти участки приложения, подлежащие оптимизации. В
рассмотренном нами примере мы уменьшили время работы приложения с 3m36 до 5 секунд.

<A NAME="371lfindex10">&nbsp;</A>
<H2>Ссылки</H2>

<ul>
<li>Pathalizer:   <a
href="http://pathalizer.sf.net">http://pathalizer.sf.net</a><br><br>
<li>KProf:        <a
href="http://kprof.sf.net">http://kprof.sf.net</a><br><br>
<li>cgprof:       <a
href="http://mvertes.free.fr">http://mvertes.free.fr</a><br><br>
<li>Devel::DProf  <a
href="http://www.perldoc.com/perl5.8.0/lib/Devel/DProf.html">http://www.perldoc.com/perl5.8.0/lib/Devel/DProf.html</a><br><br>
<li>gcj:          <a
href="http://gcc.gnu.org/java">http://gcc.gnu.org/java</a><br><br>
<li>: pathalizer example files:         <a href="../../common/src2/article371/index.html">download for article371</a><br><br>
</ul>


<!-- vim: set sw=2 ts=2 et tw=74: -->

<!-- BODY_OF_THE_ARTICLE_STOP -->
<!-- 2pdaIgnoreStart -->
<A NAME="talkback">&nbsp;</a>
<h2>Страница отзывов</h2>
У каждой заметки есть страница отзывов. На этой странице вы можете оставить 
свой комментарий или просмотреть комментарии других читателей 
<center>
    <table width="250" border=0><tr><td>
    <div class="tbbutton"><A class="nodec" href="http://cgi.linuxfocus.org/cgi-bin/lftalkback?anum=371">&nbsp;talkback page&nbsp;</a></div>
    </td></tr></table>
</center>

<br clear="all">
<HR size="2" noshade>
<table width="250" border=0><tr><td>
<div class="bbutton"><a class="nodec" href="../../index.shtml">&lt;--, LF Домой</a></div>
</td><td>
<div class="bbutton"><a class="nodec" href="index.shtml">перейти к начальной странице выпуска</a></div>
</td></tr></table>
<br clear="all">
<HR size="2" noshade>
<!-- ARTICLE FOOT -->
<CENTER><TABLE WIDTH="98%" summary="footer">
<TR><TD ALIGN=CENTER BGCOLOR="#bdc6d5" WIDTH="50%">
<A HREF="../../common/lfteam.html">Webpages maintained by the LinuxFocus Editor team</A>
<BR><FONT COLOR="#1111aa"><a href="../../common/copy.html">&copy; Arnout Engelen</a><br>&quot;some rights reserved&quot; see <a href="../../license/index.shtml">linuxfocus.org/license/</a><br><a href="http://www.linuxfocus.org">http://www.LinuxFocus.org</a></FONT>
</TD>
<TD BGCOLOR="#bdc6d5">
<!-- TRANSLATION INFO -->
<font size=2>Translation information:</font>
<TABLE summary="translators">
  <tr><td><font size="2">en --&gt; -- : Arnout Engelen <small>&lt;arnouten(Q)bzzt.net&gt;</small></font></td></tr>
  <tr><td><font size="2">en --&gt; ru: Pukhlyakov Kirill &lt;kirill(at)linuxfocus.org&gt;</font></td></tr>
</TABLE>
</TD>
</TR></TABLE></CENTER>
<p><font size=1>2005-07-14, generated by lfparser version 2.50</font></p>
<!-- 2pdaIgnoreStop -->
</BODY>
</HTML>
