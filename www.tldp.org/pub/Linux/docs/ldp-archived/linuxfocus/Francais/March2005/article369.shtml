<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML>
<HEAD>
 <META http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
 <META NAME="GENERATOR" CONTENT="lfparser_2.52">
 <META NAME="LFCATEGORY" CONTENT="Hardware">
 <link rel="icon" href="../../common/images/lf-16.png" type="image/png">
 <TITLE>lf369, Hardware: Un thermom&egrave;tre digital ou parler « I2C » &agrave; votre microcontroleur atmel -- deuxi&egrave;me partie</TITLE>
<style type="text/css">
<!--
 td.top {font-family: Arial,Geneva,Verdana,Helvetica,sans-serif; font-size:12 }
 pre { font-family:monospace,Courier }
 pre.code { font-family:monospace,Courier;background-color:#aedbe8; }
 p.cl { color:#EE9500 }
 table.left { margin-right:0.3cm }
 a.nodec { text-decoration:none }
 p.trans { font-size:8pt; text-align:right }
 p.clbox { width:50%; alignment:center; background-color:#FFD700; 
           border-style:none; border-width:medium; border-color:#FFD700; 
           padding:0.5cm;  text-align:center }
 p.code { width:80%; alignment:center; background-color:#aedbe8; 
          border-style:none; border-width:medium; border-color:#aedbe8; 
          padding:0.1cm;  text-align:left }
 p.foot { background-color:#AAAAAA; color:#FFFFFF; border-style:none; 
          border-width:medium; border-color:#AAAAAA; padding:0.5cm ; 
          margin-top:0.1cm; margin-right:1cm; margin-left:1cm; 
          text-align:center }
 div.tbbutton {
   background: #ddd;
   border-right: 1px solid #aaa;
   border-bottom: 1px solid #aaa;
   margin: 2px 5px 2px 5px;
   text-align: center;
   width: 20em;
   line-height: 1.2em;
   padding: 2px;
   font-size: 12px;
   white-space: nowrap;
   color: #555;
 }
 div.bbutton {
   background: #ddd;
   border-right: 1px solid #aaa;
   border-bottom: 1px solid #aaa;
   float: left;
   margin: 2px 5px 2px 5px;
   text-align: center;
   line-height: 1.2em;
   padding: 2px;
   font-size: 12px;
   white-space: nowrap;
   color: #555;
 }
-->
</style>
 
</HEAD>
<BODY bgcolor="#ffffff" text="#000000">
 <!-- this is generated html code. NEVER use this file for your
 translation work. Instead get the file with the same article number
 and .meta.shtml in its name. Translate this meta file and then
 use lfparser program to generate the final article -->
 <!-- lfparser can be obtained from http://main.linuxfocus.org/~guido/dev/lfparser.html -->

<!-- this is used by a number of tools:
 =LF=AUTHOR: Guido Socher
 =LF=CAT___: Hardware
 =LF=TITLE_: Un thermom&egrave;tre digital ou parler « I2C » &agrave; votre microcontroleur atmel -- deuxi&egrave;me partie
 =LF=NUMBER: 369
 =LF=ANAME_: article369.shtml
 =LF=PARSER: 2.52
 -->

<!-- 2pdaIgnoreStart -->

<!-- start navegation bar, current, style=2 -->
 <!-- top navegation bar -->
 <TABLE summary="topbar_1" cellspacing="0" cellpadding="0" border="0" align="center" width="90%">
   <TR bgcolor="#2e2292">
     <TD class="top"><TABLE summary="topbar_1_logo" cellspacing="0" cellpadding="0" border="0" width=
       "100%">
         <TR><TD width="319"><a href="../../index.shtml"><IMG src="../../common/images/logolftop_319x45.gif"
           alt="[LinuxFocus-icon]" width="319" height="45" align="left" 
           border="0"></a></TD>

           <TD class="top">
             <TABLE summary="topbar_1_links" width="100%">
               <TR align="right">
                 <TD class="top">
                 
                 <A class="nodec" href="../../index.shtml"><FONT color=
                 "#DDDDDD" size="2">&lt;--</FONT></A> &nbsp;| 
                 <A class="nodec" href="../map.html"><FONT color=
                 "#DDDDDD" size="2">Carte</FONT></A> &nbsp;| 
                 <A class="nodec" href="../indice.html"><FONT color=
                 "#DDDDDD" size="2">Index</FONT></A> &nbsp;| 
                 <A class="nodec" href="../Search/index.html"><FONT color=
                 "#DDDDDD" size="2">Recherche</FONT></A> </TD>
                 
               </TR>

               <TR align="right">
                 <TD class="top">
                   <HR width="100%" noshade size="1">
                 </TD>
               </TR>
             </TABLE>
           </TD>
         </TR>
       </TABLE>
     </TD>
   </TR>
 </TABLE>
 <!-- end top navegation bar -->
 <!-- blue bar -->
 <TABLE summary="topbar_2" cellspacing="0" cellpadding="0" border="0" align="center"
 width="90%">
   <TR bgcolor="#00ffff">
     <TD><IMG src="../../common/images/transpix.gif" width="1" height=
     "2" alt=""></TD>
   </TR>
 </TABLE>
 <!-- end blue bar -->
 <!-- bottom navegation bar -->
 <TABLE summary="topbar_3" cellspacing="0" cellpadding="0" border="0" align="center"
 width="94%">
   <TR bgcolor="#000000">
     <TD>
       <TABLE summary="topbar_3_links" cellspacing="0" cellpadding="1" border="0" width=
       "100%">
         <TR align="center">
           <TD WIDTH="20%"><A class="nodec" href="../News/index.shtml"><FONT color=
           "#FFFFFF">Nouvelles</FONT></A> </TD>
           <TD WIDTH="5%"><FONT color="#FFFFFF">|</FONT> </TD>
           <TD WIDTH="20%"><A class="nodec" href="../Archives/index.html"><FONT color=
           "#FFFFFF">Archives</FONT></A> </TD>
           <TD WIDTH="5%"><FONT color="#FFFFFF">|</FONT> </TD>
           <TD WIDTH="20%"><A class="nodec" href="../Links/index.html"><FONT color=
           "#FFFFFF">Liens</FONT></A> </TD>
           <TD WIDTH="5%"><FONT color="#FFFFFF">|</FONT> </TD>
           <TD WIDTH="20%"><A class="nodec" href="../aboutus.html"><FONT color=
           "#FFFFFF">A propos</FONT></A> </TD>
         </TR>
       </TABLE>
     </TD>
   </TR>
 </TABLE>
 <!-- end bottom navegation bar -->
<!-- stop navegation bar -->

<!-- SSI_INFO -->

<!-- tr_staticssi include virtual -->
<!-- tr_staticssi exec cmd -->
<!-- addedByLfdynahead ver 1.5 --><TABLE ALIGN="right" border=0><TR><TD ALIGN="right"><FONT SIZE="-1" FACE="Arial,Helvetica">Ce document est disponible en: <A href="../../English/March2005/article369.shtml">English</a> &nbsp;<A href="../../ChineseGB/March2005/article369.shtml">ChineseGB</a> &nbsp;<A href="../../Deutsch/March2005/article369.shtml">Deutsch</a> &nbsp;<A href="../../Francais/March2005/article369.shtml">Francais</a> &nbsp;</FONT></TD></TR></TABLE><br>
 


<!-- SSI_INFO STOP -->
<!-- 2pdaIgnoreStop -->

<!-- SHORT_BIO_ABOUT_THE_AUTHOR_AND_INDEX_START -->
<TABLE ALIGN="LEFT" BORDER="0" WIDTH="195" summary="about the author" class="left">
<TR>
<TD>

<img src="../../common/images/Guido-S.gif" alt="[Photo of the Author]" height="164" width="173">
<BR>par  Guido Socher <a href="http://linuxfocus.org/%7Eguido/"><font size="1">(homepage)</font></a>
<BR><BR>
<I>L&acute;auteur:</I><BR>
<!-- aboutauthor_start -->
<p>Guido appr&eacute;cie Linux parce que c'est r&eacute;ellement un bon syst&egrave;me pour d&eacute;velopper son propre mat&eacute;riel.</p>
<!-- aboutauthor_stop -->
<!-- TRANSLATED_TO fr -->
<BR><BR><I>Traduit en Français par:</I><BR>
Jacques WLODARCZAK <small>&lt;j.wlodarczak(at)tiscali.be&gt;</small>
<br>
<!--
 =LF=TRANSTO=fr: Jacques WLODARCZAK
-->
<!-- TRANSLATED_TO_STOP -->
<!-- INDEX_START -->
<BR><i>Sommaire</i>:
<UL>
  <LI><A HREF="#369lfindex0">Les nouveaut&eacute;s</A></LI>
  <LI><A HREF="#369lfindex1">L'affichage LCD</A></LI>
  <LI><A HREF="#369lfindex2">Une petite interface graphique</A></LI>
  <LI><A HREF="#369lfindex3">Comment fonctionne une conversion de l'analogique vers du num&eacute;rique</A></LI>
  <LI><A HREF="#369lfindex4">Comment fonctionne la communication I2C : du c&ocirc;t&eacute; de l'Atmega8 </A></LI>
  <LI><A HREF="#369lfindex5">Comment fonctionne la communication I2C : du c&ocirc;t&eacute; de Linux</A></LI>
  <LI><A HREF="#369lfindex6">USB vers RS232</A></LI>
  <LI><A HREF="#369lfindex7">Conclusion</A></LI>
  <LI><A HREF="#369lfindex8">R&eacute;f&eacute;rences</A></LI>
  <LI><A HREF="http://cgi.linuxfocus.org/cgi-bin/lftalkback?anum=369">Talkback form for this article</A></LI>
</UL>

</TD></TR></TABLE>
<!-- INDEX_STOP -->
<!-- SHORT_BIO_ABOUT_THE_AUTHOR_AND_INDEX_STOP -->
<!-- HEAD_OF_THE_ARTICLE_START -->
<br>&nbsp;
<table border="0"><tr><td>
<!-- tr_staticssi include virtual -->
<!-- tr_staticssi exec cmd -->
<!-- addedByLfPdf ver 0.1 -->
<TABLE style="border-style:outset; border-width:1px" align="right" bgcolor="#ff9616" cellspacing="1"><TR><TD bgcolor="#ff9616">
        <a href="../Archives/lf-2005_03-0369.pdf"><small>PDF</small></a>
        </TD></TR></TABLE>
         

<H2>Un thermom&egrave;tre digital ou parler « I2C » &agrave; votre microcontroleur atmel -- deuxi&egrave;me partie</H2>
 <img src="../../common/images2/article369/title_369.jpg" alt="[Illustration]" height="205" hspace="10" width="320">
<!-- ABSTRACT OF THE ARTICLE -->
<P><i>R&eacute;sum&eacute;</i>:
<P>
<!-- articleabstract_start -->

Dans cette seconde partie nous connecterons un afficheur et j'expliquerai comment fonctionne le logiciel.
<br><br>
Ceux qui d&eacute;couvrent cette s&eacute;rie devraient d'abord lire
<a href="../../English/February2005/article365.shtml">la premi&egrave;re partie (f&eacute;vrier 2005 - article 365)</a> ; <a href="../../Francais/February2005/article365.shtml"> le m&ecirc;me en fran&ccedil;ais </a>.

    
<!-- articleabstract_stop -->

<br><!-- HR divider --><center><font color="#8282e0"><b>_________________ _________________ _________________</b></font></center><br>
</td></tr></table>
<!-- HEAD_OF_THE_ARTICLE_STOP -->
<!-- BODY_OF_THE_ARTICLE_START -->


    <A NAME="369lfindex0">&nbsp;</A>
<H2>Les nouveaut&eacute;s</H2>

<a href="../../English/February2005/article365.shtml">Dans l'article pr&eacute;c&eacute;dent /</a><a href="../../Francais/February2005/article365.shtml"> (traduction en fran&ccedil;ais)</a>
nous avions d&eacute;j&agrave; &eacute;labor&eacute; l'essentiel du mat&eacute;riel et des fonctionnalit&eacute;s
afin de mesurer une temp&eacute;rature et en transmettre les donn&eacute;es &agrave; un PC linux.
Dans cet article nous ajouterons un affichage LCD et une interface tr&egrave;s simple en gtk. <br>
<br>
Ajouter ces deux choses est tr&egrave;s facile &agrave; faire. Aussi, je consacrerai le reste de l'article
&agrave; expliquer comment le logiciel I2C et le convertisseur analogique vers num&eacute;rique fonctionnent.

    <A NAME="369lfindex1">&nbsp;</A>
<H2>L'affichage LCD</H2>

Pour l'affichage LCD nous utiliserons un afficheur compatible HD44780 comme pour
les articles pr&eacute;c&eacute;dents. Ces afficheurs sont tr&egrave;s faciles &agrave; utiliser en
combinaison avec des microcontr&ocirc;leurs car vous pouvez leur envoyer des
caract&egrave;res ASCII.


<br>
<center>
<img src="../../common/images2/article369/lcd_linux.gif" alt="HD44780 compatible LCD display" height="103" width="250">
</center>
<br>
Comme pour tous les articles de cette s&eacute;rie vous pouvez
vous procurer tous les mat&eacute;riaux n&eacute;cessaires notamment l'afficheur LCD
chez <a href="http://shop.tuxgraphics.org/">shop.tuxgraphics.org</a>
<br>
J'utilise le m&ecirc;me code du pilote LCD que dans les articles pr&eacute;c&eacute;dents.
Les fichiers qui impl&eacute;mentent ce pilote LCD sont lcd.c, lcd.h et lcd_hw.h.
Ils sont inclus dans le paquet que vous pouvez t&eacute;l&eacute;charger &agrave; la fin de cet
article. L'interface pour ce code est vraiment facile &agrave; utiliser :

<pre class="code">// call this once:
// initialize LCD display, cursor off
lcd_init(LCD_DISP_ON);

// to write some text we first clear
// the display:
lcd_clrscr();
lcd_puts("Hello");
// go to the second line:
lcd_gotoxy(0,1);
lcd_puts("LCD");
</pre>
La mani&egrave;re dont fonctionnent ces afficheurs HD44780 est d&eacute;crite sur LinuxFocus dans l'article de septembre 2002
<a href="../../Francais/September2002/article258.shtml">
 Comprendre l'affichage LCD HD44780</a>

<br>
<br>
Le logiciel est &eacute;crit de sorte qu'il fonctionne tant avec les afficheurs LCD
16x2 que 20x2.
<br>
<br>
<img src="../../common/images2/article369/boardchange_th.jpg" alt="board change" align="right" height="214" width="220">
Il y a aussi une actualisation du diagramme du circuit. J'ai d&eacute;couvert que certains
afficheurs LCD ont une charge capacitive plus &eacute;lev&eacute;e et une r&eacute;sistance moins &eacute;lev&eacute;e que d'autres.
Probablement parce que ils ont une meilleure protection ESD. Cette charge additionelle
peut &eacute;ventuellement produire des erreurs de bit durant la programmation « In circuit » quand l'afficheur LCD
est connect&eacute; aux bornes SCK et MOSI.

<br><br>
Dans un premier temps, j'ai essay&eacute; de connecter des r&eacute;sistances suppl&eacute;mentaires
dans les lignes vers l'afficheur LCD. Chez moi &ccedil;a marchait, mais certains, particuli&egrave;rement
parmi les utilisateurs de laptop, continuaient &agrave; conna&icirc;tre des probl&egrave;mes
<br><br>
Pour &eacute;viter tous ces probl&egrave;mes, j'ai actualis&eacute; le diagramme du circuit
et ainsi les bornes D7 et RS de l'afficheur LCD sont maintenant connect&eacute;es aux bornes PD7 et PD6.
Et ce n'est pas un probl&egrave;me de changer &ccedil;a, m&ecirc;me si vous avez d&eacute;j&agrave; fait la plaquette :
ajoutez juste un petit fil sous la plaquette et coupez la connection vers PB3 avec une lame.

<br clear="all">
<br>
<center>
<a href="../../common/images2/article369/i2ctemp_newlcdconection.gif"><img src="../../common/images2/article369/i2ctemp_newlcdconection_th.gif" alt="Circuit diagram" height="432" width="590"></a>
</center>
<br>
    <A NAME="369lfindex2">&nbsp;</A>
<H2>Une petite interface graphique</H2>

Pour ceux qui auraient souhait&eacute; une interface graphique sur leur bureau, j'en ai fait une tr&egrave;s simple.
qui consiste en deux &eacute;tiquettes qui affichent la sortie sur deux lignes de la commande i2ctemp_linux
(i2ctemp_linux est la commande qui lit les temp&eacute;rateurs venant du circuit via l'i2c) :
<br>
<center>
<img src="../../common/images2/article369/guiscreenshot.gif" alt="GUI" height="80" width="83">
</center>
<br>
Maintenant nous avons un chouette thermom&egrave;tre avec nombre de possibilit&eacute;s :
<ul>
<li>Vous pouvez lire la temp&eacute;rature sur place gr&acirc;ce &agrave; l'afficheur
</li><li>Vous pouvez avoir une petite interface graphique sur votre bureau
</li><li>Vous pouvez &eacute;crire des valeurs, &agrave; l'aide d'une t&acirc;che cron, dans un fichier,
pour obtenir des statistiques &agrave; long terme</li></ul>
Je profite du reste de cet article pour expliquer quelque peu
les m&eacute;andres de ce logiciel.
<A NAME="369lfindex3">&nbsp;</A>
<H2>Comment fonctionne une conversion de l'analogique vers du num&eacute;rique</H2>

L'Atmega8 supporte deux modes. Un o&ugrave; il mesure en permanence les signaux analogiques
et d&eacute;clenche une interruption quand la mesure est pr&ecirc;te. Le logiciel de l'application
peut alors utiliser cette interruption pour copier aussit&ocirc;t le r&eacute;sultat venant de deux registres vers une variable.

<br>
<br>
L'autre mode est appel&eacute; mode « par &agrave; coups » (single shot).
Ici une seule conversion est effectu&eacute;e, Le mode par &agrave; coups est en plus
assez rapide. En tenant compte du temps d'initialisation pr&eacute;l&eacute;minaire des registres et de l'extraction vous pouvez
obtenir 100 conversions par seconde. C'est plus que suffisamment rapide pour nous.
Aussi utiliserons-nous ce mode.
<br>
<br>
Sur notre Atmega8 nous pouvons utiliser les bornes d'entr&eacute;es analogiques ADC0 jusque ADC3.
En plus de cela il y a les bornes AGND (masse analogique connect&eacute;e &agrave; la masse
normale), AREF (la tension de r&eacute;f&eacute;rence) et AVCC (connect&eacute; au +5V).
<br>
<br>Durant la conversion analogique vers num&eacute;rique, le signal analogique est
compar&eacute; avec l'AREF. Un signal analogique &eacute;gal &agrave; l'AREF correspond &agrave; une valeur num&eacute;rique de 1023.
l'AREF peut &ecirc;tre n'importe quelle r&eacute;f&eacute;rence externe entre 0 et 5V.
Sans l'utilisation d'une r&eacute;f&eacute;rence externe vous pouvez encore op&eacute;rer une conversion
pr&eacute;cise par l'usage ou d'une r&eacute;f&eacute;rence interne (2,56V) ou d'AVCC.
Ce qui est utilis&eacute; est d&eacute;termin&eacute; dans le logiciel par les bits REFS0 et REFS1 dans le registre ADMUX.
<br>
<br>
Le convertisseur analogique vers num&eacute;rique peut convertir une des
lignes d'entr&eacute;e ADC0-ADC3 &agrave; la fois. Avant de lancer la conversion vous devez placer
des bits dans le registre ADMUX pour indiquer &agrave; la puce quel canal utiliser.
<br>
<br>
Une simple conversion analogique vers num&eacute;rique ressemble donc &agrave; ceci :
<pre class="code">volatile static int analog_result;
volatile static unsigned char analog_busy;

analog_busy=1; // busy mark the ADC function
channel=0; // measure ADC0
// use internal 2.56V ref
outp((1&lt;&lt;REFS1)|(1&lt;&lt;REFS0)|(channel &amp; 0x07),ADMUX);
outp((1&lt;&lt;ADEN)|(1&lt;&lt;ADIE)|(1&lt;&lt;ADIF)|(1&lt;&lt;ADPS2),ADCSR);
sbi(ADCSR,ADSC); // start conversion
</pre>
Maintenant le microcontr&ocirc;leur effectuera la conversion analogique vers num&eacute;rique
et appelera la fonction SIGNAL(SIG_ADC) une fois pr&ecirc;t. Dans cette fonction nous
pouvons copier le r&eacute;sultat vers une variable. Comme programmeur vous devez
veiller &agrave; lire les 8 bits de faible poids d'abord car le microcontr&ocirc;leur
a un m&eacute;canisme de verrouillage pour simuler une lecture « atomique ».

<pre class="code">SIGNAL(SIG_ADC) {
        unsigned char adlow,adhigh;
        adlow=inp(ADCL); /* read low first, two lines. Do not combine
                          the two lines into one C statement */
        adhigh=inp(ADCH);
        analog_result=(adhigh&lt;&lt;8)|(adlow &amp; 0xFF);
        analog_busy=0;
}
</pre>
Apr&egrave;s cela nous avons le r&eacute;sultat de la conversion « analogique vers num&eacute;rique » disponible
sous forme de nombre dans la variable « analog_result ». Ceci peut &ecirc;tre utilis&eacute; ailleurs
dans le programme. Tr&egrave;s facilement.

<br>
<br>
Comme pour toute interruption vous devez appeler sei(); pour les autoriser globalement.
Ce qui devrait &ecirc;te fait quelque part dans le programme principal (ce n'est pas montr&eacute; ci-dessus).
<br>
Il y a quelques « drapeaux » que je vais vous expliquer bri&egrave;vement :
<ul>
<li>ADEN: activer le convertisseur analogique vers num&eacute;rique, &agrave; activer avant de positionner ADSC.<br><br>
</li><li>ADIE : autoriser l'interruption ADC (=autoriser l'appel de SIGNAL(SIG_ADC))<br><br>
</li><li>ADIF : ADC Interrupt Flag (doit &ecirc;tre positionn&eacute; sur 1 avant la conversion)<br><br>
</li><li>ADPS : ADC clock pre-scaler bits : doivent &ecirc;tre fix&eacute;s de telle sorte que la fr&eacute;quence d'horloge divis&eacute; par le facteur « pre-scale » soit une valeur entre 50 et 200 KHz. Le facteur de division est &eacute;gal &agrave; 2^ADPS (2 &eacute;lev&eacute; &agrave; la puissance de la valeur des bits ADPS).
Les valeurs ci-dessus (ADPS2=1, ADPS1=0, ADPS0=0 = decimal 4 -&gt; 2^4 = 16
-&gt; division factor = 16) conviennent pour une fr&eacute;quence d'horlogue de 1MHz.<br><br>
</li></ul>
L'Atmega8 offrent de nombreuses possibilit&eacute;s de s&eacute;lection de la tension de r&eacute;f&eacute;rence. Ce dernier est compar&eacute; &agrave; notre tension d'entr&eacute;e analogique. C'est la tension qui correspond &agrave; une valeur num&eacute;rique de 1023.

<table border="2" width="400">
<tbody><tr>
<td>REFS0=0, REFS1=0</td><td>utilise AREF externe, Vref interne off</td>
</tr><tr>
<td>REFS0=0, REFS1=1</td><td>AVCC avec condensateur externe optionel sur la broche AREF</td>
</tr><tr>
<td>REFS0=1, REFS1=1</td><td>Tension de R&eacute;f&eacute;rence Interne de 2.56V avec condensateur externe
(optionel) sur la broche AREF</td>
</tr></tbody></table>
Une capacit&eacute; optionnelle sur la borne AREF peut &ecirc;tre utilis&eacute;e pour supprimer le bruit (noise) et stabiliser
la tension AREF.
<br>
<br>
<A NAME="369lfindex4">&nbsp;</A>
<H2>Comment fonctionne la communication I2C : du c&ocirc;t&eacute; de l'Atmega8 </H2>

J'ai d&eacute;j&agrave; expliqu&eacute; dans la partie 1 <a href="../../Francais/February2005/article365.shtml">(February2005 article365)</a>
comment le protocole I2C fonctionne. Jetons maitenant un coup d'oeil sur le logiciel.
L'Atmega8 poss&egrave;de un support mat&eacute;riel pour une communication I2C. Aussi vous n'aurez pas besoin d'impl&eacute;menter ce protocole. Par contre vous devrez impl&eacute;menter un m&eacute;canisme d'&eacute;tat (state machine) qui dira &agrave; l'Atmega8 quoi faire ensuite. Voici un exemple :
<br><br>
On re&ccedil;oit un paquet I2C avec l'adresse de notre propre esclave.
L'Atmega8 fera alors appel &agrave; la fonction SIGNAL(SIG_2WIRE_SERIAL) avec le code d'&eacute;tat 0x60 (pour d'autres &eacute;v&eacute;vements nous aurions eu d'autres codes).<br>
<br>
--&gt; Nous devons maintenant fixer un nombre en registre pour dire &agrave; l'Atmega8 quoi faire ensuite.
Dans ce cas nous lui dirons : recevoir la partie « donn&eacute;es » et en accuser r&eacute;ception.
<br><br>
Quand les donn&eacute;es sont re&ccedil;ues nous serons appel&eacute;s par le code de statut 0x80.
<br>
<br>
--&gt; Maintenant nous lisons les octets de donn&eacute;es et disons &agrave; l'Atmega8 de r&eacute;ceptionner les prochains le cas &eacute;ch&eacute;ant.
<br>
<br>
Quand la communication est termin&eacute;e nous avons un code de statut 0xA0 (stop condition) et disons &agrave; notre application qu'un message complet &agrave; &eacute;t&eacute; re&ccedil;u.
<br>
<br>
L'enti&egrave;ret&eacute; du m&eacute;canisme d'&eacute;tat pour le mode esclave I2C et tous les &eacute;tats possibles, sont expliqu&eacute;s dans le livre de sp&eacute;cifications page 183 (voir le lien dans la section « r&eacute;f&eacute;rences » &agrave; la fin de l'article).
<br>
<br>
La transmission des donn&eacute;es est tout &agrave; fait similaire, jetez un oeil sur le code !

<A NAME="369lfindex5">&nbsp;</A>
<H2>Comment fonctionne la communication I2C : du c&ocirc;t&eacute; de Linux</H2>

<img src="../../common/images2/article369/input.gif" alt="i2c input stage" align="right" height="117" width="256">
D'abord un mot &agrave; propos du mat&eacute;riel. M&ecirc;me si I2c est un bus nous n'utiliserons qu'une connection poste &agrave; poste entre un esclave et le PC Linux comme ma&icirc;tre I2C.
Nous pouvons ainsi &eacute;pargner la r&eacute;sistance de pull-up du fait que l'esclave peut faire chuter la ligne sans cr&eacute;er de court circuit. Nous mettrons simplement une r&eacute;sistance de 4.7 K dans ce circuit.<br>
<br>
La tension doit &ecirc;tre ajust&eacute;e : c'est effectu&eacute; gr&acirc;ce &agrave; une diode Zener qui limite les tensions n&eacute;gatives &agrave; -0.7V et les positifs &agrave; maximum +5.1.
<br>
<br>
Apr&egrave;s une &eacute;tude approfondie des entrailles de l'Atmeag8, j'en vins finalement &agrave; la conclusion que la protection interne de l'Atmeag8 lors de l'entr&eacute;e est probablement suffisante car les courants qui traversent la r&eacute;sistance de 4.7 K sont tr&egrave;s faibles. Nous n'aurons pas besoins d'une diode Zener. Ceci dit, &ccedil;a ne peut faire
de tort d'en avoir une.

<br>
<br>
Le logiciel I2C de Linux impl&eacute;mente de mani&egrave;re basique une pile I2C compl&egrave;te.
Je souhaite utiliser un petit utilitaire de ligne de commande qui ne n&eacute;cessite pas de biblioth&egrave;que sp&eacute;ciale ou un module du noyau. Cela fonctionnera par lui-m&ecirc;me.
<br>
<br>
Si vous fouillez dans le fichier i2c_m.c (voir le t&eacute;l&eacute;chargement) vous pouvez constater que chaque message I2C est construit bit par bit.
<br>
<br>
Pour g&eacute;n&eacute;rer les « bits » nous devons brancher les bornes physiques sur l'interface rs232.
C'est fait avec les appels ioctl :
<pre class="code">        // set RTS pin:
        int arg=TIOCM_RTS;
        ioctl(fd, TIOCMBIS, &amp;arg);
</pre>
... ou pour produire un z&eacute;ro :
<pre class="code">        // clear RTS pin:
        int arg=TIOCM_RTS;
        ioctl(fd, TIOCMBIC, &amp;arg);
</pre>
Si vous voulez porter cette pile vers un autre OS, vous n'avez qu'&agrave; changer ces lignes, le reste est du pur C.

<A NAME="369lfindex6">&nbsp;</A>
<H2>USB vers RS232</H2>

Pour les laptops qui n'ont plus &agrave; ce jour d'interface rs232 pour pouvez
simplement utiliser l'adaptateur USB/rs232. J'utilise un adaptateur sans marque qui contient une puce Prolific 2303.
L'adaptateur en question appara&icirc;t comme suit dans le fichier /proc/bus/usb/devices :
Vendor=067b ProdID=2303 Rev= 2.02. Voyez aussi  <a href="http://linuxfocus.unixtech.be/English/November2001/article223.shtml">"Use your ATEN
UC-232A USB adapter with Linux (Linuxfocus, November 2001, article 223)"</a>.


<A NAME="369lfindex7">&nbsp;</A>
<H2>Conclusion</H2>

<img src="../../common/images2/article369/mountoutdoorsensor.jpg" alt="mount the sensor" align="right" height="176" width="300">
J'utilise maintenant le thermom&egrave;tre depuis deux mois et je l'appr&eacute;cie vraiment
car on peut lire directement sur l'afficheur et vous avez la possibilit&eacute; de stocker les donn&eacute;es sur votre PC.
Vous pouvez les lire, dessiner des graphiques et faire des statistiques. Chouette ! <br>
<br>
Le capteur ext&eacute;rieur doit &ecirc;tre prot&eacute;g&eacute; de la pluie (et du soleil). Vous pouvez essayer de l'envelopper dans du plastique mais je ne le recommande pas. Quelque soit la mani&egrave;re dont l'aurez attach&eacute;, la pluie finira par y p&eacute;n&eacute;trer et stagner. Le NTC est tr&egrave;s robuste et il importe peu qu'il soit un tantinet humide pourvu qu'il puisse s&eacute;cher. Utiliser un tube de comprim&eacute;s retourn&eacute; que vous laissez ouvert &agrave; la base. De cette fa&ccedil;on l'eau pourra sortir.

<br clear="all">
<br>

<br>
<center>
<img src="../../common/images2/article369/lcd_i2c_linux_temp.jpg" alt="the thermometer" height="338" width="450">
</center>
<br>
<br>Vous pouvez de nouveau commander toutes les pi&egrave;ces (LCD display, PCB, microcontr&ocirc;leur, ...) au magasin en ligne
tuxgraphics : <a href="http://shop.tuxgraphics.org/">shop.tuxgraphics.org</a>. <br>
Bon amusement !

    <A NAME="369lfindex8">&nbsp;</A>
<H2>R&eacute;f&eacute;rences</H2>


    <ul>
      <li><b>T&eacute;l&eacute;charger</b> la page de cet article (en anglais) : <a href="../../common/src2/article369/index.html">the linuxI2Ctemp_lcd software,
      diagrams, software updates</a></li>

      <li>Comment programmer l'atmega8 avec gcc: <a href="../../Francais/November2004/article352.shtml">November2004 article
      352</a></li>

      <li>Sp&eacute;cifictions de l'Atmega8: sur http://www.atmel.com/
      et s&eacute;lectionner  products-&gt;Microcontrollers -&gt;AVR-8 bit
      RISC-&gt;Documentation-&gt;datasheets <br><a href="../../common/src2/article365/atmega8.pdf">(local copy, pdf,
      2479982 bytes)</a></li>

    </ul>
    <!-- vim: set sw=2 ts=2 et tw=80: -->
  

<!-- BODY_OF_THE_ARTICLE_STOP -->
<!-- 2pdaIgnoreStart -->
<A NAME="talkback">&nbsp;</a>
<h2>Talkback form for this article</h2>
Every article has its own talkback page. On this page you can submit a comment or look at comments from other readers:
<center>
    <table width="250" border=0><tr><td>
    <div class="tbbutton"><A class="nodec" href="http://cgi.linuxfocus.org/cgi-bin/lftalkback?anum=369">&nbsp;talkback page&nbsp;</a></div>
    </td></tr></table>
</center>

<br clear="all">
<HR size="2" noshade>
<table width="250" border=0><tr><td>
<div class="bbutton"><a class="nodec" href="../../index.shtml">&lt;--, LF Sommaire</a></div>
</td><td>
<div class="bbutton"><a class="nodec" href="index.shtml">Sommaire de ce num&eacute;ro</a></div>
</td></tr></table>
<br clear="all">
<HR size="2" noshade>
<!-- ARTICLE FOOT -->
<CENTER><TABLE WIDTH="98%" summary="footer">
<TR><TD ALIGN=CENTER BGCOLOR="#bdc6d5" WIDTH="50%">
<A HREF="../../common/lfteam.html">Site Web maintenu par l&acute;&eacute;quipe d&acute;&eacute;dition LinuxFocus</A>
<BR><FONT COLOR="#1111aa"><a href="../../common/copy.html">&copy; Guido Socher</a><br>&quot;some rights reserved&quot; see <a href="../../license/index.shtml">linuxfocus.org/license/</a><br><a href="http://www.linuxfocus.org">http://www.LinuxFocus.org</a></FONT>
</TD>
<TD BGCOLOR="#bdc6d5">
<!-- TRANSLATION INFO -->
<font size=2>Translation information:</font>
<TABLE summary="translators">
  <tr><td><font size="2">en --&gt; -- : Guido Socher (<a href="http://linuxfocus.org/%7Eguido/"><font size="1">homepage</font></a>)</font></td></tr>
  <tr><td><font size="2">en --&gt; fr: Jacques WLODARCZAK &lt;j.wlodarczak(at)tiscali.be&gt;</font></td></tr>
</TABLE>
</TD>
</TR></TABLE></CENTER>
<p><font size=1>2005-09-14, generated by lfparser version 2.52</font></p>
<!-- 2pdaIgnoreStop -->
</BODY>
</HTML>
