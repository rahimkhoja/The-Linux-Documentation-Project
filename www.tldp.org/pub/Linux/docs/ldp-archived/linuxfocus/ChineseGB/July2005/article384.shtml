<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<HTML>
<HEAD>
 <META http-equiv="Content-Type" content="text/html; charset=gb2312">
 <META NAME="GENERATOR" CONTENT="lfparser_2.51">
 <META NAME="LFCATEGORY" CONTENT="Hardware">
 <link rel="icon" href="../../common/images/lf-16.png" type="image/png">
 <TITLE>lf384, Hardware: 一个数字直流电源--第二部分:软件</TITLE>
<style type="text/css">
<!--
 td.top {font-family: Arial,Geneva,Verdana,Helvetica,sans-serif; font-size:12 }
 pre { font-family:monospace,Courier }
 pre.code { font-family:monospace,Courier;background-color:#aedbe8; }
 p.cl { color:#EE9500 }
 table.left { margin-right:0.3cm }
 a.nodec { text-decoration:none }
 p.trans { font-size:8pt; text-align:right }
 p.clbox { width:50%; alignment:center; background-color:#FFD700; 
           border-style:none; border-width:medium; border-color:#FFD700; 
           padding:0.5cm;  text-align:center }
 p.code { width:80%; alignment:center; background-color:#aedbe8; 
          border-style:none; border-width:medium; border-color:#aedbe8; 
          padding:0.1cm;  text-align:left }
 p.foot { background-color:#AAAAAA; color:#FFFFFF; border-style:none; 
          border-width:medium; border-color:#AAAAAA; padding:0.5cm ; 
          margin-top:0.1cm; margin-right:1cm; margin-left:1cm; 
          text-align:center }
 div.tbbutton {
   background: #ddd;
   border-right: 1px solid #aaa;
   border-bottom: 1px solid #aaa;
   margin: 2px 5px 2px 5px;
   text-align: center;
   width: 20em;
   line-height: 1.2em;
   padding: 2px;
   font-size: 12px;
   white-space: nowrap;
   color: #555;
 }
 div.bbutton {
   background: #ddd;
   border-right: 1px solid #aaa;
   border-bottom: 1px solid #aaa;
   float: left;
   margin: 2px 5px 2px 5px;
   text-align: center;
   line-height: 1.2em;
   padding: 2px;
   font-size: 12px;
   white-space: nowrap;
   color: #555;
 }
-->
</style>
 
</HEAD>
<BODY bgcolor="#ffffff" text="#000000">
 <!-- this is generated html code. NEVER use this file for your
 translation work. Instead get the file with the same article number
 and .meta.shtml in its name. Translate this meta file and then
 use lfparser program to generate the final article -->
 <!-- lfparser can be obtained from http://main.linuxfocus.org/~guido/dev/lfparser.html -->

<!-- this is used by a number of tools:
 =LF=AUTHOR: Guido     Socher
 =LF=CAT___: Hardware
 =LF=TITLE_: 一个数字直流电源--第二部分:软件
 =LF=NUMBER: 384
 =LF=ANAME_: article384.shtml
 =LF=PARSER: 2.51
 -->

<!-- 2pdaIgnoreStart -->

<!-- start navegation bar, current, style=2 -->
 <!-- top navegation bar -->
 <TABLE summary="topbar_1" cellspacing="0" cellpadding="0" border="0" align="center" width="90%">
   <TR bgcolor="#2e2292">
     <TD class="top"><TABLE summary="topbar_1_logo" cellspacing="0" cellpadding="0" border="0" width=
       "100%">
         <TR><TD width="319"><a href="../../index.shtml"><IMG src="../../common/images/logolftop_319x45.gif"
           alt="[LinuxFocus-icon]" width="319" height="45" align="left" 
           border="0"></a></TD>

           <TD class="top">
             <TABLE summary="topbar_1_links" width="100%">
               <TR align="right">
                 <TD class="top">
                 
                 <A class="nodec" href="../../index.shtml"><FONT color=
                 "#DDDDDD" size="2">&lt;--</FONT></A> &nbsp;| 
                 <A class="nodec" href="../map.html"><FONT color=
                 "#DDDDDD" size="2">站点地图</FONT></A> &nbsp;| 
                 <A class="nodec" href="../indice.html"><FONT color=
                 "#DDDDDD" size="2">索引</FONT></A> &nbsp;| 
                 <A class="nodec" href="../Search/index.shtml"><FONT color=
                 "#DDDDDD" size="2">搜索</FONT></A> </TD>
                 
               </TR>

               <TR align="right">
                 <TD class="top">
                   <HR width="100%" noshade size="1">
                 </TD>
               </TR>
             </TABLE>
           </TD>
         </TR>
       </TABLE>
     </TD>
   </TR>
 </TABLE>
 <!-- end top navegation bar -->
 <!-- blue bar -->
 <TABLE summary="topbar_2" cellspacing="0" cellpadding="0" border="0" align="center"
 width="90%">
   <TR bgcolor="#00ffff">
     <TD><IMG src="../../common/images/transpix.gif" width="1" height=
     "2" alt=""></TD>
   </TR>
 </TABLE>
 <!-- end blue bar -->
 <!-- bottom navegation bar -->
 <TABLE summary="topbar_3" cellspacing="0" cellpadding="0" border="0" align="center"
 width="94%">
   <TR bgcolor="#000000">
     <TD>
       <TABLE summary="topbar_3_links" cellspacing="0" cellpadding="1" border="0" width=
       "100%">
         <TR align="center">
           <TD WIDTH="20%"><A class="nodec" href="../News/index.shtml"><FONT color=
           "#FFFFFF">新闻</FONT></A> </TD>
           <TD WIDTH="5%"><FONT color="#FFFFFF">|</FONT> </TD>
           <TD WIDTH="20%"><A class="nodec" href="../Archives/"><FONT color=
           "#FFFFFF">过往期刊</FONT></A> </TD>
           <TD WIDTH="5%"><FONT color="#FFFFFF">|</FONT> </TD>
           <TD WIDTH="20%"><A class="nodec" href="../Links/index.shtml"><FONT color=
           "#FFFFFF">链接</FONT></A> </TD>
           <TD WIDTH="5%"><FONT color="#FFFFFF">|</FONT> </TD>
           <TD WIDTH="20%"><A class="nodec" href="../aboutus.html"><FONT color=
           "#FFFFFF">关于LF</FONT></A> </TD>
         </TR>
       </TABLE>
     </TD>
   </TR>
 </TABLE>
 <!-- end bottom navegation bar -->
<!-- stop navegation bar -->

<!-- SSI_INFO -->

<!-- tr_staticssi include virtual -->
<!-- tr_staticssi exec cmd -->
<!-- addedByLfdynahead ver 1.5 --><TABLE ALIGN="right" border=0><TR><TD ALIGN="right"><FONT SIZE="-1" FACE="Arial,Helvetica">This document is available in: <A href="../../English/July2005/article384.shtml">English</a> &nbsp;<A href="../../ChineseGB/July2005/article384.shtml">ChineseGB</a> &nbsp;<A href="../../Francais/July2005/article384.shtml">Francais</a> &nbsp;</FONT></TD></TR></TABLE><br>
 


<!-- SSI_INFO STOP -->
<!-- 2pdaIgnoreStop -->

<!-- SHORT_BIO_ABOUT_THE_AUTHOR_AND_INDEX_START -->
<TABLE ALIGN="LEFT" BORDER="0" WIDTH="195" summary="about the author" class="left">
<TR>
<TD>

<img src="../../common/images/Guido-S.gif" alt=
    "[Photo of the Author]" height="164" width="173">
<BR>by  Guido Socher <a href="http://linuxfocus.org/~guido/"><font size="1">(homepage)</font></a>
<BR><BR>
<I>关于作者:</I><BR>
<!-- aboutauthor_start -->
<p>Guido喜欢LINUX，因为对于开发自己的硬件来说，它确实是一个很好的系统。</p>
<!-- aboutauthor_stop -->
<!-- TRANSLATED_TO gb -->
<!-- TRANSLATED_TO_STOP -->
<!-- INDEX_START -->
<BR><i>目录</i>:
<UL>
  <LI><A HREF="#384lfindex0">简介</A></LI>
  <LI><A HREF="#384lfindex1">一点警告</A></LI>
  <LI><A HREF="#384lfindex2">软件的结构</A></LI>
  <LI><A HREF="#384lfindex3">各文件中都包含什么</A></LI>
  <LI><A HREF="#384lfindex4">新功能:保存配置数据</A></LI>
  <LI><A HREF="#384lfindex5">参考资料/下载</A></LI>
  <LI><A HREF="http://cgi.linuxfocus.org/cgi-bin/lftalkback?anum=384">对这篇文章发表评论</A></LI>
</UL>

</TD></TR></TABLE>
<!-- INDEX_STOP -->
<!-- SHORT_BIO_ABOUT_THE_AUTHOR_AND_INDEX_STOP -->
<!-- HEAD_OF_THE_ARTICLE_START -->
<br>&nbsp;
<table border="0"><tr><td>
<H2>一个数字直流电源--第二部分:软件</H2>
 <img src="../../common/images2/article379/title_379.jpg" alt=
    "[Illustration]" hspace="10" width="354" height="173">
<!-- ABSTRACT OF THE ARTICLE -->
<P><i>摘要</i>:
<P>
<!-- articleabstract_start -->

	这是有关数字电源系列的第二部分。你可能希望先阅读本系列的<a href=
    "../June2005/article379.shtml">第一部分。</a><br><br>

	我可能会增加第三部分――增加i2c通信以从PC通过命令控制电源。
	也可能还会有第四部分――增加一些更有趣的东西。
	我在考虑除了直流电压，还可以让它输出直流脉冲和尖峰脉冲，
	这样你就可以通过测试电路来保证它们能抵抗电源噪声和振荡。

	包含电路板和所有零件的一个工具箱可以从<a href=
    "http://shop.tuxgraphics.org/electronic/microcontroller.html">shop.tuxgraphics.org</a>获得。


    
<!-- articleabstract_stop -->

<br><!-- HR divider --><center><font color="#8282e0"><b>_________________ _________________ _________________</b></font></center><br>
</td></tr></table>
<!-- HEAD_OF_THE_ARTICLE_STOP -->
<!-- BODY_OF_THE_ARTICLE_START -->


    <A NAME="384lfindex0">&nbsp;</A>
<H2>简介</H2>

	我们可以通过使用一个基于聪明的微控制器的设计，
	来制作一个比传统电源更便宜且有更多特性的电源。
	这是可能的，因为以前使用硬件来实现的功能在这里我们都使用软件来实现。
	<br>
    <br>
	在这篇文章中我们要做两件事情：

    <ul>
      <li>我会解释软件的不同部分是如何工作的。</li>

      <li>增加代码来永久保存配置数据。</li>
    </ul>

    <A NAME="384lfindex1">&nbsp;</A>
<H2>一点警告</H2>

    这篇文章会告诉你软件是如何工作的，你可以使用从这里所学的知识来做一些修改。
	但你要明白短路保护也只是在软件中实现的，如果某些地方有错误，
	这种保护可能不能正常工作。如果在输出中导致短路，
	你的硬件可能会在一缕青烟中化为灰烬。为了防止这种情况出现，
	你可以使用一个大电阻（例如一个汽车前灯的灯泡），
	它可以拉动足够的电流来激活保护而使硬件免于损坏。
	这样你就可以测试短路而没有失去硬件的危险。

    <A NAME="384lfindex2">&nbsp;</A>
<H2>软件的结构</H2>


    你在main程序中（ddcp.c文件，本文最后有下载）只能看到几行在加电时初始化的代码，
	然后软件会进入一个无限循环。<br>
	在该软件中有两处无限循环：第一个在main循环中（ddcp.c中的“while(1){ ...}”），
	第二个在模数转换器的周期性的中断中（analog.c中函数“SIGNAL(SIG_ADC){...}”）。
	系统初始化时设置为每100&mu;秒发生一次中断。
	所有的函数和代码在其中一个任务（任务是在一个实时操作系统中执行的一个进程或线程的名字，
	所以，即使没有操作系统，我也这样称呼它）的上下文环境中执行。<br>

    <center>
      <img src="../../common/images2/article384_prio.gif" alt=
      "[priorities]" hspace="10">
    </center>
    <br>
    中断任务可以在任何时候停止main循环的执行而执行它自己的代码，
	并且中断任务的执行是不会被中断的。当中断任务执行完毕时，
	main循环会从中断处接着执行。这样会有两种后果：

    <ol>
      <li>
	  由于中断代码的执行要在下一次中断到来之前结束，所在它不能太长。
	  这里要计算的是机器代码指令的数量。
	  一个可以仅用一行C代码写成的数学公式可能会产生数百行的机器代码。

	  <br><br></li>

      <li>
	  在中断代码和main程序代码中共享的变量可能会在执行过程中突然改变。
	  当你从中断向main程序中传递多于一个字节的数据时这是合法的。
	  拷贝两个字节需要不止一条指令，那么就可能会出现一个字节在中断之前被拷贝，
	  而另一个字节却在中断之后。怎么办呢？由于ADC测量的结果在两次中断之间不会相差很大，
	  这在大多数情况下不会有什么问题。
	  万一你不能忍受这种偶然性的错误（每小时可能只发生一次），
	  你就必须使用一个标志位，通过它可以检查你的代码是否在拷贝过程中被中断了。
	  </li>
    </ol>

	所有这些意味着一些复杂的事情如刷新显示屏、检测按钮、
	将安培和伏特值转换为内部单位等等都需要在main程序中完成。
	在中断过程中我们只做时间紧迫的事：电流电压控制、过压保护和设置DAC。
	为了避免复杂的数学运算，所有的计算都在ADC单元中完成（跟ADC产生的单元相同，值从0到1023）。
	<br>
    <br>
    下面是main程序中确切的逻辑流程：
<pre class="code">
1) 从中断任务中拷贝最后的ADC结果
2) 将它们转换为显示值（安培或伏特）
3) 将想要的安培或伏特值（用户设定的）转换成内部的等效ADC值
4) 将想要的等效ADC值拷贝到一个变量（比方说一个中断任务可以使用的变量）
5) 清LCD显示屏
6) 将我们要在LCD上显示的数字转换成字符串
7) 在显示屏上显示电压值
8) 检查中断任务是否可以调节电压或电流（电流限制激活）
9) 如果电压是限制因子，那么在电压值后面显示一个箭头
10)把安培值写到显示屏上
11)检查中断任务是否可以调节电压或电流（电流限制激活）
12)如果电流是限制因子，那么在电流值后显示一个箭头
13)检查是否有按钮被按下，如果没有等待100毫秒再检查。如果有按钮按下，
	那么等待200毫秒，这是为了有一个好的响应――如果按钮被持续按住时不致于滚动过快。
14)回到第一步。
</pre>
   	中断任务简单得多：
<pre class="code">
1) 将ADC结果拷贝到变量
2) 在电流和电压间切换ADC测量通道
3) 检查是否测量到过流，若过流则立即将DAC设为一个很小的值（不必为0，
   因为电压放大器只工作在0.6V以上（0.6V的输入仍得到0V的输出））。
4) 检查电压电流是否需要调节
5) 根据4)的结果检查是否需要更新DAC（数模转换器）
</pre>
    <br>
    <br>
   这是软件基本的思想，下面我将解释一下它们都在哪些文件中，
	然后你将明白这些代码（假设你熟悉C语言）。<br>
    <br>


    <A NAME="384lfindex3">&nbsp;</A>
<H2>各文件中都包含什么</H2>

<pre class="code">
ddcp.c -- 该文件包含main程序。所有初始化工作都在此完成。main循环也在这里实现。
analog.c -- 模数转换器以及所有在中断任务相关上下文中执行的代码都可以在此找到。
dac.c -- 数模转换器，在ddcp.c中初始化，但只在analog.c中调用。
kbd.c -- 键盘代码。
lcd.c -- LCD驱动。这一专门的版本不需要LCD的rw针脚，而使用一个内部定时器，
         它应该能有足够长的时间来完成中断任务。
</pre>

    <A NAME="384lfindex4">&nbsp;</A>
<H2>新功能:保存配置数据</H2>

	本文中的新功能不是很多，因为我已经用了大量的篇幅来解释软件是怎么工作的，
	而我不想让这篇文章太长。
	<br>
    <br>
	但我们所加的这项功能是非常重要的：将电压或电流值保存下来，
	我们就不用在下次加电时重新设置了。我们将这些值存储在微控制器的eeprom中。
	所有的eeprom（包括usb存储器）中存储单元的写次数都是有限的。
	对于Atmega8来说是100000次，之后eeprom就会失效而不能再存储数据了。
	延长eeprom使用寿命的一个小技巧就是每次将数值写到不同的单元里，
	但这需要首先计算存储单元的地址。如果每天存储10次配置数据，
	100000次写操作意味着可以使用25年，对我们来说绝对是足够了。
	所以我们使用最简单的方案：只将数据存储到一个地方。
	<br>
    <br>
	那么如何在eeprom中读写数据呢？有两条指令：eeprom_read_word和
	eeprom_write_word可以从/向eeprom中读写16比特的整数。eeprom
	的地址从0开始，并以字节计数。<br>
    <br>
	复杂的一点的地方是每次我们更新软件时，eeprom内容都会被删除。
	所以我们需要知道我们是否从eeprom中读到了垃圾数据（因为刚写进了新的软件）
	或者说是否我们在eeprom中存储了合法的电压电流值。
	我们通过在eeprom中写入一个魔数（magic munber）来做这件事。
	换句话说，每次我们都写入3个值：电流极限值、电压极限值和魔数。
	加电后读eeprom时，我们首先检查这个魔数，如果匹配，
	我们就认为我们所存储的电压和电流值是正确的。
	该魔数可以是任意值（比方说19)，只要不是eeprom中的缺省值就可以了。
	<br><br>
	代码请看ddcp.c中的store_permanent()函数。
	<br>
    <br>
	本文的软件是digitaldcpower-0.3.X，其中X是修正的版本。
	以后若需要更新我会继续修改该X值（上一篇文的软件是digitaldcpower-0.2.X）<br>
    <br>
	玩的开心！……下一篇文中我将增加PC到电源的I2C通信，
	届时你就可以通过命令而不仅仅是电源上的按钮来改变一些相关的东西了。
	<br>
    <br>
	希望有人能将I2C主机程序移植到其它的操作系统上。如果你能帮上忙的话请通知我。
	你需要有如何控制RS232接口的知识以及一个编译器。
	实际上也许只是需要改变一行代码就可以了（ioctl函数）。<br>
    <br>
	整个电路包括所有的零件和一个印刷电路板可以从shop.tuxgraphics.org获得（见下文）。

    <A NAME="384lfindex5">&nbsp;</A>
<H2>参考资料/下载</H2>


    <ul>
      <li><a href="../../common/src2/article384/index.html">Download page</a>
      for this article (updates and corrections will also be
      available from here).</li>

      <li>This first part in this series: <a href=
      "../June2005/article379.shtml">A digital DC powersupply</a></li>

      <li>How to program the atmega8 with gcc: <a href=
      "../November2004/article352.shtml">November2004 article
      352</a></li>

      <li><a href=
      "http://www.tuxgraphics.org/electronics/">Tuxgraphics
      electronics section</a>, a collection of all articles in this
      series.</li>

      <li><a href=
      "http://shop.tuxgraphics.org/electronic/microcontroller.html">
      shop.tuxgraphics.org , microcontroller section</a>, You can
      order all parts (transistors, passive components, LCD
      display, PCB, microcontroller, ...) from here.</li>
    </ul>
    <!-- vim: set sw=2 ts=2 et tw=80: -->
  



<!-- BODY_OF_THE_ARTICLE_STOP -->
<!-- 2pdaIgnoreStart -->
<A NAME="talkback">&nbsp;</a>
<h2>对这篇文章发表评论</h2>
每篇文章都有各自的反馈页面。在这个页面里，您可以提交评论，也可以查看其他读者的评论：
<center>
    <table width="250" border=0><tr><td>
    <div class="tbbutton"><A class="nodec" href="http://cgi.linuxfocus.org/cgi-bin/lftalkback?anum=384">&nbsp;反馈页面&nbsp;</a></div>
    </td></tr></table>
</center>

<br clear="all">
<HR size="2" noshade>
<table width="250" border=0><tr><td>
<div class="bbutton"><a class="nodec" href="../../index.shtml">&lt;--, LF 首页</a></div>
</td><td>
<div class="bbutton"><a class="nodec" href="index.shtml">Go to the index of this issue</a></div>
</td></tr></table>
<br clear="all">
<HR size="2" noshade>
<!-- ARTICLE FOOT -->
<CENTER><TABLE WIDTH="98%" summary="footer">
<TR><TD ALIGN=CENTER BGCOLOR="#bdc6d5" WIDTH="50%">
<A HREF="../../common/lfteam.html">主页由LinuxFocus编辑组维护</A>
<BR><FONT COLOR="#1111aa"><a href="../../common/copy.html">&copy; Guido     Socher</a><br>&quot;some rights reserved&quot; see <a href="../../license/index.shtml">linuxfocus.org/license/</a><br><a href="http://www.linuxfocus.org">http://www.LinuxFocus.org</a></FONT>
</TD>
<TD BGCOLOR="#bdc6d5">
<!-- TRANSLATION INFO -->
<font size=2>翻译信息:</font>
<TABLE summary="translators">
  <tr><td><font size="2">en --&gt; -- : Guido Socher (<a href="http://linuxfocus.org/~guido/"><font size="1">homepage</font></a>)</font></td></tr>
  <tr><td><font size="2">en --&gt; zh_CN: SEVEN &lt;seven1240(at)163.com&gt;</font></td></tr>
</TABLE>
</TD>
</TR></TABLE></CENTER>
<p><font size=1>2005-08-03, generated by lfparser version 2.51</font></p>
<!-- 2pdaIgnoreStop -->
</BODY>
</HTML>
