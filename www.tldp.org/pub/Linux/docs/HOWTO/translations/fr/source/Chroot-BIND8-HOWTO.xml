<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE article PUBLIC "-//OASIS//DTD DocBook XML V4.3//EN"
  "http://www.oasis-open.org/docbook/xml/4.3/docbookx.dtd" [
<!ENTITY howto         "http://www.traduc.org/docs/howto/lecture/">
<!ENTITY traduc        "http://www.traduc.org">
]>

<article lang="fr">

<articleinfo>

  <title>
  
      Guide pratique d'utilisation de BIND&nbsp;8 en environnement 
      restreint
  
  </title>
  
  <subtitle>
  
       Version française du <foreignphrase>Chroot-BIND8
       HOWTO</foreignphrase>
              
  </subtitle>

  <author>
     <firstname>Scott</firstname>
     <surname>Wunsch</surname>
     <email>scott CHEZ wunsch POINT org</email>
  </author>

  <othercredit role="traduction">
     <firstname>Vincent</firstname>
     <surname>Loupien</surname>
     <contrib>Adaptation française</contrib>
     <email>vincent POINT loupien CHEZ free POINT fr</email>
  </othercredit>

  <othercredit role="relecture">
    <firstname>Isabelle</firstname>
    <surname>Hurbain</surname>
    <contrib>Relecture de la version française</contrib>
    <email>isabelle POINT hurbain CHEZ pasithee POINT net</email>
  </othercredit>

  <othercredit role="publication">
    <firstname>Jean-Philippe</firstname>
    <surname>Guérard</surname>
    <contrib>Préparation de la publication de la v.f.</contrib>
    <email>jean TIRET philippe POINT guerard CHEZ tigreraye POINT org</email>
  </othercredit>


<pubdate>21 août 2005</pubdate>
<releaseinfo>Version&nbsp;: 1.4.fr.1.1</releaseinfo>

  <!-- Historique des révisions -->

  <revhistory>

    <revision>
      <revnumber>1.4.fr.1.1</revnumber>
      <date>2005-08-21</date>
      <authorinitials>VL,IH,JPG</authorinitials>
      <revremark>Correction de l'url de la version française</revremark>
    </revision>

    <revision>
      <revnumber>1.4.fr.1.0</revnumber>
      <date>2004-03-05</date>
      <authorinitials>VL,IH,JPG</authorinitials>
      <revremark>Première traduction française</revremark>
    </revision>

    <revision>
      <revnumber>1.4</revnumber>
      <date>2001-07-01</date>
      <authorinitials>SW</authorinitials>
    </revision>

  </revhistory>

  <abstract><para>

     Ce document décrit l'installation du serveur de noms BIND&nbsp;8 
     dans un environnement restreint en tant qu'utilisateur non 
     privilégié. Ce qui permet de disposer d'une sécurité améliorée et 
     de réduire au minimum les effets potentiels d'une compromission. 
     Cette version du document couvre l'ancienne version&nbsp;8 de BIND, 
     toujours populaire&nbsp;; il existe un autre document qui fournit 
     le même type d'informations, mais pour BIND&nbsp;9.

  </para></abstract>

</articleinfo>

<section>

<title>Introduction</title>

<para>

Ceci est le guide pratique de BIND&nbsp;8 en environnement restreint&nbsp;;
allez voir <xref linkend="ou"/> pour le site principal, qui contient la
dernière version de ce document. Nous supposons que vous savez déjà
configurer et utiliser BIND (le serveur de Noms de Domaines Internet de
Berkeley). Si ce n'est pas le cas, je vous recommande de lire d'abord le
Guide pratique du DNS (<foreignphrase>DNS HOWTO</foreignphrase>). Nous
supposons également que vous avez une connaissance suffisante de
compilation et d'installation d'un logiciel sur votre système de type
Unix.

</para>

<section>
<title>Objet de ce document</title>

<para>

Ce document décrit quelques précautions de sécurité supplémentaires que
vous pouvez prendre quand vous installez BIND. Il explique comment
configurer BIND de sorte qu'il réside dans un environnement restreint,
ceci signifiant qu'il ne peut pas voir ou avoir accès aux fichiers à
l'extérieur de sa propre arborescence. Nous le configurerons également
pour l'exécuter en tant qu'utilisateur non-root.

</para>

<para>

Le principe d'un environnement restreint est assez simple. Lorsque vous
exécutez BIND (ou tout autre processus) dans un environnement restreint
(c'est-à-dire avec une racine différente du système de fichier &mdash;
d'où le nom de la commande utilisée
«&nbsp;<foreignphrase>chroot</foreignphrase>&nbsp;», c'est-à-dire, en
anglais, «&nbsp;changer la racine&nbsp;»), le processus ne peut tout
simplement pas voir les autres parties du système de fichiers en dehors
de son environnement. Par exemple, dans ce document, nous placerons BIND
pour être exécuté en environnement restreint dans le répertoire
<filename class="directory">/chroot/named</filename>. Cependant, pour
BIND, le contenu de ce répertoire apparaîtra comme étant <filename
class="directory">/</filename>, la racine. Il ne pourra accéder à rien
d'autre en dehors de ce répertoire. Vous avez probablement déjà
rencontré un environnement restreint auparavant, si vous avez déjà fait
un <command>ftp</command> vers un serveur de fichier public.

</para>

</section>

<section>
<title>Pourquoi&nbsp;?</title>

<para>

Le principe lors de l'exécution de BIND dans un environnement restreint
est de limiter la quantité d'accès que n'importe quel individu
malveillant pourrait gagner en exploitant une des vulnérabilités de
BIND. C'est pour la même raison que nous exécutons BIND en tant
qu'utilisateur non-root.

</para>

<para>

Ceci devrait être considéré comme un supplément aux précautions normales
de sécurité (exécution de la dernière version, utilisation des listes de
contrôle d'accès, et cætera), et non pas comme une solution de remplacement
de ces dernières.

</para>

<para>
Si la sécurité du DNS vous intéresse, quelques autres produits pourraient
également vous intéresser. Compiler BIND avec 
<ulink url="http://www.immunix.org/stackguard.html">StackGuard</ulink>
peut être une bonne idée pour assurer une plus grande protection. Son 
utilisation est simple&nbsp;; elle équivaut à utiliser un gcc standard.
Il existe aussi une alternative sécurisée à BIND, 
<ulink url="http://cr.yp.to/dnscache.html">DNScache</ulink>, écrit par
Dan Berstein. Dan est l'auteur de qmail et DNScache semble en suivre la 
même philosophie.

</para>

</section>

<section id="ou">
<title>Où&nbsp;?</title>

<para>

La dernière version française de ce document est toujours disponible sur 
le site du projet <ulink url="&traduc;">Traduc.org</ulink>&nbsp;: 
<ulink url="&howto;Chroot-BIND8-HOWTO.html"/>.

</para>

<para>

La dernière version originale de ce document est toujours disponible à
partir du site web des Utilisateurs de Linux et de Logiciel Libre de
Regina, Saskatchewan, Canada (LOSURS) à l'adresse <ulink
url="http://www.losurs.org/docs/howto/Chroot-BIND8.html"/>.

</para>

<para>

Il existe maintenant une traduction japonaise de ce document, maintenue par
<email>nakano CHEZ apm POINT seikei POINT ac POINT jp</email>. Elle 
est disponible à l'adresse <ulink
url="http://www.linux.or.jp/JF/JFdocs/Chroot-BIND8-HOWTO.html"/>. 

</para>

<para>

BIND est disponible à l'adresse de l'<ulink url="http://www.isc.org/"
>Internet Software Consortium</ulink> à l'adresse <ulink
url="http://www.isc.org/bind.html"/>. Au moment de la publication de ce
document, la version courante de BIND&nbsp;8 est 8.2.4. BIND&nbsp;9.x est
maintenant sorti, et il fonctionne depuis un petit moment. Vous pouvez
envisager de mettre à jour vers cette version, la procédure
d'environnement restreint y est vraiment beaucoup plus simple et
propre. Si vous exploitez BIND&nbsp;9, alors utilisez le «&nbsp;guide
pratique d'utilisation de BIND en environnement restreint&nbsp;» qui
doit être disponible au même emplacement que ce document. 

</para>

<para>

Gardez à l'esprit que des trous de sécurité sont <emphasis>connus</emphasis>
dans toutes les versions de BIND&nbsp;8 inférieure à <emphasis>8.2.3</emphasis>, 
assurez-vous que vous exécutez bien la dernière version&nbsp;!

</para>

</section>

<section>
<title>Comment&nbsp;?</title>

<para>

J'ai écrit ce document à partir de mon expérience du paramétrage de
BIND dans un environnement restreint. Dans mon cas, j'avais déjà un BIND
en exploitation sous la forme d'un paquetage provenant de ma distribution
Linux. Je vais supposer que beaucoup d'entre vous êtes dans la même
situation, que vous allez juste récupérer et modifier les fichiers de
configuration provenant de votre installation actuelle de BIND,
puis désinstaller le paquetage avant d'installer le nouveau. Ne
désinstallez pas le paquetage tout de suite&nbsp;; nous pourrions avoir
besoin d'y récupérer quelques fichiers.

</para>

<para>

Si vous n'êtes pas dans ce cas, vous devriez néanmoins  être capable
de comprendre ce document. La seule différence est que, lorsque je copie
un fichier existant, vous devrez d'abord le créer vous-même. Le guide
pratique du DNS peut être utile pour cela.

</para>

</section>

<section>
<title>Mise en garde</title>

<para>

Cette procédure a fonctionné pour moi, sur mon système. Vous pouvez avoir à
la modifier. Ce n'est qu'une façon d'aborder la question&nbsp;; il y a
d'autres moyens d'arriver à la même solution (cependant l'approche
restera la même). Il s'est juste trouvé que ma première tentative a fonctionné,
et j'ai donc tout noté.

</para>

<para>

À ce jour, mon expérience de BIND se limite à l'installation sur des
serveurs Linux. Cependant, la plupart des instructions dans ce document
doivent être facilement applicables à d'autres saveurs d'UNIX, et
j'essaierai d'indiquer les éventuelles différences dont j'ai la
connaissance.

</para>

</section>

</section>

<section>

<title>

Préparation de l'environnement restreint

</title>

<section>

<title>Création d'un utilisateur</title>

<para>

Comme cela est mentionné dans l'introduction, il n'est pas conseillé
de faire fonctionner BIND en root. Ainsi, avant de commencer, créons 
un utilisateur spécifique pour BIND. Notez que vous
ne devez jamais employer un utilisateur générique comme
<literal>nobody</literal> pour cela. Ainsi, quelques distributions,
comme SuSE et Mandrake Linux ont commencé à fournir un utilisateur
spécifique (généralement appelé <literal>named</literal>)&nbsp;; vous
pouvez simplement adapter cet utilisateur à nos desseins, si vous le
souhaitez. 

</para>

<para>
Ceci exige l'ajout d'une ligne comme celle qui suit dans
<filename>/etc/passwd</filename>&nbsp;:

</para>

<screen>
named:x:200:200:Serveur de noms:/chroot/named:/bin/false
</screen>

<para>

Et une comme ceci dans <filename>/etc/group</filename>&nbsp;:

</para>

<screen>
named:x:200:
</screen>

<para>

Ceci crée un utilisateur et un groupe appelés <literal>named</literal>
pour BIND. Assurez-vous que les UID et les GID (les deux à 200 dans cet
exemple) sont uniques sur votre système. L'interpréteur de commande est
mis à <filename>/bin/false</filename> parce que cet utilisateur n'aura
jamais besoin de se connecter.

</para>

</section>

<section>

<title>Arborescence de répertoire</title>

<para>

Nous devons maintenant mettre en place l'arborescence de répertoire que
nous allons utiliser pour l'environnement restreint dans lequel BIND
s'exécutera. Cela peut être n'importe ou dans votre système de
fichiers&nbsp;; celui qui est vraiment paranoïaque pourra même la mettre
dans un volume séparé. Je supposerai que vous emploierez
<filename>/chroot/named</filename>. Commençons en créant l'arborescence
de répertoire suivante&nbsp;:

</para>

<screen>
/chroot
  +-- named
       +-- bin
       +-- dev
       +-- etc
       |    +-- namedb
       +-- lib
       +-- var
            +-- run
</screen>

</section>

<section>

<title>Mise en place des données de BIND</title>

<para>

Si vous avez déjà fait une installation conventionnelle de BIND et si vous
l'utilisez, votre fichier <filename>named.conf</filename> et vos fichiers de
zone existent déjà. Ces fichiers doivent être déplacés (ou copiés pour plus de
sûreté) dans l'environnement restreint, de sorte que BIND puisse les 
atteindre. <filename>named.conf</filename> ira dans <filename
class="directory">/chroot/named/etc</filename>, et les fichiers de zone
pourront aller dans <filename 
class="directory">/chroot/named/etc/namedb</filename>. Par
exemple&nbsp;:

</para>

<screen>
# cp -p /etc/named.conf /chroot/named/etc/

# cp -a /var/named/* /chroot/named/etc/namedb/
</screen>

<para>

BIND devra sûrement écrire dans le répertoire <filename
class="directory">namedb</filename>, et probablement dans certains des
fichiers contenus dans ce répertoire. Par exemple, si votre serveur DNS est
esclave pour une zone, il devra y mettre à jour les fichiers de cette zone.
De plus, BIND peut générer des statistiques, ce qu'il fait
dans ce répertoire. Pour cette raison, vous devrez probablement faire de
l'utilisateur <literal>named</literal> le propriétaire de ce répertoire
et de son contenu&nbsp;:

</para>

<screen>
# chown -R named:named /chroot/named/etc/namedb
</screen>

<para>

BIND aura aussi besoin d'écrire dans le répertoire <filename
class="directory">/var/run</filename>, pour y mettre ses fichiers pid et
son socket ndc, donc permettons-lui de le faire&nbsp;:

</para>

<screen>
# chown named:named /chroot/named/var/run
</screen>


</section>

<section>

<title>Fichiers pour le support du système</title>

<para>

Une fois que BIND s'exécute dans l'environnement restreint, il n'est pas
capable <emphasis>du tout</emphasis> d'avoir accès aux fichiers en
dehors de celui-ci. Cependant, il doit avoir accès à quelques fichiers
clefs, comme la bibliothèque C du système. Les bibliothèques
exigées dépendront de votre saveur d'Unix. Pour la plupart des
systèmes Linux modernes, les commandes suivantes seront
suffisantes pour mettre en place les bibliothèques nécessaires&nbsp;:

</para>

<para>

<screen>
# cd /chroot/named/lib
# cp -p /lib/libc-2.*.so .
# ln -s libc-2.*.so libc.so.6
# cp -p /lib/ld-2.*.so .
# ln -s ld-2.*.so ld-linux.so.2
</screen>

</para>

<para>

Vous pouvez aussi simplement compiler des versions statiquement liées
des binaires de BIND pour les placer dans votre environnement restreint.
Vous devez aussi copier <command>ldconfig</command> dans l'environnement
restreint et l'exécuter pour créer un
<filename>etc/ld.so.cache</filename> pour l'environnement restreint. Les
commandes suivantes devraient le permettre&nbsp;:

</para>

<screen>
# cp /sbin/ldconfig /chroot/named/bin/
# chroot /chroot/named /bin/ldconfig -v
</screen>

<para>

BIND a encore besoin d'un fichier système dans son environnement
restreint&nbsp;: le bon vieux <filename
class="devicefile">/dev/null</filename>. De nouveau, la commande
exacte nécessaire pour créer ce fichier spécial peut varier de
système en système&nbsp;; vérifiez votre script
<filename>/dev/MAKEDEV</filename> pour être sûr. Quelques systèmes
peuvent également exiger <filename
class="devicefile">/dev/zero</filename>.  Pour la plupart des systèmes
Linux, nous pouvons employer la commande suivante&nbsp;:

</para>

<screen>
# mknod /chroot/named/dev/null c 1 3
</screen>

<para>

Pour terminer, vous avez besoin de quelques fichiers supplémentaires
dans le répertoire <filename class="directory">/etc</filename> à
l'intérieur de l'environnement restreint. En particulier, vous devez
copier <filename>/etc/localtime</filename> (parfois nommé
<filename>/usr/lib/zoneinfo/localtime</filename> sur certains systèmes)
de façon à ce que BIND enregistre les évènements avec un horodatage
correct. Vous devez également créer un petit fichier
<filename>group</filename> contenant uniquement le groupe
<literal>named</literal>. Les deux commandes suivantes se chargeront de
ceci&nbsp;:

</para>

<screen>
# cp /etc/localtime /chroot/named/etc/

# echo 'named:x:200:' &#62; /chroot/named/etc/group
</screen>

<para>

Gardez à l'esprit que le GID, 200 dans cet exemple, doit correspondre à
celui que vous avez défini dans le vrai <filename>/etc/group</filename>
défini au dessus.

</para>

</section>

<section id="logging">

<title>Journalisation des évènements</title>

<para>

BIND a beau être prisonnier de son environnement restreint, il ne peut
pas graver son journal sur les murs de sa cellule. :-). Normalement,
BIND écrit les journaux grâce à <command>syslogd</command>, le démon de
journalisation des évènements du système. Cependant, ce type de
journalisation est effectué en envoyant les entrées d'évènements vers le
socket spécial <filename>/dev/log</filename>. Puisqu'il est à
l'extérieur de l'environnement restreint, BIND ne peut plus l'employer
désormais. Heureusement, il existe deux solutions pour contourner cela.

</para>

<section>

<title>La solution idéale</title>

<para>

La solution idéale de ce dilemme exige une version raisonnablement
récente de <command>syslogd</command> qui prend en charge le paramètre
<option>-a</option> introduit par OpenBSD. Reportez-vous aux pages de
manuel de votre <citerefentry> <refentrytitle>syslogd</refentrytitle>
<manvolnum>8</manvolnum> </citerefentry> pour voir si vous avez une
telle version. 

</para>

<para>

Si c'est la cas, la seule chose que vous ayez à faire est
d'ajouter le paramètre «&nbsp;<option>-a 
/chroot/named/dev/log</option>&nbsp;» à la ligne de commande lorsque
vous lancez <command>syslogd</command>. Sur les systèmes qui utilisent
un init SysV complet (ce qui inclut la plupart des distributions Linux),
vous pouvez faire cela dans le fichier
<filename>/etc/rc.d/init.d/syslog</filename>. Par exemple, sur mon
système Linux Red Hat, j'ai changé la ligne

</para>

<screen>
daemon syslogd -m 0
</screen>

<para>
en
</para>

<screen>
daemon syslogd -m 0 -a /chroot/named/dev/log
</screen>

<para>

Les systèmes Caldera OpenLinux utilisent un démon de lancement
appelé <command>ssd</command>, qui lit la configuration dans
<filename>/etc/sysconfig/daemons/syslog</filename>. Il vous suffit de
modifier la ligne d'options pour que cela ressemble à ceci&nbsp;:

</para>

<screen>
OPTIONS_SYSLOGD="-m 0 -a /chroot/named/dev/log"
</screen>

<para>

De la même façon sur les systèmes SuSE, je me suis dit que le meilleur
endroit pour ajouter ce paramètre est le fichier
<filename>/etc/rc.config</filename>. Changer la ligne

</para>

<screen>
SYSLOGD_PARAMS=""
</screen>

<para>
en
</para>

<screen>
SYSLOGD_PARAMS="-a /chroot/named/dev/log"
</screen>

<para>

devrait faire l'affaire. Une fois que vous avez compris comment faire cette
modification sur votre système, il vous suffit de redémarrer
<command>syslogd</command>, que cela soit en l'arrêtant et en le
relançant (avec les paramètres supplémentaires), ou en employant le
script d'init SysV qui le fera pour vous&nbsp;:

</para>

<screen>
# /etc/rc.d/init.d/syslog stop
# /etc/rc.d/init.d/syslog start
</screen>

<para>

Une fois redémarré, vous devez voir dans <filename 
class="directory">/chroot/named/dev</filename>  un «&nbsp;fichier&nbsp;»
appelé <filename>log</filename> qui ressemble à ceci&nbsp;:

</para>

<screen>
srw-rw-rw-   1 root     root            0 Mar 13 20:58 log
</screen>

</section>

<section>
<title>L'autre solution</title>

<para>

Si vous avez un ancien <command>syslogd</command>, alors vous devez
trouver une autre façon de faire vos journalisations. Il existe quelques
programmes pour faire ça, comme
<literal>holelogd</literal>, qui est conçu pour agir comme un
«&nbsp;proxy&nbsp;» en acceptant les entrées d'évènements du BIND en
environnement restreint pour les passer au véritable socket
<literal>/dev/log</literal>.  

</para>

<para>
Vous pouvez aussi tout simplement configurer BIND pour journaliser les 
évènements dans un fichier au lieu
de les passer à syslog. Voyez la documentation de BIND pour plus de
détails si vous choisissez d'utiliser cette méthode.

</para>

</section>

</section>

</section>

<section id="compiling">

<title>Compilation de BIND</title>

<para>

Vous devriez pouvoir trouver les sources de BIND en visitant
<ulink url="http://www.isc.org/bind.html"/>. Vous avez besoins du paquet
<filename>bind-src.tar.gz</filename>. Assurez-vous de bien récupérer la
dernière version&nbsp;!

</para>

<section>

<title>Modifier les chemins</title>

<para>

Les choses peuvent s'embrouiller un peu à partir de maintenant,
parce que les différentes parties du paquetage BIND se référent aux
mêmes répertoires par des noms différents (dépendant du fait qu'ils
s'exécutent ou non dans l'environnement restreint). Je vais essayer de
ne pas <emphasis remap="bf">trop</emphasis> vous embrouiller.

</para>

<para>

Le répertoire dont nous devons nous occuper en priorité est 
<filename class="directory">/var/run</filename> car son contenu est
nécessaire à la fois pour le démon <command>named</command> (à l'intérieur
de l'environnement restreint) et pour l'utilitaire <command>ndc</command> (à
l'extérieur). Nous allons commencer par paramétrer ce qu'il faut pour trouver
ce répertoire depuis le monde extérieur. Pour cela, nous devons modifier
<filename>src/port/linux/Makefile.set</filename> (substituez par le
répertoire de votre architecture si vous ne fonctionnez pas sur 
Linux), et changez la ligne

</para>

<screen>
DESTRUN=/var/run
</screen>

<para>
en
</para>

<screen>
DESTRUN=/chroot/named/var/run
</screen>

<para>

Tant que vous êtes là, vous pouvez changer l'autre chemin de
destination <filename class="directory">/usr</filename> en <filename
class="directory">/usr/local</filename>. Maintenant, tout devrait être
capable de trouver ce répertoire&hellip; excepté le démon
<command>named</command> lui-même, pour qui c'est toujours le vrai
<filename class="directory">/var/run</filename> dans l'environnement
restreint. Nous pouvons contourner ceci en faisant un petit changement
dans les sources de <command>named</command>. Dans le fichier
<filename class="headerfile">src/bin/named/named.h</filename>, trouvez 
la ligne

</para>

<screen>
#include "pathnames.h"
</screen>

<para>

et ajouter la ligne suivante immédiatement après

</para>

<screen>
#define _PATH_NDCSOCK    "/var/run/ndc"
</screen>

<para>

De cette façon, <command>named</command> ignorera notre définition de
<literal>DESTRUN</literal> dans <filename>Makefile.set</filename> et
emploiera l'emplacement correct (par rapport à sa perspective dans
l'environnement restreint). Vous remarquerez quelques avertissements au
sujet des redéfinitions de &lowbar;PATH&lowbar;NDCSOCK quand vous faites
la compilation&nbsp;; vous pouvez les ignorer.

</para>

</section>

<section>

<title>Compiler</title>

<para>

Vous devriez maintenant être capable de compiler normalement BIND, en
suivante les instructions du fichier <filename>INSTALL</filename>. À
cette étape, nous voulons seulement compiler BIND, sans l'installer.
N'allez pas trop loin en suivant le fichier
<filename>INSTALL</filename>. Globalement, il faut juste
faire <command>make clean</command>, <command>make depend</command> et
<command>make</command>.

</para>

</section>

</section>

<section id="installing">

<title>Installer votre beau BIND tout neuf</title>

<para>

Je dois signaler que si vous avez une installation existante de BIND,
par exemple en provenance d'un RPM, vous devrez probablement la
désinstaller avant d'installer la nouvelle. Sur un système Red Hat, cela
implique probablement de désinstaller les paquetages
<medialabel>bind</medialabel> et <medialabel>bind-utils</medialabel>, et
peut-être <medialabel>bind-devel</medialabel> et
<medialabel>caching-nameserver</medialabel>, si vous les avez. 

</para>

<para>
Vous voudrez sans doute sauvegarder une copie du script d'init (par exemple
<filename>/etc/rc.d/init.d/named</filename>), s'il y a en un, avant de
faire ceci&nbsp;; ce sera utile plus tard.

</para>

<section>

<title>
   
Installer les outils en dehors de l'environnement restreint

</title>

<para>

C'est la partie facile :-). Il vous suffit d'exécuter <command>make
install</command> et laissez faire le tout pour vous. Vous pouvez
vouloir faire un <command>chmod 000 /usr/local/sbin/named</command>
par la suite, pour être sûr que vous n'exécutez pas accidentellement une
copie de BIND hors environnement restreint (il s'agit de
<filename>/usr/sbin/named</filename> si vous ne lui avez pas dit d'aller
dans <filename class="directory">/usr/local/sbin</filename> comme je
l'ai suggéré).

</para>

</section>

<section>

<title>

Installer les binaires dans l'environnement restreint

</title>

<para>

Seuls deux parties du paquetage doivent s'exécuter à l'intérieur de
l'environnement restreint&nbsp;: le démon principal
<command>named</command> lui-même, et <command>named-xfer</command>, qui
est utilisé pour les transferts de zone. Vous pouvez simplement les
copier depuis l'arborescence source&nbsp;:

</para>

<screen>
# cp src/bin/named/named /chroot/named/bin

# cp src/bin/named-xfer/named-xfer /chroot/named/bin
</screen>

</section>

<section>
<title>Mise en place du script d'init</title>

<para>

Si vous avez un script d'init provenant de votre distribution, le mieux
serait probablement de simplement le modifier pour exécuter
<command>/chroot/named/bin/named</command>, avec les paramètres
appropriés. Les paramètres sont&hellip; (roulement de tambour s'il vous
plaît&hellip;)

</para>

<itemizedlist>

<listitem><para>

<option>-u named</option>, qui demande à BIND de s'exécuter en tant 
qu'utilisateur <literal>named</literal>, plutôt que 
<literal>root</literal>.

</para></listitem>

<listitem><para>

<option>-g named</option>, pour exécuter BIND avec le groupe 
<literal>named</literal> également, plutôt que <literal>root</literal> 
ou <literal>wheel</literal>.

</para></listitem>

<listitem><para>

<option>-t /chroot/named</option>, qui demande à BIND de s'exécuter dans 
l'environnement restreint que nous avons construit.

</para></listitem>

</itemizedlist>

<para>

Ce qui suit est le script d'init que j'utilise avec mon système Red Hat
6.0. Comme vous pouvez voir, il est presque identique à celui 
livré par Red Hat. J'ai aussi modifié la commande <userinput>ndc 
restart</userinput> de façon à ce qu'elle redémarre le serveur correctement, 
et le garde à l'intérieur de l'environnement restreint. Vous pouvez 
probablement faire la même chose dans votre script d'init, sans avoir à 
copier celui-ci.

</para>

<programlisting>
#!/bin/sh
#
# named           Le rôle de ce script "shell" est de démarrer et d'arrêter
#                 named (serveur DNS BIND)
#
# chkconfig: 345 55 45
# description: named (BIND) est le serveur de nom de domain (DNS)
# qui est utilisé pour résoudre les noms de domaines en adresses IP.
# probe: true

# Bibliothèque basique de fonctions.
. /etc/rc.d/init.d/functions

# Configuration basique du réseau.
. /etc/sysconfig/network

# Vérifie que la gestion du réseau est assurée
[ ${NETWORKING} = "no" ] &#38;&#38; exit 0

[ -f /chroot/named/bin/named ] || exit 0

[ -f /chroot/named/etc/named.conf ] || exit 0

# En fonction de ce qui est appelé
case "$1" in
  start)
        # Démarrer le démon.
        echo -n "Démarrage de named : "
        daemon /chroot/named/bin/named -u named -g named -t /chroot/named
        echo
        touch /var/lock/subsys/named
        ;;
  stop)
        # Arrêter le démon.
        echo -n "Arrêt de named : "
        killproc named
        rm -f /var/lock/subsys/named
        echo
        ;;
  status)
        /usr/local/sbin/ndc status
        exit $?
        ;;
  restart)
        /usr/local/sbin/ndc -n /chroot/named/bin/named "restart -u named -g named -t /chroot/named"
        exit $?
        ;;
  reload)
        /usr/local/sbin/ndc reload
        exit $?
        ;;
  probe)
        # named sait comment redémarrer intelligemment ; nous ne voulons pas 
        # que linuxconf nous propose de le redémarrer à chaque fois
        /usr/local/sbin/ndc reload &#62;/dev/null 2&#62;&#38;1 || echo start
        exit 0
        ;;

  *)
        echo "Utilisation: named {start|stop|status|restart}"
        exit 1
esac

exit 0
</programlisting>

<para>

Sur les systèmes Caldera OpenLinux, vous avez juste besoin de modifier
les variables définies au début et le système va s'occuper du reste pour vous&nbsp;:

</para>

<programlisting>
NAME=named
DAEMON=/chroot/named/bin/$NAME
OPTIONS="-t /chroot/named -u named -g named"
</programlisting>

</section>

<section>

<title>Changement de configuration</title>

<para>

Vous devez aussi ajouter ou modifier quelques options dans votre
<filename>named.conf</filename> pour avoir vos différents répertoires en
ordre. En particulier, vous devez ajouter (ou changer, si vous les avez
déjà) les directives suivantes dans la section
<literal>options</literal>&nbsp;:

</para>

<programlisting>
directory "/etc/namedb";
pid-file "/var/run/named.pid";
named-xfer "/bin/named-xfer";
</programlisting>

<para>

Puisque ce fichier est lu par le démon <command>named</command>, tous
les chemins sont naturellement relatifs à l'environnement restreint.

</para>

<para>

Quelques personnes ont aussi rapporté devoir ajouter quelques lignes
supplémentaires à leur <filename>named.conf</filename> pour obtenir un
fonctionnement correct de <command>ndc</command>&nbsp;:

</para>

<programlisting>
controls {
    unix "/var/run/ndc" perm 0600 owner 0 group 0;
};
</programlisting>

</section>

</section>

<section>

<title>La fin</title>

<section>

<title>Lancement de BIND</title>

<para>

Tout devrait être configuré, et vous devriez être prêt à lancer votre nouveau
BIND plus sécurisé. Si vous utilisez un script
d'init du style SysV, vous pouvez simplement le lancer par&nbsp;:

</para>

<screen>
# /etc/rc.d/init.d/named start
</screen>

<para>

Assurez-vous d'avoir arrêté toutes les anciennes versions de BIND qui
pourraient encore fonctionner avant de faire cela.

</para>

<para>

Si vous jetez un coup d'&oelig;il à votre journal système, vous devez
trouver les messages d'initialisations que BIND crache quand il démarre.
(si ce n'est pas le cas&nbsp;; il y a un problème avec votre <link
linkend="logging">configuration de journalisation</link> que vous devez
résoudre.) Parmi ces messages, BIND devrait vous indiquer qu'il est
passé avec succès dans l'environnement restreint
(<foreignphrase>chroot</foreignphrase> et qu'il fonctionne en tant
qu'utilisateur et groupe <literal>named</literal>. Si ce n'est pas le
cas, vous avez un problème.

</para>

</section>

<section>
<title>Voilà&nbsp;!</title>

<para>
Vous pouvez aller faire un petit somme maintenant ;-).
</para>

</section>

</section>

<appendix>

<title>

Annexes

</title>

<section id="upgrading">
<title>Mises à jour ultérieures de BIND</title>

<para>

Ainsi, vous avez un BIND&nbsp;8.2.2&lowbar;P7 tout joliment placé dans son
environnement restreint et assez peaufiné à votre goût&hellip; et vous
entendez parler de cette rumeur désagréable qu'il y a une faille root
exploitable à distante dans cette version également, et vous avez besoin
de mettre à jour en 8.2.3 tout de suite. Devez-vous repasser entièrement
par ce long processus pour installer cette nouvelle version&nbsp;?

</para>

<para>

Non. En fait, vous avez juste besoin de la section <xref
linkend="compiling"/> et les deux premières parties de la section <xref
linkend="installing"/> (installation des binaires en dehors et à
l'intérieur de l'environnement restreint, respectivement).

</para>

<para>

Le reste de ce guide pratique traite de la mise en place de
l'environnement restreint et d'autres choses de ce genre-là, qui ne
devrait pas devoir être changé entre les versions du BIND. Vous devez
juste déposer les nouveaux binaires par-dessus les anciens, et vous
pouvez continuer. Mais n'oubliez pas d'arrêter et de redémarrer BIND par
la suite ou c'est l'ancienne version, vulnérable, qui continuera à 
tourner&nbsp;!

</para>

</section>

<section id="thanks">
<title>Remerciements</title>

<para>

Je voudrais remercier les gens suivants pour leur aide dans la création
de ce guide pratique&nbsp;:

</para>

<itemizedlist>

<listitem><para>

Lonny Selinger

<email>lonny CHEZ abyss POINT za POINT org</email> 

pour «&nbsp;l'évaluation&nbsp;» de la première version de ce guide
pratique et pour s'être assuré que je n'avais rien oublié.

</para></listitem>

<listitem><para>

Chirik

<email>chirik CHEZ CastleFur POINT COM</email>,

Dwayne Litzenberger

<email>dlitz CHEZ dlitz POINT net</email>,

Phil Bambridge

<email>phil POINT b CHEZ cableinet POINT co POINT uk</email>,

Robert Cole

<email>rcole CHEZ metrum-datatape POINT com</email>,

Colin MacDonald

<email>colinm CHEZ telus POINT net</email>,

et d'autres qui ont mis le doigt sur des erreurs, des omissions, et
prodigué d'autres conseils utiles pour faire que ce guide pratique soit
meilleur encore.

</para></listitem>

<listitem><para>

Erik Wallin

<email>erikw CHEZ sec POINT se</email>

et Brian Cervenka 

<email>brian CHEZ zerobelow POINT org</email>

pour avoir fourni de bonnes suggestions pour mieux sécuriser
encore l'environnement restreint.

</para></listitem>

</itemizedlist>

<para>

Et le dernier mais certainement pas le moindre, je voudrais remercier
Nakano Takeo

<email>nakano CHEZ apm POINT seikei POINT ac POINT jp</email>

pour avoir traduit en japonais ce guide pratique de BIND&nbsp;8 en
environnement restreint. Vous pouvez trouver sa traduction à l'adresse
<ulink url="http://www.linux.or.jp/JF/JFdocs/Chroot-BIND-HOWTO.html"/>.

</para>

</section>

<section id="legal">

<title>Politique de distribution de ce document</title>

<para>

Copyright &copy; Scott Wunsch, 2000-2001 pour la version originale.

</para>

<para>

Copyright &copy; 2004-2005 Vincent Loupien, Isabelle Hurbain et
Jean-Philippe Guérard pour la version française.

</para>

<para>

Ce document peut être distribué selon les termes de la licence LDP tels
que définis à l'adresse <ulink
url="http://metalab.unc.edu/LDP/COPYRIGHT.html"/>.

</para>

<para>

Ce guide pratique est une documentation libre&nbsp;; vous pouvez le 
redistribuer ou le modifier conformément à la licence de LDP. Il est 
distribué dans l'espoir qu'il sera utile, mais <emphasis remap="bf">sans 
aucune garantie</emphasis>&nbsp;; sans même les garanties de 
commercialisation ou d'adaptation dans un but spécifique. Voir la 
licence de LDP pour plus de détails.

</para>

</section>

</appendix>

</article>
