<html><head><META http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>
    Guide pratique de sauvegarde et de r&eacute;cup&eacute;ration sous Linux
</title><link href="style.css" rel="stylesheet" type="text/css"><meta content="DocBook XSL Stylesheets V1.67.2" name="generator"><meta name="description" content="

    Imaginez une seconde que votre disque dur vient de se transformer en 
    un palet de hockey hors de prix. Imaginez qu'apr&egrave;s un incendie, 
    votre ordinateur ressemble &agrave; un sujet que Salvador Dali
    appr&eacute;cierait. Et maintenant&nbsp;?

 

    La restauration compl&egrave;te, que l'on appelle parfois restauration 
    int&eacute;grale de syst&egrave;me, est un processus consistant &agrave; remonter un 
    ordinateur apr&egrave;s une panne catastrophique. Pour effectuer une 
    restauration compl&egrave;te, vous devez disposer de sauvegardes compl&egrave;tes, 
    non seulement de vos syst&egrave;mes de fichiers, mais aussi des 
    informations sur vos partitions, ainsi que sur d'autres donn&eacute;es. Ce 
    guide pratique est un tutoriel qui vous montrera pas &agrave; pas comment 
    sauvegarder un ordinateur sous Linux pour &ecirc;tre en mesure d'effectuer 
    une restauration int&eacute;grale de syst&egrave;me, et comment effectuer cette 
    restauration int&eacute;grale de syst&egrave;me. Il comprend des scripts destin&eacute;s 
    &agrave; ces t&acirc;ches.

"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div class="article" lang="fr"><div class="titlepage"><div><div><h1 class="title"><a name="index"></a>
    Guide pratique de sauvegarde et de r&eacute;cup&eacute;ration sous Linux
</h1></div><div><h3 class="subtitle"><i>
    Version fran&ccedil;aise du guide pratique <span class="foreignphrase" lang="en"><em class="foreignphrase">Linux Complete 
    Backup and Recovery HOWTO</em></span>
</i></h3></div><div><div class="author"><h3 class="author"><span class="firstname">Charles</span> <span class="surname">Curley</span></h3><code class="email">&lt;<a href="mailto:charlescurley CHEZ charlescurley POINT com">charlescurley CHEZ charlescurley POINT com</a>&gt;</code></div></div><div><p class="othercredit"><span class="contrib">Adaptation fran&ccedil;aise</span>: <span class="firstname">Denis</span> <span class="surname">Berhaut</span></p></div><div><p class="othercredit"><span class="contrib">Relecture de la version fran&ccedil;aise</span>: <span class="firstname">Guillaume</span> <span class="surname">Lelarge</span></p></div><div><p class="othercredit"><span class="contrib">Pr&eacute;paration de la publication de la v.f.</span>: <span class="firstname">Jean-Philippe</span> <span class="surname">Gu&eacute;rard</span></p></div><div><p class="releaseinfo">1.6.fr.1.0</p></div><div><p class="pubdate">10 octobre 2004</p></div><div><div class="revhistory"><table summary="Revision history" width="100%" border="1"><tr><th colspan="3" valign="top" align="left"><b>Historique des versions</b></th></tr><tr><td align="left">Version 1.6.fr.1.0</td><td align="left">2004-10-10</td><td align="left">DB, GL, JPG</td></tr><tr><td colspan="3" align="left">

    Premi&egrave;re adaptation fran&ccedil;aise.

</td></tr><tr><td align="left">Version 1.6</td><td align="left">2004-04-29</td><td align="left">C^2</td></tr><tr><td colspan="3" align="left">

        Ajout de notes sur Knoppix, Syslinux, PPART, QtParted, quelques 
        autres CDROM de secours, ainsi que quelques corrections.

        <span class="emphasis"><em>(Added Knoppix notes, Syslinux, PPART, QtParted,
        some other rescue CDs, and made some fixes.)</em></span>

    </td></tr><tr><td align="left">Version 1.5</td><td align="left">2003-12-19</td><td align="left">C^2</td></tr><tr><td colspan="3" align="left">
    
        Notes sur Fedora et GRUB.

        <span class="emphasis"><em>(Fedora and GRUB notes.)</em></span>
    
    </td></tr><tr><td align="left">Version 1.4</td><td align="left">2003-08-17</td><td align="left">C^2</td></tr><tr><td colspan="3" align="left">
    
        Quelques notes sur le gravage des CDROM et rajouts concernant
        les fichiers &agrave; exclure.
    
        <span class="emphasis"><em>(Some notes on burning CD-ROMs, and more 
        on files to exclude.)</em></span>

    </td></tr><tr><td align="left">Version 1.3</td><td align="left">2003-04-24</td><td align="left">C^2</td></tr><tr><td colspan="3" align="left">
    
        Substitution d'une nouvelle adresse de courrier &eacute;lectronique et d'une
        URL aux anciennes.

        <span class="emphasis"><em>(Substituted new email address and URL for 
        old.)</em></span>
        
    </td></tr><tr><td align="left">Version 1.2</td><td align="left">2003-02-12</td><td align="left">C^2</td></tr><tr><td colspan="3" align="left">
    
        Ajout de notes pour Red Hat 8.0, pour le support de FAT32, 
        scission de la premi&egrave;re &eacute;tape des scripts de restauration, ainsi 
        que quelques changements mineurs. Notes sur <a href="#amanda" title="8.5.&nbsp;Amanda">Amanda</a>.

        <span class="emphasis"><em>(Added Red Hat 8.0 notes, support for FAT32, split
        the first stage restore scripts, and other minor changes. Notes on 
        <a href="#amanda" title="8.5.&nbsp;Amanda">Amanda</a>.)</em></span>

    </td></tr><tr><td align="left">Version 1.1</td><td align="left">2002-09-10</td><td align="left">C^2</td></tr><tr><td colspan="3" align="left">
	
        Nouveau code pour prendre en charge les partitions ext3 dans le 
        fichier <a href="#make.fdisk" title="11.1.1.&nbsp;make.fdisk"><code class="filename">make.fdisk</code></a>, 
        ainsi qu'une note sur <a href="#initrd" title="4.1.5.&nbsp;Initrd"><code class="filename">initrd</code></a>.

        <span class="emphasis"><em>(New code to handle ext3 partitions in <a href="#make.fdisk" title="11.1.1.&nbsp;make.fdisk"> <code class="filename">make.fdisk</code> </a>, 
        and a note on <a href="#initrd" title="4.1.5.&nbsp;Initrd"> 
        <code class="filename">initrd</code> </a>.)</em></span>

    </td></tr><tr><td align="left">Version 1.0</td><td align="left">2002-07-24</td><td align="left">C^2</td></tr><tr><td colspan="3" align="left">
    
        D&eacute;sormais, nous utilisons la compression bz2 pour la premi&egrave;re 
        &eacute;tape, disposons de l'option &laquo;&nbsp;run time&nbsp;&raquo; pour la 
        v&eacute;rification des blocs d&eacute;fectueux et avons cr&eacute;&eacute; un script qui 
        ex&eacute;cute enti&egrave;rement la premi&egrave;re &eacute;tape.
    
        <span class="emphasis"><em>(We now use bz2 compression in the first 
        stage, have the run time option to check for bad 
        blocks, and have a script that runs the entire first 
        stage.)</em></span>

    </td></tr></table></div></div><div><div class="abstract"><p class="title"><b>R&eacute;sum&eacute;</b></p><p>

    Imaginez une seconde que votre disque dur vient de se transformer en 
    un palet de hockey hors de prix. Imaginez qu'apr&egrave;s un incendie, 
    votre ordinateur ressemble &agrave; un sujet que Salvador Dali
    appr&eacute;cierait. Et maintenant&nbsp;?

</p><p>

    La restauration compl&egrave;te, que l'on appelle parfois restauration 
    int&eacute;grale de syst&egrave;me, est un processus consistant &agrave; remonter un 
    ordinateur apr&egrave;s une panne catastrophique. Pour effectuer une 
    restauration compl&egrave;te, vous devez disposer de sauvegardes compl&egrave;tes, 
    non seulement de vos syst&egrave;mes de fichiers, mais aussi des 
    informations sur vos partitions, ainsi que sur d'autres donn&eacute;es. Ce 
    guide pratique est un tutoriel qui vous montrera pas &agrave; pas comment 
    sauvegarder un ordinateur sous Linux pour &ecirc;tre en mesure d'effectuer 
    une restauration int&eacute;grale de syst&egrave;me, et comment effectuer cette 
    restauration int&eacute;grale de syst&egrave;me. Il comprend des scripts destin&eacute;s 
    &agrave; ces t&acirc;ches.

</p></div></div></div><hr></div><div class="toc"><p><b>Table des mati&egrave;res</b></p><dl><dt><span class="sect1"><a href="#intro">1. Introduction</a></span></dt><dd><dl><dt><span class="sect2"><a href="#copyright">1.1. 

    Droits d'utilisation <span class="foreignphrase" lang="en"><em class="foreignphrase">(Copyright 
    Information)</em></span>

</a></span></dt><dt><span class="sect2"><a href="#disclaimers">1.2. 
    Limitation de Responsabilit&eacute;
    
    (<span class="foreignphrase" lang="en"><em class="foreignphrase">Disclaimers</em></span>)
    
</a></span></dt><dt><span class="sect2"><a href="#newversions">1.3. Nouvelles versions</a></span></dt><dt><span class="sect2"><a href="#credits">1.4. Historique</a></span></dt><dt><span class="sect2"><a href="#feedback">1.5. Commentaires et r&eacute;actions</a></span></dt><dt><span class="sect2"><a href="#translations">1.6. Traductions</a></span></dt></dl></dd><dt><span class="sect1"><a href="#Overview">2. Tour d'horizon</a></span></dt><dd><dl><dt><span class="sect2"><a href="#limitations">2.1. Limitations</a></span></dt></dl></dd><dt><span class="sect1"><a href="#Preparation">3. Pr&eacute;paration</a></span></dt><dd><dl><dt><span class="sect2"><a href="#installingzipdrive">3.1. Installation du lecteur ZIP</a></span></dt></dl></dd><dt><span class="sect1"><a href="#CreatingtheStage1BackUp">4. Cr&eacute;ation de la sauvegarde de l'&eacute;tape 1</a></span></dt><dd><dl><dt><span class="sect2"><a href="#ThemeAndVariations">4.1. Variations sur le th&egrave;me</a></span></dt></dl></dd><dt><span class="sect1"><a href="#firststagerestore">5. Premi&egrave;re &eacute;tape de restauration</a></span></dt><dd><dl><dt><span class="sect2"><a href="#Bootingtomsrtbt">5.1. D&eacute;marrer tomsrtbt</a></span></dt><dt><span class="sect2"><a href="#restoration">5.2. Restauration</a></span></dt></dl></dd><dt><span class="sect1"><a href="#SecondStageRestoration">6. Seconde &eacute;tape de la restauration</a></span></dt><dt><span class="sect1"><a href="#DistributionSpecificNotes">7. Notes sp&eacute;cifiques aux distributions</a></span></dt><dd><dl><dt><span class="sect2"><a href="#fedora">7.1. Fedora</a></span></dt><dt><span class="sect2"><a href="#redhat9">7.2. Red Hat 9</a></span></dt><dt><span class="sect2"><a href="#redhat80">7.3. Red Hat 8.0</a></span></dt><dt><span class="sect2"><a href="#RedHat71">7.4. Red Hat 7.1</a></span></dt><dt><span class="sect2"><a href="#RedHat70">7.5. Red Hat 7.0</a></span></dt><dt><span class="sect2"><a href="#knoppix">7.6. Knoppix</a></span></dt></dl></dd><dt><span class="sect1"><a href="#ApplicationSpecificNotes">8. 
Notes concernant certaines application</a></span></dt><dd><dl><dt><span class="sect2"><a href="#grub">8.1. 
GRUB</a></span></dt><dt><span class="sect2"><a href="#tripwire">8.2. 
Tripwire</a></span></dt><dt><span class="sect2"><a href="#Squid">8.3. 
Squid</a></span></dt><dt><span class="sect2"><a href="#arkeia">8.4. 
Arkeia</a></span></dt><dt><span class="sect2"><a href="#amanda">8.5. Amanda</a></span></dt></dl></dd><dt><span class="sect1"><a href="#SomeAdviceforDisasterRecovery">9. Quelques conseils pour une r&eacute;cup&eacute;ration apr&egrave;s un d&eacute;sastre</a></span></dt><dt><span class="sect1"><a href="#WhatNow">10. Et maintenant&nbsp;?</a></span></dt><dd><dl><dt><span class="sect2"><a href="#todo">10.1. Liste de travail</a></span></dt></dl></dd><dt><span class="sect1"><a href="#TheScripts">11. Les scripts</a></span></dt><dd><dl><dt><span class="sect2"><a href="#FirstStage">11.1. Premi&egrave;re &eacute;tape</a></span></dt><dt><span class="sect2"><a href="#SecondStage">11.2. Deuxi&egrave;me &eacute;tape</a></span></dt><dt><span class="sect2"><a href="#BackupServerScripts">11.3. Scripts de sauvegarde du serveur</a></span></dt></dl></dd><dt><span class="sect1"><a href="#resources">12. Ressources</a></span></dt><dt><span class="appendix"><a href="#appendix1gfdl">A. License GNU Free Documentation</a></span></dt><dd><dl><dt><span class="sect1"><a href="#gfdl02">0. 
PREAMBULE</a></span></dt><dt><span class="sect1"><a href="#gfdl03">1. 
APPLICABILITY AND DEFINITIONS</a></span></dt><dt><span class="sect1"><a href="#gfdl04">2. 
VERBATIM COPYING</a></span></dt><dt><span class="sect1"><a href="#gfdl05">3. 
COPYING IN QUANTITY</a></span></dt><dt><span class="sect1"><a href="#gfdl06">4. 
MODIFICATIONS</a></span></dt><dt><span class="sect1"><a href="#gfdl07">5. 
COMBINING DOCUMENTS</a></span></dt><dt><span class="sect1"><a href="#gfdl08">6. 
COLLECTIONS OF DOCUMENTS</a></span></dt><dt><span class="sect1"><a href="#gfdl09">7. 
AGGREGATION WITH INDEPENDENT WORKS</a></span></dt><dt><span class="sect1"><a href="#gfdl10">8. 
TRANSLATION</a></span></dt><dt><span class="sect1"><a href="#gfdl11">9. 
TERMINATION</a></span></dt><dt><span class="sect1"><a href="#gfdl12">10. 
FUTURE REVISIONS OF THIS LICENSE</a></span></dt><dt><span class="sect1"><a href="#gfdl13">11. 
How to use this License for your documents</a></span></dt></dl></dd></dl></div><div class="sect1" lang="fr"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="intro"></a>1.&nbsp;Introduction</h2></div></div></div><p>

Le processus de restauration int&eacute;grale de syst&egrave;me consiste &agrave;&nbsp;: 
installer le syst&egrave;me d'exploitation &agrave; partir des disques du produit. 
installer le logiciel de sauvegarde de fa&ccedil;on &agrave; pouvoir restaurer vos 
donn&eacute;es. Restaurer vos donn&eacute;es. Puis, il vous faudra restaurer les 
fonctionnalit&eacute;s en v&eacute;rifiant vos fichiers de configuration, les 
droits, etc.

</p><p>

    Le processus et les scripts d&eacute;crits dans ce guide pratique 
    sauvegarderont la r&eacute;installation du syst&egrave;me d'exploitation. Le 
    processus d&eacute;crit ici restaurera uniquement les sauvegardes des 
    fichiers de l'ordinateur de production. La restauration vous 
    r&eacute;tablira votre configuration intacte, vous &eacute;pargnant des heures de 
    v&eacute;rification de votre configuration et des donn&eacute;es.

</p><div class="sect2" lang="fr"><div class="titlepage"><div><div><h3 class="title"><a name="copyright"></a>1.1.&nbsp;

    Droits d'utilisation <span class="foreignphrase" lang="en"><em class="foreignphrase">(Copyright 
    Information)</em></span>

</h3></div></div></div><p>

Copyright &copy; 2001, 2002, 2003 Charles Curley pour la version 
originale.

</p><p>

Copyright &copy; 2004 Denis Berhaut, Guillaume Lelarge, Jean-Philippe Gu&eacute;rard
pour la version fran&ccedil;aise.

</p><p>

Ce document est distribu&eacute; selon les termes de la licence GNU Free 
Documentation License (GFDL), d&eacute;crite ci-dessous. Permission est 
accord&eacute;e de copier, distribuer et de modifier ce document selon les 
termes de la GNU Free Documentation Licence, version 1.1 ou ult&eacute;rieure 
publi&eacute;e par la Free Software Foundation &agrave; condition qu'il ne contienne 
ni Section Inalt&eacute;rable, ni texte de premi&egrave;re ou de quatri&egrave;me de 
couverture. Une copie de la licence est incluse dans la section <a href="#appendix1gfdl" title="A.&nbsp;License GNU Free Documentation">&laquo;&nbsp;<span class="quote">Licence GNU Free 
Documentation</span>&nbsp;&raquo;</a>.

</p><p><span class="foreignphrase" lang="en"><em class="foreignphrase">

Copyright &copy; 2001, 2002, 2003 Charles Curley and distributed under the 
terms of the GNU Free Documentation License (GFDL) license, stated 
below. Permission is granted to copy, distribute and/or modify this 
document under the terms of the GNU Free Documentation License, Version 
1.1 or any later version published by the Free Software Foundation; with 
no Invariant Sections, with no Front-Cover Texts, and with no Back-Cover 
Texts. A copy of the license is included in the section entitled <a href="#appendix1gfdl" title="A.&nbsp;License GNU Free Documentation">&ldquo;<span class="quote">GNU Free Documentation 
License</span>&rdquo;</a>.

</em></span></p><p><span class="foreignphrase" lang="en"><em class="foreignphrase">

If you have any questions, please contact 

<code class="email">&lt;<a href="mailto:linux-howto at metalab.unc.edu">linux-howto at metalab.unc.edu</a>&gt;</code>.

</em></span></p><p>

Pour toute question relative &agrave; la version originale de ce document, 
veuillez contacter en anglais

<code class="email">&lt;<a href="mailto:linux TIRET howto CHEZ metalab POINT unc POINT edu">linux TIRET howto CHEZ metalab POINT unc POINT edu</a>&gt;</code>.

</p><p>

    N'h&eacute;sitez pas &agrave; faire parvenir tout commentaire relatif &agrave; la version 
    fran&ccedil;aise de ce document &agrave;

    <code class="email">&lt;<a href="mailto:commentaires CHEZ traduc POINT org">commentaires CHEZ traduc POINT org</a>&gt;</code>

    en pr&eacute;cisant son titre, sa date et sa version.

</p></div><div class="sect2" lang="fr"><div class="titlepage"><div><div><h3 class="title"><a name="disclaimers"></a>1.2.&nbsp;
    Limitation de Responsabilit&eacute;
    
    (<span class="foreignphrase" lang="en"><em class="foreignphrase">Disclaimers</em></span>)
    
</h3></div></div></div><p>
 
    Ni l'auteur de ce document, ni le <a href="http://www.tldp.org/" target="_top">Projet de documentation Linux</a> ou 
    qui que ce soit d'autre ne pourra &ecirc;tre tenu responsable du contenu 
    de ce document. L'utilisation des concepts, exemples et autres 
    contenus du document s'effectue &agrave; vos risques et p&eacute;rils. Il peut 
    comporter des erreurs ou des inexactitudes pouvant endommager votre 
    syst&egrave;me. Proc&eacute;dez prudemment, et bien qu'il n'y ait probablement pas 
    d'erreur, l'auteur d&eacute;gage toute responsabilit&eacute; &agrave; leur sujet.

</p><p><span class="foreignphrase" lang="en"><em class="foreignphrase">

     No liability for the contents of this documents can be accepted by 
     the author, the <a href="http://www.tldp.org/" target="_top">Linux 
     Documentation Project</a> or anyone else. Use the concepts, 
     examples and other content at your own risk. There may be errors 
     and inaccuracies that may damage your system. Proceed with caution, 
     and, although errors are unlikely, the author take no 
     responsibility for them.

</em></span></p><p>

    Sauf mention sp&eacute;cifique, les droits d'auteur sont la possession de 
    leurs propri&eacute;taires respectifs. L'utilisation d'un terme dans ce 
    document ne devrait pas &ecirc;tre consid&eacute;r&eacute;e comme ayant une influence 
    sur la validit&eacute; d'une quelconque marque d&eacute;pos&eacute;e ou marque de 
    services.

</p><p><span class="foreignphrase" lang="en"><em class="foreignphrase">

    All copyrights are held by their by their respective owners, unless 
    specifically noted otherwise. Use of a term in this document should 
    not be regarded as affecting the validity of any trademark or 
    service mark.

</em></span></p><p>
 
    Le fait de nommer un produit ou une marque ne doit pas &ecirc;tre 
    consid&eacute;r&eacute; comme une approbation.

</p><p><span class="foreignphrase" lang="en"><em class="foreignphrase">

    Naming of particular products or brands should not be seen as 
    endorsements.

</em></span></p><p>

    Nous vous recommandons fortement d'effectuer une sauvegarde de votre 
    syst&egrave;me avant une installation importante et d'effectuer des 
    sauvegardes &agrave; intervalles r&eacute;guliers. De plus, nous vous recommandons 
    fortement d'utiliser un ordinateur exp&eacute;rimental d&eacute;di&eacute; lorsque vous 
    mettrez les mains dans le cambouis des mat&eacute;riaux de ce guide 
    pratique, en particulier les scripts.

</p><p><span class="foreignphrase" lang="en"><em class="foreignphrase">

    You are strongly recommended to take a backup of your system before 
    major installation and backups at regular intervals. In addition, 
    you are strongly recommended to use a sacrificial experimental 
    computer when mucking with the material, especially the scripts, in 
    this HOWTO.

</em></span></p></div><div class="sect2" lang="fr"><div class="titlepage"><div><div><h3 class="title"><a name="newversions"></a>1.3.&nbsp;Nouvelles versions</h3></div></div></div><p>

Vous pourrez trouver ce document &agrave; sa <a href="http://www.charlescurley.com/Linux-Complete-Backup-and-Recovery-HOWTO.html" target="_top">page 
d'accueil</a> ou sur le site internet du <a href="http://www.tldp.org/" target="_top">projet de documentation Linux</a> dans de 
nombreux formats. Envoyez vos commentaires &agrave; l'adresse 
<code class="email">&lt;<a href="mailto:charlescurley CHEZ charlescurley POINT com">charlescurley CHEZ charlescurley POINT com</a>&gt;</code>.

</p><p>

En fonction de votre navigateur, il vous faudra peut-&ecirc;tre maintenir la 
touche majuscule appuy&eacute;e pour les t&eacute;l&eacute;charger lorsque vous cliquerez 
dessus.

</p><div class="itemizedlist"><ul type="disc"><li><p>

<a href="http://www.charlescurley.com/Linux-Complete-Backup-and-Recovery-HOWTO/Linux-Complete-Backup-and- Recovery-HOWTO.chunky.html.tar.bz2" target="_top">compression 
bzip2 de divers fichiers (beaucoup de petites pages. Lecture plus 
rapide.) HTML</a>

</p></li><li><p>

<a href="http://www.charlescurley.com/Linux-Complete-Backup-and-Recovery-HOWTO/Linux-Complete-Backup-and- Recovery-HOWTO.smooth.html.tar.bz2" target="_top"> 
compression bzip2 &laquo;&nbsp;<span class="quote">douce</span>&nbsp;&raquo; (une &eacute;norme page &mdash; pas de 
petits fichiers. Recherches plus faciles). HTML</a>

</p></li><li><p>

<a href="http://www.charlescurley.com/Linux-Complete-Backup-and-Recovery-HOWTO/Linux-Complete-Backup-and- Recovery-HOWTO.ps.bz2" target="_top"> 
compression bzip2 postscript (format lettre US)</a>

</p></li><li><p>

<a href="http://www.charlescurley.com/Linux-Complete-Backup-and-Recovery-HOWTO/Linux-Complete-Backup-and- Recovery-HOWTO.pdf.bz2" target="_top"> 
compression bzip2 PDF (format lettre US)</a>

</p></li><li><p>

<a href="http://www.charlescurley.com/Linux-Complete-Backup-and-Recovery-HOWTO/Linux-Complete-Backup-and- Recovery-HOWTO.txt.bz2" target="_top">
compression bzip2 texte brut ASCII</a>

</p></li><li><p>

Utilise les <a href="http://www.charlescurley.com/Linux-Complete-Backup-and-Recovery-HOWTO/Linux-Complete-Backup-and- Recovery-HOWTO.tar.bz2" target="_top">sources</a>, 
Luke.

</p></li></ul></div></div><div class="sect2" lang="fr"><div class="titlepage"><div><div><h3 class="title"><a name="credits"></a>1.4.&nbsp;Historique</h3></div></div></div><p>

Ce document provient de deux articles publi&eacute;s &agrave; l'origine dans <a href="http://www.linuxjournal.com/" target="_top"><em class="citetitle">le 
Linux Journal</em></a>. Je tiens &agrave; remercier <em class="citetitle"> le Linux Journal</em> pour avoir modifi&eacute; les 
droits sur ces articles, rendant la r&eacute;daction de ce guide pratique 
possible.

</p><p>

Je remercie particuli&egrave;rement Joy Y Goodreau pour son excellente mise en forme du
guide pratique, et David Palomares pour avoir corrig&eacute; l'orthographe du pr&eacute;nom de
Salvador Dali.

</p><p>

D'autres remerciements vont &agrave; <a href="mailto:pon CHEZ iki POINT fi" target="_top">
Pasi Oja-Nisula</a> pour avoir corrig&eacute; un bogue et fourni des informations sur
<a href="http://www.knoppix-fr.org/" target="_top">Knoppix</a>.

</p></div><div class="sect2" lang="fr"><div class="titlepage"><div><div><h3 class="title"><a name="feedback"></a>1.5.&nbsp;Commentaires et r&eacute;actions</h3></div></div></div><p>

Les r&eacute;actions que vous pourrez faire &agrave; ce document sont bienvenues. Sans vos
corrections, suggestions et autres apports, ce document n'existerait pas.
Envoyez-moi, en anglais, vos ajouts, commentaires et critiques &agrave; cette adresse&nbsp;:
<code class="email">&lt;<a href="mailto:charlescurley CHEZ charlescurley POINT com">charlescurley CHEZ charlescurley POINT com</a>&gt;</code>.

</p><p>
    
    N'h&eacute;sitez pas &agrave; faire parvenir tout commentaire relatif &agrave; la
    version fran&ccedil;aise de ce document &agrave;
    
    <code class="email">&lt;<a href="mailto:commentaires CHEZ traduc POINT org">commentaires CHEZ traduc POINT org</a>&gt;</code>
    
    en pr&eacute;cisant son titre, sa date et sa version.
    
</p></div><div class="sect2" lang="fr"><div class="titlepage"><div><div><h3 class="title"><a name="translations"></a>1.6.&nbsp;Traductions</h3></div></div></div><p>

Tout le monde ne parle pas anglais. Les volontaires sont bienvenus.

</p><p>

<a href="http://www.traduc.org/docs/howto/lecture/" target="_top">Traduction en 
fran&ccedil;ais</a> par

<span class="firstname">Denis</span> <span class="surname">Berhaut</span>

<code class="email">&lt;<a href="mailto:denis POINT berhaut CHEZ free POINT fr">denis POINT berhaut CHEZ free POINT fr</a>&gt;</code>

</p><p>

Relecture par

<span class="firstname">Guillaume</span> <span class="surname">Lelarge</span>

<code class="email">&lt;<a href="mailto:gleu CHEZ wanadoo POINT fr">gleu CHEZ wanadoo POINT fr</a>&gt;</code>

</p></div></div><div class="sect1" lang="fr"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="Overview"></a>2.&nbsp;Tour d'horizon</h2></div></div></div><p>

Mettre en œuvre le processus pr&eacute;sent&eacute; ci-dessous n'est pas facile et 
peut &ecirc;tre dangereux pour vos donn&eacute;es. Entra&icirc;nez-vous avant d'en avoir 
besoin&nbsp;! Faites comme moi et <span class="emphasis"><em>utilisez un ordinateur 
sacrifi&eacute; d'avance.</em></span>&nbsp;!

</p><p>

Dans ce guide pratique, l'ordinateur cible est un Pentium. &Agrave; l'origine, 
la version de <a href="http://www.fr.redhat.com" target="_top">Red Hat</a> 7.1 
Linux serveur ou poste de travail &eacute;tait install&eacute;e sur un disque dur IDE. 
Depuis, il a &eacute;t&eacute; mis &agrave; jour vers la Red Hat 8.0 et <a href="http://fedora.redhat.com/" target="_top">Fedora Core 1</a>. L'ordinateur 
cible ne contient pas beaucoup de donn&eacute;es dans la mesure o&ugrave; c'est une 
&laquo;&nbsp;<span class="quote">machine sacrifi&eacute;e</span>&nbsp;&raquo; consacr&eacute;e aux tests. En fait, je ne 
voulais pas tester ce processus avec un ordinateur de production et des 
donn&eacute;es de production. Aussi, j'ai effectu&eacute; une installation avant 
d'engager les tests pour &ecirc;tre en mesure de r&eacute;installer si j'avais besoin 
de retourner &agrave; une configuration connue.

</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note: N.B."><tr><td valign="top" align="center" rowspan="2" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">N.B.</th></tr><tr><td valign="top" align="left" colspan="2"><p>
 
Les exemples de commandes montreront, en g&eacute;n&eacute;ral, ce que j'ai d&ucirc; 
effectuer pour r&eacute;cup&eacute;rer le syst&egrave;me cible. Vous utiliserez sans doute 
des commandes similaires, mais avec des param&egrave;tres diff&eacute;rents. C'est &agrave; 
vous de vous assurer que vous dupliquez votre configuration, et non pas 
la configuration de l'ordinateur de test.

  </p></td></tr></table></div><p>

La proc&eacute;dure initiale a &eacute;t&eacute; mise au point dans le livre de W. Curtis Preston,
<a href="http://www.oreilly.com/catalog/unixbr/" target="_top">
<em class="citetitle">Unix Backup &amp; Recovery</em></a>,
O'Reilly &amp; Associates, 1999, que j'ai approuv&eacute; dans le <a href="http://www2.linuxjournal.com/lj-issues/issue78/3839.html" target="_top">
<em class="citetitle">Linux Journal</em></a>.
Cependant, le livre est un peu l&eacute;ger en ce qui concerne les questions
sp&eacute;cifiques, concr&egrave;tes. Par exemple, quels fichiers faut-il sauvegarder&nbsp;?
Quelles m&eacute;ta donn&eacute;es sont &agrave; conserver, et comment&nbsp;?

</p><p>

Avant de d&eacute;marrer le processus publi&eacute; dans ce guide pratique, il vous faudra
sauvegarder votre syst&egrave;me &agrave; l'aide d'un outil de sauvegarde classique comme
Amanda, <span class="trademark">BRU</span>&trade;, tar, <span class="trademark">Arkeia</span>&reg;ou cpio. La question suivante sera de
d&eacute;terminer comment ex&eacute;cuter l'outil qui restaurera vos donn&eacute;es &agrave; partir d'un mat&eacute;riel
hors d'usage.

</p><p>

Les utilisateurs du Red Hat Package Manager (RPM) des distributions Linux
devront aussi sauver les m&eacute;ta donn&eacute;es RPM en tant que parties int&eacute;grantes de
leurs sauvegardes normales. Une instruction du type&nbsp;:

</p><pre class="programlisting">
bash# <span><strong class="command">rpm -Va &gt; /etc/rpmVa.txt</strong></span>
</pre><p>

dans votre script de sauvegarde vous donnera une base de comparaison du r&eacute;sultat
&agrave; obtenir apr&egrave;s une restauration int&eacute;grale de syst&egrave;me.

</p><p>
Pour arriver &agrave; ce point, il vous faut&nbsp;: </p><div class="itemizedlist"><ul type="disc"><li><p>
Votre mat&eacute;riel remont&eacute; et de nouveau en &eacute;tat de marche, les composants ayant &eacute;t&eacute;
remplac&eacute;s. Le BIOS devrait &ecirc;tre configur&eacute; correctement, y compris l'heure et la
date, ainsi que les param&egrave;tres du disque dur. &Agrave; ce stade, il n'y a pas de raison
d'utiliser un disque dur diff&eacute;rent.</p></li><li><p>
 Un lecteur <a href="http://www.iomega.com/" target="_top">
<span class="trademark">Iomega</span>&reg;
</a>
<a href="http://www.iomega.com/zip/products/par100_250.html" target="_top">
<span class="trademark">ZIP</span>&reg; sur port parall&egrave;le</a>
ou &eacute;quivalent. Vous aurez besoin d'au moins 30&nbsp;Mo d'espace libre.</p></li><li><p>Votre m&eacute;dia de sauvegarde.</p></li><li><p>Un syst&egrave;me Linux minimal pour vous permettre de lancer le logiciel de
restauration.</p></li></ul></div><p>
Pour en arriver l&agrave;, au moins deux &eacute;tapes de sauvegarde sont n&eacute;cessaires,
peut-&ecirc;tre trois. La nature exacte de ce que vous sauvegardez et &agrave; quelle &eacute;tape
vous sauvegardez est d&eacute;termin&eacute;e par votre processus de restauration. Par
exemple, si vous restaurez un serveur de bandes, il se peut que vous n'ayez pas
besoin du r&eacute;seau pendant le processus de restauration. Donc, sauvegardez le
r&eacute;seau uniquement lors de vos sauvegardes habituelles.</p><p>
De plus, vous restaurerez par &eacute;tapes. &Agrave; l'&eacute;tape une, nous construisons les
partitions, les syst&egrave;mes de fichiers, etc. et restaurons un minimum de fichiers
du disque ZIP. L'objectif de la premi&egrave;re &eacute;tape est de pouvoir initialiser un
ordinateur disposant d'une connexion r&eacute;seau, de lecteurs de bandes, d'un
logiciel de restauration ou de tout ce qui est n&eacute;cessaire pour l'&eacute;tape
deux.</p><p>
La seconde &eacute;tape si n&eacute;cessaire, consiste &agrave; restaurer le logiciel de sauvegarde
et les bases de donn&eacute;es associ&eacute;es. Par exemple, supposons que vous utilisiez
Arkeia et que vous pr&eacute;pariez un disque zip de restauration int&eacute;grale de syst&egrave;me
pour votre serveur de sauvegarde. Arkeia occupe &eacute;norm&eacute;ment d'espace pour sa base
de donn&eacute;es sur les disques durs du serveur. Si vous le d&eacute;sirez, vous pouvez
r&eacute;cup&eacute;rer la base de donn&eacute;es &agrave; partir des bandes. &Agrave; la place, pourquoi ne pas
archiver et compresser avec tar et gzip l'int&eacute;gralit&eacute; du r&eacute;pertoire arkeia
(/usr/knox), et l'enregistrer sur un autre ordinateur &agrave; l'aide de nfs ou
ssh&nbsp;? La premi&egrave;re &eacute;tape, comme nous l'avons d&eacute;fini plus bas, ne comprend pas X.
Vous aurez donc quelques tests &agrave; effectuer si vous d&eacute;sirez sauvegarder X avec
votre programme de sauvegarde. Pour certains programmes de restauration, X est
indispensable.</p><p>
Bien s&ucirc;r, si vous utilisez d'autres programmes de sauvegarde, vous aurez
peut-&ecirc;tre un travail de d&eacute;tective &agrave; effectuer. Vous devrez d&eacute;terminer les
r&eacute;pertoires et les fichiers n&eacute;cessaires &agrave; son fonctionnement. Si vous utilisez
tar, gzip, cpio, mt ou dd comme outils de sauvegarde et de restauration, ils
devront &ecirc;tre enregistr&eacute;s sur votre disque ZIP et restaur&eacute;s pendant la premi&egrave;re
&eacute;tape d&eacute;crite plus bas.</p><p>
La derni&egrave;re &eacute;tape est une restauration int&eacute;grale &agrave; partir d'une bande ou d'un
autre m&eacute;dia. Apr&egrave;s avoir termin&eacute; la derni&egrave;re &eacute;tape, vous devriez pouvoir
d&eacute;marrer un syst&egrave;me enti&egrave;rement restaur&eacute; et op&eacute;rationnel.</p><div class="sect2" lang="fr"><div class="titlepage"><div><div><h3 class="title"><a name="limitations"></a>2.1.&nbsp;Limitations</h3></div></div></div><p>
Ce guide pratique se limite &agrave; la cr&eacute;ation d'une sauvegarde minimum de sorte que,
ayant ensuite restaur&eacute; cette sauvegarde vers un nouveau mat&eacute;riel (&laquo;&nbsp;<span class="quote">
restauration int&eacute;grale de syst&egrave;me</span>&nbsp;&raquo;), vous pourrez ensuite utiliser vos
sauvegardes traditionnelles pour restaurer
un syst&egrave;me totalement op&eacute;rationnel. Ce guide pratique ne traite pas de vos
sauvegardes traditionnelles.</p><p>
M&ecirc;me dans ce cadre &eacute;troit, ce guide pratique n'est pas exhaustif. Vous devrez
encore faire des recherches, &eacute;diter des scripts et effectuer des tests.</p><p>
Les scripts pr&eacute;sent&eacute;s restaurent les donn&eacute;es des partitions telles qu'elles sont
sur le disque dur d'origine. Ce serait formidable si vous pouviez restaurer sur
un ordinateur identique ou au moins un disque dur identique, mais c'est rarement
le cas. Pour l'instant, il y a deux rem&egrave;des (qui prendront plus de sens apr&egrave;s
que vous ayez lu le reste du guide pratique)&nbsp;:</p><div class="itemizedlist"><ul type="disc"><li><p>
&Eacute;ditez le fichier d'entr&eacute;e de la table des partitions. Je l'ai fait quelquefois.
Vous pouvez aussi recourir &agrave; ce moyen pour ajouter de nouvelles partitions ou en
supprimer (mais &eacute;ditez les scripts qui utilisent aussi le fichier d'entr&eacute;es de
la table des partitions).</p></li><li><p>
Cr&eacute;ez &agrave; la main une nouvelle table des partitions et partez de ce point. c'est
une des raisons qui fait que <a href="#restore.metadata" title="11.1.6.&nbsp;restore.metadata"><code class="filename">
restore.metadata</code></a> n'appelle pas le script de reconstruction du
disque dur. Utilisez le <a href="#mount.dev.hda" title="11.1.3.&nbsp;mount.dev.hda">script de reconstruction</a>.</p></li></ul></div><p>
Les scripts pr&eacute;sent&eacute;s ici prennent en charge uniquement ext2fs, FAT12, FAT16 et
FAT32. Vous aurez besoin d'autres outils pour sauvegarder et restaurer des
syst&egrave;mes de fichiers que nous n'avons pas couverts, &agrave; moins que des volontaires
passionn&eacute;s ne codent les scripts pour le faire. <a href="http://www.partimage.org/" target="_top">Partition Image</a> se pr&eacute;sente comme un candidat
utile.</p></div></div><div class="sect1" lang="fr"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="Preparation"></a>3.&nbsp;Pr&eacute;paration</h2></div></div></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note: AVERTISSEMENT"><tr><td valign="top" align="center" rowspan="2" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">AVERTISSEMENT</th></tr><tr><td valign="top" align="left" colspan="2"><p>
Effectuez vos sauvegardes traditionnelles de fa&ccedil;on r&eacute;guli&egrave;re. Ce guide pratique
est sans int&eacute;r&ecirc;t si vous ne le faites pas.</p></td></tr></table></div><p>
Fabriquez vous-m&ecirc;me un disque de secours. J'utilise <a href="http://www.toms.net/rb" target="_top">tomsrtbt</a>. Il est bien document&eacute; et tient
sur une disquette qui comprend de nombreux
outils utiles. Sa liste de discussion est active et les quelques questions que
j'ai pos&eacute;es ont trouv&eacute; rapidement une r&eacute;ponse pr&eacute;cise. J'appr&eacute;cie cela dans un
produit dont ma boutique peut d&eacute;pendre un jour.</p><p>
Ensuite, imaginez comment sauvegarder le syst&egrave;me d'exploitation dont vous aurez
besoin pour restaurer vos sauvegardes traditionnelles. J'ai suivi les conseils
de Preston et j'ai utilis&eacute; un lecteur ZIP sur port parall&egrave;le. Les lecteurs
contiennent &agrave; peu pr&egrave;s 90&nbsp;Mo utiles. J'ai besoin d'environ 85&nbsp;Mo pour
sauvegarder mon ordinateur, ce qui fait qu'un lecteur de 100&nbsp;Mo peut &ecirc;tre votre
salut.</p><div class="sect2" lang="fr"><div class="titlepage"><div><div><h3 class="title"><a name="installingzipdrive"></a>3.1.&nbsp;Installation du lecteur ZIP</h3></div></div></div><p>
L'installation du lecteur ZIP est d&eacute;crite dans le <a href="http://www.tldp.org/HOWTO/mini/ZIP-Drive.html" target="_top">
guide pratique des disques ZIP</a>, qui est disponible aupr&egrave;s du <a href="http://www.tldp.org/" target="_top">Linux Documentation Project</a>
et, pour sa traduction fran&ccedil;aise, &agrave; l'adresse <a href="http://www.traduc.org/docs/howto/lecture/ZIP-Drive.html" target="_top">
http://www.traduc.org/docs/HOWTO/vf/ZIP-Drive.html</a>
. 
</p></div></div><div class="sect1" lang="fr"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="CreatingtheStage1BackUp"></a>4.&nbsp;Cr&eacute;ation de la sauvegarde de l'&eacute;tape 1</h2></div></div></div><p>
Votre sauvegarde de production &eacute;tant effectu&eacute;e, il est indispensable de
conserver les informations de partitions pour pouvoir les reconstruire.</p><p>
Le script  <a href="#make.fdisk" title="11.1.1.&nbsp;make.fdisk"><code class="filename">make.fdisk</code></a>
recherche les informations des partitions du disque dur et les enregistre dans
trois fichiers. Le premier est un script ex&eacute;cutable, nomm&eacute; <a href="#make.dev.hda" title="11.1.2.&nbsp;make.dev.hda"><code class="filename">make.dev.x</code></a> (o&ugrave; &laquo;&nbsp;<span class="quote">x</span>&nbsp;&raquo;
est le nom du fichier de p&eacute;riph&eacute;rique, c'est-&agrave;-dire hda). Le second est <a href="#mount.dev.hda" title="11.1.3.&nbsp;mount.dev.hda"><code class="filename">mount.dev.x</code></a>, qui cr&eacute;e les
points de montage et qui y monte les partitions nouvellement cr&eacute;&eacute;es. Le dernier,
<a href="#dev.hda" title="11.1.4.&nbsp;dev.hda"><code class="filename">dev.x</code></a>, est constitu&eacute; des
commandes n&eacute;cessaires &agrave; <span><strong class="command">fdisk</strong></span> pour construire les partitions.
Vous pr&eacute;cisez quel disque dur vous d&eacute;sirez, pour construire les scripts associ&eacute;s
(et donc les noms de fichiers) en nommant le fichier de p&eacute;riph&eacute;rique associ&eacute; comme
argument de <a href="#make.fdisk" title="11.1.1.&nbsp;make.fdisk"><code class="filename">make.fdisk</code></a>. Par
exemple, sur un syst&egrave;me IDE classique,</p><pre class="programlisting">
bash# <span><strong class="command">make.fdisk /dev/hda</strong></span>
</pre><p>
produit les scripts <a href="#make.dev.hda" title="11.1.2.&nbsp;make.dev.hda"><code class="filename">make.dev.hda</code></a>,
<a href="#mount.dev.hda" title="11.1.3.&nbsp;mount.dev.hda"><code class="filename">mount.dev.hda</code></a> ainsi que le
fichier en entr&eacute;e de <span><strong class="command">fdisk</strong></span>, <a href="#dev.hda" title="11.1.4.&nbsp;dev.hda"><code class="filename">dev.hda</code></a>.</p><p>
De plus, si <a href="#make.fdisk" title="11.1.1.&nbsp;make.fdisk"><code class="filename">make.fdisk</code></a>
rencontre une partition FAT, il conserve le secteur d'amor&ccedil;age de la partition
dans un fichier nomm&eacute; <code class="filename">dev.xy</code>, o&ugrave; x est le nom de p&eacute;riph&eacute;rique
du disque (c'est-&agrave;-dire sdc, hda) et y est le num&eacute;ro de la partition. Le secteur
d'amor&ccedil;age est le premier secteur (512 octets) de la partition. Ce secteur est
restaur&eacute; en m&ecirc;me temps que les partitions sont reconstruites, dans le script
<code class="filename">make.dev.hda</code>.</p><p>
Heureusement, le prix des disques durs s'effondre presque aussi vite que la
confiance du public envers les politiciens apr&egrave;s une &eacute;lection. Donc, c'est une
bonne chose que les fichiers produits soient au format texte et puissent &ecirc;tre
&eacute;dit&eacute;s manuellement. C'est la fa&ccedil;on la plus difficile mais la plus flexible pour
effectuer une reconstruction sur un plus grand disque de remplacement. (Voir 
<a href="#todo" title="10.1.&nbsp;Liste de travail">la liste du carnet de route</a>.)</p><p>
Les autres m&eacute;ta donn&eacute;es sont conserv&eacute;es dans le script <a href="#save.metadata" title="11.1.5.&nbsp;save.metadata"><code class="filename">save.metadata</code></a>.
Le script enregistre les informations de partition dans le fichier
<code class="filename">fdisk.hda</code> &agrave; la racine du disque ZIP. C'est une bonne id&eacute;e
d'imprimer ce fichier ainsi que votre <code class="filename">/etc/fstab</code> pour
avoir une copie durable au cas o&ugrave; vous devriez restaurer manuellement les
donn&eacute;es de la partition. Vous pouvez enregistrer une arborescence en alternant
l'utilisation de deux consoles virtuelles, par le lancement de
<span><strong class="command">fdisk</strong></span> dans l'une et en affichant par la commande
cat <code class="filename">/etc/fstab</code> ou <code class="filename">/fdisk.hda</code>
au besoin. Cependant, pratiquer ainsi peut mener &agrave; l'erreur.</p><p>
Vous voudrez aussi conserver les fichiers se rapportant &agrave; votre m&eacute;thode de
restauration. Par exemple, si vous utilisez nfs pour sauvegarder vos donn&eacute;es,
vous devrez conserver hosts.allow, hosts.deny, exports, etc. De m&ecirc;me, si vous
utilisez un processus de restauration adoss&eacute; au r&eacute;seau comme Amanda ou Quick
Restore, il vous faudra conserver les fichiers de configuration r&eacute;seau tels que
HOSTNAME, hosts, etc., ainsi que l'arborescence logicielle qui s'y
rapporte.</p><p>
La fa&ccedil;on la plus simple de r&eacute;gler ces questions ainsi que d'autres similaires
est de conserver l'int&eacute;gralit&eacute; du r&eacute;pertoire etc.</p><p>
Il est impossible &agrave; un lecteur ZIP de 100&nbsp;Mo de contenir &agrave; lui tout seul
l'installation d'une distribution moderne d'un serveur Linux. Nous ne pouvons
pas conserver l'ensemble du zinzin. Il nous faut &ecirc;tre bien plus s&eacute;lectifs. De
quels fichiers avons-nous besoin&nbsp;?</p><div class="itemizedlist"><ul type="disc"><li><p>
Le r&eacute;pertoire /boot.</p></li><li><p>
Le r&eacute;pertoire /etc et ses sous-r&eacute;pertoires.</p></li><li><p>
Les r&eacute;pertoires n&eacute;cessaires au moment du d&eacute;marrage.</p></li><li><p>
Les fichiers de p&eacute;riph&eacute;riques dans /dev.</p></li></ul></div><p>
Pour d&eacute;terminer les r&eacute;pertoires n&eacute;cessaires au d&eacute;marrage, il nous faut 
regarder dans le fichier d'initialisation du d&eacute;marrage 
<code class="filename">/etc/rc.sysinit</code>. Il d&eacute;termine son propre chemin 
ainsi&nbsp;:</p><pre class="programlisting">
PATH=/bin:/sbin:/usr/bin:/usr/sbin
export PATH
</pre><p>
Les essais et les erreurs ont indiqu&eacute; que nous avons besoin d'autres
r&eacute;pertoires, tels que <code class="filename">/dev</code>. Sous Linux, vous ne pouvez pas
faire grand-chose sans les fichiers de p&eacute;riph&eacute;riques.</p><p>
Lorsque vous lirez le script <a href="#save.metadata" title="11.1.5.&nbsp;save.metadata"><code class="filename">save.metadata</code></a>, vous remarquerez
que nous ne sauvegardons pas n&eacute;cessairement les fichiers qui sont appel&eacute;s par
leur chemin absolu.</p><p>
Il nous faudra peut-&ecirc;tre proc&eacute;der &agrave; plusieurs it&eacute;rations de sauvegarde, tester
la restauration int&eacute;grale du syst&egrave;me, r&eacute;installer d'un CDROM et essayer encore,
avant d'obtenir un script de sauvegarde fonctionnel. Pour la pr&eacute;paration de ce
guide pratique, j'ai fait cinq it&eacute;rations avant de r&eacute;ussir une restauration.
C'est la raison pour laquelle il est n&eacute;cessaire d'utiliser des scripts d&egrave;s que
possible. Testez soigneusement&nbsp;!</p><p>
L'une des choses &agrave; faire avec un syst&egrave;me bas&eacute; sur RPM est d'utiliser le
programme <span><strong class="command">rpm</strong></span> pour d&eacute;terminer l'emplacement des fichiers. Par
exemple, pour obtenir la liste compl&egrave;te des fichiers utilis&eacute;s par le paquet openssh,
saisissez&nbsp;:</p><pre class="programlisting">
bash# <span><strong class="command">rpm -ql openssh</strong></span>
</pre><p>
Certains &eacute;l&eacute;ments ne sont pas n&eacute;cessaires, comme les pages man. Vous pouvez les
inspecter un par un et d&eacute;cider de les sauvegarder ou non.</p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note: AVERTISSEMENT"><tr><td valign="top" align="center" rowspan="2" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">AVERTISSEMENT</th></tr><tr><td valign="top" align="left" colspan="2"><p>
La seconde &eacute;tape de la restauration est men&eacute;e sans que les fichiers pr&eacute;c&eacute;demment
restaur&eacute;s soient &eacute;cras&eacute;s. Cela signifie que les fichiers restaur&eacute;s durant la
premi&egrave;re &eacute;tape sont ceux qui seront utilis&eacute;s apr&egrave;s la fin de la restauration.
Donc, mettez &agrave; jour vos sauvegardes int&eacute;grales de syst&egrave;me &agrave; chaque fois que vous
mettez &agrave; jour des fichiers de ces r&eacute;pertoires.</p></td></tr></table></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note: AVERTISSEMENT"><tr><td valign="top" align="center" rowspan="2" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">AVERTISSEMENT</th></tr><tr><td valign="top" align="left" colspan="2"><p>
La version de <span><strong class="command">tar</strong></span> fournie avec <a href="http://www.toms.net/rb" target="_top">tomsrtbt</a> ne pr&eacute;serve pas le propri&eacute;taire lors de
la restauration. Ceci peut poser probl&egrave;me &agrave; des applications comme <a href="#amanda" title="8.5.&nbsp;Amanda">Amanda</a>. Amanda, outil de sauvegarde et de restauration,
a plusieurs r&eacute;pertoires dont le propri&eacute;taire est son utilisateur &eacute;ponyme. La
solution est&nbsp;:</p><div class="itemizedlist"><ul type="disc"><li><p>
Notez quels sont les r&eacute;pertoires et les fichiers dont root n'est pas
propri&eacute;taire.</p></li><li><p>
Notez l'identifiant de leurs propri&eacute;taires.</p></li><li><p>
Faites en sorte que le processus de restauration comprenne le r&eacute;tablissement du
propri&eacute;taire. Par exemple&nbsp;:</p><pre class="programlisting">
bash# <span><strong class="command">chown -R amanda:disk /var/lib/amanda</strong></span>
</pre><p>
vous pouvez aussi ajouter cette ligne &agrave; vos scripts de la deuxi&egrave;me &eacute;tape de
restauration, comme dans
<a href="#restore.tester" title="11.3.2.&nbsp;restore.tester"><code class="filename">restore.tester</code></a>.</p></li></ul></div></td></tr></table></div><div class="sect2" lang="fr"><div class="titlepage"><div><div><h3 class="title"><a name="ThemeAndVariations"></a>4.1.&nbsp;Variations sur le th&egrave;me</h3></div></div></div><div class="sect3" lang="fr"><div class="titlepage"><div><div><h4 class="title"><a name="N10389"></a>4.1.1.&nbsp;Pas de lecteur ZIP</h4></div></div></div><p>
Ce processus de sauvegarde vous oblige &agrave; disposer du lecteur de disque ZIP &agrave;
chaque sauvegarde. Vous pouvez cr&eacute;er le contenu du disque ZIP dans un
r&eacute;pertoire, puis le sauvegarder via le r&eacute;seau. Ensuite, il vous faudra
simplement construire un disque ZIP sur le serveur de sauvegarde (avec la
commande <span><strong class="command">cp -rp</strong></span>) lorsque vous aurez besoin de restaurer.</p><p>
Le processus de sauvegarde sera plus rapide, mais v&eacute;rifiez tout de m&ecirc;me que le
r&eacute;pertoire cr&eacute;&eacute; tiendra sur votre disque ZIP (avec la commande
<span><strong class="command">du -hs $cible.zip</strong></span>)&nbsp;! Vous devrez &eacute;diter la d&eacute;finition
de la variable <code class="varname">zip</code> dans le fichier <a href="#save.metadata" title="11.1.5.&nbsp;save.metadata"><code class="filename">save.metadata</code></a>.</p><p>
Mon portable ne supportant pas la pr&eacute;sence simultan&eacute;e d'une carte r&eacute;seau et d'un
lecteur ZIP, c'est le processus que j'utilise pour le sauvegarder. Je conserve
une image de sauvegarde en m&ecirc;me temps que la courante, ce qui fait que je
dispose d'un syst&egrave;me de secours au cas o&ugrave; l'ordinateur planterait pendant une
sauvegarde.</p><p>
Vous pouvez aussi sauvegarder sur plusieurs disques ZIP des donn&eacute;es qui en
valent la peine, et les transf&eacute;rer sur le syst&egrave;me pendant la restauration.</p></div><div class="sect3" lang="fr"><div class="titlepage"><div><div><h4 class="title"><a name="N103A5"></a>4.1.2.&nbsp;C&eacute;d&eacute;rom</h4></div></div></div><p>
Ceci est similaire &agrave; l'option &laquo;&nbsp;<span class="quote">pas de lecteur ZIP</span>&nbsp;&raquo; 
ci-dessus. Enregistrez vos sauvegardes dans un r&eacute;pertoire de votre 
disque dur, comme mentionn&eacute;. Puis, utilisez la commande 
<span><strong class="command">mkisofs</strong></span> pour cr&eacute;er une image ISO 9660 de ce 
r&eacute;pertoire et gravez-la.

</p><p>

De nos jours, beaucoup d'ordinateurs sont livr&eacute;s avec un lecteur de 
CDROM mais pas de disquette. De plus, les lecteurs de disquette 
tombent en panne. C'est pourquoi, graver votre CDROM avec une image qui permette
d'amorcer le syst&egrave;me est une bonne id&eacute;e. La mauvaise 
nouvelle, c'est que le format &laquo;&nbsp;<span class="quote">El Torito</span>&nbsp;&raquo; supporte les 
disquettes de 1,2&nbsp;Mo, 1,44&nbsp;Mo et 2,88&nbsp;Mo, et que <a href="http://www.toms.net/rb" target="_top">tomsrtbt</a> utilise une disquette de 
1,7&nbsp;Mo. La bonne nouvelle, c'est que vous pouvez obtenir une 
version en 2,88&nbsp;Mo, 
<code class="filename">tomsrtbt-2.0.103.ElTorito.288.img</code> , des m&ecirc;mes 
miroirs que l&agrave; o&ugrave; vous vous procurez l'image pour disquette. Placez une 
<span class="emphasis"><em>copie</em></span>

<sup>[<a href="#ftn.N103C1" name="N103C1">1</a>]</sup>

dans le r&eacute;pertoire racine des fichiers de sauvegarde. Puis, utilisez 
l'option -b de la commande <span><strong class="command">mkisofs</strong></span> pour sp&eacute;cifier que 
<code class="filename">tomsrtbt-2.0.103.ElTorito.288.img</code> est le fichier de 
l'image d'amor&ccedil;age.</p><p>

Le seul point noir de ce processus est que beaucoup de vieux BIOS ne 
supportent pas les images de disquette de 2,88&nbsp;Mo sur CDROM. 
Beaucoup de ceux-ci s'amorceront avec une disquette <a href="http://www.toms.net/rb" target="_top">tomsrtbt</a>.

</p><p>
On peut aussi utiliser <a href="http://syslinux.zytor.com/" target="_top">Syslinux</a>.
Il n'est pas d&eacute;pendant de l'image d'une disquette et vous pouvez construire
votre propre CD avec un certain nombre d'outils tels que <a href="http://www.toms.net/rb" target="_top">tomsrtbt</a>.</p><p>
Il vous faudra peut-&ecirc;tre ajuster les options du BIOS pour pouvoir amorcer sur le
lecteur de CDROM.</p><p><span class="emphasis"><em>Testez</em></span> vos CDROM sur le lecteur que vous utiliserez
pour la restauration. S'il se trouve que vous devez modifier les scripts, vous
pouvez les copier dans <code class="filename">/tmp</code>, un disque en m&eacute;moire vive sous
<a href="http://www.toms.net/rb" target="_top">tomsrtbt</a>, et les y &eacute;diter. Les
scripts s'ex&eacute;cuteront &agrave; cet emplacement. Un disque en MEV &eacute;tant volatil par
nature, enregistrez vos changements avant de r&eacute;amorcer&nbsp;!</p></div><div class="sect3" lang="fr"><div class="titlepage"><div><div><h4 class="title"><a name="N103EF"></a>4.1.3.&nbsp;Disques ZIP multiples</h4></div></div></div><p>
En s&eacute;parant les deux premiers scripts de la premi&egrave;re &eacute;tape, <a href="#restore.metadata" title="11.1.6.&nbsp;restore.metadata"><code class="filename">restore.metadata</code></a>
et <a href="#save.metadata" title="11.1.5.&nbsp;save.metadata"><code class="filename">save.metadata</code></a>, vous
pouvez r&eacute;partir les m&eacute;ta donn&eacute;es de la premi&egrave;re &eacute;tape sur plusieurs disques
ZIP.</p></div><div class="sect3" lang="fr"><div class="titlepage"><div><div><h4 class="title"><a name="N10401"></a>4.1.4.&nbsp;Exclusions de l'enregistrement de la premi&egrave;re &eacute;tape</h4></div></div></div><p>
Lors de la premi&egrave;re &eacute;tape, il est parfois n&eacute;cessaire de compresser quelques
m&eacute;ga-octets de donn&eacute;es, particuli&egrave;rement lorsque vous atteignez les limites de
votre disque ZIP. La fonction <span><strong class="command">crunch</strong></span> du script <a href="#save.metadata" title="11.1.5.&nbsp;save.metadata"><code class="filename">save.metadata</code></a>
accepte de nombreux param&egrave;tres pour alimenter la commande
<span><strong class="command">tar</strong></span>. Elle accepte aussi le param&egrave;tre
<span><strong class="command">--exclude</strong></span>. Ainsi, par exemple, vous pouvez exclure les
r&eacute;pertoires <code class="filename">samba</code> et <code class="filename">X11</code> situ&eacute;s dans
<code class="filename">/etc</code> de cette fa&ccedil;on&nbsp;:</p><pre class="programlisting">
crunch etc etc --exclude etc/samba --exclude etc/X11
</pre><p>

Pourquoi ces deux-l&agrave;&nbsp;? Parce qu'ils consomment beaucoup d'espace disque 
et que nous n'en avons pas besoin pour l'amor&ccedil;age.

</p><p>
Si vous poss&eacute;dez un nombre important de noyaux, vous pouvez &eacute;liminer les
modules de tous les noyaux sur lesquels vous n'amorcerez pas. v&eacute;rifiez votre
<code class="filename">lilo.conf</code> ou <code class="filename">grub.conf</code>
pour conna&icirc;tre le noyau que vous utiliserez, puis v&eacute;rifiez
<code class="filename">/lib/modules</code> pour conna&icirc;tre les r&eacute;pertoires des modules que
vous pouvez exclure.</p><p>
O&ugrave; trouver d'autres bons candidats &agrave; l'exclusion&nbsp;? Listez les r&eacute;pertoires
cible avec la commande <span><strong class="command">ls -alSr</strong></span> pour les fichiers
individuels, et avec la commande <span><strong class="command">du | sort -n</strong></span>
pour les r&eacute;pertoires.</p><p>
Une autre fa&ccedil;on (probablement plus nette), d'exclure les r&eacute;pertoires est
d'&eacute;crire la liste compl&egrave;te des r&eacute;pertoires dans un fichier puis d'y faire
r&eacute;f&eacute;rence via l'option tar <code class="filename">--exclude-from=FILENAME</code>.</p></div><div class="sect3" lang="fr"><div class="titlepage"><div><div><h4 class="title"><a name="initrd"></a>4.1.5.&nbsp;Initrd</h4></div></div></div><p>
Si votre syst&egrave;me utilise un disque MEV pour initialiser, ou initrd pour amorcer,
assurez-vous que <a href="#restore.metadata" title="11.1.6.&nbsp;restore.metadata"><code class="filename">restore.metadata</code></a> cr&eacute;e le
r&eacute;pertoire <code class="filename">/initrd</code>. La fa&ccedil;on la plus simple de le faire
est de s'assurer qu'ils figurent dans la liste des r&eacute;pertoires utilis&eacute;s dans la
boucle de cr&eacute;ation des r&eacute;pertoires (vers la fin).</p><p>
Votre syst&egrave;me utilise probablement initrd s'il d&eacute;marre sur un disque SCSI ou si
sa racine est sur une partition ext3fs. V&eacute;rifiez dans
<code class="filename">/etc/lilo.conf</code> s'il appelle un tel script.</p></div></div></div><div class="sect1" lang="fr"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="firststagerestore"></a>5.&nbsp;Premi&egrave;re &eacute;tape de restauration</h2></div></div></div><div class="sect2" lang="fr"><div class="titlepage"><div><div><h3 class="title"><a name="Bootingtomsrtbt"></a>5.1.&nbsp;D&eacute;marrer tomsrtbt</h3></div></div></div><p>

La premi&egrave;re chose &agrave; faire avant de d&eacute;marrer le processus de restauration 
est de v&eacute;rifier que l'heure du syst&egrave;me est correctement r&eacute;gl&eacute;e. Pour ce 
faire, configurez le BIOS. La pr&eacute;cision du r&eacute;glage de l'heure d&eacute;pendra 
de vos applications. Pour une restauration, une pr&eacute;cision de quelques 
minutes devrait &ecirc;tre suffisante. Cela devrait permettre aux &eacute;v&eacute;nements 
d&eacute;pendant de l'heure de red&eacute;marrer &agrave; leur point d'arr&ecirc;t lorsque vous 
lancerez finalement la restauration du syst&egrave;me.

</p><p>

Avant de d&eacute;marrer <a href="http://www.toms.net/rb" target="_top">tomsrtbt</a>, 
v&eacute;rifiez que votre lecteur ZIP est install&eacute; sur un port parall&egrave;le, soit 
<code class="filename">/dev/lp0</code> soit <code class="filename">/dev/lp1</code>. Le 
logiciel d'initialisation chargera pour vous le pilote du lecteur zip 
sur le port parall&egrave;le.

</p><p>

L'&eacute;tape suivante est la configuration du mode vid&eacute;o. D'habitude, j'aime 
afficher &agrave; l'&eacute;cran tout ce qui est possible. &Agrave; l'apparition de la 
s&eacute;lection du mode vid&eacute;o, je s&eacute;lectionne le mode 6, 80 colonnes par 60 
lignes. Il se peut que votre mat&eacute;riel ne soit pas capable de supporter 
de si hautes r&eacute;solutions, aussi effectuez des tests.

</p></div><div class="sect2" lang="fr"><div class="titlepage"><div><div><h3 class="title"><a name="restoration"></a>5.2.&nbsp;Restauration</h3></div></div></div><p>

Une fois <a href="http://www.toms.net/rb" target="_top">tomsrtbt</a> d&eacute;marr&eacute; et 
que vous voyez une console, montez le lecteur ZIP. C'est probablement 
une bonne id&eacute;e de le monter en lecture seule&nbsp;:

</p><pre class="programlisting">
# mount /dev/sda1 /mnt -o ro
</pre><p>

V&eacute;rifiez sa pr&eacute;sence&nbsp;:

</p><pre class="programlisting">
# ls -l /mnt
</pre><p>

&Agrave; ce stade, vous pouvez lancer la restauration automatiquement ou 
manuellement. Utilisez la restauration automatique si vous n'avez pas 
besoin d'effectuer des changements pendant celle-ci.

</p><p>

Une remarque cependant si vous avez plusieurs disques durs. Si votre 
installation de Linux monte des partitions &agrave; partir de plusieurs disques 
durs, vous devez monter la partition racine en premier. Ceci pour &ecirc;tre 
certain que les r&eacute;pertoires des points de montage sont cr&eacute;&eacute;s sur la 
partition &agrave; laquelle ils appartiennent. Le script <code class="filename"> 
first.stage</code> lancera les scripts de montage des lecteurs dans 
leur ordre de cr&eacute;ation. Si vous les avez cr&eacute;&eacute;s (dans le script 
<code class="filename">save.metadata</code>) dans un ordre d&eacute;coulant de l'arbre 
racine, le processus de montage devrait se d&eacute;rouler correctement.

</p><p>

Si vous avez plusieurs disques durs, et qu'ils se montent de fa&ccedil;on 
crois&eacute;e, faites-le &agrave; votre main. Vous pouvez combiner et &eacute;diter 
les scripts pour les monter dans le bon ordre, o&ugrave; les monter 
manuellement.

</p><div class="sect3" lang="fr"><div class="titlepage"><div><div><h4 class="title"><a name="N10498"></a>5.2.1.&nbsp;Automatis&eacute;e</h4></div></div></div><p>
	
Le processus automatique lance tous les scripts manuels dans le bon 
ordre. Il ne permet pas les interventions manuelles, telles que la 
cr&eacute;ation de syst&egrave;mes de fichiers que ce guide pratique ne prend pas en 
charge. Pour lancer la premi&egrave;re &eacute;tape de restauration automatiquement, 
saisissez&nbsp;:

</p><pre class="programlisting">
# /mnt/root.bin/first.stage
</pre><p>

Si vous d&eacute;sirez rechercher les blocs endommag&eacute;s, ajoutez l'option 
&laquo;&nbsp;<span class="quote"><code class="option">-c</code></span>&nbsp;&raquo;.

</p></div><div class="sect3" lang="fr"><div class="titlepage"><div><div><h4 class="title"><a name="N104A6"></a>5.2.2.&nbsp;Manuelle</h4></div></div></div><p>

Pour lancer le processus manuel, positionnez-vous dans le r&eacute;pertoire o&ugrave; 
se trouvent les scripts, dans le lecteur ZIP.

</p><pre class="programlisting">
# cd /mnt/root.bin
</pre><p>

Lancez maintenant le(s) script(s) qui restaurer(a/ont) les informations 
de partition et cr&eacute;er(a/ont) les syst&egrave;mes de fichiers. Vous pouvez les 
lancer dans n'importe quel ordre, par exemple&nbsp;:

</p><pre class="programlisting">
# ./make.dev.hda
</pre><p>

Si vous d&eacute;sirez qu'une recherche de blocs endommag&eacute;s s'effectue, ajoutez 
l'option &laquo;&nbsp;<span class="quote"><code class="option">-c</code></span>&nbsp;&raquo;.

</p><p>

Ce script va&nbsp;:

</p><div class="itemizedlist"><ul type="disc"><li><p>
 
Nettoyer les 1024 premiers octets du disque dur, d&eacute;truire toutes les 
tables des partitions existantes ainsi que le bloc de d&eacute;marrage (MBR).

</p></li><li><p>

Recr&eacute;er les partitions des informations collect&eacute;es quand vous avez lanc&eacute; 
<a href="#make.fdisk" title="11.1.1.&nbsp;make.fdisk"> <code class="filename">make.fdisk</code></a>.

</p></li><li><p>

Cr&eacute;er correctement des partitions ext2 et ext3 ainsi que des partitions 
swap. Si vous ajoutez l'option &laquo;&nbsp;<span class="quote"><code class="option">-c</code></span>&nbsp;&raquo; au 
script, il v&eacute;rifiera aussi les blocs d&eacute;fectueux.

</p></li><li><p>

Cr&eacute;er diff&eacute;rents types de partitions FAT.

</p></li></ul></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note: N.B."><tr><td valign="top" align="center" rowspan="2" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">N.B.</th></tr><tr><td valign="top" align="left" colspan="2"><p>

Si vous devez restaurer d'autres syst&egrave;mes d'exploitation, c'est le 
moment de le faire. Lorsque c'est termin&eacute;, red&eacute;marrez avec <a href="http://www.toms.net/rb" target="_top"> tomsrtbt</a> et continuez la 
restauration de Linux.

</p></td></tr></table></div><p>

&Agrave; pr&eacute;sent, lancez le(s) script(s) qui cr&eacute;e(nt) des points de montage et 
montez les partitions.

</p><pre class="programlisting">
# ./mount.dev.hda
</pre><p>

Une fois que vous avez cr&eacute;&eacute; tous vos r&eacute;pertoires et que vous y avez 
mont&eacute; les partitions, vous pouvez lancer le script <a href="#restore.metadata" title="11.1.6.&nbsp;restore.metadata"> <code class="filename">restore.metadata</code> 
</a>. Il restaurera le contenu du lecteur zip sur le disque dur.

</p><p>
	
Vous devriez voir un r&eacute;pertoire du r&eacute;pertoire racine du lecteur zip, 
puis une liste des fichiers d'archives tels qu'ils sont restaur&eacute;s. 
L'ex&eacute;cution de la commande tar sous <a href="http://www.toms.net/rb" target="_top">tomsrtbt</a> vous dira que la taille 
d'un bloc de tar est de 20, et c'est tr&egrave;s bien ainsi. Vous pouvez 
l'ignorer. Assurez-vous que lilo affiche ses r&eacute;sultats&nbsp;:

</p><pre class="screen">
Added linux *
</pre><p>

Un affichage suivra, correspondant &agrave; la commande 
&laquo;&nbsp;<span class="quote"><span><strong class="command">df&nbsp;-m</strong></span></span>&nbsp;&raquo;.

</p></div><div class="sect3" lang="fr"><div class="titlepage"><div><div><h4 class="title"><a name="N104FB"></a>5.2.3.&nbsp;Touche finale</h4></div></div></div><p>

Si d'habitude vous d&eacute;marrez directement sous X, vous aurez peut-&ecirc;tre 
quelques probl&egrave;mes. Pour les &eacute;viter, changez temporairement votre niveau 
de d&eacute;marrage. Dans le fichier <code class="filename"> /target/etc/inittab</code>, 
trouvez la ligne qui ressemble &agrave;&nbsp;:

</p><pre class="programlisting">
id:5:initdefault:
</pre><p>
et transformez-la en&nbsp;:
</p><pre class="programlisting">
id:3:initdefault:
</pre><p>

Vous pouvez maintenant d&eacute;marrer en douceur. Retirez la disquette <a href="http://www.toms.net/rb" target="_top">tomsrtbt</a> de votre lecteur si vous 
ne l'avez pas encore fait, et faites le salut &agrave; trois doigts &agrave; votre 
ordinateur (N.D.T.&nbsp;: CTRL+MAJ+SUP), ou son &eacute;quivalent&nbsp;:

</p><pre class="programlisting">
# <span><strong class="command">reboot</strong></span>
</pre><p>

L'ordinateur va s'arr&ecirc;ter et red&eacute;marrer.

</p></div></div></div><div class="sect1" lang="fr"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="SecondStageRestoration"></a>6.&nbsp;Seconde &eacute;tape de la restauration</h2></div></div></div><p>
 
Au red&eacute;marrage de l'ordinateur, v&eacute;rifiez dans le BIOS que l'heure est &agrave; 
peu pr&egrave;s correcte.</p><p>

Une fois la v&eacute;rification termin&eacute;e, sortez du BIOS et red&eacute;marrez sur le 
disque dur. Laissez simplement la s&eacute;quence de d&eacute;marrage normal de 
l'ordinateur se d&eacute;rouler. Vous verrez un nombre important de messages 
d'erreurs, essentiellement de type &laquo;&nbsp;<span class="quote"> Impossible de trouver 
bla-bla&nbsp;! Ouahhh&nbsp;!</span>&nbsp;&raquo; Si vous avez bien travaill&eacute; jusqu'&agrave; 
maintenant, ces messages d'erreurs seront sans importance. Vous n'avez 
pas besoin de linuxconf ou d'apache pour cette op&eacute;ration.

  </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note: N.B."><tr><td valign="top" align="center" rowspan="2" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">N.B.</th></tr><tr><td valign="top" align="left" colspan="2"><p>
 
Vous pouvez aussi d&eacute;marrer en mode utilisateur unique (single 
user)&nbsp;: &agrave; l'invite de lilo, saisissez&nbsp;: <strong class="userinput"><code>linux 
single</code></strong>, mais il vous faudra configurer manuellement votre 
r&eacute;seau et lancer sshd ou tous les d&eacute;mons n&eacute;cessaires au red&eacute;marrage de 
votre syst&egrave;me. Chaque syst&egrave;me a sa m&eacute;thode sp&eacute;cifique.</p></td></tr></table></div><p>

Vous devriez vous identifier sur une console en tant que super 
utilisateur (root) (d&eacute;sol&eacute;, pas de session X, pas d'utilisateurs). &Agrave; 
pr&eacute;sent, vous devriez pouvoir utiliser le r&eacute;seau, par exemple pour 
monter la sauvegarde de votre syst&egrave;me via nfs.
 
 </p><p>

Si vous avez effectu&eacute; la sauvegarde en deux &eacute;tapes que j'ai sugg&eacute;r&eacute;es 
pour Arkeia, vous pouvez maintenant restaurer les ex&eacute;cutables et la base 
de donn&eacute;es d'Arkeia. Vous devriez pouvoir lancer

</p><pre class="programlisting">
/etc/rc.d/init.d/arkeia start
</pre><p>

et d&eacute;marrer le serveur. Si vous avez une interface graphique install&eacute;e 
sur un autre ordinateur, vous devriez pouvoir vous connecter &agrave; Arkeia 
sur votre serveur de bandes et pr&eacute;parer la restauration.
 
 </p><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note: N.B."><tr><td valign="top" align="center" rowspan="2" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">N.B.</th></tr><tr><td valign="top" align="left" colspan="2"><p>
 
Pendant la restauration, lisez attentivement la documentation de 
restauration de vos programmes. Par exemple, d'habitude, tar ne restaure 
pas certaines caract&eacute;ristiques de fichiers, telles que le bit suid. Les 
droits sur les fichiers sont fix&eacute;es par l'utilisateur avec la 
commande umask. Pour restaurer vos fichiers exactement comme vous les 
avez sauvegard&eacute;s, utilisez l'option tar avec l'option p. De la m&ecirc;me 
mani&egrave;re, v&eacute;rifiez que votre logiciel de restauration restaure les 
donn&eacute;es de fa&ccedil;on identique &agrave; la sauvegarde.</p></td></tr></table></div><p>

Pour restaurer l'ordinateur de test, saisissez&nbsp;:

</p><pre class="programlisting">
bash# restore.all
</pre><p>

Si vous avez sauvegard&eacute; et restaur&eacute; avec tar, et avez utilis&eacute; l'option 
-k (conserver les anciens fichiers, ne pas &eacute;craser), vous constaterez un 
nombre important de&nbsp;:

</p><pre class="screen">
tar: usr/sbin/rpcinfo: Could not create file: File exists
tar: usr/sbin/zdump: Could not create file: File exists
tar: usr/sbin/zic: Could not create file: File exists
tar: usr/sbin/ab: Could not create file: File exists
</pre><p>

Ceci est normal, tar refusant d'&eacute;craser les fichiers que vous avez 
restaur&eacute;s pendant la premi&egrave;re &eacute;tape.

</p><p>

Puis red&eacute;marrez. &Agrave; la fermeture, vous verrez un nombre important de messages
d'erreurs, tels que &laquo;&nbsp;<span class="quote">no such pid</span>&nbsp;&raquo;.
Ils font partie du processus. Le programme de fermeture utilise les fichiers pid
des d&eacute;mons qui tournaient au moment de la sauvegarde pour fermer les d&eacute;mons qui
n'avaient pas &eacute;t&eacute; lanc&eacute;s au dernier d&eacute;marrage. Et &eacute;videmment, il n'ont pas de
PID.</p><p>
Votre syst&egrave;me devrait s'initialiser normalement avec beaucoup moins d'erreurs
que pr&eacute;c&eacute;demment et id&eacute;alement sans erreurs. Le test d&eacute;cisif du bon
fonctionnement de votre restauration sur un syst&egrave;me bas&eacute; sur des RPM est de
v&eacute;rifier tous les paquets&nbsp;:</p><pre class="programlisting">
bash# <span><strong class="command">rpm -Va</strong></span>
</pre><p>
Si vous constatez des messages d'erreurs de d&eacute;pendances, vous pouvez lancer la
commande <span><strong class="command">/etc/cron.daily/prelink</strong></span> pour les enlever.</p><p>
Certains fichiers, tels que les fichiers de configuration et les journaux,
auront naturellement chang&eacute;&nbsp;; vous devriez pouvoir mentalement les exclure
du rapport. Vous pouvez rediriger la sortie dans un fichier, et le comparer
gr&acirc;ce &agrave; diff avec celui effectu&eacute; lors de la sauvegarde (/etc/rpmVa.txt), ce qui
acc&eacute;l&eacute;rera consid&eacute;rablement cette &eacute;tape. Les utilisateurs d'Emacs devraient se
renseigner sur ses aptitudes &agrave; comparer des fichiers.</p><p>
&Agrave; pr&eacute;sent, votre syst&egrave;me devrait &ecirc;tre lanc&eacute; et fonctionner. C'est le moment de
tester vos applications, particuli&egrave;rement celles lanc&eacute;es en tant que d&eacute;mons.
Plus les applications seront sophistiqu&eacute;es, plus il vous faudra effectuer des
tests. S'il y a des utilisateurs distants, interdisez leur l'acc&egrave;s du syst&egrave;me,
ou passez le en &laquo;&nbsp;<span class="quote">lecture seule</span>&nbsp;&raquo; le temps des tests. Ceci vaut
particuli&egrave;rement pour les bases de donn&eacute;es, afin emp&ecirc;cher une corruption ou une
perte de donn&eacute;es pire que ce qu'il pourrait d&eacute;j&agrave; y avoir.</p><p>
Si d'habitude vous red&eacute;marrez directement sous X et que vous l'avez d&eacute;sactiv&eacute;
plus haut, testez X avant de le r&eacute;activer. R&eacute;activez-le en r&eacute;tablissant cette
unique ligne dans le fichier /etc/inittab&nbsp;:</p><pre class="programlisting">
id:5:initdefault:
</pre><p>

Vous pourrez alors aller faire la f&ecirc;te, prendre un peu d'aspirine et 
aller au dodo.

</p></div><div class="sect1" lang="fr"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="DistributionSpecificNotes"></a>7.&nbsp;Notes sp&eacute;cifiques aux distributions</h2></div></div></div><p>
Vous trouverez ci-dessous des remarques n&eacute;es de l'exp&eacute;rience, distribution par
distribution. Si vous avez des remarques concernant d'autres distributions,
envoyez-les-moi.</p><div class="sect2" lang="fr"><div class="titlepage"><div><div><h3 class="title"><a name="fedora"></a>7.1.&nbsp;Fedora</h3></div></div></div><p>
<a href="http://fedora.redhat.com/" target="_top">Fedora</a>
est issue de Red Hat 9. Effectuez les modifications suivantes&nbsp;:</p><div class="itemizedlist"><ul type="disc"><li><p>
Fedora utilise <a href="#grub" title="8.1.&nbsp;
GRUB">
grub</a>, et non lilo. Effectuez les modifications suivantes.</p></li><li><p>
Il n'est plus n&eacute;cessaire de sauvegarder les biblioth&egrave;ques kerberos 
s&eacute;par&eacute;ment, comme dans la <a href="#redhat80" title="7.3.&nbsp;Red Hat 8.0">Red Hat 8.0</a>. 
Enlevez ou mettez en commentaire cette ligne du fichier <a href="#save.metadata" title="11.1.5.&nbsp;save.metadata"> <code class="filename">save.metadata</code> 
</a>&nbsp;:

</p><pre class="programlisting">
# RH8. Fedora 1 puts them in /lib # crunch kerberos usr/kerberos/lib/
</pre></li><li><p>
	 
Les noms des biblioth&egrave;ques n&eacute;cessaires &agrave; la sauvegarde de SSH ont 
chang&eacute;. Aussi, dans le fichier <a href="#save.metadata" title="11.1.5.&nbsp;save.metadata"> 
<code class="filename">save.metadata</code></a>&nbsp;:</p><pre class="programlisting">
# save these so we can use ssh for restore. *crack* for RH 7.0 login
# authentication.
# RH 8.0
# crunch usr.lib usr/lib/*crack* usr/lib/libz* usr/lib/libssl*
usr/lib/libcrypto*
# Fedora 1
crunch usr.lib usr/lib/*crack* usr/lib/libz* usr/lib/libwrap* usr/lib/libk*
usr/lib/libgss*
</pre></li><li><p>
 
Dans le fichier <a href="#restore.metadata" title="11.1.6.&nbsp;restore.metadata"> 
<code class="filename">restore.metadata</code></a>, il y a un plus grand 
nombre de r&eacute;pertoires &agrave; sauvegarder.

</p><pre class="programlisting">
# If you boot via an initrd, make sure you build a directory here so
# the kernel can mount the initrd at boot. tmp/.font-unix is for the
# xfs font server.
for dir in mnt/save mnt/zip mnt/cdrom mnt/floppy mnt/imports mnt/dosc mnt/nfs\
proc initrd tmp/.font-unix var/empty/sshd var/lock/subsys var/log; do
</pre><p>
Certains modes sont &agrave; configurer&nbsp;:</p><pre class="programlisting">
chmod a-w $target/proc		# Restore /proc's read-only permissions
# Set modes
chmod 0111 $target/var/empty/sshd
chmod 0775 $target/var/lock
# For Fedora. First two for xfs.
chroot $target
chown xfs:xfs /tmp/.font-unix
chmod 1777 $target/tmp/.font-unix
# set the sticky bit.
chmod 1777 $target/tmp
</pre></li></ul></div></div><div class="sect2" lang="fr"><div class="titlepage"><div><div><h3 class="title"><a name="redhat9"></a>7.2.&nbsp;Red Hat 9</h3></div></div></div><p>
Je n'ai jamais travaill&eacute; sous Red Hat 9. Les commentaires concernant <a href="#fedora" title="7.1.&nbsp;Fedora">
Fedora</a>
devraient s'appliquer &eacute;galement &agrave; la Red Hat 9.</p></div><div class="sect2" lang="fr"><div class="titlepage"><div><div><h3 class="title"><a name="redhat80"></a>7.3.&nbsp;Red Hat 8.0</h3></div></div></div><p>
Il est n&eacute;cessaire de modifier Red Hat 8.0 uniquement si vous vous connectez
apr&egrave;s la premi&egrave;re &eacute;tape de restauration via ssh. Si vous effectuez la
deuxi&egrave;me &eacute;tape de restauration avec ssh, effectuez les
modifications suivantes&nbsp;:</p><div class="itemizedlist"><ul type="disc"><li><p>
Dans le fichier <code class="filename">
save.metadata</code>, ajoutez les biblioth&egrave;ques kerberos &agrave; la premi&egrave;re &eacute;tape
de sauvegarde&nbsp;:</p><pre class="programlisting">
crunch kerberos usr/kerberos/lib/</pre></li><li><p>
Dans le fichier <code class="filename">
restore.metadata</code>, il y a une boucle qui cr&eacute;e plusieurs r&eacute;pertoires.
Tout d'abord, ajoutez le nom de ces deux r&eacute;pertoires &agrave; la liste&nbsp;:
<code class="filename">
/var/empty/sshd</code>
et <code class="filename">
/var/lock/subsys</code>
. Red Hat 8.0 utilisant par d&eacute;faut ext3fs, a besoin d'un disque en MEV au
d&eacute;marrage. Aussi assurez-vous que <code class="filename">
initrd</code>
est dans la liste. Puis, s'il n'y est pas encore, ajoutez l'argument <span><strong class="command">
-p</strong></span>
&agrave; la commande mkdir.</p><p>
Le groupe propri&eacute;taire du r&eacute;pertoire  <code class="filename">
/var/lock/subsys</code>
est le groupe lock, aussi changez son propri&eacute;taire.</p><pre class="programlisting">
chroot $target /bin/chown root:lock /var/lock</pre><p>
Pour finir, <code class="filename">
usr/lib/libcrypto*</code>
a disparu, aussi vous pouvez le retirer de la ligne qui traite <code class="filename">
usr/lib</code>
.</p></li></ul></div></div><div class="sect2" lang="fr"><div class="titlepage"><div><div><h3 class="title"><a name="RedHat71"></a>7.4.&nbsp;Red Hat 7.1</h3></div></div></div><p>
&Agrave; l'origine, j'ai utilis&eacute; cette distribution sur mon ordinateur de test. Je n'ai
eu aucun probl&egrave;me avec.</p></div><div class="sect2" lang="fr"><div class="titlepage"><div><div><h3 class="title"><a name="RedHat70"></a>7.5.&nbsp;Red Hat 7.0</h3></div></div></div><p>
Il semble que cette version ait besoin de libcrack (dans /usr/lib) et de ses
fichiers pour authentifier les utilisateurs. Aussi, dans le fichier <a href="#save.metadata" title="11.1.5.&nbsp;save.metadata"><code class="filename">save.metadata</code></a>, ajoutez ce
qui suit &agrave; la ligne qui sauvegarde /usr/lib&nbsp;: /usr/lib/*crack* et activez
cette ligne.</p></div><div class="sect2" lang="fr"><div class="titlepage"><div><div><h3 class="title"><a name="knoppix"></a>7.6.&nbsp;Knoppix</h3></div></div></div><p>
Je n'ai pas utilis&eacute; <a href="http://www.knoppix.org/" target="_top">Knoppix</a>, mais
d'autres que moi l'ont fait. <a href="mailto:pon at iki dot fi" target="_top">
Pasi Oja-Nisula</a> nous en parle&nbsp;:</p><div class="blockquote"><blockquote class="blockquote"><p>
Pour moi, le grand avantage de knoppix est que je n'ai pas besoin d'un m&eacute;dium de
d&eacute;marrage propre &agrave; chaque machine mais que je peux utiliser les m&ecirc;mes outils
tout le temps. Et le support mat&eacute;riel de Knoppix est vraiment excellent. Je n'ai
pas tant d'exp&eacute;rience que &ccedil;a avec les diff&eacute;rentes plates-formes mais toutes les
machines que j'ai essay&eacute; ont bien fonctionn&eacute;, les pilotes scsi ont &eacute;t&eacute; trouv&eacute;s,
etc...</p><p>
J'effectue le travail de restauration en copiant les sauvegardes sur une autre
machine du r&eacute;seau. Restaurer implique de d&eacute;marrer &agrave; partir du CDROM de
Knoppix, d'aller chercher le fichier metadata.tar.gz sur l'autre machine du
r&eacute;seau. Puis de d'appeler make.dev, mount.dev, d'aller chercher les autres
fichiers tar.gz, grub et de red&eacute;marrer. Il y a bien quelques saisies mais, gr&acirc;ce
&agrave; vos scripts, c'est tr&egrave;s simple. &Agrave; moins que vous ne passiez de ide &agrave; scsi ou
quelque chose de ce genre, mais m&ecirc;me ainsi, ce n'est pas si difficile dans la
mesure o&ugrave; Linux peut facilement &ecirc;tre restaur&eacute; sur diff&eacute;rents mat&eacute;riels.</p></blockquote></div><p>
Jetez aussi un coup d'œil &agrave; <a href="http://www-106.ibm.com/developerworks/linux/library/l-knopx.html?ca=dgr- lnxw04Knoppix" target="_top">
&laquo;&nbsp;<span class="quote">
R&eacute;cup&eacute;ration de syst&egrave;me avec Knoppix (System recovery with
Knoppix, N.D.T.&nbsp;: pas de version fran&ccedil;aise)</span>&nbsp;&raquo;
</a>
.</p></div></div><div class="sect1" lang="fr"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="ApplicationSpecificNotes"></a>8.&nbsp;
Notes concernant certaines application</h2></div></div></div><p>
Vous trouverez ci-dessous quelques remarques sur la sauvegarde de certaines
applications.</p><div class="sect2" lang="fr"><div class="titlepage"><div><div><h3 class="title"><a name="grub"></a>8.1.&nbsp;
GRUB</h3></div></div></div><p>
Le chargeur d'amor&ccedil;age par d&eacute;faut de <a href="#fedora" title="7.1.&nbsp;Fedora">
Fedora</a>
est le <a href="http://www.gnu.org/software/grub/" target="_top">
Grand Chargeur D'amor&ccedil;age Unifi&eacute; (Grand Unified Bootloader (GRUB))</a>
. Il doit &ecirc;tre lanc&eacute; &agrave; la fin de la premi&egrave;re &eacute;tape, sans quoi vous ne pourrez
pas d&eacute;marrer ensuite. Pour l'inclure dans la premi&egrave;re &eacute;tape de restauration,
effectuez les modifications suivantes&nbsp;:</p><div class="itemizedlist"><ul type="disc"><li><p>
&Eacute;ditez la p&eacute;nulti&egrave;me stance de <a href="#restore.metadata" title="11.1.6.&nbsp;restore.metadata">
<code class="filename">
restore.metadata</code></a>&nbsp;:</p><pre class="programlisting">
# Now install the boot sector.
# chroot $target /sbin/lilo -C /etc/lilo.conf
chroot $target /sbin/grub-install /dev/hda
</pre></li><li><p>
Ajoutez la stance suivante &agrave; <a href="#save.metadata" title="11.1.5.&nbsp;save.metadata">
<code class="filename">
save.metadata</code></a>&nbsp;:</p><pre class="programlisting">
# Grub requires these at installation time.
crunch usr.share.grub usr/share/grub
</pre></li></ul></div></div><div class="sect2" lang="fr"><div class="titlepage"><div><div><h3 class="title"><a name="tripwire"></a>8.2.&nbsp;
Tripwire</h3></div></div></div><p>
Si vous utilisez Tripwire ou une autre application qui utilise une base de
donn&eacute;es de m&eacute;tadonn&eacute;es en fichiers, reconstruisez cette base de donn&eacute;es
imm&eacute;diatement apr&egrave;s la restauration.</p></div><div class="sect2" lang="fr"><div class="titlepage"><div><div><h3 class="title"><a name="Squid"></a>8.3.&nbsp;
Squid</h3></div></div></div><p>
Squid est un serveur HTTP de cache et de proximit&eacute;. Il stocke donc une grande
quantit&eacute; de donn&eacute;es temporaires sur le disque dur. Il n'y a aucune raison de les
sauvegarder. Ins&eacute;rez &laquo;&nbsp;<span class="quote">
--exclude /var/spool/squid</span>&nbsp;&raquo;
dans la commande tar appropri&eacute;e du script de sauvegarde de la deuxi&egrave;me &eacute;tape.
Puis, laissez squid reconstruire sa structure de r&eacute;pertoires lui-m&ecirc;me. Ajoutez
une commande pour que squid s'initialise tout seul &agrave; la fin du script de
restauration de la deuxi&egrave;me &eacute;tape. Voil&agrave; comment j'ai fait avec ssh dans le
fichier <a href="#restore.tester" title="11.3.2.&nbsp;restore.tester">
<code class="filename">
restore.tester</code></a>&nbsp;:</p><pre class="programlisting">
ssh $target "mkdir /var/spool/squid ; chown squid:squid /var/spool/squid;\
 /usr/sbin/squid -z; touch /var/spool/squid/.OPB_NOBACKUP"
</pre><p>
La derni&egrave;re commande cr&eacute;e un fichier de longueur 0 appel&eacute; .OPB_NOBACKUP. Il est
&agrave; destination d' <a href="#arkeia" title="8.4.&nbsp;
Arkeia">
Arkeia</a>, et lui dit de ne rien sauvegarder en dessous de ce
r&eacute;pertoire.</p></div><div class="sect2" lang="fr"><div class="titlepage"><div><div><h3 class="title"><a name="arkeia"></a>8.4.&nbsp;
Arkeia</h3></div></div></div><p>
Ces notes sont bas&eacute;es sur des tests effectu&eacute;s avec Arkeia 4.2.</p><p>
<a href="http://www.arkeia.com/" target="_top">
Arkeia</a>
est un programme de sauvegarde et de restauration qui tourne sur une grande
vari&eacute;t&eacute; de plate-formes. Vous pouvez utiliser Arkeia dans votre programme de
restauration int&eacute;grale de syst&egrave;me, mais je ferais deux observations.</p><p>
La premi&egrave;re est probablement celle qui pose le plus de probl&egrave;mes, dans la mesure
o&ugrave; il n'y a pas de solution plus &eacute;l&eacute;gante que de s&eacute;lectionner &agrave; la main et dans
le navigateur les r&eacute;pertoires &agrave; restaurer. Ceci est d&ucirc; au fait qu'apparemment,
Arkeia ne dispose pas de m&eacute;canisme pour ne pas restaurer des fichiers d&eacute;j&agrave;
pr&eacute;sents sur le disque, rien qui soit analogue &agrave;  <span><strong class="command">
tar</strong></span>
et &agrave; son option -p. Si vous param&eacute;trez simplement une restauration compl&egrave;te, la
restauration plantera car Arkeia &eacute;crasera une biblioth&egrave;que utilis&eacute;e au moment de
la restauration, &agrave; savoir <code class="filename">
lib/libc-2.1.1.so</code>
. Une s&eacute;lection &agrave; la main des r&eacute;pertoires &agrave; restaurer est moins risqu&eacute;e, aussi
je la recommande.</p><p>
La seconde observation est qu'il vous faudra sauvegarder le dictionnaire des
donn&eacute;es et/ou les programmes d'Arkeia. Pour le faire, modifiez le script
<code class="filename">
save.metadata</code>
en ajoutant Arkeia &agrave; la liste des r&eacute;pertoires &agrave; sauvegarder&nbsp;:</p><pre class="programlisting">
# arkeia specific: tar cf - usr/knox | gzip -c &gt; $zip/arkeia.tar.gz
</pre><p>
C'est ainsi que vous <span class="emphasis"><em>
devez</em></span>
sauvegarder le dictionnaire des donn&eacute;es car Arkeia ne le fait pas. C'est un des
reproches que je fais &agrave; Arkeia, mais je le r&eacute;sous sur mon propre PC en
sauvegardant le dictionnaire des donn&eacute;es sur bande avec <a href="http://www.estinc.com/" target="_top">
The TOLIS Group's BRU</a>
.</p><p>
Le script <code class="filename">
restore.metadata</code>
restaurera le dictionnaire des donn&eacute;es automatiquement.</p></div><div class="sect2" lang="fr"><div class="titlepage"><div><div><h3 class="title"><a name="amanda"></a>8.5.&nbsp;Amanda</h3></div></div></div><p>
<a href="http://www.amanda.org/" target="_top">Amanda</a>, archiveur automatique
avanc&eacute; sur disque en r&eacute;seau du Maryland (The Advanced Maryland Automatic Network
Disk Archiver), marche plut&ocirc;t bien avec cet ensemble de scripts. Utilisez le
processus normal de sauvegarde d'Amanda et cr&eacute;ez votre premi&egrave;re &eacute;tape comme
d'habitude. Amanda stocke les donn&eacute;es sur bande au format tar ou cpio, donc vous
pouvez restaurer des fichiers individuels jusqu'&agrave; des images compl&egrave;tes de
sauvegarde. Ce qu'il y a de bien dans une restauration d'image compl&egrave;te est que
vous pouvez utiliser les variantes de ce guide pratique pour restaurer &agrave; partir
de l'image ou &agrave; partir de la bande directement. J'ai pu r&eacute;parer ma machine de
tests avec les instructions de W. Curtis Preston <a href="http://www.oreilly.com/catalog/unixbr/" target="_top"><em class="citetitle">et de son
Unix Backup &amp; Recovery</em></a>. Pour plus d'informations,
consultez le lien <a href="#resources" title="12.&nbsp;Ressources">Ressources</a>. Le chapitre du
livre qui concerne Amanda est <a href="http://www.backupcentral.com/amanda.html" target="_top">en ligne</a>.</p><p>
J'ai effectu&eacute; deux changements au script <a href="#restore.tester" title="11.3.2.&nbsp;restore.tester">
<code class="filename">restore.tester</code></a>. Premi&egrave;rement, je l'ai modifi&eacute; pour
qu'il accepte un nom de fichier comme argument. Puis, comme la commande d'Amanda
<span><strong class="command">amrestore</strong></span> d&eacute;compresse les donn&eacute;es pendant qu'il les restaure,
je l'ai r&eacute;&eacute;crit pour qu'il envoie, via la commande cat, le fichier dans le canal
(pipe) plut&ocirc;t que de le d&eacute;compresser.</p><p>
La ligne en question ressemble &agrave;&nbsp;:</p><pre class="programlisting">
cat $fichier | ssh $cible "umask 000 ; cd / ; tar -xpkf - " </pre><p>
o&ugrave; <span><strong class="command">$fichier</strong></span> est l'argument du script, l'image r&eacute;cup&eacute;r&eacute;e de la
bande par la commande <span><strong class="command">amrestore</strong></span>.</p><p>
Comme les arguments de la ligne de commande de <span><strong class="command">tar</strong></span>
interdisent l'&eacute;crasement de fichiers, restaurez les images dans l'ordre
<span class="emphasis"><em>inverse</em></span> de leur ordre de cr&eacute;ation. Restaurez les plus
r&eacute;cents en premier.</p><p>
Avec Amanda, il n'est pas n&eacute;cessaire de d&eacute;terminer manuellement les
propri&eacute;taires si vous sauvegardez le r&eacute;pertoire des donn&eacute;es d'Amanda avec le
fichier <a href="#save.metadata" title="11.1.5.&nbsp;save.metadata"><code class="filename">save.metadata</code></a>.
Ce devrait &ecirc;tre une instruction du type&nbsp;:</p><pre class="programlisting">
bash# <span><strong class="command">chown -R amanda:disk /var/lib/amanda</strong></span>
</pre><p>
Vous pouvez aussi ajouter cette ligne &agrave; vos scripts de la deuxi&egrave;me &eacute;tape de
restauration, comme dans <a href="#restore.tester" title="11.3.2.&nbsp;restore.tester"><code class="filename">restore.tester</code></a>.</p></div></div><div class="sect1" lang="fr"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="SomeAdviceforDisasterRecovery"></a>9.&nbsp;Quelques conseils pour une r&eacute;cup&eacute;ration apr&egrave;s un d&eacute;sastre</h2></div></div></div><p>
Vous devriez placer les disques zip de chaque ordinateur et les sorties papier
que vous avez effectu&eacute;es dans un endroit sur de votre boutique. Vous devriez
conserver des copies de ces sauvegardes dans un site de stockage ext&eacute;rieur.
L'int&eacute;r&ecirc;t principal d'un site de stockage ext&eacute;rieur est de rendre possible une
r&eacute;cup&eacute;ration apr&egrave;s un d&eacute;sastre&nbsp;; restaurer chaque h&ocirc;te sur un mat&eacute;riel de
remplacement fait d'ailleurs partie d'une r&eacute;cup&eacute;ration apr&egrave;s un d&eacute;sastre.</p><p>
Vous devriez conserver plusieurs disquettes de <a href="http://www.toms.net/rb" target="_top">tomsrtbt</a> ainsi que si possible plusieurs
disques zip &agrave; l'ext&eacute;rieur. De plus, installez des copies de la distribution de
<a href="http://www.toms.net/rb" target="_top">tomsrtbt</a> sur plusieurs de vos
ordinateurs, de fa&ccedil;on &agrave; ce qu'ils puissent se restaurer mutuellement.</p><p>
Vous devriez probablement conserver des copies de ce guide pratique, agr&eacute;ment&eacute;es
d'annotations sp&eacute;cifiques &agrave; votre site, avec vos sauvegardes et sur votre site
ext&eacute;rieur de conservation des sauvegardes.</p></div><div class="sect1" lang="fr"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="WhatNow"></a>10.&nbsp;Et maintenant&nbsp;?</h2></div></div></div><p>
Ce guide pratique est le r&eacute;sultat d'exp&eacute;rimentations sur un seul ordinateur.
Vous y trouverez sans aucun doute des r&eacute;pertoires ou des fichiers n&eacute;cessaires &agrave;
la premi&egrave;re &eacute;tape de votre sauvegarde. Je n'ai pas essay&eacute; de sauvegarder ni de
restaurer X &agrave; la premi&egrave;re &eacute;tape, pas plus que je ne me suis occup&eacute; d'autres
processeurs qu'Intel.</p><p>
J'appr&eacute;cierais que vous me fassiez des retours sur vos tests et les
am&eacute;liorations que vous avez apport&eacute;es &agrave; ces scripts pour vos ordinateurs.
J'encourage aussi les &eacute;diteurs de logiciels de sauvegarde &agrave; r&eacute;diger une
documentation permettant d'effectuer une sauvegarde minimum de leurs produits.
J'aimerais que gr&acirc;ce &agrave; ces efforts la communaut&eacute; Linux dorme un tout petit peu
mieux chaque nuit.</p><div class="sect2" lang="fr"><div class="titlepage"><div><div><h3 class="title"><a name="todo"></a>10.1.&nbsp;Liste de travail</h3></div></div></div><p>
Les volontaires sont bienvenus. Avant de commencer un th&egrave;me, consultez-moi pour
savoir si quelqu'un d'autre y travaille d&eacute;j&agrave;.</p><div class="itemizedlist"><ul type="disc"><li><p>
Un &eacute;diteur de partitions pour ajuster les limites des partitions dans le fichier
<code class="filename">dev.hdx</code>. Cela permettra aux utilisateurs d'ajuster les
partitions sur un disque dur diff&eacute;rent, ou sur le m&ecirc;me, mais avec une g&eacute;om&eacute;trie
diff&eacute;rente, ou encore d'ajuster la taille des partitions sur le m&ecirc;me disque dur.
Une interface graphique serait certainement une bonne chose. D'un autre c&ocirc;t&eacute;, le
programme de la FSF  <a href="http://www.gnu.org/software/parted" target="_top"><code class="filename">parted</code></a>
semble pouvoir r&eacute;pondre partiellement au besoin. Il redimensionne les partitions
existantes, mais avec certaines restrictions.</p></li><li><p>
<a href="#make.fdisk" title="11.1.1.&nbsp;make.fdisk"><code class="filename">make.fdisk</code></a>
est le seul actuellement &agrave; reconna&icirc;tre certaines partitions FAT, pas toutes.
Ajouter du code &agrave; <a href="#make.fdisk" title="11.1.1.&nbsp;make.fdisk"><code class="filename">make.fdisk</code></a>
pour qu'il reconnaisse les autres et &eacute;crire les instructions appropri&eacute;es pour
qu'il les reconstruise dans les fichiers en sortie.</p></li><li><p>
Pour les partitions FAT12 et FAT16, nous ne formatons pas, n'&eacute;crivons pas de
z&eacute;ro dans la partition de telle sorte que MS-DOS 6.x les reconnaisse
correctement. Reportez-vous aux notes sur <span><strong class="command">fdisk</strong></span> pour une
explication du probl&egrave;me.</p></li><li><p>
Faire un script pour mettre les syst&egrave;mes de fichiers ext2/3 sur disque
ZIP.</p></li><li><p>
Traduire ce guide dans d'autres langues.</p></li><li><p>
D&eacute;terminer dans quelle mesure loadlin ou des programmes de ce type affectent le
processus.</p></li><li><p>
J'ai mentionn&eacute; le gestionnaire de paquets de (Red Hat Red Hat Package
Manager&nbsp;: rpm) de temps en temps. Quelles sont les commandes deb
&eacute;quivalentes&nbsp;?</p></li></ul></div></div></div><div class="sect1" lang="fr"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="TheScripts"></a>11.&nbsp;Les scripts</h2></div></div></div><p>
Reportez-vous aux notes situ&eacute;es au d&eacute;but de chaque script pour voir le r&eacute;sum&eacute; de
ce qu'il fait.</p><div class="sect2" lang="fr"><div class="titlepage"><div><div><h3 class="title"><a name="FirstStage"></a>11.1.&nbsp;Premi&egrave;re &eacute;tape</h3></div></div></div><div class="sect3" lang="fr"><div class="titlepage"><div><div><h4 class="title"><a name="make.fdisk"></a>11.1.1.&nbsp;<code class="filename">make.fdisk</code></h4></div></div></div><p>

    Ce script, lanc&eacute; pendant la sauvegarde, cr&eacute;e des scripts semblables 
    &agrave; <a href="#make.dev.hda" title="11.1.2.&nbsp;make.dev.hda"><code class="filename">make.dev.hda</code></a> et 
    <a href="#mount.dev.hda" title="11.1.3.&nbsp;mount.dev.hda"><code class="filename">mount.dev.x</code></a>, 
    plus bas, pour que vous les lanciez &agrave; la restauration. Il produit 
    aussi des fichiers de donn&eacute;es semblables &agrave; <a href="#dev.hda" title="11.1.4.&nbsp;dev.hda"><code class="filename">dev.hda</code></a>, plus bas. Le 
    nom du script et du fichier de donn&eacute;es qui est produit d&eacute;pend du 
    p&eacute;riph&eacute;rique donn&eacute; en param&egrave;tre &agrave; ce script. Ce script, lanc&eacute; &agrave; la 
    restauration, cr&eacute;e les partitions sur le disque dur. 
    <code class="filename">make.fdisk</code> est appel&eacute; par <a href="#save.metadata" title="11.1.5.&nbsp;save.metadata"><code class="filename">save.metadata</code></a>, 
    plus bas.
    
</p><pre class="programlisting">
#! /usr/bin/perl

# A perl script to create a script and input file for fdisk to
# re-create the partitions on the hard disk, and format the Linux and
# Linux swap partitions. The first parameter is the fully qualified
# path of the device of the hard disk, e.g. /dev/hda. The two
# resulting files are the script make.dev.x and the data file dev.x
# (where x is the hard drive described, e.g. hda, sdc). make.dev.x is
# run at restore time to rebuild hard drive x, prior to running
# restore.metadata. dev.x is the input file for fdisk.

# Time-stamp: &lt;2004-04-10 13:51:37 root make.fdisk&gt;

# Copyright 2001 through the last date of modification Charles Curley
# except for the subroutine cut2fmt.

# cut2fmt Copyright (c) 1998 Tom Christiansen, Nathan Torkington and
# O'Reilly &amp; Associates, Inc.  Permission is granted to use this code
# freely EXCEPT for book publication.  You may use this code for book
# publication only with the explicit permission of O'Reilly &amp;
# Associates, Inc.

# This program is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the
# Free Software Foundation; either version 2 of the License, or (at your
# option) any later version.

# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.

# You should have received a copy of the GNU General Public License along
# with this program; if not, write to the Free Software Foundation, Inc.,
# 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA

# In addition, as a special exception, Tom Christiansen, Nathan
# Torkington and O'Reilly &amp; Associates, Inc.  give permission to use
# the code of this program with the subroutine cut2fmt (or with
# modified versions of the subroutine cut2fmt that use the same
# license as the subroutine cut2fmt), and distribute linked
# combinations including the two.  You must obey the GNU General
# Public License in all respects for all of the code used other than
# the subroutine cut2fmt.  If you modify this file, you may extend
# this exception to your version of the file, but you are not
# obligated to do so.  If you do not wish to do so, delete this
# exception statement and the subroutine cut2fmt from your version.

# You can also contact the Free Software Foundation at
# http://www.fsf.org/

# Changes:

# 2004 04 10: fdisk v &gt; 2.11 has wider columns. Added code to select
# the appropriate cut string based on fdisk's version.

# 2004 04 09: Added support for Mandrake's idea of devfs. On Mandrake,
# everything is mounted with devfs. So the mount devices are buried
# deep in places like /dev/ide/host0/bus0/target0/lun0/part1 instead
# of places like /dev/hda1, where $DEITY intended they should be. We
# have to reverse from the long devfs device to the shorter old style
# that tomsrtbt uses. The alternative is to keep track in an array of
# which devfs device belongs to which short device.

# 2003 12 29: Changed the regex for detecting whether a file system is
# read-write in the code that builds the mount file(s). The old test
# does not work if mount returns multiple parameters in the 5th field,
# e.g. (rw,errors=remount-ro) on some debian systems. This regex
# assumes that the rw parameter is always listed first, which may not
# always be the case. If it fails, take out the '\('. Thanks to Pasi
# Oja-Nisula &lt;pon at iki dot fi&gt; for pointing this out.

# 2003 01 09: Added support for FAT32. We now create two scripts for
# each hard drive, make.dev.[as]dx and mount.dev.[as]dx. These create
# and make file systems on each partition, and make mount points and
# mount them.

# 2002 12 25: added support to handle W95 extended (LBA) (f) and W95
# FAT 32 partitions. I have tested this for primary but not logical
# partitions.

# 2002 09 08: Added minimal support for ext3fs. We now detect mounted
# ext3fs partitions &amp; rebuild but with no options. The detection
# depends on the command line "dumpe2fs &lt;device&gt; 2&gt;/dev/null | grep -i
# journal" producing no output for an ext2fs, and output (we don't
# care what) for an ext3fs.

# This could stand extension to support non-default ext3 options such
# as the type of journaling. Volunteers?

# 2002 07 25: Bad block checking is now a command line option (-c) at
# the time the product script is run.

# 2002 07 03: Corrected the mechanism for specifying the default
# drive.

# 2001 11 25: Changed the way mke2fs gets its bad block
# list. badblocks does not guess at the block size, so you have to get
# it (from dumpe2fs) and feed it to badblocks. It is simpler to just
# have mke2fs call badblocks, but you do loose the ability to have a
# writing test easily. -- C^2

# 2001 11 25: Changed the regex that extracts partition labels from
# the mount command. This change does not affect the results at all,
# it just makes it possible to use Emacs' perl mode to indent
# correctly. I just escaped the left bracket in the regex. -- C^2

# Discussion:

# fdisk will spit out a file of the form below if you run it as "fdisk
# -l".

# root@tester ~/bin $ fdisk -l /dev/hda

# Disk /dev/hda: 64 heads, 63 sectors, 1023 cylinders
# Units = cylinders of 4032 * 512 bytes

#    Device Boot    Start       End    Blocks   Id  System
# /dev/hda1             1         9     18112+  83  Linux
# /dev/hda2            10      1023   2044224    5  Extended
# /dev/hda5            10       368    723712+  83  Linux
# /dev/hda6           369       727    723712+  83  Linux
# /dev/hda7           728       858    264064+  83  Linux
# /dev/hda8           859       989    264064+  83  Linux
# /dev/hda9           990      1022     66496+  82  Linux swap

# What fdisk does not do is provide output suitable for later
# importing into fdisk, a la sfdisk. This script parses the output
# from fdisk and creates an input file for fdisk. Use the input file
# like so:

# fdisk /dev/hdx &lt; dev.hdx

# For the bare metal restore package, this script also builds a script
# that will execute the above command so you can run it from your zip
# disk. Because the bare metal restore scripts all are in /root/bin,
# the data file and script created by this script are also placed
# there. The same script also creates appropriate Linux file systems,
# either ext2fs, or Linux swap. There is limited support for FAT12,
# FAT16 and FAT32. For anything else, you're on your own.

# Note for FAT32: According to the MS KB, there are more than one
# reserved sectors for FAT32, usually 32, but it can vary. Do a search
# in M$'s KB for "boot sector" or BPB for the gory details. For more
# info than you really need on how boot sectors are used, see
# http://support.microsoft.com/support/kb/articles/Q140/4/18.asp

# You can also edit dev.x to change the sizes of partitions. Don't
# forget, if you change the size of a FAT partition across the 32MB
# boundary, you need to change the type as well! Run "fdisk /dev/hda"
# or some such, then the l command to see the available partition
# types. Then go ahead and edit dev.x appropriately. Also, when moving
# partition boundarys with hand edits, make sure you move both logical
# and extended partition boundaries appropriately.

# Bad block checking right now is a quick read of the partition. A
# writing check is also possible but more difficult. You have to run
# badblocks as a separate command, and pass the bad block list to
# mke2fs in a file (in /tmp, which is a ram disk). You also have to
# know how large the blocks are, which you learn by running
# dumpe2fs. It gets messy and I haven't done it yet. You probably
# don't need it for a new hard drive, but if you have had a hard drive
# crash on you and you are reusing it (while you are waiting for its
# replacement to come in, I presume), then I highly recommend it. Let
# me know how you do it.

# For more information contact the author, Charles Curley, at
# http://www.charlescurley.com/.


# cut2fmt figures out the format string for the unpack function we use
# to slice and dice the output from fdisk. From Christiansen and
# Torkington, Perl Cookbook 5.

sub cut2fmt {
    my (@positions) = @_;
    my $template    = '';
    my $lastpos     = 1;

    foreach $place (@positions) {
        $template .= "A" . ($place - $lastpos) . " ";
        $lastpos = $place;
    }

    $template .= "A*";
    return $template;
}


# Sub gpl, a subroutine to ship the GPL and other header information
# to the current output file.

sub gpl {

print OUTPUT &lt;&lt;FINIS;

# Copyright 2001 through the last date of modification Charles Curley.

# This program is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the
# Free Software Foundation; either version 2 of the License, or (at your
# option) any later version.

# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.

# You should have received a copy of the GNU General Public License along
# with this program; if not, write to the Free Software Foundation, Inc.,
# 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA

# You can also contact the Free Software Foundation at http://www.fsf.org/

# For more information contact the author, Charles Curley, at
# http://www.charlescurley.com/.

FINIS

}


# Begin main line code.



# Provide a default device.

# print "\$ARGV[0] is $ARGV[0].\n";

$device = defined ($ARGV[0]) ? $ARGV[0] : "/dev/hda";

# Need to check to see if $device is a sym link. If it is, the mount
# point is the target of the link. (Mandrake) Otherwise we search for
# mount points on $device. Fedora, Red Hat.

if ( -l $device) {

    # It is a sym link. Get the target of the link, then make it into
    # an absolute path, preserving the numbering.

    $mountdev = '/dev/' . readlink ($device);
    $mountdev =~ s|ide/host(\d+)/bus(\d+)/target(\d+)/lun(\d+)/disc|ide/host\1/bus\2/target\3/lun\4|;
} else {
    # not a sym link; just assign it.
    $mountdev = $device;
}

# print "Device is $device; mount device is $mountdev.\n";

# Prepare format string. Here are two format strings I have found
# useful. Here, column numbers are 1 based, i.e. the leftmost column
# is column 1, not column 0 as in Emacs.

# We select a format string according to fdisk's version.

$fdpid = open (FDVER, "fdisk -v |") or die "Couldn't fork: $!\n";
while (&lt;FDVER&gt;) {
    @_ = unpack ("A7 A*", $_);
    $fdver=$_[1];
    $fdver =~ s/[^\d.]//g; # strip non-numbers, non-periods, as in "2.12pre".
}

# print "fdisk version is $fdver\n";

if ($fdver &lt; 2.12) {
# fdisk to 2.11?? Red Hat, Fedora Core 1
    $fmt = cut2fmt (11, 19, 24, 34, 45, 49);
} else {
# fdisk 2.12 &amp; up?? Mandrake 10.0, Fedora Core 2
    $fmt = cut2fmt (12, 14, 26, 38, 50, 55);
}
# print "Format string is $fmt.\n";

# define fields in the array @_.
$dev = 0;
$bootable = 1;
$firstcyl = 2;
$lastcyl = 3;
$parttype = 5;
$partstring = 6;

$target = "\/target";

$outputfilename = $device;
$outputfilename =~ s/\//./g;
$outputfilename = substr ($outputfilename, 1, 100);

$outputfilepath = "\/root\/bin\/";


# Make a hash of the labels.
$mpid = open (MOUNT, "mount -l |") or die "Couldn't fork: $!\n";
while (&lt;MOUNT&gt;) {
    if ($_ =~ /^$mountdev/i) { # is this a line with a partition in it?
#       print $_;               # print it just for grins
        split;
        if ($_[6] ne "") {      # only process if there actually is a label
            $_[6] =~ s/[\[\]]//g; # strike [ and ].
            $labels{$_[0]} = $_[6];
#           print "The label of file device $_[0] is $labels{$_[0]}.\n";
        }


        # We only mount if it's ext2fs or ext3fs and read and write.

        if ($_[4] =~ /ext[23]/ and $_[5] =~ /\(rw/ ) {
            if ($_[0] =~ /ide/i) {

                # We have a devfs system, e.g. Mandrake. This code
                # converts back from the devfs designation to the old
                # /dev/hd* designation for tomsrtb. I have NOT checked
                # this out for drives other than /dev/hda. Also, this
                # code does not handle SCSI drives.

                if ( $_[0] =~ /target0/ &amp;&amp; $_[0] =~ /bus0/ ) {
                    $letter = 'a';
                } elsif ( $_[0] =~ /target1/ &amp;&amp; $_[0] =~ /bus0/) {
                    $letter = 'b';
                } elsif ( $_[0] =~ /target0/ &amp;&amp; $_[0] =~ /bus1/) {
                    $letter = 'c';
                } else {
                    $letter = 'd';
                }
                $_[0] =~ s|/ide/host\d+/bus\d+/target\d+/lun\d+/part|/hd|g;
                $_[0] =~ s/hd/hd$letter/;
            }
            $mountpoints{$_[2]} = $_[0];
#             print "$_[2] is the mountpoint for tomsrtbt device $mountpoints{$_[2]}.\n";
        }
    }
}
close (MOUNT);


$fpid = open (FDISK, "fdisk -l $device |") or die "Couldn't fork: $!\n";

open (OUTPUT, "&gt; $outputfilepath${outputfilename}")
    or die "Couldn't open output file $outputfilepath${outputfilename}.\n";

while (&lt;FDISK&gt;) {
    if ($_ =~ /^$device/i) {    # is this a line with a partition in it?
#       print $_;               # print it just for grins
        chop;                   # kill trailing \r
        @_ = unpack ($fmt, $_);

        # now strip white spaces from cylinder numbers
        @_[$firstcyl] =~ s/[ \t]+//;
        @_[$lastcyl] =~ s/[ \t]+//;
        @_[$parttype] =~ s/[ \t]+//;

        $partnumber = substr(@_[$dev], 8, 10); # get partition number for this line
        # just for grins
#       print "  $partnumber, @_[$firstcyl], @_[$lastcyl], @_[$parttype], @_[$partstring]\n";

        # Here we start creating the input to recreate the partition
        # this line represents.

        print OUTPUT "n\n";
        if ($partnumber &lt; 5) {
            # primary Linux partition
            if (@_[$parttype] == 83) {
                print OUTPUT "p\n$partnumber\n@_[$firstcyl]\n";
                if (@_[$firstcyl] ne @_[$lastcyl]) { # in case it's all on one cylinder
                    print OUTPUT "@_[$lastcyl]\n";
                }

                # Now detect if this is an ext3 (journaling)
                # partition. We do this using dumpe2fs to dump the
                # partition and grepping on "journal". If the
                # partition is ext2, there will be no output. If it is
                # ext3, there will be output, and we use that fact to
                # set a command line switch. The command line switch
                # goes into an associative array (hash) so we don't
                # have to remember to reset it to the null string when
                # we're done.

                $dpid = open (DUMPE2FS, "dumpe2fs @_[$dev] 2&gt;/dev/null | grep -i journal |")
                    or die "Couldn't fork: $!\n";
                while (&lt;DUMPE2FS&gt;) {
#                   print "Dumpe2fs: $_";
                    $ext3{$_[$dev]} = "-j ";
                    last;
                }
                close (DUMPE2FS);

                if ($labels{@_[$dev]}) { # do we have a label?
                    $format .= "echo\necho formatting $checking@_[$dev]\n";
                    $format .= "mke2fs $ext3{$_[$dev]}\$blockcheck -L $labels{@_[$dev]} @_[$dev]\n\n";
                } else {
                    $format .= "echo\necho formatting $checking@_[$dev]\n";
                    $format .= "mke2fs $ext3{$_[$dev]}\$blockcheck @_[$dev]\n\n";
                }

                # extended partition
            } elsif (@_[$parttype] == 5) {
                # print ("Creating Extended Partition.\n");
                print OUTPUT "e\n$partnumber\n@_[$firstcyl]\n";
                if (@_[$firstcyl] ne @_[$lastcyl]) {
                    print OUTPUT "@_[$lastcyl]\n";
                }

                # extended partition, Win95 Ext'd (LBA)
            } elsif (@_[$parttype] eq "f") {
                # print ("Creating Extended LBA Partition.\n");
                print OUTPUT "e\n$partnumber\n@_[$firstcyl]\n";
                if (@_[$firstcyl] ne @_[$lastcyl]) {
                    print OUTPUT "@_[$lastcyl]\n";
                }
                print OUTPUT "t\n$partnumber\nf\n";

                # primary Linux swap partition
            } elsif (@_[$parttype] == 82) {
                print OUTPUT "p\n$partnumber\n@_[$firstcyl]\n";
                if (@_[$firstcyl] ne @_[$lastcyl]) {
                    print OUTPUT "@_[$lastcyl]\n";
                }
                print OUTPUT "t\n$partnumber\n82\n";
                $format .= "echo Making @_[$dev] a swap partition.\n";
                $format .= "mkswap \$blockcheck @_[$dev]\n\n";

                # Primary mess-dos partition. We don't handle hidden
                # partitions.
            } elsif ( @_[$parttype] == 1 || @_[$parttype] == 4 || @_[$parttype] == 6
                      || @_[$parttype] eq "b" || @_[$parttype] eq "c"
                      || @_[$parttype] eq "e" ) {
                # print ("Making DOS primary partition.\n");
                print ("dd if=@_[$dev] of=$outputfilepath$outputfilename$partnumber");
                print (" bs=512 count=1\n");
                system ("dd if=@_[$dev] of=$outputfilepath$outputfilename$partnumber bs=512 count=1");
                print OUTPUT "p\n$partnumber\n@_[$firstcyl]\n";
                if (@_[$firstcyl] ne @_[$lastcyl]) { # in case it's all on one cylinder
                    print OUTPUT "@_[$lastcyl]\n";
                }
                print OUTPUT "t\n$partnumber\n@_[$parttype]\n";
                $format .= "echo\necho formatting $checking@_[$dev]\n";
                $format .= "mkdosfs \$blockcheck";
                if ( @_[$parttype] == b || @_[$parttype] == c) {
                    # We have a W9x FAT32 partition. Add a command line switch.
                    $format .= " -F 32";
                }
                $format .= " @_[$dev]\n";
                $format .= "# restore FAT boot sector.\n";
                $format .= "dd if=$outputfilename$partnumber of=@_[$dev] bs=512 count=1\n\n";

            } else {
                # anything else partition
                print OUTPUT "p\n@_[$firstcyl]\n";
                if (@_[$firstcyl] ne @_[$lastcyl]) {
                    print OUTPUT "@_[$lastcyl]\n";
                }
                print OUTPUT "t\n$partnumber\n@_[$parttype]\n";
            }

        } else {
            # logical Linux partition
            if (@_[$parttype] == 83) {
                print OUTPUT "l\n@_[$firstcyl]\n";
                if (@_[$firstcyl] ne @_[$lastcyl]) {
                    print OUTPUT "@_[$lastcyl]\n";
                }

                # Now detect if this is an ext3 (journaling)
                # partition. We do this using dumpe2fs to dump the
                # partition and grepping on "journal". If the
                # partition is ext2, there will be no output. If it is
                # ext3, there will be output, and we use that fact to
                # set a command line switch. The command line switch
                # goes into an associative array (hash) so we don't
                # have to remember to reset it to the null string when
                # we're done.

                $dpid = open (DUMPE2FS, "dumpe2fs @_[$dev] 2&gt;/dev/null | grep -i journal |")
                    or die "Couldn't fork: $!\n";
                while (&lt;DUMPE2FS&gt;) {
#                   print "Dumpe2fs: $_";
                    $ext3{$_[$dev]} = "-j ";
                    last;
                }
                close (DUMPE2FS);

                if ($labels{@_[$dev]}) { # do we have a label?
                    $format .= "echo\necho formatting $checking@_[$dev]\n";
                    $format .= "mke2fs $ext3{@_[$dev]}\$blockcheck -L $labels{@_[$dev]} @_[$dev]\n\n";
                } else {
                    $format .= "echo\necho formatting $checking@_[$dev]\n";
                    $format .= "mke2fs $ext3{@_[$dev]}\$blockcheck @_[$dev]\n\n";
                }

                # logical Linux swap partition
            } elsif (@_[$parttype] == 82 ) {
                print OUTPUT "l\n@_[$firstcyl]\n";
                if (@_[$firstcyl] ne @_[$lastcyl]) {
                    print OUTPUT "@_[$lastcyl]\n";
                }
                print OUTPUT "t\n$partnumber\n82\n";
                $format .= "echo Making @_[$dev] a swap partition.\n";
                $format .= "mkswap \$blockcheck @_[$dev]\n\n";

                # Logical mess-dos partition. We don't handle hidden
                # partitions.

            } elsif ( @_[$parttype] == 1 || @_[$parttype] == 4 || @_[$parttype] == 6
                      || @_[$parttype] eq "b" || @_[$parttype] eq "c"
                      || @_[$parttype] eq "e" ) {
#               print ("Making DOS logical partition.\n");
                print ("dd if=@_[$dev] of=$outputfilepath$outputfilename$partnumber");
                print (" bs=512 count=1\n");
                system ("dd if=@_[$dev] of=$outputfilepath$outputfilename$partnumber bs=512 count=1");
                print OUTPUT "l\n$partnumber\n@_[$firstcyl]\n";
                if (@_[$firstcyl] ne @_[$lastcyl]) { # in case it's all on one cylinder
                    print OUTPUT "@_[$lastcyl]\n";
                }
                print OUTPUT "t\n$partnumber\n@_[$parttype]\n";
                $format .= "echo\necho formatting $checking@_[$dev]\n";
                $format .= "mkdosfs \$blockcheck";
                if ( @_[$parttype] == b || @_[$parttype] == c) {
                    # We have a W9x FAT32 partition. Add a command line switch.
                    $format .= " -F 32";
                }
                $format .= " @_[$dev]\n";
                $format .= "# restore FAT boot sector.\n";
                $format .= "dd if=$outputfilename$partnumber of=@_[$dev] bs=512 count=1\n\n";

            } else {
                # anything else partition
                print OUTPUT "l\n@_[$firstcyl]\n";
                if (@_[$firstcyl] ne @_[$lastcyl]) {
                    print OUTPUT "@_[$lastcyl]\n";
                }
                print OUTPUT "t\n$partnumber\n@_[$parttype]\n";
            }

        }

        # handle bootable partitions
        if (@_[$bootable] =~ /\*/) {
            print OUTPUT "a\n$partnumber\n";
        }
    }
}

print OUTPUT "v\nw\n";

close (OUTPUT);
close (FDISK);


open (OUTPUT, "&gt; ${outputfilepath}make.$outputfilename")
    or die "Couldn't open output file ${outputfilepath}make.$outputfilename.\n";

print OUTPUT &lt;&lt;FINIS;
#! /bin/sh

# A script to restore the partition data of a hard drive and format
# the partitions. Created at bare metal backup time by the Perl script
# make.fdisk.
FINIS

&amp;gpl;

print OUTPUT &lt;&lt;FINIS;

export blockcheck=\$1;

if [ "\$blockcheck" != "-c" ] &amp;&amp; [ -n "\$blockcheck" ]
then
    echo "\${0}: automated restore with no human interaction."
    echo "\${0}: -c: block check during file system making."
    exit 1;
fi

FINIS

# Clean the old partition table out.
print OUTPUT "dd if=/dev/zero of=$device bs=512 count=2\n\nsync\n\n";

print OUTPUT "fdisk $device \&lt; $outputfilename\n\nsync\n\n";
print OUTPUT $format;

print OUTPUT "fdisk -l \"$device\"\n";

close (OUTPUT);

# Now build the script that will build the mount points on the root
# and other partitions.

open (OUTPUT, "&gt; ${outputfilepath}mount.$outputfilename")
    or die "Couldn't open output file ${outputfilepath}make.$outputfilename.\n";

print OUTPUT &lt;&lt;FINIS;
#! /bin/sh

# A script to create a minimal directory tree on the target hard drive
# and mount the partitions on it. Created at bare metal backup time by
# the Perl script make.fdisk.
FINIS

&amp;gpl;

print OUTPUT &lt;&lt;FINIS;

# WARNING: If your Linux system mount partitions across hard drive
# boundaries, you will have multiple "mount.dev.* scripts. You must
# ensure that they run in the proper order. The root partition should
# be mounted first, then the rest in the order they cascade. If they
# cross mount, you'll have to handle that manually.

FINIS


# We have a hash of mount points and devices in %mountpoints. However,
# we have to process them such that directories are built on the
# appropriate target partition. E.g. where /usr/local is on its own
# partition, we have to mount /usr before we build /usr/local. We can
# ensure this by sorting them. Shorter mount point paths will be built
# first. We can't sort a hash directly, so we use an array.

# We build commands to create the appropriate mount points and then
# mount the partitions to the mount points. This is in preparation for
# untarring the contents of the ZIP disk, done in restore.metadata.

foreach $point ( sort keys %mountpoints) {
    print OUTPUT "\n# $point is the mountpoint for tomsrtbt device $mountpoints{$point}.\n";
    print OUTPUT "mkdir $target$point\n";
    print OUTPUT "mount $mountpoints{$point} $target$point\n";
}

print OUTPUT "\nmount | grep -i \"$device\"\n";

close (OUTPUT);

# These scripts are dangerous &amp; should only be visible to root.

chmod 0700, "${outputfilepath}make.$outputfilename";
chmod 0700, "${outputfilepath}mount.$outputfilename";
chmod 0600, "${outputfilepath}$outputfilename";


</pre></div><div class="sect3" lang="fr"><div class="titlepage"><div><div><h4 class="title"><a name="make.dev.hda"></a>11.1.2.&nbsp;<code class="filename">make.dev.hda</code></h4></div></div></div><p>
	
    Ce script est un exemple de la production de <a href="#make.fdisk" title="11.1.1.&nbsp;make.fdisk"><code class="filename">make.fdisk</code></a>, plus 
    haut. Il fait appel &agrave; des fichiers de donn&eacute;es comme <a href="#dev.hda" title="11.1.4.&nbsp;dev.hda"><code class="filename">dev.hda</code></a>, plus bas. Il 
    cr&eacute;e des partitions et des syst&egrave;mes de fichiers sur certains d'entre 
    elles. C'est le premier script lanc&eacute; &agrave; la restauration.

</p><p>

    Si vous &ecirc;tes suffisamment courageux pour &eacute;diter <a href="#dev.hda" title="11.1.4.&nbsp;dev.hda"><code class="filename">dev.hda</code></a> (voir plus 
    haut), pour, disons, ajouter une nouvelle partition, il se peut que 
    vous deviez &eacute;diter ce script.</p><p>

Si vous voulez que make.dev.hda v&eacute;rifie les secteurs d&eacute;fectueux quand il
installe un syst&egrave;me de fichiers sur les partitions, saisissez en ligne de
commande l'option "-c".</p><pre class="programlisting">
#! /bin/sh

# A script to restore the partition data of a hard drive and format
# the partitions. Created at bare metal backup time by the Perl script
# make.fdisk.

# Copyright 2001 through the last date of modification Charles Curley.

# This program is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the
# Free Software Foundation; either version 2 of the License, or (at your
# option) any later version.

# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.

# You should have received a copy of the GNU General Public License along
# with this program; if not, write to the Free Software Foundation, Inc.,
# 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA

# You can also contact the Free Software Foundation at http://www.fsf.org/

# For more information contact the author, Charles Curley, at
# http://www.charlescurley.com/.


export blockcheck=$1;

if [ "$blockcheck" != "-c" ] &amp;&amp; [ -n "$blockcheck" ]
then
    echo "${0}: automated restore with no human interaction."
    echo "${0}: -c: block check during file system making."
    exit 1;
fi

dd if=/dev/zero of=/dev/hda bs=512 count=2

sync

fdisk /dev/hda &lt; dev.hda

sync

echo
echo formatting /dev/hda1
mkdosfs $blockcheck /dev/hda1
# restore FAT boot sector.
dd if=dev.hda1 of=/dev/hda1 bs=512 count=1

echo
echo formatting /dev/hda2
mke2fs -j $blockcheck -L /boot /dev/hda2

echo
echo formatting /dev/hda3
mke2fs -j $blockcheck -L / /dev/hda3

echo Making /dev/hda5 a swap partition.
mkswap $blockcheck /dev/hda5

fdisk -l "/dev/hda"


</pre></div><div class="sect3" lang="fr"><div class="titlepage"><div><div><h4 class="title"><a name="mount.dev.hda"></a>11.1.3.&nbsp;<code class="filename">mount.dev.hda</code></h4></div></div></div><p>

Ce script est un exemple de la production de <a href="#make.fdisk" title="11.1.1.&nbsp;make.fdisk"><code class="filename">make.fdisk</code></a>, plus haut. 
Il cr&eacute;e des points de montage et monte les partitions, pr&eacute;parant le 
syst&egrave;me de fichiers cible &agrave; la restauration des fichiers. C'est le 
second script lanc&eacute; &agrave; la restauration.

</p><p>

Si vous &ecirc;tes suffisamment courageux pour &eacute;diter <a href="#dev.hda" title="11.1.4.&nbsp;dev.hda"><code class="filename">dev.hda</code></a> (voir plus haut), 
pour, disons, ajouter une nouvelle partition, il se peut que vous deviez 
&eacute;diter ce script.

</p><pre class="programlisting">
#! /bin/sh

# A script to create a minimal directory tree on the target hard drive
# and mount the partitions on it. Created at bare metal backup time by
# the Perl script make.fdisk.

# Copyright 2001 through the last date of modification Charles Curley.

# This program is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the
# Free Software Foundation; either version 2 of the License, or (at your
# option) any later version.

# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.

# You should have received a copy of the GNU General Public License along
# with this program; if not, write to the Free Software Foundation, Inc.,
# 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA

# You can also contact the Free Software Foundation at http://www.fsf.org/

# For more information contact the author, Charles Curley, at
# http://www.charlescurley.com/.


# WARNING: If your Linux system mount partitions across hard drive
# boundaries, you will have multiple "mount.dev.* scripts. You must
# ensure that they run in the proper order. The root partition should
# be mounted first, then the rest in the order they cascade. If they
# cross mount, you'll have to handle that manually.


# / is the mountpoint for /dev/hda3.
mkdir /target/
mount /dev/hda3 /target/

# /boot is the mountpoint for /dev/hda2.
mkdir /target/boot
mount /dev/hda2 /target/boot

mount | grep -i "/dev/hda"


</pre></div><div class="sect3" lang="fr"><div class="titlepage"><div><div><h4 class="title"><a name="dev.hda"></a>11.1.4.&nbsp;<code class="filename">dev.hda</code></h4></div></div></div><p>

    Ce fichier de donn&eacute;es est utilis&eacute; au moment de la restauration. Il 
    est utilis&eacute; par <span><strong class="command">fdisk</strong></span> et est aliment&eacute; par <a href="#make.dev.hda" title="11.1.2.&nbsp;make.dev.hda"><code class="filename">make.dev.hda</code></a>. Il 
    est produit pendant la sauvegarde par <a href="#make.fdisk" title="11.1.1.&nbsp;make.fdisk"><code class="filename">make.fdisk</code></a>. Ceux 
    qui connaissent bien <span><strong class="command">fdisk</strong></span> reconna&icirc;tront que 
    chaque ligne est une commande ou une valeur de 
    <span><strong class="command">fdisk</strong></span>, tel qu'un num&eacute;ro de cylindre. Donc, il est 
    possible de changer les tailles des partitions et d'ajouter de 
    nouvelles partitions en &eacute;ditant ce fichier. C'est pourquoi la 
    p&eacute;nulti&egrave;me commande est <span><strong class="command">v</strong></span>, qui v&eacute;rifiera la table 
    des partitions avant qu'elle soit &eacute;crite.

</p><pre class="programlisting">
n
p
1
1
29
t
1
6
a
1
n
p
2
30
44
n
e
3
45
1023
n
l
45
944
n
l
945
1023
t
6
82
v
w


</pre></div><div class="sect3" lang="fr"><div class="titlepage"><div><div><h4 class="title"><a name="save.metadata"></a>11.1.5.&nbsp;<code class="filename">save.metadata</code></h4></div></div></div><p>

C'est le premier script lanc&eacute; dans le processus de sauvegarde. Il 
appelle <a href="#make.fdisk" title="11.1.1.&nbsp;make.fdisk"><code class="filename">make.fdisk</code></a>, plus haut. 
Si vous devez sauvegarder un disque dur SCSI ou plusieurs disques durs, 
faites de sorte que l'appel &agrave; <a href="#make.fdisk" title="11.1.1.&nbsp;make.fdisk"><code class="filename">make.fdisk</code></a> soit 
effectu&eacute; de fa&ccedil;on correcte.

</p><pre class="programlisting">
#! /bin/sh

# A script to save certain meta-data off to the boot partition. Useful for
# restoration.

# Time-stamp: &lt;2004-04-29 15:36:52 root save.metadata&gt;

# Copyright 2000 through the last date of modification, Charles Curley.

# This program is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the
# Free Software Foundation; either version 2 of the License, or (at your
# option) any later version.

# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.

# You should have received a copy of the GNU General Public License along
# with this program; if not, write to the Free Software Foundation, Inc.,
# 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA

# You can also contact the Free Software Foundation at http://www.fsf.org/


# 2003 01 08: We now age the output from rpm -VA to make back
# comparisons easier.

# The loop that creates directories now has the -p option for mkdir,
# which means you can create parents on the fly if they don't already
# exist.

# initrd is now in the list of directories to create automatically.

# We now exclude more stuff when building the tarballs.

# 2002 07 01: Went to bzip2 to compress the archives, for smaller
# results. This is important in a 100MB ZIP disk. Also some general
# code cleanup.

# 2002 07 01: The function crunch will tar and BZIP2 the
# archives. This is cleaner than the old code, and has better safety
# checking.


# For more information contact the author, Charles Curley, at
# http://www.charlescurley.com/.


# Crunch: A function to compress the contents of a directory and put
# the archive onto the ZIP disk.

# The first parameter is the name of the archive file to be
# created. The backup location, $zip, will be prepended and the
# extension, "tar.bz2" will be appended.

# All following parameters will be taken as additional directories or
# files to be put into the archive.

function crunch {

if [ -z "$1" ] || [ -z "$2" ]	# Checks if parameter #1 or #2 is zero length.
then
   echo "-Parameter #1 or #2 is missing.-"  # Also if no parameter is passed.
   return 1
else
   local file=$1		# The archive file to create
   shift			# Discard the file name
   local dirs=$@		# The director[y|ies] to archive
   local tarcmd="tar -cjf"	# The tar command.

   $tarcmd  $zip/$file.tar.bz2 $dirs # do it!!

   error=$?			# Preserve the exit code

   if [ $error != 0 ]		# Did we fail?
   then				# Yes
      echo "Tar failed with error $error"
      echo $tarcmd $zip/$file.tar.bz2 $dirs
      exit $error		# return tar's exit code as ours
   fi

   return 0			# For error testing if needed.
fi
}

# Begin the main line code
export zip="/mnt/zip";		# Where we will put archives
#  export save="/mnt/save";

RPMVABACKS=/etc			# where we keep our backups
RPMVAROOT=rpmVa			# The root name of the pg backups
ANC=${RPMVABACKS}/${RPMVAROOT}.anc	# name for the oldest (ancient) backup
OLD=${RPMVABACKS}/${RPMVAROOT}.old	# name for the middling oldest backup
NEW=${RPMVABACKS}/${RPMVAROOT}.txt	# name for the newest backup

if [ -f ${ANC} ]; then
echo "Deleting ${ANC}"
rm ${ANC}
fi

if [ -f ${OLD} ]; then
echo "Aging ${OLD}"
mv ${OLD} ${ANC}
fi

if [ -f ${NEW} ]; then
echo "Aging ${NEW}"
mv ${NEW} ${OLD}
fi


# Now we save hard drive information. Run make.fdisk on each hard
# drive in the order in which it mounted from the root partition. That
# is, run it first on the hard drive with your root partition, then
# any hard drives that mount to the first hard drive, then any hard
# drives that mount to those. For example, if your root partition is
# on /dev/sdc, run "make.fdisk /dev/sdc" first.

# The reason for this is that make.fdisk produces a script to make
# mount points and then mount the appropriate partition to them during
# first stage restore. Mount points must be created on the partition
# where they will reside. The partitions must be mounted in this
# order. For example, if your /var and /var/ftp are both separate
# partitions, then you must mount /, create /var, then mount /var,
# then create /var/ftp. The order in which the script "first.stage"
# runs the mounting scripts is based on their time of creation.

# If necessary, put a line, "sleep 1" between calls to make.fdisk.

echo "Saving hard drive info"
make.fdisk /dev/hda

# back up RPM metadata

echo "Verifying RPMs."

rpm -Va | sort +2 -t ' ' &gt; ${NEW}

echo "Finished verifying RPMs; now mounting the ZIP drive."

# Make sure we have the ZIP drive mounted.
umount $zip
modprobe ppa			# Driver for 100MB parallel port ZIP disk
mount $zip			# It should have ext2fs on partition 1.

# clean it all out
rm -r $zip/*
mkdir $zip/lost+found

echo "`hostname` bare metal ZIP disk, created `date`. `uname -a`" &gt; $zip/README.txt

echo "Building the ZIP drive backups."

# These are in case we need to refer to them while rebuilding. The
# rebuilding process should be mostly automated, but you never
# know....

fdisk -l /dev/hda &gt; $zip/fdisk.hda

ls -al /mnt &gt; $zip/ls.mnt.txt
ls -al / &gt; $zip/ls.root.txt

cd /

# Build our minimal archives on the ZIP disk. These appear to be
# required so we can restore later on.

crunch boot boot
crunch root root --exclude root/.cpan --exclude root/.mozilla
crunch etc etc --exclude etc/samba --exclude X11
crunch lib lib

crunch usr.sbin usr/sbin
crunch usr.bin usr/bin --exclude usr/bin/emacs --exclude usr/bin/emacs-21.2 --exclude usr/bin/emacsclient --exclude usr/bin/emacs-nox --exclude usr/bin/gs --exclude usr/bin/pine --exclude usr/bin/gimp-1.2 --exclude usr/bin/doxygen --exclude usr/bin/postgres --exclude usr/bin/gdb --exclude usr/bin/kmail --exclude usr/bin/splint --exclude usr/bin/odbctest --exclude usr/bin/php --exclude usr/bin/xchat --exclude usr/bin/gnucash --exclude usr/bin/pdfetex  --exclude usr/bin/pdftex --exclude usr/bin/smbcacls --exclude usr/bin/evolution-calendar --exclude usr/bin/xpdf --exclude usr/bin/xmms
crunch sbin sbin
crunch bin bin
crunch dev dev
crunch kerberos usr/kerberos/lib/

# Now optional saves.

# arkeia specific:
# crunch arkeia usr/knox

# save these so we can use ssh for restore. *crack* for RH 7.0 login
# authentication.
crunch usr.lib usr/lib/*crack* usr/lib/libz* usr/lib/libssl* usr/lib/libcrypto*

# save the scripts we used to create the ZIP disk and the ones we will
# use to restore it.
mkdir $zip/root.bin
cp -p /root/bin/* $zip/root.bin
rm $zip/root.bin/*~ $zip/root.bin/#*#

echo "Testing our results."
find $zip -iname "*.bz2" | xargs bunzip2 -t

# Not a normal part of the process: we duplicate the ZIP disk onto an
# NFS mount elsewhere.

#  echo "Backing the ZIP drive to the NFS mount."

#  umount $save
#  mount $save

#  rm -r $save/zip
#  mkdir $save/zip
#  cp -pr $zip $save

du -hs ${zip}*
df -m


</pre></div><div class="sect3" lang="fr"><div class="titlepage"><div><div><h4 class="title"><a name="restore.metadata"></a>11.1.6.&nbsp;<code class="filename">restore.metadata</code></h4></div></div></div><p>

Ce script restaure les m&eacute;tadonn&eacute;es du disque ZIP &agrave; la premi&egrave;re &eacute;tape de 
la restauration.

</p><pre class="programlisting">
#! /bin/sh

# A script to restore the meta-data from the ZIP disk. This runs under
# tomsrtbt only after partitions have been rebuilt, file systems made,
# and mounted. It also assumes the ZIP disk has already been
# mounted. Mounting the ZIP disk read only is probably a good idea.

# Time-stamp: &lt;2003-08-23 10:09:16 ccurley restore.metadata&gt;

# Copyright 2000 through the last date of modification Charles Curley.

# This program is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the
# Free Software Foundation; either version 2 of the License, or (at your
# option) any later version.

# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.

# You should have received a copy of the GNU General Public License along
# with this program; if not, write to the Free Software Foundation, Inc.,
# 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA

# You can also contact the Free Software Foundation at http://www.fsf.org/

# 2003 08 23: Oops: tar on tomsrtbt does not respect -p. Try setting
# umask to 0000 instead.

# 2003 02 13: Tar was not preserving permissions on restore. Fixed
# that.

# 2002 07 01: Went to bzip2 to compress the archives, for smaller
# results. This is important in a 100MB ZIP disk. Also some general
# code cleanup.

# For more information contact the author, Charles Curley, at
# http://www.charlescurley.com/.

umask 0000

zip="/mnt";			# Where we mount the zip drive.
target="/target";		# Where the hard drive to restore is mounted.

ls -lt $zip			# Warm fuzzies for the user.

cd $target

# Restore the archived metadata files.
for archive in $( ls $zip/*.bz2 ); do
echo $archive
ls -al $archive
bzip2 -dc $archive | tar -xf -
done

# Build the mount points for our second stage restoration and other
# things.

# If you boot via an initrd, make sure you build a directory here so
# the kernel can mount the initrd at boot.

for dir in mnt/zip mnt/cdrom mnt/floppy mnt/imports proc initrd; do
mkdir -p $target/$dir
done

chmod a-w $target/proc		# Restore /proc's read-only permissions

# Restore the scripts we used to create the ZIP disk and the ones we will
# use to restore it. These should be the latest &amp; greatest in case we had
# to do any editing during 1st stage restore.
cp -p $zip/root.bin/* $target/root/bin

# Now install the boot sector.
chroot $target /sbin/lilo -C /etc/lilo.conf

df -m


</pre></div><div class="sect3" lang="fr"><div class="titlepage"><div><div><h4 class="title"><a name="first.stage"></a>11.1.7.&nbsp;<code class="filename">first.stage</code></h4></div></div></div><p>

Ce script effectue compl&egrave;tement la premi&egrave;re &eacute;tape de la restauration 
sans intervention humaine.

</p><p>

Si vous d&eacute;sirez v&eacute;rifier les secteurs d&eacute;fectueux pendant la cr&eacute;ation des 
syst&egrave;mes de fichiers des partitions, utilisez l'option de ligne de 
commande &laquo;&nbsp;<span class="quote">-c</span>&nbsp;&raquo;.

</p><pre class="programlisting">
#! /bin/sh

# A master script to run the other, detailed scripts. Use this script
# only if you want no human intervention in the restore process. The
# only option is -c, which forces bad block checking during formatting
# of the partitions.

# Time-stamp: &lt;2003-04-24 10:03:07 ccurley first.stage&gt;

# Copyright 2002 through the last date of modification Charles Curley.

# This program is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the
# Free Software Foundation; either version 2 of the License, or (at your
# option) any later version.

# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.

# You should have received a copy of the GNU General Public License along
# with this program; if not, write to the Free Software Foundation, Inc.,
# 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA

# You can also contact the Free Software Foundation at http://www.fsf.org/

# For more information contact the author, Charles Curley, at
# http://www.charlescurley.com/.

export blockcheck=$1;

if [ "$blockcheck" != "-c" ] &amp;&amp; [ -n "$blockcheck" ]
then
    echo "${0}: automated restore with no human interaction."
    echo "${0}: -c: block check during file system making."
    exit 1;
fi

cd /mnt/root.bin		# just in case we aren't already where we should be.

for drive in $( ls make.dev.* ); do
    ./$drive $blockcheck;
done


# WARNING: If your Linux system mount partitions across hard drive
# boundaries, you will have multiple "mount.dev.* scripts. You must
# ensure that they run in the proper order, which the loop below may
# not do. The root partition should be mounted first, then the rest in
# the order they cascade. If they cross mount, you'll have to handle
# that manually.

# The "ls -tr" will list the scripts in the order they are created, so
# it might be a good idea to create them (in the script save.metadata)
# in the order in which you should run them.

for drive in $( ls -tr mount.dev.* ); do
    ./$drive;
done

./restore.metadata

# People who are really confident may comment this line in.
# reboot

</pre></div></div><div class="sect2" lang="fr"><div class="titlepage"><div><div><h3 class="title"><a name="SecondStage"></a>11.2.&nbsp;Deuxi&egrave;me &eacute;tape</h3></div></div></div><p>

Ces scripts sont lanc&eacute;s sur l'ordinateur &agrave; sauvegarder ou restaurer.

</p><div class="sect3" lang="fr"><div class="titlepage"><div><div><h4 class="title"><a name="back.up.all"></a>11.2.1.&nbsp;<code class="filename">back.up.all</code></h4></div></div></div><p>

    Ce script effectue une sauvegarde vers un autre ordinateur via un 
    montage NFS. Vous pouvez l'adapter pour effectuer vos sauvegardes 
    vers une bande ou d'autres supports.

</p><pre class="programlisting">
#! /bin/sh

# Back up the entire system to another computer's drive. To make this
# work, we need a convenient chunk of disk space on the remote computer we
# can nfs mount as /mnt/save.

# Time-stamp: &lt;2003-04-24 09:56:05 ccurley back.up.all&gt;

# Copyright 2000 through the last date of modification Charles Curley.

# This program is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the
# Free Software Foundation; either version 2 of the License, or (at your
# option) any later version.

# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.

# You should have received a copy of the GNU General Public License along
# with this program; if not, write to the Free Software Foundation, Inc.,
# 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA

# You can also contact the Free Software Foundation at http://www.fsf.org/

# For more information contact the author, Charles Curley, at
# http://www.charlescurley.com/.

save="/mnt/save"

# Make sure it's there
umount $save
mount $save

cd /

rm $save/tester.tar.old.gz
mv $save/tester.tar.gz $save/tester.tar.old.gz

# save everything except /mnt, /proc, and nfs mounted directories.

time tar cf - / --exclude /mnt --exclude /proc --exclude $save\
    | gzip -c &gt; $save/tester.tar.gz



</pre></div><div class="sect3" lang="fr"><div class="titlepage"><div><div><h4 class="title"><a name="back.up.all.ssh"></a>11.2.2.&nbsp;<code class="filename">back.up.all.ssh</code></h4></div></div></div><p>

    Ce script fait exactement la m&ecirc;me chose que <a href="#back.up.all" title="11.2.1.&nbsp;back.up.all"><code class="filename">back.up.all</code></a> mais 
    il utilise ssh &agrave; la place de nfs.
    
</p><pre class="programlisting">
#! /bin/sh

# Back up the entire system to another computer's drive. To make this
# work, we need a convenient chunk of disk space on the remote
# computer. This version uses ssh to do its transfer, and compresses
# using bz2. This means this script has to know more about the other
# computer, which does not make for good modularization.

# Time-stamp: &lt;2003-04-24 09:56:52 ccurley back.up.all.ssh&gt;

# Copyright 2000 through the last date of modification Charles Curley.

# This program is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the
# Free Software Foundation; either version 2 of the License, or (at your
# option) any later version.

# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.

# You should have received a copy of the GNU General Public License along
# with this program; if not, write to the Free Software Foundation, Inc.,
# 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA

# You can also contact the Free Software Foundation at http://www.fsf.org/

# For more information contact the author, Charles Curley, at
# http://www.charlescurley.com/.

save="/backs/tester"
backup_server="charlesc"

# rotate the old backups. Do it all in one line to minimze authentication overhead.
ssh $backup_server "rm $save/tester.tar.old.bz2; mv $save/tester.tar.bz2 \
    $save/tester.tar.old.bz2"

# save everything except /mnt, /proc, and squid directories.

time tar cf - / --exclude /mnt --exclude /proc --exclude /var/spool/squid\
    | ssh $backup_server "bzip2 -9 &gt; $save/tester.tar.bz2"


</pre></div><div class="sect3" lang="fr"><div class="titlepage"><div><div><h4 class="title"><a name="restore.all"></a>11.2.3.&nbsp;<code class="filename">restore.all</code></h4></div></div></div><p>

Vous utiliserez ce script de restauration si votre sauvegarde a &eacute;t&eacute; 
effectu&eacute;e avec <a href="#back.up.all" title="11.2.1.&nbsp;back.up.all"><code class="filename">back.up.all</code></a>.</p><pre class="programlisting">
#! /bin/sh

# A script to restore all of the data from an nfs mount. This is our final
# stage restore.

# Time-stamp: &lt;2003-04-24 09:58:51 ccurley restore.all&gt;

# Copyright 2000 through the last date of modification Charles Curley.

# This program is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the
# Free Software Foundation; either version 2 of the License, or (at your
# option) any later version.

# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.

# You should have received a copy of the GNU General Public License along
# with this program; if not, write to the Free Software Foundation, Inc.,
# 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA

# You can also contact the Free Software Foundation at http://www.fsf.org/

# For more information contact the author, Charles Curley, at
# http://www.charlescurley.com/.

export save="/mnt/save"

mount $save

cd /
gunzip -dc $save/tester.tar.gz | tar -xpkf -

rm /var/run/*.pid

lilo


</pre></div><div class="sect3" lang="fr"><div class="titlepage"><div><div><h4 class="title"><a name="restore.all.ssh"></a>11.2.4.&nbsp;<code class="filename">restore.all.ssh</code></h4></div></div></div><p>

Vous utiliserez ce script de restauration si votre sauvegarde a &eacute;t&eacute; 
effectu&eacute;e avec <a href="#back.up.all.ssh" title="11.2.2.&nbsp;back.up.all.ssh"><code class="filename">back.up.all.ssh</code></a>.

</p><pre class="programlisting">
#! /bin/sh

# A script to restore all of the data using ssh and bunzip2. This is
# our final stage restore.

# Copyright 2000 through the last date of modification Charles Curley.

# Time-stamp: &lt;2003-04-24 09:59:10 ccurley restore.all.ssh&gt;

# This program is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the
# Free Software Foundation; either version 2 of the License, or (at your
# option) any later version.

# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.

# You should have received a copy of the GNU General Public License along
# with this program; if not, write to the Free Software Foundation, Inc.,
# 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA

# You can also contact the Free Software Foundation at http://www.fsf.org/

# For more information contact the author, Charles Curley, at
# http://www.charlescurley.com/.

save="/backs/tester/"
backup_server="charlesc"

cd /

ssh $backup_server "cat $save/tester.tar.bz2" | bunzip2 | tar -xpkf -

rm /var/run/*.pid

lilo


</pre></div></div><div class="sect2" lang="fr"><div class="titlepage"><div><div><h3 class="title"><a name="BackupServerScripts"></a>11.3.&nbsp;Scripts de sauvegarde du serveur</h3></div></div></div><p>

Les scripts ssh d&eacute;crits ci-dessus sont susceptibles de poser un probl&egrave;me 
de s&eacute;curit&eacute;. Si vous les lancez derri&egrave;re un pare-feu, le pare-feu doit 
permettre &agrave; ssh d'acc&eacute;der au serveur de sauvegarde. Dans ce cas, il se 
peut qu'un pirate intelligent soit aussi capable de pirater le serveur 
de sauvegarde. Il serait plus s&ucirc;r d'ex&eacute;cuter les scripts de sauvegarde 
et de restauration sur le serveur de sauvegarde, et de laisser le 
serveur de sauvegarde acc&eacute;der au pare-feu. Ces scripts sont con&ccedil;us pour 
fonctionner ainsi. Renommez-les en <code class="filename">get.x</code> et en 
<code class="filename">restore.x</code> o&ugrave; <code class="filename">x</code> est le nom de 
l'ordinateur cible. &Eacute;ditez-les (la variable $target 
d'initialisation d&eacute;finissant la cible) pour qu'ils utilisent le nom 
d'h&ocirc;te de l'ordinateur cible, ou r&eacute;&eacute;crivez-les pour qu'ils utilisent un 
argument de ligne de commande.

</p><p>

    Ces scripts effectuent compl&egrave;tement la sauvegarde et la restauration 
    de la cible, et pas uniquement la premi&egrave;re &eacute;tape de la sauvegarde et 
    de la restauration. Remarquez aussi que 
    <code class="filename">get.tester</code> sauvegarde aussi le disque ZIP, au 
    cas o&ugrave; vous auriez besoin de remplacer un disque ZIP d&eacute;fectueux.

</p><p>

    J'utilise couramment ces scripts.

</p><div class="sect3" lang="fr"><div class="titlepage"><div><div><h4 class="title"><a name="get.tester"></a>11.3.1.&nbsp;<code class="filename">get.tester</code></h4></div></div></div><pre class="programlisting">
#! /bin/sh

# Back up another computer's drive to this system. To make this work, we
# need a convenient chunk of disk space on this computer. This version
# uses ssh to do its transfer, and compresses using bz2. This version was
# developed so that the system to be backed up won't be authenticated to
# log onto the backup computer. This script is intended to be used on a
# firewall. You don't want the firewall to be authenticated to the backup
# system in case the firewall is cracked.

# Time-stamp: &lt;2004-04-03 12:24:12 ccurley get.tester&gt;

# Copyright 2000 through the last date of modification Charles Curley.

# This program is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the
# Free Software Foundation; either version 2 of the License, or (at your
# option) any later version.

# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.

# You should have received a copy of the GNU General Public License along
# with this program; if not, write to the Free Software Foundation, Inc.,
# 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA

# You can also contact the Free Software Foundation at http://www.fsf.org/

# For more information contact the author, Charles Curley, at
# http://www.charlescurley.com/.

# 2004 04 03: added /sys to the list of excludes. It is a read-only
# pseudo-file system like /proc.

# 2002 07 01: We now set the path on the target to the zip drive with
# a variable. This fixes a bug in the command to eject the zip disk.

# 2002 07 01: The zip disk archives are now in bzip2 format, so this
# script has been changed to reflect that.



# The host name of the computer to be backed up.
target=tester
zip=/mnt/zip

echo Backing up $target

echo Aging the ZIP disk backups.

rm -r $target.old.zip

mv $target.zip $target.old.zip

ssh $target "modprobe ppa ; mount -r $zip"

echo Copying the ZIP disk.

# -r for recursive copy, -p to preserve times and permissions, -q for
# quiet: no progress meter.

scp -qpr $target:$zip $target.zip

du -hs $target.zip


echo Aging the archives

rm $target.tar.old.bz2

mv $target.tar.bz2 $target.tar.old.bz2


echo Backing up $target to the backup server.

ssh $target tar -cf - / --exclude /sys --exclude /mnt --exclude /proc\
    --exclude /var/spool/squid\
    | bzip2 -9 | cat &gt; $target.tar.bz2

echo Testing the results.
find . -iname "*.bz2" | xargs bunzip2 -t

ssh $target "eject $zip"


</pre></div><div class="sect3" lang="fr"><div class="titlepage"><div><div><h4 class="title"><a name="restore.tester"></a>11.3.2.&nbsp;<code class="filename">restore.tester</code></h4></div></div></div><pre class="programlisting">
#! /bin/sh

# A script to restore all of the data to tester via ssh. This is our final
# stage restore.

# Time-stamp: &lt;2003-04-24 09:59:45 ccurley restore.tester&gt;

# Copyright 2000 through the last date of modification Charles Curley.

# This program is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License as published by the
# Free Software Foundation; either version 2 of the License, or (at your
# option) any later version.

# This program is distributed in the hope that it will be useful, but
# WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
# General Public License for more details.

# You should have received a copy of the GNU General Public License along
# with this program; if not, write to the Free Software Foundation, Inc.,
# 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA

# You can also contact the Free Software Foundation at http://www.fsf.org/

# For more information contact the author, Charles Curley, at
# http://www.charlescurley.com/.

# The host name of the computer to be restored.

target=tester

bunzip2 -dc $target.tar.bz2 | ssh $target "cd / ; tar -xpkf - "

ssh $target lilo


</pre></div></div></div><div class="sect1" lang="fr"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="resources"></a>12.&nbsp;Ressources</h2></div></div></div><p>

    Dans le d&eacute;sordre. Il y a des points que vous avez peut-&ecirc;tre envie 
    d'approfondir. Une pr&eacute;sence dans cette liste ne doit pas &ecirc;tre 
    comprise comme une approbation. En fait, bien souvent, je n'ai pas 
    utilis&eacute; le produit et ne peux pas le commenter.
    
</p><div class="itemizedlist"><ul type="disc"><li><p>

<a href="http://www.oreilly.com/catalog/unixbr/author.html" target="_top">W. Curtis 
Preston</a> et son excellent <a href="http://www.oreilly.com/catalog/unixbr/" target="_top"><em class="citetitle">Unix Backup &amp; Recovery</em></a>. Voici le 
livre qui m'a fait d&eacute;marrer ce travail de restauration int&eacute;grale de 
syst&egrave;mes. Je le recommande chaleureusement ; <a href="http://www2.linuxjournal.com/lj-issues/issue78/3839.html" target="_top">lire mon 
bilan</a>.

</p></li><li><p>


Une vieille (datant de 2000) liste de <a href="http://www.fokus.gmd.de/linux/linux-distrib-small.html" target="_top">petites 
distributions Linux.</a>

</p></li><li><p>

<a href="http://www.toms.net/rb" target="_top"> tomsrtbt</a>, 
&laquo;&nbsp;<span class="quote">l'essentiel de Linux sur une disquette.</span>&nbsp;&raquo; Tom est aussi li&eacute; 
&agrave; d'autres petites distributions.

</p></li><li><p>

    Le <a href="http://www.tldp.org/" target="_top">projet de documentation 
    Linux</a>. En particulier, jetez un coup d'œil &agrave; 
    &laquo;&nbsp;<span class="citetitle">LILO, Linux Crash Rescue 
    HOW-TO</span>&nbsp;&raquo;.

</p></li><li><p>

Le programme de la Free Software Foundation <a href="http://www.gnu.org/software/parted" target="_top"><code class="filename">parted</code></a> 
pour &eacute;diter (agrandir, diminuer, d&eacute;placer) les partitions.

</p></li><li><p>

<a href="http://qtparted.sourceforge.net/" target="_top">QtParted</a> semble 
faire la m&ecirc;me chose mais avec une interface graphique.

</p></li><li><p>

<a href="http://www.partimage.org/" target="_top">Partition Image</a> pour les 
sauvegardes des partitions.

</p><p>

De sa page eb&nbsp;: &laquo;&nbsp;<span class="quote">Partition Image est un utilitaire 
Linux/UNIX qui sauvegarde des partitions d'un grand nombre de formats 
(voir plus bas) dans un fichier image. Le fichier image peut &ecirc;tre 
comprim&eacute; au format GZIP/BZIP2 pour &eacute;conomiser de l'espace, et &ecirc;tre 
d&eacute;coup&eacute; en plusieurs fichiers destin&eacute;s &agrave; &ecirc;tre copi&eacute;s sur des supports 
amovibles (des disques ZIP par exemple) La partition peut &ecirc;tre 
sauvegard&eacute;e sur le r&eacute;seau depuis la version 0.6.0.</span>&nbsp;&raquo;

</p></li><li><p>

<a href="http://sourceforge.net/projects/bacula" target="_top"> Bacula</a> est 
un produit de sauvegarde sous licence GPL comprenant du code pour 
effectuer une restauration int&eacute;grale de syst&egrave;me, qui a &eacute;t&eacute; inspir&eacute; en 
partie par ce guide pratique.

</p></li><li><p>

&laquo;&nbsp;<span class="quote"><a href="http://www.feyrer.de/g4u/" target="_top">g4u ghost pour unix 
('ghost for unix')</a> est une disquette/CDROM de 
d&eacute;marrage bas&eacute;e sur NetBSD qui permet de cloner facilement des disques 
durs de PC devant &ecirc;tre d&eacute;ploy&eacute;s via FTP avec une configuration commune 
sur un certain nombre de PC. La disquette (ou le CDROM) a deux 
fonctions. La premi&egrave;re est de transf&eacute;rer l'image comprim&eacute;e d'un disque 
dur local vers un serveur FTP. L'autre est de restaurer cette image par 
FTP, la d&eacute;compresser et la restaurer sur un disque; la configuration 
r&eacute;seau est obtenu par DHCP. Le disque dur &eacute;tant trait&eacute; comme une image, 
n'importe quel syst&egrave;me d'exploitation ou de fichiers peut &ecirc;tre d&eacute;ploy&eacute; &agrave; 
l'aide de g4u.</span>&nbsp;&raquo;

</p></li><li><p>

&laquo;&nbsp;<span class="quote">Nous pr&eacute;sentons <a href="http://www.cs.utah.edu/flux/papers/frisbee-usenix03-base.html" target="_top">Frisbee</a>,
qui est un syst&egrave;me destin&eacute; &agrave; sauvegarder, transf&eacute;rer et installer les
images de disques entiers, avec comme objectifs d'&ecirc;tre rapide et
extensible dans un environnement de r&eacute;seau local. Techniquement, Frisbee
utilise une m&eacute;thode particuli&egrave;re de compression qui tient compte des
syst&egrave;mes de fichiers, un protocole maison de diffusion s&eacute;lective de
niveau application et un d&eacute;coupage de trames flexible de niveau
application. De cette conception, il en r&eacute;sulte un syst&egrave;me capable de
distribuer rapidement et de fa&ccedil;on fiable l'image d'un disque &agrave; de
nombreux clients simultan&eacute;s. Par exemple, Frisbee est capable d'&eacute;crire
un total de 50 giga-octets de donn&eacute;es sur 80 disques en 34 secondes,
ceci sur des PC standards. Nous d&eacute;crivons la conception et la mise en
œuvre de Frisbee, examinons les d&eacute;cisions importantes de
conception et &eacute;valuons ses performances.</span>&nbsp;&raquo;

</p></li><li><p>

Il y a un certain nombre de distributions disponibles sous forme de cl&eacute;s 
USB. Rendez-vous sur le site de <a href="http://www.distrowatch.com/" target="_top">DistroWatch</a> pour plus de 
d&eacute;tails.

</p></li><li><p>

Kits de secours bas&eacute;es sur CDROM. Ceci n'est pas une liste 
exhaustive. Si vous en connaissez une (ou du moins qui pr&eacute;tend en &ecirc;tre 
une), <a href="charlescurley CHEZ charlescurley POINT com" target="_top">faites-le moi savoir.</a> Vous 
trouverez des informations plus r&eacute;centes sur <a href="http://www.distrowatch.com/" target="_top">DistroWatch</a>.

</p><div class="itemizedlist"><ul type="circle"><li><p>

Le <a href="http://www.microwerks.net/~hugo/" target="_top">Mondo</a> de Hugo 
Rabson &laquo;&nbsp;<span class="quote">... cr&eacute;e un ou plusieurs CDROM (ou disquettes + bandes) 
amor&ccedil;ables de secours contenant tout ou partie de votre syst&egrave;me 
de fichiers. En cas de perte catastrophique de donn&eacute;es, vous pourrez 
restaurer int&eacute;gralement.</span>&nbsp;&raquo;

</p></li><li><p>

Le <a href="http://crashrecovery.org/" target="_top">kit de r&eacute;cup&eacute;ration apr&egrave;s une 
panne irr&eacute;cup&eacute;rable (Crash Recovery Kit for Linux)</a>

</p></li><li><p>

<a href="http://www-106.ibm.com/developerworks/linux/library/l-knopx.html?ca=dgr- lnxw04Knoppix" target="_top">&laquo;&nbsp;<span class="quote">R&eacute;cup&eacute;ration 
de syst&egrave;me avec Knoppix (System recovery with Knoppix)</span>&nbsp;&raquo;</a> 
est une bonne introduction &agrave; la r&eacute;cup&eacute;ration de syst&egrave;me en g&eacute;n&eacute;ral et 
dispose de liens <a href="http://www.knoppix.org/" target="_top">Knoppix</a>utiles.

</p></li><li><p>

&laquo;&nbsp;<span class="quote"><a href="http://emergencycd2.sourceforge.net/" target="_top">Cool Linux 
CD</a> est une version de Linux sur CDROM. Il est bas&eacute; sur le 
noyau 2.4 et on y trouve des logiciels libres et de 
d&eacute;monstration.</span>&nbsp;&raquo;

</p></li><li><p>

<a href="http://www.sysresccd.org/index.en.php" target="_top">SystemRescueCd</a> &laquo;&nbsp;<span class="quote"> 
est un syst&egrave;me linux mont&eacute; sur un CDROM amor&ccedil;able, destin&eacute; &agrave; r&eacute;parer 
votre syst&egrave;me et vos donn&eacute;es apr&egrave;s une panne irr&eacute;cup&eacute;rable. Il a aussi 
pour but de faciliter les t&acirc;ches d'administration de votre ordinateur, 
telles que cr&eacute;er et &eacute;diter les partitions du disque dur. Il contient un 
bon nombre d'utilitaires syst&egrave;me (parted, partimage, fstools, ...) et 
basiques (&eacute;diteurs, midnight commander, outils r&eacute;seau). Il a pour 
objectif d'&ecirc;tre facile &agrave; utiliser&nbsp;: d&eacute;marrez simplement avec le 
CDROM et vous pourrez tout faire. Son noyau supporte les principaux 
syst&egrave;mes de fichiers (ext2/ext3, reiserfs, xfs, jfs, vfat, ntfs, 
iso9660) et r&eacute;seaux (samba et nfs).</span>&nbsp;&raquo;

</p></li><li><p>

<a href="http://syslinux.zytor.com/" target="_top">Syslinux</a> cr&eacute;e le code de 
d&eacute;marrage pour des images de disquettes, de CDROM et de PXE 
(Environnement de pr&eacute;-ex&eacute;cution) Intel. Il ne d&eacute;pend pas d'une image de 
disquette. Vous pourrez cr&eacute;er vos propres CDROM &agrave; l'aide de certains 
outils, tels que <a href="http://www.toms.net/rb" target="_top">tomsrtbt</a>.

</p></li><li><p>

Au cas o&ugrave; voudriez vous d&eacute;brouiller tout seul&nbsp;: &laquo;&nbsp;<span class="quote"><a href="http://www.linux-live.org/" target="_top">Linux Live</a> est un ensemble de 
scripts bash qui vous permet de cr&eacute;er votre propre LiveCD &agrave; partir de 
n'importe quelle distribution Linux. Installez simplement votre 
distribution favorite, enlevez tous les fichiers superflus (les pages de 
manuel, par exemple, et tous les autres fichiers que vous n'estimez pas 
importants).</span>&nbsp;&raquo;

</p></li><li><p>

&laquo;&nbsp;<span class="quote">Le <a href="http://www.linbox.com/en/ppart.html" target="_top">CDROM 
PPART</a> vous permet de g&eacute;n&eacute;rer un CD amor&ccedil;able de r&eacute;cup&eacute;ration de 
syst&egrave;me &agrave; partir de disques durs pr&eacute;c&eacute;demment sauvegard&eacute;s.</span>&nbsp;&raquo;

</p></li><li><p>

<a href="http://rescuecd.sourceforge.net/" target="_top">Timo's Rescue CD Set (Le 
CD de secours de Timo)</a>&nbsp;: &laquo;&nbsp;<span class="quote">Cette bo&icirc;te &agrave; outils 
constitue mon approche pour g&eacute;n&eacute;rer facilement un CD amor&ccedil;able de 
sauvegarde de syst&egrave;me, qui peut ais&eacute;ment &ecirc;tre adapt&eacute; &agrave; vos besoins. Le 
projet est en train de se transformer en une distribution "debian sur 
CDROM", ce qui fait qu'il n'est pas seulement utilisable comme CD de 
secours mais que l'on peut aussi installer une debian compl&egrave;te sur le 
CD.</span>&nbsp;&raquo;

</p></li><li><p>

La <a href="http://www.frozentech.com/content/livecd.php" target="_top">liste des 
distributions bas&eacute;es sur CDROM</a> comprend plus de distributions 
bas&eacute;es sur CDROM.

</p></li></ul></div></li></ul></div></div><div class="appendix" lang="fr"><h2 class="title" style="clear: both"><a name="appendix1gfdl"></a>A.&nbsp;License GNU Free Documentation</h2><p>
Version 1.1, March 2000</p><div class="blockquote"><blockquote class="blockquote"><p>
Copyright (C) 2000 Free Software Foundation, Inc. 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA Everyone is permitted to copy and distribute verbatim copies of this license document, but changing it is not allowed.</p></blockquote></div><div class="sect1" lang="fr"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="gfdl02"></a>0.&nbsp;
PREAMBULE</h2></div></div></div><p>
The purpose of this License is to make a manual, textbook, or other written document "free" in the sense of freedom: to assure everyone the effective freedom to copy and redistribute it, with or without modifying it, either commercially or noncommercially. Secondarily, this License preserves for the author and publisher a way to get credit for their work, while not being considered responsible for modifications made by others.</p><p>
This License is a kind of "copyleft", which means that derivative works of the document must themselves be free in the same sense. It complements the GNU General Public License, which is a copyleft license designed for free software.</p><p>
We have designed this License in order to use it for manuals for free software, because free software needs free documentation: a free program should come with manuals providing the same freedoms that the software does. But this License is not limited to software manuals; it can be used for any textual work, regardless of subject matter or whether it is published as a printed book. We recommend this License principally for works whose purpose is instruction or reference.</p></div><div class="sect1" lang="fr"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="gfdl03"></a>1.&nbsp;
APPLICABILITY AND DEFINITIONS</h2></div></div></div><p>
This License applies to any manual or other work that contains a notice placed by the copyright holder saying it can be distributed under the terms of this License. The "Document", below, refers to any such manual or work. Any member of the public is a licensee, and is addressed as "you".</p><p>
A "Modified Version" of the Document means any work containing the Document or a portion of it, either copied verbatim, or with modifications and/or translated into another language.</p><p>
A "Secondary Section" is a named appendix or a front-matter section of the Document that deals exclusively with the relationship of the publishers or authors of the Document to the Document's overall subject (or to related matters) and contains nothing that could fall directly within that overall subject. (For example, if the Document is in part a textbook of mathematics, a Secondary Section may not explain any mathematics.) The relationship could be a matter of historical connection with the subject or with related matters, or of legal, commercial, philosophical, ethical or political position regarding them.</p><p>
The "Invariant Sections" are certain Secondary Sections whose titles are designated, as being those of Invariant Sections, in the notice that says that the Document is released under this License.</p><p>
The "Cover Texts" are certain short passages of text that are listed, as Front-Cover Texts or Back-Cover Texts, in the notice that says that the Document is released under this License.</p><p>
A "Transparent" copy of the Document means a machine-readable copy, represented in a format whose specification is available to the general public, whose contents can be viewed and edited directly and straightforwardly with generic text editors or (for images composed of pixels) generic paint programs or (for drawings) some widely available drawing editor, and that is suitable for input to text formatters or for automatic translation to a variety of formats suitable for input to text formatters. A copy made in an otherwise Transparent file format whose markup has been designed to thwart or discourage subsequent modification by readers is not Transparent. A copy that is not "Transparent" is called "Opaque".</p><p>
Examples of suitable formats for Transparent copies include plain ASCII without markup, Texinfo input format, LaTeX input format, SGML or XML using a publicly available DTD, and standard-conforming simple HTML designed for human modification. Opaque formats include PostScript, PDF, proprietary formats that can be read and edited only by proprietary word processors, SGML or XML for which the DTD and/or processing tools are not generally available, and the machine-generated HTML produced by some word processors for output purposes only.</p><p>
The "Title Page" means, for a printed book, the title page itself, plus such following pages as are needed to hold, legibly, the material this License requires to appear in the title page. For works in formats which do not have any title page as such, "Title Page" means the text near the most prominent appearance of the work's title, preceding the beginning of the body of the text.</p></div><div class="sect1" lang="fr"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="gfdl04"></a>2.&nbsp;
VERBATIM COPYING</h2></div></div></div><p>
You may copy and distribute the Document in any medium, either commercially or noncommercially, provided that this License, the copyright notices, and the license notice saying this License applies to the Document are reproduced in all copies, and that you add no other conditions whatsoever to those of this License. You may not use technical measures to obstruct or control the reading or further copying of the copies you make or distribute. However, you may accept compensation in exchange for copies. If you distribute a large enough number of copies you must also follow the conditions in section 3.</p><p>
You may also lend copies, under the same conditions stated above, and you may publicly display copies.</p></div><div class="sect1" lang="fr"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="gfdl05"></a>3.&nbsp;
COPYING IN QUANTITY</h2></div></div></div><p>
If you publish printed copies of the Document numbering more than 100, and the Document's license notice requires Cover Texts, you must enclose the copies in covers that carry, clearly and legibly, all these Cover Texts: Front-Cover Texts on the front cover, and Back-Cover Texts on the back cover. Both covers must also clearly and legibly identify you as the publisher of these copies. The front cover must present the full title with all words of the title equally prominent and visible. You may add other material on the covers in addition. Copying with changes limited to the covers, as long as they preserve the title of the Document and satisfy these conditions, can be treated as verbatim copying in other respects.</p><p>
If the required texts for either cover are too voluminous to fit legibly, you should put the first ones listed (as many as fit reasonably) on the actual cover, and continue the rest onto adjacent pages.</p><p>
If you publish or distribute Opaque copies of the Document numbering more than 100, you must either include a machine-readable Transparent copy along with each Opaque copy, or state in or with each Opaque copy a publicly-accessible computer-network location containing a complete Transparent copy of the Document, free of added material, which the general network-using public has access to download anonymously at no charge using public-standard network protocols. If you use the latter option, you must take reasonably prudent steps, when you begin distribution of Opaque copies in quantity, to ensure that this Transparent copy will remain thus accessible at the stated location until at least one year after the last time you distribute an Opaque copy (directly or through your agents or retailers) of that edition to the public.</p><p>
It is requested, but not required, that you contact the authors of the Document well before redistributing any large number of copies, to give them a chance to provide you with an updated version of the Document.</p></div><div class="sect1" lang="fr"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="gfdl06"></a>4.&nbsp;
MODIFICATIONS</h2></div></div></div><p>
You may copy and distribute a Modified Version of the Document under the conditions of sections 2 and 3 above, provided that you release the Modified Version under precisely this License, with the Modified Version filling the role of the Document, thus licensing distribution and modification of the Modified Version to whoever possesses a copy of it. In addition, you must do these things in the Modified Version:</p><div class="orderedlist"><ol type="A"><li><p>
Use in the Title Page (and on the covers, if any) a title distinct from that of the Document, and from those of previous versions (which should, if there were any, be listed in the History section of the Document). You may use the same title as a previous version if the original publisher of that version gives permission.</p></li><li><p>
List on the Title Page, as authors, one or more persons or entities responsible for authorship of the modifications in the Modified Version, together with at least five of the principal authors of the Document (all of its principal authors, if it has less than five).</p></li><li><p>
State on the Title page the name of the publisher of the Modified Version, as the publisher.</p></li><li><p>
Preserve all the copyright notices of the Document.</p></li><li><p>
Add an appropriate copyright notice for your modifications adjacent to the other copyright notices.</p></li><li><p>
Include, immediately after the copyright notices, a license notice giving the public permission to use the Modified Version under the terms of this License, in the form shown in the Addendum below.</p></li><li><p>
Preserve in that license notice the full lists of Invariant Sections and required Cover Texts given in the Document's license notice.</p></li><li><p>
Include an unaltered copy of this License.</p></li><li><p>
Preserve the section entitled "History", and its title, and add to it an item stating at least the title, year, new authors, and publisher of the Modified Version as given on the Title Page. If there is no section entitled "History" in the Document, create one stating the title, year, authors, and publisher of the Document as given on its Title Page, then add an item describing the Modified Version as stated in the previous sentence.</p></li><li><p>
Preserve the network location, if any, given in the Document for public access to a Transparent copy of the Document, and likewise the network locations given in the Document for previous versions it was based on. These may be placed in the "History" section. You may omit a network location for a work that was published at least four years before the Document itself, or if the original publisher of the version it refers to gives permission.</p></li><li><p>
In any section entitled "Acknowledgements" or "Dedications", preserve the section's title, and preserve in the section all the substance and tone of each of the contributor acknowledgements and/or dedications given therein.</p></li><li><p>
Preserve all the Invariant Sections of the Document, unaltered in their text and in their titles. Section numbers or the equivalent are not considered part of the section titles.</p></li><li><p>
Delete any section entitled "Endorsements". Such a section may not be included in the Modified Version.</p></li><li><p>
Do not retitle any existing section as "Endorsements" or to conflict in title with any Invariant Section.</p></li></ol></div><p>
If the Modified Version includes new front-matter sections or appendices that qualify as Secondary Sections and contain no material copied from the Document, you may at your option designate some or all of these sections as invariant. To do this, add their titles to the list of Invariant Sections in the Modified Version's license notice. These titles must be distinct from any other section titles.</p><p>
You may add a section entitled "Endorsements", provided it contains nothing but endorsements of your Modified Version by various parties--for example, statements of peer review or that the text has been approved by an organization as the authoritative definition of a standard.</p><p>
You may add a passage of up to five words as a Front-Cover Text, and a passage of up to 25 words as a Back-Cover Text, to the end of the list of Cover Texts in the Modified Version. Only one passage of Front-Cover Text and one of Back-Cover Text may be added by (or through arrangements made by) any one entity. If the Document already includes a cover text for the same cover, previously added by you or by arrangement made by the same entity you are acting on behalf of, you may not add another; but you may replace the old one, on explicit permission from the previous publisher that added the old one.</p><p>
The author(s) and publisher(s) of the Document do not by this License give permission to use their names for publicity for or to assert or imply endorsement of any Modified Version.</p></div><div class="sect1" lang="fr"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="gfdl07"></a>5.&nbsp;
COMBINING DOCUMENTS</h2></div></div></div><p>
You may combine the Document with other documents released under this License, under the terms defined in section 4 above for modified versions, provided that you include in the combination all of the Invariant Sections of all of the original documents, unmodified, and list them all as Invariant Sections of your combined work in its license notice.</p><p>
The combined work need only contain one copy of this License, and multiple identical Invariant Sections may be replaced with a single copy. If there are multiple Invariant Sections with the same name but different contents, make the title of each such section unique by adding at the end of it, in parentheses, the name of the original author or publisher of that section if known, or else a unique number. Make the same adjustment to the section titles in the list of Invariant Sections in the license notice of the combined work.</p><p>
In the combination, you must combine any sections entitled "History" in the various original documents, forming one section entitled "History"; likewise combine any sections entitled "Acknowledgements", and any sections entitled "Dedications". You must delete all sections entitled "Endorsements."</p></div><div class="sect1" lang="fr"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="gfdl08"></a>6.&nbsp;
COLLECTIONS OF DOCUMENTS</h2></div></div></div><p>
You may make a collection consisting of the Document and other documents released under this License, and replace the individual copies of this License in the various documents with a single copy that is included in the collection, provided that you follow the rules of this License for verbatim copying of each of the documents in all other respects.</p><p>
You may extract a single document from such a collection, and distribute it individually under this License, provided you insert a copy of this License into the extracted document, and follow this License in all other respects regarding verbatim copying of that document.</p></div><div class="sect1" lang="fr"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="gfdl09"></a>7.&nbsp;
AGGREGATION WITH INDEPENDENT WORKS</h2></div></div></div><p>
A compilation of the Document or its derivatives with other separate and independent documents or works, in or on a volume of a storage or distribution medium, does not as a whole count as a Modified Version of the Document, provided no compilation copyright is claimed for the compilation. Such a compilation is called an "aggregate", and this License does not apply to the other self-contained works thus compiled with the Document, on account of their being thus compiled, if they are not themselves derivative works of the Document.</p><p>
If the Cover Text requirement of section 3 is applicable to these copies of the Document, then if the Document is less than one quarter of the entire aggregate, the Document's Cover Texts may be placed on covers that surround only the Document within the aggregate. Otherwise they must appear on covers around the whole aggregate.</p></div><div class="sect1" lang="fr"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="gfdl10"></a>8.&nbsp;
TRANSLATION</h2></div></div></div><p>
Translation is considered a kind of modification, so you may distribute translations of the Document under the terms of section 4. Replacing Invariant Sections with translations requires special permission from their copyright holders, but you may include translations of some or all Invariant Sections in addition to the original versions of these Invariant Sections. You may include a translation of this License provided that you also include the original English version of this License. In case of a disagreement between the translation and the original English version of this License, the original English version will prevail.</p></div><div class="sect1" lang="fr"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="gfdl11"></a>9.&nbsp;
TERMINATION</h2></div></div></div><p>
You may not copy, modify, sublicense, or distribute the Document except as expressly provided for under this License. Any other attempt to copy, modify, sublicense or distribute the Document is void, and will automatically terminate your rights under this License. However, parties who have received copies, or rights, from you under this License will not have their licenses terminated so long as such parties remain in full compliance.</p></div><div class="sect1" lang="fr"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="gfdl12"></a>10.&nbsp;
FUTURE REVISIONS OF THIS LICENSE</h2></div></div></div><p>
The Free Software Foundation may publish new, revised versions of the GNU Free Documentation License from time to time. Such new versions will be similar in spirit to the present version, but may differ in detail to address new problems or concerns. See <a href="http://www.gnu.org/copyleft/" target="_top">
http://www.gnu.org/copyleft/</a>
.</p><p>
Each version of the License is given a distinguishing version number. If the Document specifies that a particular numbered version of this License "or any later version" applies to it, you have the option of following the terms and conditions either of that specified version or of any later version that has been published (not as a draft) by the Free Software Foundation. If the Document does not specify a version number of this License, you may choose any version ever published (not as a draft) by the Free Software Foundation.</p></div><div class="sect1" lang="fr"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="gfdl13"></a>11.&nbsp;
How to use this License for your documents</h2></div></div></div><p>
To use this License in a document you have written, include a copy of the License in the document and put the following copyright and license notices just after the title page:</p><div class="blockquote"><blockquote class="blockquote"><p>
 Copyright (c) YEAR YOUR NAME. Permission is granted to copy, distribute and/or modify this document under the terms of the GNU Free Documentation License, Version 1.1 or any later version published by the Free Software Foundation; with the Invariant Sections being LIST THEIR TITLES, with the Front-Cover Texts being LIST, and with the Back-Cover Texts being LIST. A copy of the license is included in the section entitled "GNU Free Documentation License". </p></blockquote></div><p>
If you have no Invariant Sections, write "with no Invariant Sections" instead of saying which ones are invariant. If you have no Front-Cover Texts, write "no Front-Cover Texts" instead of "Front-Cover Texts being LIST"; likewise for Back-Cover Texts.</p><p>
If your document contains nontrivial examples of program code, we recommend releasing these examples in parallel under your choice of free software license, such as the GNU General Public License, to permit their use in free software.</p></div></div><div class="footnotes"><br><hr align="left" width="100"><div class="footnote"><p><sup>[<a href="#N103C1" name="ftn.N103C1">1</a>] </sup>

Je fais ressortir copie parce que <span><strong class="command">mkisofs</strong></span> d&eacute;truira le 
fichier dans le r&eacute;pertoire o&ugrave; il fabrique l'image ISO.

</p></div></div></div></body></html>