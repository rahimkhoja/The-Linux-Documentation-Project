<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
"http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<meta name="generator" content=
"HTML Tidy for Linux (vers 7 December 2008), see www.w3.org">
<title>Mini How-To sur la configuration de l'aliasing IP sous
Linux</title>
<meta name="GENERATOR" content=
"Modular DocBook HTML Stylesheet Version 1.79">
</head>
<body class="ARTICLE" bgcolor="#FFFFFF" text="#000000" link=
"#0000FF" vlink="#840084" alink="#0000FF">
<div class="ARTICLE">
<div class="TITLEPAGE">
<h1 class="TITLE"><a name="AEN2" id="AEN2">Mini How-To sur la
configuration de l'aliasing IP sous Linux</a></h1>
<h3 class="AUTHOR"><a name="AEN4" id="AEN4">Harish Pillay</a></h3>
<div class="AFFILIATION">
<div class="ADDRESS">
<p class="ADDRESS">&nbsp;<code class="EMAIL">&lt;<a href=
"mailto:h.pillay@ieee.org">h.pillay@ieee.org</a>&gt;</code>&nbsp;</p>
</div>
</div>
<p class="PUBDATE">2001-01-23<br></p>
<div class="REVHISTORY">
<table width="100%" border="0">
<tr>
<th align="left" valign="top" colspan="3"><b>Historique des
versions</b></th>
</tr>
<tr>
<td align="left">Version 1.2</td>
<td align="left">2001-01-26</td>
<td align="left">Revu par&nbsp;: JEY</td>
</tr>
<tr>
<td align="left" colspan="3"></td>
</tr>
<tr>
<td align="left">Version 1.1</td>
<td align="left">2001-01-24</td>
<td align="left">Revu par&nbsp;: JEY</td>
</tr>
<tr>
<td align="left" colspan="3"></td>
</tr>
<tr>
<td align="left">Version 1.0</td>
<td align="left">1997-01-13</td>
<td align="left">Revu par&nbsp;: HP</td>
</tr>
<tr>
<td align="left" colspan="3"></td>
</tr>
</table>
</div>
<div>
<div class="ABSTRACT"><a name="AEN11" id="AEN11"></a>
<p>C'est une recette de cuisine pour configurer et utiliser
l'aliasing IP sur une machine Linux, et pour configurer cette
machine pour recevoir du courrier &eacute;lectronique sur les
adresses IP utilisant l'aliasing. (NDT: l'aliasing IP permet
d'associer plusieurs adresses IP sur la m&ecirc;me interface
r&eacute;seau.)</p>
</div>
</div>
<hr></div>
<div class="SECT1">
<h2 class="SECT1"><a name="MYSETUP" id="MYSETUP">Ma
configuration</a></h2>
<ul>
<li>
<p>L'aliasing IP est en standard dans les noyaux 2.0.x et 2.2.x, et
disponible en option de compilation dans les versions 2.4.x.
(L'aliasing IP a &eacute;t&eacute; d&eacute;sapprouv&eacute; dans
les 2.4.x et remplac&eacute; par un m&eacute;canisme de pare-feu
plus puissant.)</p>
</li>
<li>
<p>Aliasing IP compil&eacute; en module chargeable. Vous auriez du
indiquer pendant la commande "make config", pour construire votre
noyau, que vous voulez compiler l'option "IP Masquerade" en
(M)odule. (NDT: c'est plut&ocirc;t l'option IP Aliasing).
V&eacute;rifiez dans le HOW-TO sur les modules (s'il existe), ou
v&eacute;rifiez dans le fichier <tt class=
"FILENAME">/usr/src/linux/Documentation/modules.txt.</tt></p>
</li>
<li>
<p>Je dois fournir 2 adresses IP en plus de celle qui m'est
d&eacute;j&agrave; attribu&eacute;e.</p>
</li>
<li>
<p>Un adaptateur de poche D-Link DE620 (ce n'est pas important,
cela fonctionne avec n'importe quel adaptateur r&eacute;seau
support&eacute; par Linux).</p>
</li>
</ul>
</div>
<div class="SECT1">
<hr>
<h2 class="SECT1"><a name="COMMANDS" id=
"COMMANDS">Commandes</a></h2>
<ol type="1">
<li>
<p>Chargez le module IP alias (vous pouvez sauter cette
&eacute;tape si vous avez compil&eacute; ce module dans le
noyau):</p>
<pre class="SCREEN">
/sbin/insmod /lib/modules/`uname -r`/ipv4/ip_alias.o
</pre></li>
<li>
<p>Configurez les interfaces loopback, eth0 et tous les
num&eacute;ros IP, en commen&ccedil;ant par le num&eacute;ro IP
principal pour l'interface eth0:</p>
<pre class="SCREEN">
/sbin/ifconfig lo 127.0.0.1
/sbin/ifconfig eth0 up
/sbin/ifconfig eth0 172.16.3.1
/sbin/ifconfig eth0:0 172.16.3.10
/sbin/ifconfig eth0:1 172.16.3.100
</pre>
<p>172.16.3.1 est le num&eacute;ro IP principal, alors que .10 et
.100 sont les aliases. La magie vient de eth0:x, o&ugrave;
x=0,1,3,...n pour les diff&eacute;rents num&eacute;ros IP. Le
num&eacute;ro IP principal n'a pas besoin d'alias.</p>
</li>
<li>
<p>Configurez les routes. D'abord la route pour l'interface
loopback, puis le r&eacute;seau, et finalement les divers
num&eacute;ros IP en commen&ccedil;ant par celui par d&eacute;faut
(allou&eacute; originellement):</p>
<pre class="SCREEN">
/sbin/route add -net 127.0.0.0
/sbin/route add -net 172.16.3.0 dev eth0
/sbin/route add -host 172.16.3.1 dev eth0
/sbin/route add -host 172.16.3.10 dev eth0:0
/sbin/route add -host 172.16.3.100 dev eth0:1
/sbin/route add default gw 172.16.3.200
</pre>
<p>C'est tout.</p>
</li>
</ol>
<p>Dans l'exemple ci-dessus, j'utilise les num&eacute;ros IP
priv&eacute;s (RFC 1918) dans un but d'illustration. Remplacez-les
par vos propres num&eacute;ros IP, officiels ou priv&eacute;s.</p>
<p>L'exemple ne montre que 3 num&eacute;ros IP. Le maximum est
d&eacute;fini &agrave; 256 dans <tt class=
"FILENAME">/usr/include/linux/net_alias.h.</tt> 256 num&eacute;ros
IP sur UNE carte, c'est beaucoup :-) !</p>
<p>Voil&agrave; &agrave; quoi ressemble mon <tt class=
"FILENAME">/sbin/ifconfig</tt>:</p>
<pre class="PROGRAMLISTING">
lo        Link encap:Local Loopback
               inet addr:127.0.0.1  Bcast:127.255.255.255  Mask:255.0.0.0
                         UP BROADCAST LOOPBACK RUNNING  MTU:3584  Metric:1
                    RX packets:5088 errors:0 dropped:0 overruns:0
                    TX packets:5088 errors:0 dropped:0 overruns:0
                
eth0      Link encap:10Mbps Ethernet  HWaddr 00:8E:B8:83:19:20
                    inet addr:172.16.3.1  Bcast:172.16.3.255  Mask:255.255.255.0
                    UP BROADCAST RUNNING PROMISC MULTICAST  MTU:1500  Metric:1
                    RX packets:334036 errors:0 dropped:0 overruns:0
                    TX packets:11605 errors:0 dropped:0 overruns:0
                    Interrupt:7 Base address:0x378
                
eth0:0    Link encap:10Mbps Ethernet  HWaddr 00:8E:B8:83:19:20
                    inet addr:172.16.3.10  Bcast:172.16.3.255  Mask:255.255.255.0
                    UP BROADCAST RUNNING  MTU:1500  Metric:1
                    RX packets:0 errors:0 dropped:0 overruns:0
                    TX packets:0 errors:0 dropped:0 overruns:0
                
eth0:1    Link encap:10Mbps Ethernet  HWaddr 00:8E:B8:83:19:20
                    inet addr:172.16.3.100  Bcast:172.16.3.255  Mask:255.255.255.0
                    UP BROADCAST RUNNING  MTU:1500  Metric:1
                    RX packets:1 errors:0 dropped:0 overruns:0
                    TX packets:0 errors:0 dropped:0 overruns:0
</pre>
<p>Et <tt class="FILENAME">/proc/net/aliases</tt>:</p>
<pre class="SCREEN">
device         family    address
eth0:0           2      172.16.3.10
eth0:1           2      172.16.3.100
</pre>
<p>Et <tt class="FILENAME">/proc/net/alias_types</tt>:</p>
<pre class="PROGRAMLISTING">
type    name            n_attach
2       ip              2
</pre>
<p>Bien s&ucirc;r, les donn&eacute;es de <tt class=
"FILENAME">/proc/net</tt> ont &eacute;t&eacute;
cr&eacute;&eacute;es par la commande <b class=
"COMMAND">ifconfig</b>, et non &agrave; la main!</p>
</div>
<div class="SECT1">
<hr>
<h2 class="SECT1"><a name="TROUBLESHOOTING" id=
"TROUBLESHOOTING">Probl&egrave;mes: Questions et
R&eacute;ponses</a></h2>
<div class="SECT2">
<h3 class="SECT2"><a name="KEEPSETTINGS" id=
"KEEPSETTINGS">Question: Comment garder la configuration
apr&eacute;s un red&eacute;marrage?</a></h3>
<p>R&eacute;ponse: que vous utilisiez un <b class=
"COMMAND">init</b> &agrave; la mani&egrave;re BSD ou &agrave; la
mani&egrave;re SysV (RedHat par exemple), vous pouvez toujours
inclure cela dans <tt class="FILENAME">/etc/rc.d/rc.local</tt>.
Voici ce que j'ai dans mon syst&egrave;me init SysV (RedHat 3.0.3
et 4.0):</p>
<p>Mon <tt class="FILENAME">/etc/rc.d/rc.local</tt>:
(&eacute;dit&eacute; pour ne montrer que les parties
int&eacute;ressantes)</p>
<pre class="SCREEN">
# configuration des interfaces avec IP alias
echo "Configuration des aliases IP: 172.16.3.1, 172.16.3.10, 172.16.3.100..."
/sbin/ifconfig lo 127.0.0.1
/sbin/ifconfig eth0 up
/sbin/ifconfig eth0 172.16.3.1
/sbin/ifconfig eth0:0 172.16.3.10
/sbin/ifconfig eth0:1 172.16.3.100
# configuration des routes
echo "Configuration des routes IP..."
/sbin/route add -net 127.0.0.0
/sbin/route add -net 172.16.3.0 dev eth0
/sbin/route add -host 172.16.3.1 eth0
/sbin/route add -host 172.16.3.10 eth0:0
/sbin/route add -host 172.16.3.100 eth0:1
/sbin/route add default gw 172.16.3.200
# 
</pre></div>
<div class="SECT2">
<hr>
<h3 class="SECT2"><a name="SETTINGUPMAIL" id=
"SETTINGUPMAIL">Question: Comment configurer sendmail pour recevoir
des mails sur plusieurs num&eacute;ros IP?</a></h3>
<p>R&eacute;ponse: Cr&eacute;er (s'il n'existe pas
d&eacute;j&agrave;) un fichier appel&eacute;, par exemple,
<tt class="FILENAME">/etc/mes_noms.cw</tt>. Il ne doit pas
forc&eacute;mement s'appeler ainsi, ni se trouver dans le
repertoire <tt class="FILENAME">/etc directory</tt>.</p>
<p>Dans ce fichier, placer les noms officiels des num&eacute;ros
alias IP. Si ces num&eacute;ros n'ont pas de nom dans un domaine,
alors vous pouvez indiquer le num&eacute;ro IP lui-m&ecirc;me.</p>
<p>Le fichier <tt class="FILENAME">/etc/mes_noms.cw</tt> pourrait
ressembler &agrave; &ccedil;a:</p>
<pre class="PROGRAMLISTING">
# /etc/mes_noms.cw - inclure ici tous les aliases pour votre machine
#                    # est un commentaire
domaine.un.net
domaine.deux.com
domaine.trois.org
4.5.6.7 
</pre>
<p>Dans votre fichier <tt class="FILENAME">sendmail.cf</tt>,
&agrave; l'endroit o&ugrave; on d&eacute;finit une macro de classe
fichier Fw, ajoutez:</p>
<pre class="SCREEN">
     
##################
# infos locales  #
##################
                                     
                                     
# fichier contenant les noms des h&ocirc;tes pour lesquels on re&ccedil;oit du courrier
Fw/etc/mes_noms.cw
                                 
</pre>
<p>Cela devrait suffire. Testez votre nouvelle configuration en
lan&ccedil;ant <b class="COMMAND">sendmail</b> en mode de test, par
exemple:</p>
<pre class="SCREEN">
ganymede$ /usr/lib/sendmail -bt
ADDRESS TEST MODE (ruleset 3 NOT automatically invoked)
Enter &lt; ruleset&gt; &lt; address&gt;
&gt; 0 moi@4.5.6.7
rewrite: ruleset  0   input: moi @ 4 . 5 . 6 . 7
rewrite: ruleset 98   input: moi @ 4 . 5 . 6 . 7
rewrite: ruleset 98 returns: moi @ 4 . 5 . 6 . 7
rewrite: ruleset 97   input: moi @ 4 . 5 . 6 . 7
rewrite: ruleset  3   input: moi @ 4 . 5 . 6 . 7
rewrite: ruleset 96   input: moi &lt; @ 4 . 5 . 6 . 7 &gt;
rewrite: ruleset 96 returns: moi &lt; @ 4 . 5 . 6 . 7 . &gt;
rewrite: ruleset  3 returns: moi &lt; @ 4 . 5 . 6 . 7 . &gt;
rewrite: ruleset  0   input: moi &lt; @ 4 . 5 . 6 . 7 . &gt;
rewrite: ruleset 98   input: moi &lt; @ 4 . 5 . 6 . 7 . &gt;
rewrite: ruleset 98 returns: moi &lt; @ 4 . 5 . 6 . 7 . &gt;
rewrite: ruleset  0 returns: $# local $: moi
rewrite: ruleset 97 returns: $# local $: moi
rewrite: ruleset  0 returns: $# local $: moi
&lt; 0 moi@4.5.6.8
rewrite: ruleset  0   input: moi @ 4 . 5 . 6 . 8
rewrite: ruleset 98   input: moi @ 4 . 5 . 6 . 8
rewrite: ruleset 98 returns: moi @ 4 . 5 . 6 . 8
rewrite: ruleset 97   input: moi @ 4 . 5 . 6 . 8
rewrite: ruleset  3   input: moi @ 4 . 5 . 6 . 8
rewrite: ruleset 96   input: moi &lt; @ 4 . 5 . 6 . 8 &gt;
rewrite: ruleset 96 returns: moi &lt; @ 4 . 5 . 6 . 8 &gt;
rewrite: ruleset  3 returns: moi &lt; @ 4 . 5 . 6 . 8 &gt;
rewrite: ruleset  0   input: moi &lt; @ 4 . 5 . 6 . 8 &gt;
rewrite: ruleset 98   input: moi &lt; @ 4 . 5 . 6 . 8 &gt;
rewrite: ruleset 98 returns: moi &lt; @ 4 . 5 . 6 . 8 &gt;
rewrite: ruleset 95   input: &lt; &gt; moi &lt; @ 4 . 5 . 6 . 8 &gt;
rewrite: ruleset 95 returns: moi &lt; @ 4 . 5 . 6 . 8 &gt;
rewrite: ruleset  0 returns: $# smtp $@ 4 . 5 . 6 . 8 $: moi &lt; @ 4 . 5 . 6 . 8 &gt;
rewrite: ruleset 97 returns: $# smtp $@ 4 . 5 . 6 . 8 $: moi &lt; @ 4 . 5 . 6 . 8 &gt;
rewrite: ruleset  0 returns: $# smtp $@ 4 . 5 . 6 . 8 $: moi &lt; @ 4 . 5 . 6 . 8 &gt;
&gt;
</pre>
<p>Notez que lorsque j'ai test&eacute; <b class=
"COMMAND">moi@4.5.6.7</b>, cela a envoy&eacute; le mail &agrave; la
machine locale, alors que <b class="COMMAND">moi@4.5.6.8</b> a
&eacute;t&eacute; envoy&eacute; &agrave; l'agent de transport smtp.
C'est la r&eacute;ponse correcte.</p>
<p>Tout est configur&eacute; maintenant.</p>
</div>
</div>
<div class="SECT1">
<hr>
<h2 class="SECT1"><a name="REMERCIEMENTS" id=
"REMERCIEMENTS">Remerciements</a></h2>
<p>Merci &agrave; tous ceux qui ont fait ce travail grandiose sur
Linux et l'Aliasing IP. Et particuli&egrave;rement &agrave; Juan
Jose Ciarlante pour avoir clarifi&eacute; mes questions.</p>
<p>Gloire aux as de la programmation!</p>
<p>Si vous trouvez ce document utile, ou si vous avez des
suggestions pour des am&eacute;liorations, envoyez moi un courrier
&eacute;lectronique &agrave;: <code class="EMAIL">&lt;<a href=
"mailto:h.pillay@ieee.org"></a><a href="mailto:h.pillay@ieee.org"
target="_top">h.pillay@ieee.org</a>&gt;</code>. (NDT: l'auteur
n'&eacute;tant probablement pas francophone, pensez &agrave;
r&eacute;diger vos courriers en anglais...)</p>
<p>Amusez-vous bien.</p>
<p>Pour plus d'information &agrave; propos de r&eacute;seau, vous
pouvez consulter le <a href=
"http://www.linuxdoc.org/HOWTO/Networking-Overview-HOWTO.html"
target="_top">Linux Networking Overview HOWTO</a> (NDT: pour la
version fran&ccedil;aise: <a href=
"http://fr.tldp.org/HOWTO/lecture/Networking-Overview-HOWTO.html"
target="_top">Possibilit&eacute;s r&eacute;seau de Linux
HOWTO</a>).</p>
</div>
</div>
</body>
</html>
